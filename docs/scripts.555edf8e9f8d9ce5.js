!function(H,Ar){"object"==typeof exports&&typeof module<"u"?Ar(exports):"function"==typeof define&&define.amd?define(["exports"],Ar):Ar((H=H||self).faceapi=H.faceapi||{})}(this,function(H){"use strict";var Ar=function(e,n){return(Ar=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var o in r)r.hasOwnProperty(o)&&(t[o]=r[o])})(e,n)};function Nn(e,n){function t(){this.constructor=e}Ar(e,n),e.prototype=null===n?Object.create(n):(t.prototype=n.prototype,new t)}function oe(e,n,t,r){return new(t=t||Promise)(function(o,a){function i(c){try{u(r.next(c))}catch(l){a(l)}}function s(c){try{u(r.throw(c))}catch(l){a(l)}}function u(c){c.done?o(c.value):new t(function(l){l(c.value)}).then(i,s)}u((r=r.apply(e,n||[])).next())})}function ae(e,n){var t,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(u){return function(c){return function(l){if(t)throw new TypeError("Generator is already executing.");for(;i;)try{if(t=1,r&&(o=2&l[0]?r.return:l[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,l[1])).done)return o;switch(r=0,o&&(l=[2&l[0],o.value]),l[0]){case 0:case 1:o=l;break;case 4:return i.label++,{value:l[1],done:!1};case 5:i.label++,r=l[1],l=[0];continue;case 7:l=i.ops.pop(),i.trys.pop();continue;default:if(!(o=0<(o=i.trys).length&&o[o.length-1])&&(6===l[0]||2===l[0])){i=0;continue}if(3===l[0]&&(!o||l[1]>o[0]&&l[1]<o[3])){i.label=l[1];break}if(6===l[0]&&i.label<o[1]){i.label=o[1],o=l;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(l);break}o[2]&&i.ops.pop(),i.trys.pop();continue}l=n.call(e,i)}catch(h){l=[6,h],r=0}finally{t=o=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([u,c])}}}var Dl=(yn.prototype.setPlatform=function(e,n){null!=this.platform&&console.warn("Platform "+this.platformName+" has already been set. Overwriting the platform with "+n+"."),this.platformName=e,this.platform=n},yn.prototype.registerFlag=function(e,n,t){if(this.flagRegistry[e]={evaluationFn:n,setHook:t},null!=this.urlFlags[e]){var r=this.urlFlags[e];console.warn("Setting feature override from URL "+e+": "+r+"."),this.set(e,r)}},yn.prototype.get=function(e){return e in this.flags||(this.flags[e]=this.evaluateFlag(e)),this.flags[e]},yn.prototype.getNumber=function(e){return this.get(e)},yn.prototype.getBool=function(e){return this.get(e)},yn.prototype.getFlags=function(){return this.flags},Object.defineProperty(yn.prototype,"features",{get:function(){return this.flags},enumerable:!0,configurable:!0}),yn.prototype.set=function(e,n){if(null==this.flagRegistry[e])throw new Error("Cannot set flag "+e+" as it has not been registered.");this.flags[e]=n,null!=this.flagRegistry[e].setHook&&this.flagRegistry[e].setHook(n)},yn.prototype.evaluateFlag=function(e){if(null==this.flagRegistry[e])throw new Error("Cannot evaluate flag '"+e+"': no evaluation function found.");return this.flagRegistry[e].evaluationFn()},yn.prototype.setFlags=function(e){this.flags=Object.assign({},e)},yn.prototype.reset=function(){this.flags={},this.urlFlags={},this.populateURLFlags()},yn.prototype.populateURLFlags=function(){var e=this;if(void 0!==this.global&&void 0!==this.global.location&&void 0!==this.global.location.search){var t,r=(t={},this.global.location.search.replace(/[?&]([^=?&]+)(?:=([^&]*))?/g,function(o){for(var a=[],i=1;i<arguments.length;i++)a[i-1]=arguments[i];return c=a[1],t[decodeURIComponent(a[0])]=decodeURIComponent(c||""),a.join("=");var c}),t);"tfjsflags"in r&&r.tfjsflags.split(",").forEach(function(o){var a=o.split(":"),i=a[0];e.urlFlags[i]=function(u,c){if("true"===(c=c.toLowerCase())||"false"===c)return"true"===c;if(""+ +c===c)return+c;throw new Error("Could not parse value flag value "+c+" for flag "+u+".")}(i,a[1])})}},yn);function yn(e){this.global=e,this.flags={},this.flagRegistry={},this.urlFlags={},this.populateURLFlags()}function q(){return Ji}var Ji=null,Tr=new Map,po=new Map;function Qi(e,n){var t=ns(e,n);return Tr.get(t)}function Al(e){return po.get(e)}function Zi(e){for(var n=Tr.entries(),t=[];;){var r=n.next(),a=r.value;if(r.done)break;var s=a[1];a[0].split("_")[0]===e&&t.push(s)}return t}function es(e){var n=e.kernelName,t=e.backendName,r=ns(n,t);if(Tr.has(r))throw new Error("The kernel '"+n+"' for backend '"+t+"' is already registered");Tr.set(r,e)}function Tl(e){var n=e.kernelName;po.has(n)&&console.warn("Overriding the gradient for '"+n+"'"),po.set(n,e)}function ns(e,n){return n+"_"+e}function Nl(e){for(var n=e.length,t=0,r=0;0<n;)r=Math.random()*n|0,t=e[--n],e[n]=e[r],e[r]=t}function la(e,n,t){return Math.max(e,Math.min(n,t))}function ts(e){return e%2==0?e:e+1}function Fl(e){for(var n=0,t=0;t<e.length;t++)n+=e[t];return n}function S(e,n){if(!e)throw new Error("string"==typeof n?n:n())}function we(e,n,t){void 0===t&&(t=""),S(Le(e,n),function(){return t+" Shapes "+e+" and "+n+" must match"})}function rr(e){S(null!=e,function(){return"The input to the tensor constructor must be a non-null value."})}function st(e,n,t){if(void 0===n&&(n=[]),void 0===t&&(t=!1),null==n&&(n=[]),Array.isArray(e)||Ze(e)&&!t)for(var r=0;r<e.length;++r)st(e[r],n,t);else n.push(e);return n}function ie(e){if(0===e.length)return 1;for(var n=e[0],t=1;t<e.length;t++)n*=e[t];return n}function Le(e,n){if(e===n)return!0;if(null==e||null==n||e.length!==n.length)return!1;for(var t=0;t<e.length;t++)if(e[t]!==n[t])return!1;return!0}function Me(e){return e%1==0}function Ml(e){if(null!=Math.tanh)return Math.tanh(e);if(e===1/0)return 1;if(e===-1/0)return-1;var n=Math.exp(2*e);return(n-1)/(n+1)}function ha(e){var n=Math.ceil(Math.sqrt(e));return[n,Math.ceil(e/n)]}function or(e,n){return n<=e.length?e:e+" ".repeat(n-e.length)}function rs(e,n,t){return void 0===n&&(n=function(r){return 0}),new Promise(function(r,o){var a=0,i=function(){if(e())r();else{var s=n(++a);null!=t&&t<=a?o():setTimeout(i,s)}};i()})}function Ol(e,n){for(var t=1,r=-1,o=0;o<e.length;++o)if(0<=e[o])t*=e[o];else if(-1===e[o]){if(-1!==r)throw Error("Shapes can only have 1 implicit size. Found -1 at dim "+r+" and dim "+o);r=o}else if(e[o]<0)throw Error("Shapes can not be < 0. Found "+e[o]+" at dim "+o);if(-1===r){if(0<n&&n!==t)throw Error("Size("+n+") must match the product of shape "+e);return e}if(0===t)throw Error("Cannot infer the missing size in ["+e+"] when there are 0 elements");if(n%t!=0)throw Error("The implicit shape can't be a fractional number. Got "+n+" / "+t);var a=e.slice();return a[r]=n/t,a}function We(e,n){var t=n.length;return S((e=null==e?n.map(function(r,o){return o}):[].concat(e)).every(function(r){return-t<=r&&r<t}),function(){return"All values in axis param must be in range [-"+t+", "+t+") but got axis "+e}),S(e.every(function(r){return Me(r)}),function(){return"All values in axis param must be integers but got axis "+e}),e.map(function(r){return r<0?t+r:r})}function At(e,n){for(var t=[],r=[],o=null!=n&&Array.isArray(n)&&0===n.length,a=null==n||o?null:We(n,e).sort(),i=0,s=0;s<e.length;++s){if(null!=a){if(a[i]===s&&1!==e[s])throw new Error("Can't squeeze axis "+s+" since its dim '"+e[s]+"' is not 1");(null==a[i]||a[i]>s)&&1===e[s]&&(t.push(e[s]),r.push(s)),a[i]<=s&&i++}1!==e[s]&&(t.push(e[s]),r.push(s))}return{newShape:t,keptDims:r}}function Nr(e,n){var t=null;if(null==e||"float32"===e)t=new Float32Array(n);else if("int32"===e)t=new Int32Array(n);else{if("bool"!==e)throw new Error("Unknown data type "+e);t=new Uint8Array(n)}return t}function vo(e,n){var t=null;if(null==e||"float32"===e)t=new Float32Array(n);else if("int32"===e)t=new Int32Array(n);else if("bool"===e)t=new Uint8Array(n);else{if("string"!==e)throw new Error("Unknown data type "+e);t=new Array(n)}return t}function Pl(e,n){for(var t=0;t<e.length;t++){var r=e[t];if(isNaN(r)||!isFinite(r))throw Error("A tensor of type "+n+" being uploaded contains "+r+".")}}function Bl(e){return"bool"===e||"complex64"===e||"float32"===e||"int32"===e||"string"===e}function Ll(e,n){return!("complex64"===n||"float32"===n&&"complex64"!==e||"int32"===n&&"float32"!==e&&"complex64"!==e||"bool"===n&&"bool"===e)}function Ze(e){return e instanceof Float32Array||e instanceof Int32Array||e instanceof Uint8Array}function os(e){if("float32"===e||"int32"===e)return 4;if("complex64"===e)return 8;if("bool"===e)return 1;throw new Error("Unknown dtype "+e)}function Wl(e){if(null==e)return 0;var n=0;return e.forEach(function(t){return n+=t.length}),n}function Tt(e){return"string"==typeof e||e instanceof String}function zl(e){return"boolean"==typeof e}function Ul(e){return"number"==typeof e}function Fr(e){return Array.isArray(e)?Fr(e[0]):e instanceof Float32Array?"float32":e instanceof Int32Array||e instanceof Uint8Array?"int32":Ul(e)?"float32":Tt(e)?"string":zl(e)?"bool":"float32"}function Nt(e){return!!(e&&e.constructor&&e.call&&e.apply)}function fa(e,n){for(var t=n;t<e;++t)if(e%t==0)return t;return e}function Fn(e){var n=e.length;if(n<2)return[];var t=new Array(n-1);t[n-2]=e[n-1];for(var r=n-3;0<=r;--r)t[r]=t[r+1]*e[r+1];return t}function as(e,n,t){if("string"===n)throw new Error("Cannot convert a string[] to a TypedArray");if(Array.isArray(e)&&(e=st(e)),t&&Pl(e,n),e instanceof Float32Array&&"float32"===n||e instanceof Int32Array&&"int32"===n||e instanceof Uint8Array&&"bool"===n)return e;if(null==n||"float32"===n||"complex64"===n)return new Float32Array(e);if("int32"===n)return new Int32Array(e);if("bool"!==n)throw new Error("Unknown data type "+n);for(var r=new Uint8Array(e.length),o=0;o<r.length;++o)0!==Math.round(e[o])&&(r[o]=1);return r}function is(e,n){if(0===e.length)return n[0];var t=e.reduce(function(r,o){return r*o});if(0===t)return[];if(t!==n.length)throw new Error("["+e+"] does not match the input size.");return function r(o,a,i){var s=new Array;if(1===a.length)for(var u=a[0],c=0;c<u;c++)s[c]=i[o+c];else{u=a[0];var l=a.slice(1),h=l.reduce(function(f,p){return f*p});for(c=0;c<u;c++)s[c]=r(o+c*h,l,i)}return s}(0,e,n)}function ss(e,n){for(var t=Mr(e,n),r=0;r<t.length;r++)t[r]=1;return t}function Mr(e,n){if(null==n||"float32"===n||"complex64"===n)return new Float32Array(e);if("int32"===n)return new Int32Array(e);if("bool"===n)return new Uint8Array(e);throw new Error("Unknown data type "+n)}function Mn(){return q().platform.now()}function us(e){e.forEach(function(n){S(Number.isInteger(n)&&0<=n,function(){return"Tensor must have a shape comprised of positive integers but got shape ["+e+"]."})})}function Vl(e,n){return void 0===n&&(n="utf-8"),n=n||"utf-8",q().platform.encode(e,n)}function mo(e,n){return void 0===n&&(n="utf-8"),n=n||"utf-8",q().platform.decode(e,n)}function cs(e,n,t){if(0===n)return 0;if(1===n)return e[0];for(var r=e[e.length-1],o=0;o<e.length-1;++o)r+=t[o]*e[o];return r}function Gl(e,n,t){if(0===n)return[];if(1===n)return[e];for(var r=new Array(n),o=0;o<r.length-1;++o)r[o]=Math.floor(e/t[o]),e-=r[o]*t[o];return r[r.length-1]=e,r}var Bg=Object.freeze({shuffle:Nl,clamp:la,nearestLargerEven:ts,sum:Fl,randUniform:function(e,n){var t=Math.random();return n*t+(1-t)*e},distSquared:function(e,n){for(var t=0,r=0;r<e.length;r++){var o=Number(e[r])-Number(n[r]);t+=o*o}return t},assert:S,assertShapesMatch:we,assertNonNull:rr,flatten:st,sizeFromShape:ie,isScalarShape:function(e){return 0===e.length},arraysEqual:Le,isInt:Me,tanh:Ml,sizeToSquarishShape:ha,createShuffledIndices:function(e){for(var n=new Uint32Array(e),t=0;t<e;++t)n[t]=t;return Nl(n),n},rightPad:or,repeatedTry:rs,inferFromImplicitShape:Ol,parseAxisParam:We,squeezeShape:At,getTypedArrayFromDType:Nr,getArrayFromDType:vo,checkConversionForErrors:Pl,isValidDtype:Bl,hasEncodingLoss:Ll,isTypedArray:Ze,bytesPerElement:os,bytesFromStringArray:Wl,isString:Tt,isBoolean:zl,isNumber:Ul,inferDtype:Fr,isFunction:Nt,nearestDivisor:fa,computeStrides:Fn,toTypedArray:as,toNestedArray:is,makeOnesTypedArray:ss,makeZerosTypedArray:Mr,now:Mn,assertNonNegativeIntegerDimensions:us,fetch:function(e,n){return q().platform.fetch(e,n)},encodeString:Vl,decodeString:mo,locToIndex:cs,indexToLoc:Gl}),Lg=(Hl.prototype.profileKernel=function(e,n,t){var r,o=this,a=this.backendTimer.time(function(){r=t()});return r.forEach(function(i){i.data().then(function(s){(function(u,c,l){if("float32"===c)for(var h=0;h<u.length;h++){var f=u[h];if(isNaN(f)||!isFinite(f))return console.warn("Found "+f+" in the result of '"+l+"'")}})(s,i.dtype,e),a.then(function(u){var c="";null!=u.getExtraProfileInfo&&(c=u.getExtraProfileInfo()),o.logger.logKernelProfile(e,i,s,u.kernelMs,n,c)})})}),r},Hl);function Hl(e,n){this.backendTimer=e,null==(this.logger=n)&&(this.logger=new Wg)}var Wg=(ql.prototype.logKernelProfile=function(e,n,t,r,o,a){var i="number"==typeof r?or(r+"ms",9):r.error,s=or(e,25),u=n.rank,c=n.size,l=or(n.shape.toString(),14),h="";for(var f in o){var p=o[f].shape||n.shape,d=p.length;h+=f+": "+d+"D "+(0<d?p:"")+" "}console.log("%c"+s+"\t%c"+i+"\t%c"+u+"D "+l+"\t%c"+c+"\t%c"+h+"\t%c"+a,"font-weight:bold","color:red","color:blue","color: orange","color: green","color: steelblue")},ql);function ql(){}function go(e,n,t){return or(Array.isArray(e)?parseFloat(e[0].toFixed(7))+" + "+parseFloat(e[1].toFixed(7))+"j":Tt(e)?"'"+e+"'":"bool"===t?jl(e):parseFloat(e.toFixed(7)).toString(),n)}function jl(e){return 0===e?"false":"true"}function yo(e){for(var n=[],t=0;t<e.length;t+=2)n.push([e[t],e[t+1]]);return n}var Or=(ar.prototype.set=function(e){for(var n=this,t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];0===t.length&&(t=[0]),S(t.length===this.rank,function(){return"The number of provided coordinates ("+t.length+") must match the rank ("+n.rank+")"});var o=this.locToIndex(t);this.values[o]=e},ar.prototype.get=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];0===e.length&&(e=[0]);for(var t=0,r=0,o=e;r<o.length;r++){var a=o[r];if(a<0||a>=this.shape[t])throw new Error("Requested out of range element at "+e+".   Buffer shape="+this.shape);t++}for(var s=e[e.length-1],u=0;u<e.length-1;++u)s+=this.strides[u]*e[u];return this.values[s]},ar.prototype.locToIndex=function(e){if(0===this.rank)return 0;if(1===this.rank)return e[0];for(var n=e[e.length-1],t=0;t<e.length-1;++t)n+=this.strides[t]*e[t];return n},ar.prototype.indexToLoc=function(e){if(0===this.rank)return[];if(1===this.rank)return[e];for(var n=new Array(this.shape.length),t=0;t<n.length-1;++t)n[t]=Math.floor(e/this.strides[t]),e-=n[t]*this.strides[t];return n[n.length-1]=e,n},Object.defineProperty(ar.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),ar.prototype.toTensor=function(){return qn().makeTensor(this.values,this.shape,this.dtype)},ar),qn=null,G=null,Kl=null;function ar(e,n,t){var r=this;if(this.dtype=n,this.shape=e.slice(),this.size=ie(e),null!=t){var o=t.length;S(o===this.size,function(){return"Length of values '"+o+"' does not match the size inferred by the shape '"+r.size+"'."})}if("complex64"===n)throw new Error("complex64 dtype TensorBuffers are not supported. Please create a TensorBuffer for the real and imaginary parts separately and call tf.complex(real, imag).");this.values=t||vo(n,this.size),this.strides=Fn(e)}var Re=(L.prototype.flatten=function(){return this.throwIfDisposed(),this.as1D()},L.prototype.asScalar=function(){return this.throwIfDisposed(),S(1===this.size,function(){return"The array must have only 1 element."}),this.reshape([])},L.prototype.as1D=function(){return this.throwIfDisposed(),this.reshape([this.size])},L.prototype.as2D=function(e,n){return this.throwIfDisposed(),this.reshape([e,n])},L.prototype.as3D=function(e,n,t){return this.throwIfDisposed(),this.reshape([e,n,t])},L.prototype.as4D=function(e,n,t,r){return this.throwIfDisposed(),this.reshape([e,n,t,r])},L.prototype.as5D=function(e,n,t,r,o){return this.throwIfDisposed(),this.reshape([e,n,t,r,o])},L.prototype.asType=function(e){return this.throwIfDisposed(),G.cast(this,e)},Object.defineProperty(L.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),L.prototype.buffer=function(){return oe(this,void 0,void 0,function(){var e;return ae(this,function(n){switch(n.label){case 0:return[4,this.data()];case 1:return e=n.sent(),[2,G.buffer(this.shape,this.dtype,e)]}})})},L.prototype.bufferSync=function(){return G.buffer(this.shape,this.dtype,this.dataSync())},L.prototype.array=function(){return oe(this,void 0,void 0,function(){var e;return ae(this,function(n){switch(n.label){case 0:return[4,this.data()];case 1:return e=n.sent(),[2,is(this.shape,e)]}})})},L.prototype.arraySync=function(){return is(this.shape,this.dataSync())},L.prototype.data=function(){return oe(this,void 0,void 0,function(){var e,n;return ae(this,function(t){switch(t.label){case 0:return this.throwIfDisposed(),e=qn().read(this.dataId),"string"!==this.dtype?[3,2]:[4,e];case 1:n=t.sent();try{return[2,n.map(function(r){return mo(r)})]}catch{throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}t.label=2;case 2:return[2,e]}})})},L.prototype.dataSync=function(){this.throwIfDisposed();var e=qn().readSync(this.dataId);if("string"===this.dtype)try{return e.map(function(n){return mo(n)})}catch{throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}return e},L.prototype.bytes=function(){return oe(this,void 0,void 0,function(){var e;return ae(this,function(n){switch(n.label){case 0:return this.throwIfDisposed(),[4,qn().read(this.dataId)];case 1:return e=n.sent(),"string"===this.dtype?[2,e]:[2,new Uint8Array(e.buffer)]}})})},L.prototype.dispose=function(){this.isDisposed||(qn().disposeTensor(this),this.isDisposedInternal=!0)},Object.defineProperty(L.prototype,"isDisposed",{get:function(){return this.isDisposedInternal},enumerable:!0,configurable:!0}),L.prototype.throwIfDisposed=function(){if(this.isDisposed)throw new Error("Tensor is disposed.")},L.prototype.toFloat=function(){return this.asType("float32")},L.prototype.toInt=function(){return this.asType("int32")},L.prototype.toBool=function(){return this.asType("bool")},L.prototype.print=function(e){return void 0===e&&(e=!1),G.print(this,e)},L.prototype.reshape=function(e){return this.throwIfDisposed(),G.reshape(this,e)},L.prototype.reshapeAs=function(e){return this.throwIfDisposed(),this.reshape(e.shape)},L.prototype.expandDims=function(e){return void 0===e&&(e=0),G.expandDims(this,e)},L.prototype.cumsum=function(e,n,t){return void 0===e&&(e=0),void 0===n&&(n=!1),void 0===t&&(t=!1),G.cumsum(this,e,n,t)},L.prototype.squeeze=function(e){return this.throwIfDisposed(),G.squeeze(this,e)},L.prototype.clone=function(){return this.throwIfDisposed(),G.clone(this)},L.prototype.oneHot=function(e,n,t){return this.throwIfDisposed(),G.oneHot(this,e,n,t)},L.prototype.toString=function(e){return void 0===e&&(e=!1),n=this.dataSync(),r=this.dtype,o=e,a=Fn(t=this.shape),i=function(l,h,f,p){var d=ie(h),g=p[p.length-1],v=new Array(g).fill(0),m=h.length,y="complex64"===f?yo(l):l;if(1<m)for(var x=0;x<d/g;x++)for(var w=x*g,b=0;b<g;b++)v[b]=Math.max(v[b],go(y[w+b],0,f).length);return v}(n,t,r,a),s=t.length,u=function l(h,f,p,d,g,v){void 0===v&&(v=!0);var m="complex64"===p?2:1,y=f[0],x=f.length;if(0===x)return"complex64"===p?[go(yo(h)[0],0,p)]:"bool"===p?[jl(h[0])]:[h[0].toString()];if(1===x){if(20<y){var b=Array.from(h.slice(0,3*m)),I=Array.from(h.slice((y-3)*m,y*m));return"complex64"===p&&(b=yo(b),I=yo(I)),["["+b.map(function(F,z){return go(F,g[z],p)}).join(", ")+", ..., "+I.map(function(F,z){return go(F,g[y-3+z],p)}).join(", ")+"]"]}return["["+("complex64"===p?yo(h):Array.from(h)).map(function(F,z){return go(F,g[z],p)}).join(", ")+"]"]}var E=f.slice(1),C=d.slice(1),R=d[0]*m,k=[];if(20<y){for(var D=0;D<3;D++){var N=(M=D*R)+R;k.push.apply(k,l(h.slice(M,N),E,p,C,g,!1))}for(k.push("..."),D=y-3;D<y;D++)N=(M=D*R)+R,k.push.apply(k,l(h.slice(M,N),E,p,C,g,D===y-1))}else for(D=0;D<y;D++){var M;N=(M=D*R)+R,k.push.apply(k,l(h.slice(M,N),E,p,C,g,D===y-1))}var W=2===x?",":"";for(k[0]="["+k[0]+W,D=1;D<k.length-1;D++)k[D]=" "+k[D]+W;var P=",\n";for(D=2;D<x;D++)P+="\n";return k[k.length-1]=" "+k[k.length-1]+"]"+(v?"":P),k}(n,t,r,a,i),c=["Tensor"],o&&(c.push("  dtype: "+r),c.push("  rank: "+s),c.push("  shape: ["+t+"]"),c.push("  values:")),c.push(u.map(function(l){return"    "+l}).join("\n")),c.join("\n");var n,t,r,o,a,i,s,u,c},L.prototype.tile=function(e){return this.throwIfDisposed(),G.tile(this,e)},L.prototype.gather=function(e,n){return void 0===n&&(n=0),this.throwIfDisposed(),G.gather(this,e,n)},L.prototype.matMul=function(e,n,t){return void 0===n&&(n=!1),void 0===t&&(t=!1),this.throwIfDisposed(),G.matMul(this,e,n,t)},L.prototype.dot=function(e){return this.throwIfDisposed(),G.dot(this,e)},L.prototype.norm=function(e,n,t){return void 0===e&&(e="euclidean"),void 0===n&&(n=null),void 0===t&&(t=!1),this.throwIfDisposed(),G.norm(this,e,n,t)},L.prototype.slice=function(e,n){return this.throwIfDisposed(),G.slice(this,e,n)},L.prototype.reverse=function(e){return this.throwIfDisposed(),G.reverse(this,e)},L.prototype.concat=function(e,n){return void 0===n&&(n=0),this.throwIfDisposed(),e instanceof L&&(e=[e]),G.concat([this].concat(e),n)},L.prototype.split=function(e,n){return void 0===n&&(n=0),this.throwIfDisposed(),G.split(this,e,n)},L.prototype.stack=function(e,n){return void 0===n&&(n=0),G.stack([this,e],n)},L.prototype.unstack=function(e){return void 0===e&&(e=0),G.unstack(this,e)},L.prototype.pad=function(e,n){return void 0===n&&(n=0),G.pad(this,e,n)},L.prototype.batchNormalization=function(e,n,t,r,o){return void 0===t&&(t=.001),Kl("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon"),this.batchNorm(e,n,o,r,t)},L.prototype.batchNorm=function(e,n,t,r,o){return void 0===o&&(o=.001),this.throwIfDisposed(),G.batchNorm(this,e,n,t,r,o)},L.prototype.all=function(e,n){return void 0===e&&(e=null),void 0===n&&(n=!1),this.throwIfDisposed(),G.all(this,e,n)},L.prototype.any=function(e,n){return void 0===e&&(e=null),void 0===n&&(n=!1),this.throwIfDisposed(),G.any(this,e,n)},L.prototype.logSumExp=function(e,n){return void 0===e&&(e=null),void 0===n&&(n=!1),this.throwIfDisposed(),G.logSumExp(this,e,n)},L.prototype.sum=function(e,n){return void 0===e&&(e=null),void 0===n&&(n=!1),this.throwIfDisposed(),G.sum(this,e,n)},L.prototype.prod=function(e,n){return void 0===e&&(e=null),void 0===n&&(n=!1),this.throwIfDisposed(),G.prod(this,e,n)},L.prototype.mean=function(e,n){return void 0===e&&(e=null),void 0===n&&(n=!1),this.throwIfDisposed(),G.mean(this,e,n)},L.prototype.min=function(e,n){return void 0===e&&(e=null),void 0===n&&(n=!1),this.throwIfDisposed(),G.min(this,e,n)},L.prototype.max=function(e,n){return void 0===e&&(e=null),void 0===n&&(n=!1),this.throwIfDisposed(),G.max(this,e,n)},L.prototype.argMin=function(e){return void 0===e&&(e=null),this.throwIfDisposed(),G.argMin(this,e)},L.prototype.argMax=function(e){return void 0===e&&(e=null),this.throwIfDisposed(),G.argMax(this,e)},L.prototype.cast=function(e){return this.throwIfDisposed(),G.cast(this,e)},L.prototype.add=function(e){return this.throwIfDisposed(),G.add(this,e)},L.prototype.addStrict=function(e){return this.throwIfDisposed(),G.addStrict(this,e)},L.prototype.atan2=function(e){return this.throwIfDisposed(),G.atan2(this,e)},L.prototype.sub=function(e){return this.throwIfDisposed(),G.sub(this,e)},L.prototype.subStrict=function(e){return this.throwIfDisposed(),G.subStrict(this,e)},L.prototype.pow=function(e){return this.throwIfDisposed(),G.pow(this,e)},L.prototype.powStrict=function(e){return this.throwIfDisposed(),G.powStrict(this,e)},L.prototype.mul=function(e){return this.throwIfDisposed(),G.mul(this,e)},L.prototype.mulStrict=function(e){return this.throwIfDisposed(),G.mulStrict(this,e)},L.prototype.div=function(e){return this.throwIfDisposed(),G.div(this,e)},L.prototype.divNoNan=function(e){return this.throwIfDisposed(),G.divNoNan(this,e)},L.prototype.floorDiv=function(e){return this.throwIfDisposed(),G.floorDiv(this,e)},L.prototype.divStrict=function(e){return this.throwIfDisposed(),G.divStrict(this,e)},L.prototype.minimum=function(e){return this.throwIfDisposed(),G.minimum(this,e)},L.prototype.minimumStrict=function(e){return this.throwIfDisposed(),G.minimumStrict(this,e)},L.prototype.maximum=function(e){return this.throwIfDisposed(),G.maximum(this,e)},L.prototype.maximumStrict=function(e){return this.throwIfDisposed(),G.maximumStrict(this,e)},L.prototype.mod=function(e){return this.throwIfDisposed(),G.mod(this,e)},L.prototype.modStrict=function(e){return this.throwIfDisposed(),G.modStrict(this,e)},L.prototype.squaredDifferenceStrict=function(e){return this.throwIfDisposed(),G.squaredDifferenceStrict(this,e)},L.prototype.transpose=function(e){return this.throwIfDisposed(),G.transpose(this,e)},L.prototype.notEqual=function(e){return this.throwIfDisposed(),G.notEqual(this,e)},L.prototype.notEqualStrict=function(e){return this.throwIfDisposed(),G.notEqualStrict(this,e)},L.prototype.less=function(e){return this.throwIfDisposed(),G.less(this,e)},L.prototype.lessStrict=function(e){return this.throwIfDisposed(),G.lessStrict(this,e)},L.prototype.equal=function(e){return this.throwIfDisposed(),G.equal(this,e)},L.prototype.equalStrict=function(e){return this.throwIfDisposed(),G.equalStrict(this,e)},L.prototype.lessEqual=function(e){return this.throwIfDisposed(),G.lessEqual(this,e)},L.prototype.lessEqualStrict=function(e){return this.throwIfDisposed(),G.lessEqualStrict(this,e)},L.prototype.greater=function(e){return this.throwIfDisposed(),G.greater(this,e)},L.prototype.greaterStrict=function(e){return this.throwIfDisposed(),G.greaterStrict(this,e)},L.prototype.greaterEqual=function(e){return this.throwIfDisposed(),G.greaterEqual(this,e)},L.prototype.greaterEqualStrict=function(e){return this.throwIfDisposed(),G.greaterEqualStrict(this,e)},L.prototype.logicalAnd=function(e){return this.throwIfDisposed(),G.logicalAnd(this,e)},L.prototype.logicalOr=function(e){return this.throwIfDisposed(),G.logicalOr(this,e)},L.prototype.logicalNot=function(){return this.throwIfDisposed(),G.logicalNot(this)},L.prototype.logicalXor=function(e){return this.throwIfDisposed(),G.logicalXor(this,e)},L.prototype.where=function(e,n){return this.throwIfDisposed(),G.where(e,this,n)},L.prototype.neg=function(){return this.throwIfDisposed(),G.neg(this)},L.prototype.ceil=function(){return this.throwIfDisposed(),G.ceil(this)},L.prototype.floor=function(){return this.throwIfDisposed(),G.floor(this)},L.prototype.sign=function(){return this.throwIfDisposed(),G.sign(this)},L.prototype.isNaN=function(){return this.throwIfDisposed(),G.isNaN(this)},L.prototype.isInf=function(){return this.throwIfDisposed(),G.isInf(this)},L.prototype.isFinite=function(){return this.throwIfDisposed(),G.isFinite(this)},L.prototype.exp=function(){return this.throwIfDisposed(),G.exp(this)},L.prototype.expm1=function(){return this.throwIfDisposed(),G.expm1(this)},L.prototype.log=function(){return this.throwIfDisposed(),G.log(this)},L.prototype.log1p=function(){return this.throwIfDisposed(),G.log1p(this)},L.prototype.sqrt=function(){return this.throwIfDisposed(),G.sqrt(this)},L.prototype.rsqrt=function(){return this.throwIfDisposed(),G.rsqrt(this)},L.prototype.square=function(){return this.throwIfDisposed(),G.square(this)},L.prototype.reciprocal=function(){return this.throwIfDisposed(),G.reciprocal(this)},L.prototype.abs=function(){return this.throwIfDisposed(),G.abs(this)},L.prototype.clipByValue=function(e,n){return this.throwIfDisposed(),G.clipByValue(this,e,n)},L.prototype.relu=function(){return this.throwIfDisposed(),G.relu(this)},L.prototype.relu6=function(){return this.throwIfDisposed(),G.relu6(this)},L.prototype.elu=function(){return this.throwIfDisposed(),G.elu(this)},L.prototype.selu=function(){return this.throwIfDisposed(),G.selu(this)},L.prototype.leakyRelu=function(e){return void 0===e&&(e=.2),this.throwIfDisposed(),G.leakyRelu(this,e)},L.prototype.prelu=function(e){return this.throwIfDisposed(),G.prelu(this,e)},L.prototype.sigmoid=function(){return this.throwIfDisposed(),G.sigmoid(this)},L.prototype.logSigmoid=function(){return this.throwIfDisposed(),G.logSigmoid(this)},L.prototype.softplus=function(){return this.throwIfDisposed(),G.softplus(this)},L.prototype.zerosLike=function(){return this.throwIfDisposed(),G.zerosLike(this)},L.prototype.onesLike=function(){return this.throwIfDisposed(),G.onesLike(this)},L.prototype.sin=function(){return this.throwIfDisposed(),G.sin(this)},L.prototype.cos=function(){return this.throwIfDisposed(),G.cos(this)},L.prototype.tan=function(){return this.throwIfDisposed(),G.tan(this)},L.prototype.asin=function(){return this.throwIfDisposed(),G.asin(this)},L.prototype.acos=function(){return this.throwIfDisposed(),G.acos(this)},L.prototype.atan=function(){return this.throwIfDisposed(),G.atan(this)},L.prototype.sinh=function(){return this.throwIfDisposed(),G.sinh(this)},L.prototype.cosh=function(){return this.throwIfDisposed(),G.cosh(this)},L.prototype.tanh=function(){return this.throwIfDisposed(),G.tanh(this)},L.prototype.asinh=function(){return this.throwIfDisposed(),G.asinh(this)},L.prototype.acosh=function(){return this.throwIfDisposed(),G.acosh(this)},L.prototype.atanh=function(){return this.throwIfDisposed(),G.atanh(this)},L.prototype.erf=function(){return this.throwIfDisposed(),G.erf(this)},L.prototype.round=function(){return this.throwIfDisposed(),G.round(this)},L.prototype.step=function(e){return void 0===e&&(e=0),this.throwIfDisposed(),G.step(this,e)},L.prototype.softmax=function(e){return void 0===e&&(e=-1),this.throwIfDisposed(),G.softmax(this,e)},L.prototype.logSoftmax=function(e){return void 0===e&&(e=-1),this.throwIfDisposed(),G.logSoftmax(this,e)},L.prototype.resizeBilinear=function(e,n){return void 0===n&&(n=!1),this.throwIfDisposed(),G.image.resizeBilinear(this,e,n)},L.prototype.resizeNearestNeighbor=function(e,n){return void 0===n&&(n=!1),this.throwIfDisposed(),G.image.resizeNearestNeighbor(this,e,n)},L.prototype.conv1d=function(e,n,t,r,o,a){return void 0===r&&(r="NWC"),void 0===o&&(o=1),this.throwIfDisposed(),G.conv1d(this,e,n,t,r,o,a)},L.prototype.conv2d=function(e,n,t,r,o,a){return void 0===r&&(r="NHWC"),void 0===o&&(o=[1,1]),this.throwIfDisposed(),G.conv2d(this,e,n,t,r,o,a)},L.prototype.conv2dTranspose=function(e,n,t,r,o){return this.throwIfDisposed(),G.conv2dTranspose(this,e,n,t,r,o)},L.prototype.depthwiseConv2D=function(e,n,t,r,o,a){return void 0===r&&(r="NHWC"),void 0===o&&(o=[1,1]),this.throwIfDisposed(),G.depthwiseConv2d(this,e,n,t,r,o,a)},L.prototype.separableConv2d=function(e,n,t,r,o,a){return void 0===o&&(o=[1,1]),void 0===a&&(a="NHWC"),this.throwIfDisposed(),G.separableConv2d(this,e,n,t,r,o,a)},L.prototype.avgPool=function(e,n,t,r){return this.throwIfDisposed(),G.avgPool(this,e,n,t,r)},L.prototype.maxPool=function(e,n,t,r){return this.throwIfDisposed(),G.maxPool(this,e,n,t,r)},L.prototype.localResponseNormalization=function(e,n,t,r){return void 0===e&&(e=5),void 0===n&&(n=1),void 0===t&&(t=1),void 0===r&&(r=.5),G.localResponseNormalization(this,e,n,t,r)},L.prototype.pool=function(e,n,t,r,o){return this.throwIfDisposed(),G.pool(this,e,n,t,r,o)},L.prototype.variable=function(e,n,t){return void 0===e&&(e=!0),this.throwIfDisposed(),qn().makeVariable(this,e,n,t)},L.prototype.unsortedSegmentSum=function(e,n){return this.throwIfDisposed(),G.unsortedSegmentSum(this,e,n)},L.prototype.batchToSpaceND=function(e,n){return this.throwIfDisposed(),G.batchToSpaceND(this,e,n)},L.prototype.spaceToBatchND=function(e,n){return this.throwIfDisposed(),G.spaceToBatchND(this,e,n)},L.prototype.topk=function(e,n){return void 0===e&&(e=1),void 0===n&&(n=!0),this.throwIfDisposed(),G.topk(this,e,n)},L.prototype.stridedSlice=function(e,n,t,r,o,a,i,s){return void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===i&&(i=0),void 0===s&&(s=0),this.throwIfDisposed(),G.stridedSlice(this,e,n,t,r,o,a,i,s)},L.prototype.depthToSpace=function(e,n){return this.throwIfDisposed(),G.depthToSpace(this,e,n)},L.prototype.fft=function(){return this.throwIfDisposed(),G.spectral.fft(this)},L.prototype.ifft=function(){return this.throwIfDisposed(),G.spectral.ifft(this)},L.prototype.rfft=function(){return this.throwIfDisposed(),G.spectral.rfft(this)},L.prototype.irfft=function(){return this.throwIfDisposed(),G.spectral.irfft(this)},L);function L(e,n,t,r){this.kept=!1,this.isDisposedInternal=!1,this.shape=e.slice(),this.dtype=n||"float32",this.size=ie(e),this.strides=Fn(e),this.dataId=t,this.id=r,this.rankType=this.rank<5?this.rank.toString():"higher"}Object.defineProperty(Re,Symbol.hasInstance,{value:function(e){return!!e&&null!=e.dataId&&null!=e.shape&&null!=e.dtype}});var hs,fs,ps,ds,vs,Xl,pa,da,va,ma,ir,sr=(Nn(ga,Xl=Re),ga.prototype.assign=function(e){if(e.dtype!==this.dtype)throw new Error("dtype of the new value ("+e.dtype+") and previous value ("+this.dtype+") must match");if(!Le(e.shape,this.shape))throw new Error("shape of the new value ("+e.shape+") and previous value ("+this.shape+") must match");qn().disposeTensor(this),this.dataId=e.dataId,qn().incRef(this,null)},ga.prototype.dispose=function(){qn().disposeVariable(this),this.isDisposedInternal=!0},ga);function ga(e,n,t,r){var o=Xl.call(this,e.shape,e.dtype,e.dataId,r)||this;return o.trainable=n,o.name=t,o}Object.defineProperty(sr,Symbol.hasInstance,{value:function(e){return e instanceof Re&&null!=e.assign&&e.assign instanceof Function}}),(ir=hs=hs||{}).R0="R0",ir.R1="R1",ir.R2="R2",ir.R3="R3",ir.R4="R4",ir.R5="R5",ir.R6="R6",(ma=fs=fs||{}).float32="float32",ma.int32="int32",ma.bool="int32",ma.complex64="complex64",(va=ps=ps||{}).float32="float32",va.int32="int32",va.bool="bool",va.complex64="complex64",(da=ds=ds||{}).float32="float32",da.int32="float32",da.bool="float32",da.complex64="complex64",(pa=vs=vs||{}).float32="complex64",pa.int32="complex64",pa.bool="complex64",pa.complex64="complex64";var zg={float32:ds,int32:fs,bool:ps,complex64:vs};function Ye(e,n){if("string"!==e&&"string"!==n)return zg[e][n];if("string"===e&&"string"===n)return"string";throw new Error("Can not upcast "+e+" with "+n)}function ya(e){return Ye(e,"int32")}function Ne(e,n){if(e.dtype===n.dtype)return[e,n];var t=Ye(e.dtype,n.dtype);return[e.cast(t),n.cast(t)]}function Yl(e,n){S(e.dtype===n.dtype,function(){return"The dtypes of the first("+e.dtype+") and second("+n.dtype+") input must match"})}function ms(e){var n=[];return function t(r,o,a){if(null!=r)if(r instanceof Re)o.push(r);else if(i=r,Array.isArray(i)||"object"==typeof i){var i,s=r;for(var u in s){var c=s[u];a.has(c)||(a.add(c),t(c,o,a))}}}(e,n,new Set),n}var gs,Ug=Object.freeze({makeTypesMatch:Ne,assertTypesMatch:Yl,isTensorInList:function(e,n){return n.some(function(t){return t.id===e.id})},getTensorsInContainer:ms}),$l=(Jl.prototype.dispose=function(){for(var e in this.registeredVariables)this.registeredVariables[e].dispose()},Jl),Vg=(se.prototype.ready=function(){return oe(this,void 0,void 0,function(){var e,n,t;return ae(this,function(r){switch(r.label){case 0:if(null!=this.pendingBackendInit)return[2,this.pendingBackendInit.then(function(){})];if(null!=this.backendInstance)return[2];e=this.getSortedBackends(),n=0,r.label=1;case 1:return n<e.length?[4,this.initializeBackend(t=e[n]).success]:[3,5];case 2:return r.sent()?[4,this.setBackend(t)]:[3,4];case 3:return r.sent(),[2];case 4:return n++,[3,1];case 5:throw new Error("Could not initialize any backends, all backend initializations failed.")}})})},Object.defineProperty(se.prototype,"backend",{get:function(){if(null!=this.pendingBackendInit)throw new Error("Backend '"+this.backendName+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");if(null==this.backendInstance){var e=this.initializeBackendsAndReturnBest(),n=e.name;if(e.asyncInit)throw new Error("The highest priority backend '"+n+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");this.setBackend(n)}return this.backendInstance},enumerable:!0,configurable:!0}),se.prototype.backendNames=function(){return Object.keys(this.registryFactory)},se.prototype.findBackend=function(e){return e in this.registry||e in this.registryFactory&&!this.initializeBackend(e).asyncInit?this.registry[e]:null},se.prototype.findBackendFactory=function(e){return e in this.registryFactory?this.registryFactory[e].factory:null},se.prototype.registerBackend=function(e,n,t){return void 0===t&&(t=1),e in this.registryFactory?(console.warn(e+" backend was already registered. Reusing existing backend factory."),!1):(this.registryFactory[e]={factory:n,priority:t},!0)},se.prototype.setBackend=function(e){return oe(this,void 0,void 0,function(){var n,t,r;return ae(this,function(o){switch(o.label){case 0:if(null==this.registryFactory[e])throw new Error("Backend name '"+e+"' not found in registry");return this.backendName=e,null!=this.registry[e]?[3,4]:(this.backendInstance=null,n=this.initializeBackend(e),t=n.success,n.asyncInit?[4,t]:[3,2]);case 1:return r=o.sent(),[3,3];case 2:r=t,o.label=3;case 3:if(!r)return[2,!1];o.label=4;case 4:return this.backendInstance=this.registry[e],this.setupRegisteredKernels(),this.profiler=new Lg(this.backendInstance),[2,!0]}})})},se.prototype.setupRegisteredKernels=function(){var e=this;Zi(this.backendName).forEach(function(n){null!=n.setupFunc&&n.setupFunc(e.backendInstance)})},se.prototype.disposeRegisteredKernels=function(e){var n=this;Zi(e).forEach(function(t){null!=t.disposeFunc&&t.disposeFunc(n.registry[e])})},se.prototype.initializeBackend=function(e){var n=this,t=this.registryFactory[e];if(null==t)throw new Error("Cannot initialize backend "+e+", no registration found.");try{var r=t.factory();if(Promise.resolve(r)!==r)return this.registry[e]=r,{success:!0,asyncInit:!1};var o=++this.pendingBackendInitId,a=r.then(function(i){return!(o<n.pendingBackendInitId||(n.registry[e]=i,n.pendingBackendInit=null))}).catch(function(i){return!(o<n.pendingBackendInitId||(n.pendingBackendInit=null,console.warn("Initialization of backend "+e+" failed"),console.warn(i.stack||i.message),1))});return{success:this.pendingBackendInit=a,asyncInit:!0}}catch(i){return console.warn("Initialization of backend "+e+" failed"),console.warn(i.stack||i.message),{success:!1,asyncInit:!1}}},se.prototype.removeBackend=function(e){if(!(e in this.registryFactory))throw new Error(e+" backend not found in registry");this.backendName===e&&null!=this.pendingBackendInit&&this.pendingBackendInitId++,e in this.registry&&(this.disposeRegisteredKernels(e),this.registry[e].dispose(),delete this.registry[e]),delete this.registryFactory[e],this.backendName===e&&(this.pendingBackendInit=null,this.backendName=null,this.backendInstance=null)},se.prototype.getSortedBackends=function(){var e=this;if(0===Object.keys(this.registryFactory).length)throw new Error("No backend found in registry.");return Object.keys(this.registryFactory).sort(function(n,t){return e.registryFactory[t].priority-e.registryFactory[n].priority})},se.prototype.initializeBackendsAndReturnBest=function(){for(var e=this.getSortedBackends(),n=0;n<e.length;n++){var t=e[n],r=this.initializeBackend(t),a=r.asyncInit;if(a||r.success)return{name:t,asyncInit:a}}throw new Error("Could not initialize any backends, all backend initializations failed.")},se.prototype.moveData=function(e,n){var t=this.state.tensorInfo.get(n),r=t.backend,o=this.readSync(n);r.disposeData(n),(t.backend=e).move(n,o,t.shape,t.dtype),this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack[this.state.numDataMovesStack.length-1]++},se.prototype.tidy=function(e,n){var t,r=this,o=null;if(null==n){if("function"!=typeof e)throw new Error("Please provide a function to tidy()");n=e}else{if("string"!=typeof e&&!(e instanceof String))throw new Error("When calling with two arguments, the first argument to tidy() must be a string");if("function"!=typeof n)throw new Error("When calling with two arguments, the 2nd argument to tidy() must be a function");o=e}return this.scopedRun(function(){return r.startScope(o)},function(){return r.endScope(t)},function(){return(t=n())instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),t})},se.prototype.scopedRun=function(e,n,t){e();try{var r=t();return n(),r}catch(o){throw n(),o}},se.prototype.nextTensorId=function(){return se.nextTensorId++},se.prototype.nextVariableId=function(){return se.nextVariableId++},se.prototype.clone=function(e){var n=this.makeTensorFromDataId(e.dataId,e.shape,e.dtype);return this.addTapeNode(this.state.activeScope.name,{x:e},[n],function(r){return{x:function(){return r.toFloat()}}},[]),n},se.prototype.runKernel=function(e,n,t,r,o){return this.runKernelFunc(null,n,null,e,t,r,o)},se.prototype.shouldCheckForMemLeaks=function(){return this.ENV.getBool("IS_TEST")},se.prototype.checkKernelForMemLeak=function(e,n,t){var r=this.backend.numDataIds(),o=0;t.forEach(function(s){o+="complex64"===s.dtype?3:1});var i=r-n-o-this.state.numDataMovesStack[this.state.numDataMovesStack.length-1];if(0<i)throw new Error("Backend '"+this.backendName+"' has an internal memory leak ("+i+" data ids) after running '"+e+"'")},se.prototype.runKernelFunc=function(e,n,t,r,o,a,i){var s,u=this;void 0===a&&(a=[]),void 0===i&&(i=[]);var c=[],l=this.isTapeOn();function h(m){l&&(c=m.map(function(y){return u.keep(u.clone(y))}))}null==r&&(r=null!=this.state.activeScope?this.state.activeScope.name:"");var f,p=this.state.numBytes,d=this.state.numTensors;this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack.push(0);var g,v=Qi(r,this.backendName);return f=null!=v?function(){var m=u.backend.numDataIds();g=v.kernelFunc({inputs:n,attrs:o,backend:u.backend});var y=Array.isArray(g)?g:[g];u.shouldCheckForMemLeaks()&&u.checkKernelForMemLeak(r,m,y);var x=y.map(function(b){return u.makeTensorFromDataId(b.dataId,b.shape,b.dtype)}),w=x.filter(function(b,I){return i[I]});return h((a||[]).slice().concat(w)),x}:function(){var m=u.backend.numDataIds();g=u.tidy(function(){return e(u.backend,h)});var y=Array.isArray(g)?g:[g];return u.shouldCheckForMemLeaks()&&u.checkKernelForMemLeak(r,m,y),y},this.scopedRun(function(){return u.state.kernelDepth++},function(){return u.state.kernelDepth--},function(){s=u.ENV.getBool("DEBUG")?u.profiler.profileKernel(r,n,function(){return f()}):f()}),l&&this.addTapeNode(r,n,s,t,c),this.state.profiling&&this.state.activeProfile.kernels.push({name:r,bytesAdded:this.state.numBytes-p,totalBytesSnapshot:this.state.numBytes,tensorsAdded:this.state.numTensors-d,totalTensorsSnapshot:this.state.numTensors,inputShapes:Object.keys(n).map(function(m){return n[m].shape}),outputShapes:s.map(function(m){return m.shape})}),Array.isArray(g)?s:s[0]},se.prototype.makeTensor=function(e,n,t,r){if(null==e)throw new Error("Values passed to engine.makeTensor() are null");r=r||this.backend;var o=e;"string"===(t=t||"float32")&&Tt(e[0])&&(o=e.map(function(c){return Vl(c)}));var a=r.write(o,n,t),i=new Re(n,t,a,this.nextTensorId());if(this.incRef(i,r),"string"===t){var s=this.state.tensorInfo.get(a),u=Wl(o);this.state.numBytes+=u-s.bytes,s.bytes=u}return i},se.prototype.makeTensorFromDataId=function(e,n,t,r){var o=new Re(n,t=t||"float32",e,this.nextTensorId());return this.incRef(o,r),o},se.prototype.makeVariable=function(e,n,t,r){void 0===n&&(n=!0),t=t||this.nextVariableId().toString(),null!=r&&r!==e.dtype&&(e=e.asType(r));var o=new sr(e,n,t,this.nextTensorId());if(null!=this.state.registeredVariables[o.name])throw new Error("Variable with name "+o.name+" was already registered");return this.state.registeredVariables[o.name]=o,this.incRef(o,this.backend),o},se.prototype.incRef=function(e,n){var t=this.state.tensorInfo.has(e.dataId)?this.state.tensorInfo.get(e.dataId).refCount:0;if(this.state.numTensors++,"string"===e.dtype&&this.state.numStringTensors++,0===t){this.state.numDataBuffers++;var r=0;"complex64"!==e.dtype&&"string"!==e.dtype&&(r=e.size*os(e.dtype)),this.state.tensorInfo.set(e.dataId,{backend:n||this.backend,dtype:e.dtype,shape:e.shape,bytes:r,refCount:0}),this.state.numBytes+=r}this.state.tensorInfo.get(e.dataId).refCount++,e instanceof sr||this.track(e)},se.prototype.disposeTensor=function(e){if(this.state.tensorInfo.has(e.dataId)){this.state.numTensors--,"string"===e.dtype&&this.state.numStringTensors--;var n=this.state.tensorInfo.get(e.dataId);n.refCount<=1?("complex64"!==e.dtype&&(this.state.numBytes-=n.bytes),this.state.numDataBuffers--,n.backend.disposeData(e.dataId),this.state.tensorInfo.delete(e.dataId)):this.state.tensorInfo.get(e.dataId).refCount--}},se.prototype.disposeVariables=function(){for(var e in this.state.registeredVariables)this.disposeVariable(this.state.registeredVariables[e])},se.prototype.disposeVariable=function(e){this.disposeTensor(e),null!=this.state.registeredVariables[e.name]&&delete this.state.registeredVariables[e.name]},se.prototype.memory=function(){var e=this.backend.memory();return e.numTensors=this.state.numTensors,e.numDataBuffers=this.state.numDataBuffers,e.numBytes=this.state.numBytes,0<this.state.numStringTensors&&(e.unreliable=!0,null==e.reasons&&(e.reasons=[]),e.reasons.push("Memory usage by string tensors is approximate (2 bytes per character)")),e},se.prototype.profile=function(e){return oe(this,void 0,void 0,function(){var n,t;return ae(this,function(r){return this.state.profiling=!0,n=this.state.numBytes,t=this.state.numTensors,this.state.activeProfile.kernels=[],this.state.activeProfile.result=e(),this.state.profiling=!1,this.state.activeProfile.peakBytes=Math.max.apply(Math,this.state.activeProfile.kernels.map(function(o){return o.totalBytesSnapshot})),this.state.activeProfile.newBytes=this.state.numBytes-n,this.state.activeProfile.newTensors=this.state.numTensors-t,[2,this.state.activeProfile]})})},se.prototype.isTapeOn=function(){return 0<this.state.gradientDepth&&0===this.state.kernelDepth},se.prototype.addTapeNode=function(e,n,t,r,o){var a=this,i={id:this.state.nextTapeNodeId++,kernelName:e,inputs:n,outputs:t,saved:o},s=Al(e);null!=s&&(r=s.gradFunc),null!=r&&(i.gradient=function(u){return u=u.map(function(c,l){if(null!=c)return c;var h=t[l],f=Mr(h.size,h.dtype);return a.makeTensor(f,h.shape,h.dtype)}),r(1<u.length?u:u[0],o)}),this.state.activeTape.push(i)},se.prototype.keep=function(e){return e.kept=!0,e},se.prototype.startTape=function(){0===this.state.gradientDepth&&(this.state.activeTape=[]),this.state.gradientDepth++},se.prototype.endTape=function(){this.state.gradientDepth--},se.prototype.startScope=function(e){var n={track:[],name:"unnamed scope",id:this.state.nextScopeId++};e&&(n.name=e),this.state.scopeStack.push(n),this.state.activeScope=n},se.prototype.endScope=function(e){for(var n=this,t=ms(e),r=new Set(t.map(function(s){return s.id})),o=0;o<this.state.activeScope.track.length;o++){var a=this.state.activeScope.track[o];a.kept||r.has(a.id)||a.dispose()}var i=this.state.scopeStack.pop();this.state.activeScope=0===this.state.scopeStack.length?null:this.state.scopeStack[this.state.scopeStack.length-1],t.forEach(function(s){s.kept||s.scopeId!==i.id||n.track(s)})},se.prototype.gradients=function(e,n,t,r){var o=this;if(void 0===r&&(r=!1),S(0<n.length,function(){return"gradients() received an empty list of xs."}),null!=t&&"float32"!==t.dtype)throw new Error("dy must have 'float32' dtype, but has '"+t.dtype+"'");var a=this.scopedRun(function(){return o.startTape()},function(){return o.endTape()},function(){return o.tidy("forward",e)});S(a instanceof Re,function(){return"The result y returned by f() must be a tensor."});var i=function(s,u,c){for(var l={},h={},f=0;f<u.length;f++)l[u[f].id]=!0;for(f=0;f<s.length;f++){var p=(b=s[f]).inputs;for(var d in p){for(var g=p[d],v=!1,m=0;m<u.length;m++)if(l[g.id]){b.outputs.forEach(function(R){return l[R.id]=!0}),v=!0,h[b.id]=!0;break}if(v)break}}var y={};y[c.id]=!0;var x={};for(f=s.length-1;0<=f;f--)for(p=(b=s[f]).inputs,m=0;m<b.outputs.length;m++)if(y[b.outputs[m].id]){for(var d in p)y[p[d].id]=!0,x[b.id]=!0;break}var w=[];for(f=0;f<s.length;f++){var b;if(h[(b=s[f]).id]&&x[b.id]){var I={};for(var d in b.inputs){var E=b.inputs[d];l[E.id]&&(I[d]=E)}var C=Object.assign({},b);C.inputs=I,C.outputs=b.outputs,w.push(C)}}return w}(this.state.activeTape,n,a);if(!r&&0===i.length&&0<n.length)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that the f you passed encloses all operations that lead from x to y.");return this.tidy("backward",function(){var s,u,c={};c[a.id]=t??(u=ss(ie(s=a.shape),"float32"),A.makeTensor(u,s,"float32")),function(h,f){for(var p=function(g){var v=f[g],m=[];if(v.outputs.forEach(function(b){var I=h[b.id];m.push(null!=I?I:null)}),null==v.gradient)throw new Error("Cannot compute gradient: gradient function not found for "+v.kernelName+".");function y(b){if(!(b in x))throw new Error("Cannot backprop through input "+b+". Available gradients found: "+Object.keys(x)+".");var I=o.tidy(function(){return x[b]()});if("float32"!==I.dtype)throw new Error("Error in gradient for op "+v.kernelName+". The gradient of input "+b+" must have 'float32' dtype, but has '"+I.dtype+"'");var E=v.inputs[b];if(!Le(I.shape,E.shape))throw new Error("Error in gradient for op "+v.kernelName+". The gradient of input '"+b+"' has shape '"+I.shape+"', which does not match the shape of the input '"+E.shape+"'");if(null==h[E.id])h[E.id]=I;else{var C=h[E.id];h[E.id]=C.add(I),C.dispose()}}var x=v.gradient(m);for(var w in v.inputs)y(w)},d=f.length-1;0<=d;d--)p(d)}(c,i);var l=n.map(function(h){return c[h.id]});return 0===o.state.gradientDepth&&(o.state.activeTape.forEach(function(h){for(var f=0,p=h.saved;f<p.length;f++)p[f].dispose()}),o.state.activeTape=null),{value:a,grads:l}})},se.prototype.customGrad=function(e){var n=this;return S(Nt(e),function(){return"The f passed in customGrad(f) must be a function."}),function(){for(var t,r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];S(r.every(function(i){return i instanceof Re}),function(){return"The args passed in customGrad(f)(x1, x2,...) must all be tensors"});var a={};return r.forEach(function(i,s){a[s]=i}),n.runKernelFunc(function(i,s){return S((t=e.apply(void 0,r.concat([s]))).value instanceof Re,function(){return"The function f passed in customGrad(f) must return an object where `obj.value` is a tensor"}),S(Nt(t.gradFunc),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function."}),t.value},a,function(i,s){var u=t.gradFunc(i,s),c=Array.isArray(u)?u:[u];S(c.length===r.length,function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns the same number of tensors as inputs passed to f(...)."}),S(c.every(function(h){return h instanceof Re}),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns a list of only tensors."});var l={};return c.forEach(function(h,f){l[f]=function(){return h}}),l})}},se.prototype.readSync=function(e){return this.state.tensorInfo.get(e).backend.readSync(e)},se.prototype.read=function(e){return this.state.tensorInfo.get(e).backend.read(e)},se.prototype.time=function(e){return oe(this,void 0,void 0,function(){var n,t;return ae(this,function(r){switch(r.label){case 0:return n=Mn(),[4,this.backend.time(e)];case 1:return(t=r.sent()).wallMs=Mn()-n,[2,t]}})})},se.prototype.track=function(e){return null!=this.state.activeScope&&(e.scopeId=this.state.activeScope.id,this.state.activeScope.track.push(e)),e},Object.defineProperty(se.prototype,"registeredVariables",{get:function(){return this.state.registeredVariables},enumerable:!0,configurable:!0}),se.prototype.reset=function(){for(var e in this.pendingBackendInitId++,this.state.dispose(),this.ENV.reset(),this.state=new $l,this.registry)this.disposeRegisteredKernels(e),this.registry[e].dispose(),delete this.registry[e];this.backendName=null,this.backendInstance=null,this.pendingBackendInit=null},se.nextTensorId=0,se.nextVariableId=0,se);function se(e){this.ENV=e,this.registry={},this.registryFactory={},this.pendingBackendInitId=0,this.state=new $l}function Jl(){this.registeredVariables={},this.nextTapeNodeId=0,this.numBytes=0,this.numTensors=0,this.numStringTensors=0,this.numDataBuffers=0,this.gradientDepth=0,this.kernelDepth=0,this.scopeStack=[],this.numDataMovesStack=[],this.nextScopeId=0,this.tensorInfo=new WeakMap,this.profiling=!1,this.activeProfile={newBytes:0,newTensors:0,peakBytes:0,kernels:[],result:null}}var A=function(){var n=function(){if(null==gs){var r=void 0;if(typeof window<"u")r=window;else if(typeof global<"u")r=global;else if(typeof process<"u")r=process;else{if(typeof self>"u")throw new Error("Could not find a global object");r=self}gs=r}return gs}();if(null==n._tfengine){var t=new Dl(n);n._tfengine=new Vg(t)}return Ji=n._tfengine.ENV,qn=function(){return n._tfengine},n._tfengine}();function Ql(){return typeof window<"u"&&null!=window.document||typeof WorkerGlobalScope<"u"}var ut=q();ut.registerFlag("DEBUG",function(){return!1},function(e){e&&console.warn("Debugging mode is ON. The output of every math call will be downloaded to CPU and checked for NaNs. This significantly impacts performance.")}),ut.registerFlag("IS_BROWSER",function(){return Ql()}),ut.registerFlag("IS_NODE",function(){return typeof process<"u"&&void 0!==process.versions&&void 0!==process.versions.node}),ut.registerFlag("IS_CHROME",function(){return typeof navigator<"u"&&null!=navigator&&null!=navigator.userAgent&&/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)}),ut.registerFlag("PROD",function(){return!1}),ut.registerFlag("TENSORLIKE_CHECK_SHAPE_CONSISTENCY",function(){return ut.getBool("DEBUG")}),ut.registerFlag("DEPRECATION_WARNINGS_ENABLED",function(){return!0}),ut.registerFlag("IS_TEST",function(){return!1});var xo,xn,bn,jn,Ft,xa,ur={},ys={alpha:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,depth:!1,stencil:!1,failIfMajorPerformanceCaveat:!0};function Zl(e,n){ur[e]=n}function Kn(e){e in ur||(ur[e]=function(t){if(1!==t&&2!==t)throw new Error("Cannot get WebGL rendering context, WebGL is disabled.");var r=function(){if(typeof OffscreenCanvas<"u"&&2===t)return new OffscreenCanvas(300,150);if(typeof document<"u")return document.createElement("canvas");throw new Error("Cannot create a canvas in this context")}();return r.addEventListener("webglcontextlost",function(o){o.preventDefault(),delete ur[t]},!1),1===t?r.getContext("webgl",ys)||r.getContext("experimental-webgl",ys):r.getContext("webgl2",ys)}(e));var n=ur[e];return n.isContextLost()?(delete ur[e],Kn(e)):(n.disable(n.DEPTH_TEST),n.disable(n.STENCIL_TEST),n.disable(n.BLEND),n.disable(n.DITHER),n.disable(n.POLYGON_OFFSET_FILL),n.disable(n.SAMPLE_COVERAGE),n.enable(n.SCISSOR_TEST),n.enable(n.CULL_FACE),n.cullFace(n.BACK),ur[e])}function ba(e,n){return[n,e]}function bo(e){var n=ie(e);return ha(Math.ceil(n/4))}function wo(e,n){return[Math.max(1,Math.ceil(n/2)),Math.max(1,Math.ceil(e/2))]}function xs(e,n){var t,r,o,a,i,s,u,c,l,h=e;return l=2===q().getNumber("WEBGL_VERSION")?(t=h.R32F,r=h.R16F,o=h.RGBA16F,a=h.RGBA32F,i=h.RED,s=4,u=1,c=h.HALF_FLOAT,h.FLOAT):(t=e.RGBA,r=e.RGBA,o=e.RGBA,a=h.RGBA,i=e.RGBA,u=s=4,c=null!=n?n.HALF_FLOAT_OES:null,e.FLOAT),{internalFormatFloat:t,internalFormatHalfFloat:r,internalFormatPackedHalfFloat:o,internalFormatPackedFloat:a,textureFormatFloat:i,downloadTextureFormat:e.RGBA,downloadUnpackNumChannels:s,defaultNumChannels:u,textureTypeHalfFloat:c,textureTypeFloat:l}}function ee(e,n,t){var r=t();return n&&function(o){var a=o.getError();if(a!==o.NO_ERROR)throw new Error("WebGL Error: "+nh(o,a))}(e),r}function eh(e){return!!(q().getBool("WEBGL_RENDER_FLOAT32_ENABLED")||0===e||5.96e-8<Math.abs(e)&&Math.abs(e)<65504)}function nh(e,n){switch(n){case e.NO_ERROR:return"NO_ERROR";case e.INVALID_ENUM:return"INVALID_ENUM";case e.INVALID_VALUE:return"INVALID_VALUE";case e.INVALID_OPERATION:return"INVALID_OPERATION";case e.INVALID_FRAMEBUFFER_OPERATION:return"INVALID_FRAMEBUFFER_OPERATION";case e.OUT_OF_MEMORY:return"OUT_OF_MEMORY";case e.CONTEXT_LOST_WEBGL:return"CONTEXT_LOST_WEBGL";default:return"Unknown error code "+n}}function Co(e,n,t){return ct(e,n,function(){return e.getExtension(t)},'Extension "'+t+'" not supported on this browser.')}function th(e,n,t){var r=ct(e,n,function(){return e.createShader(e.VERTEX_SHADER)},"Unable to create vertex WebGLShader.");if(ee(e,n,function(){return e.shaderSource(r,t)}),ee(e,n,function(){return e.compileShader(r)}),!1===e.getShaderParameter(r,e.COMPILE_STATUS))throw console.log(e.getShaderInfoLog(r)),new Error("Failed to compile vertex shader.");return r}function rh(e,n,t){var r=ct(e,n,function(){return e.createShader(e.FRAGMENT_SHADER)},"Unable to create fragment WebGLShader.");if(ee(e,n,function(){return e.shaderSource(r,t)}),ee(e,n,function(){return e.compileShader(r)}),!1===e.getShaderParameter(r,e.COMPILE_STATUS))throw function(o,a){var i=Gg.exec(a);if(null==i)return console.log("Couldn't parse line number in error: "+a),console.log(o);for(var s=+i[1],u=o.split("\n"),c=u.length.toString().length+2,l=u.map(function(v,m){return or((m+1).toString(),c)+v}),h=0,f=0;f<l.length;f++)h=Math.max(l[f].length,h);var p=l.slice(0,s-1),d=l.slice(s-1,s),g=l.slice(s);console.log(p.join("\n")),console.log(a.split("\n")[0]),console.log("%c "+or(d[0],h),"border:1px solid red; background-color:#e3d2d2; color:#a61717"),console.log(g.join("\n"))}(t,e.getShaderInfoLog(r)),new Error("Failed to compile fragment shader.");return r}(xa=xo=xo||{})[xa.DENSE=0]="DENSE",xa[xa.SHARED_BATCH=1]="SHARED_BATCH",(Ft=xn=xn||{})[Ft.RENDER=0]="RENDER",Ft[Ft.UPLOAD=1]="UPLOAD",Ft[Ft.PIXELS=2]="PIXELS",Ft[Ft.DOWNLOAD=3]="DOWNLOAD",(jn=bn=bn||{})[jn.UNPACKED_FLOAT16=0]="UNPACKED_FLOAT16",jn[jn.UNPACKED_FLOAT32=1]="UNPACKED_FLOAT32",jn[jn.PACKED_4X1_UNSIGNED_BYTE=2]="PACKED_4X1_UNSIGNED_BYTE",jn[jn.PACKED_2X2_FLOAT32=3]="PACKED_2X2_FLOAT32",jn[jn.PACKED_2X2_FLOAT16=4]="PACKED_2X2_FLOAT16";var wa,Ca,Gg=/ERROR: [0-9]+:([0-9]+):/g;function oh(e,n){return ct(e,n,function(){return e.createProgram()},"Unable to create WebGLProgram.")}function ah(e,n,t){if(ee(e,n,function(){return e.linkProgram(t)}),!1===e.getProgramParameter(t,e.LINK_STATUS))throw console.log(e.getProgramInfoLog(t)),new Error("Failed to link vertex and fragment shaders.")}function Ea(e,n,t){if(ee(e,n,function(){return e.validateProgram(t)}),!1===e.getProgramParameter(t,e.VALIDATE_STATUS))throw console.log(e.getProgramInfoLog(t)),new Error("Shader program validation failed.")}function ih(e,n,t){var r=ct(e,n,function(){return e.createBuffer()},"Unable to create WebGLBuffer");return ee(e,n,function(){return e.bindBuffer(e.ARRAY_BUFFER,r)}),ee(e,n,function(){return e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW)}),r}function sh(e,n,t){var r=ct(e,n,function(){return e.createBuffer()},"Unable to create WebGLBuffer");return ee(e,n,function(){return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r)}),ee(e,n,function(){return e.bufferData(e.ELEMENT_ARRAY_BUFFER,t,e.STATIC_DRAW)}),r}function uh(e,n){return ct(e,n,function(){return e.createTexture()},"Unable to create WebGLTexture.")}function ch(e,n){var t=q().getNumber("WEBGL_MAX_TEXTURE_SIZE");if(e<=0||n<=0){var r="["+e+"x"+n+"]";throw new Error("Requested texture size "+r+" is invalid.")}if(t<e||t<n)throw r="["+e+"x"+n+"]",new Error("Requested texture size "+r+" greater than WebGL maximum on this browser / GPU ["+t+"x"+t+"].")}function lh(e,n){return ct(e,n,function(){return e.createFramebuffer()},"Unable to create WebGLFramebuffer.")}function bs(e,n,t,r,o,a,i,s){var u=e.getAttribLocation(t,r);return-1!==u&&(ee(e,n,function(){return e.bindBuffer(e.ARRAY_BUFFER,o)}),ee(e,n,function(){return e.vertexAttribPointer(u,a,e.FLOAT,!1,i,s)}),ee(e,n,function(){return e.enableVertexAttribArray(u)}),!0)}function hh(e,n,t,r){mh(e,r),ee(e,n,function(){return e.activeTexture(e.TEXTURE0+r)}),ee(e,n,function(){return e.bindTexture(e.TEXTURE_2D,t)})}function fh(e,n,t,r){return ct(e,n,function(){return e.getUniformLocation(t,r)},'uniform "'+r+'" not present in program.')}function ph(e,n,t){return e.getUniformLocation(n,t)}function dh(e,n,t,r,o,a){ee(e,n,function(){return hh(e,n,r,a)}),ee(e,n,function(){return e.uniform1i(o,a)})}function _a(e,n,t,r){ee(e,n,function(){return e.bindFramebuffer(e.FRAMEBUFFER,r)}),ee(e,n,function(){return e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0)})}function ws(e,n,t){ee(e,n,function(){return e.bindFramebuffer(e.FRAMEBUFFER,t)}),ee(e,n,function(){return e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,null,0)})}function Eo(e){var n=e.checkFramebufferStatus(e.FRAMEBUFFER);if(n!==e.FRAMEBUFFER_COMPLETE)throw new Error("Error binding framebuffer: "+vh(e,n))}function vh(e,n){switch(n){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case e.FRAMEBUFFER_UNSUPPORTED:return"FRAMEBUFFER_UNSUPPORTED";default:return"unknown error "+n}}function ct(e,n,t,r){var o=ee(e,n,function(){return t()});if(null==o)throw new Error(r);return o}function mh(e,n){var t=e.MAX_COMBINED_TEXTURE_IMAGE_UNITS-1,r=n+e.TEXTURE0;if(r<e.TEXTURE0||t<r)throw new Error("textureUnit must be in [gl.TEXTURE0, gl.TEXTURE"+t+"].")}function _o(e,n){return void 0===n&&(n=2),ie(e.slice(0,e.length-n))}function Io(e){if(0===e.length)throw Error("Cannot get rows and columns of an empty shape array.");return[1<e.length?e[e.length-2]:1,e[e.length-1]]}function Ia(e){var n=[1,1,1];return 0===e.length||1===e.length&&1===e[0]||(n=[_o(e)].concat(Io(e))),n}function gh(e,n){var t;void 0===n&&(n=!1);var r=q().getNumber("WEBGL_MAX_TEXTURE_SIZE");if(n&&(r*=2,1===(e=e.map(function(c,l){return l>=e.length-2?ts(e[l]):e[l]})).length&&(e=[2,e[0]])),2!==e.length){var o=At(e);e=o.newShape}var a=ie(e);if(e.length<=1&&a<=r)return[1,a];if(2===e.length&&e[0]<=r&&e[1]<=r)return e;if(3===e.length&&e[0]*e[1]<=r&&e[2]<=r)return[e[0]*e[1],e[2]];if(3===e.length&&e[0]<=r&&e[1]*e[2]<=r)return[e[0],e[1]*e[2]];if(4===e.length&&e[0]*e[1]*e[2]<=r&&e[3]<=r)return[e[0]*e[1]*e[2],e[3]];if(4===e.length&&e[0]<=r&&e[1]*e[2]*e[3]<=r)return[e[0],e[1]*e[2]*e[3]];if(n){var i=_o(e),s=2,u=2;return e.length&&(s=(t=Io(e))[0],u=t[1]),ha(a=i*(s/2)*(u/2)).map(function(c){return 2*c})}return ha(a)}function Ra(e){return e%2==0}function Ro(e,n){if(Le(e=e.slice(-2),n=n.slice(-2))||!e.length||!n.length||0===e[0]||0===e[1]||0===n[0]||0===n[1])return!0;if(e.length!==n.length){var t=e.slice(-1)[0],r=n.slice(-1)[0];if(t===r||Ra(t)&&Ra(r)&&(1===e[0]||1===n[0]))return!0}return e[1]===n[1]&&Ra(e[0])&&Ra(n[0])}function yh(e){if(null==wa){var n=Kn(e);wa=n.getParameter(n.MAX_TEXTURE_SIZE)}return wa}function xh(e){if(null==Ca){var n=Kn(e);Ca=n.getParameter(n.MAX_TEXTURE_IMAGE_UNITS)}return Math.min(16,Ca)}function bh(e){if(0===e)return 0;var n=Kn(e);return wn(n,"EXT_disjoint_timer_query_webgl2")&&2===e?2:wn(n,"EXT_disjoint_timer_query")?1:0}function wn(e,n){return null!=e.getExtension(n)}function Cs(e){try{if(null!=Kn(e))return!0}catch{return!1}return!1}function wh(e){if(0===e)return!1;var n=Kn(e);if(1===e){if(!wn(n,"OES_texture_float"))return!1}else if(!wn(n,"EXT_color_buffer_float"))return!1;return Es(n)}function Ch(e){if(0===e)return!1;var n=Kn(e);if(1===e)return!!wn(n,"OES_texture_float")&&!!wn(n,"WEBGL_color_buffer_float")&&Es(n);if(wn(n,"EXT_color_buffer_float"))return Es(n);if(wn(n,"EXT_color_buffer_half_float")){var t=n.getExtension("EXT_color_buffer_half_float");return function(r){var o=xs(r,t),a=r.createTexture();r.bindTexture(r.TEXTURE_2D,a),r.texImage2D(r.TEXTURE_2D,0,o.internalFormatHalfFloat,1,1,0,o.textureFormatFloat,o.textureTypeHalfFloat,null);var i=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,i),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,a,0);var s=r.checkFramebufferStatus(r.FRAMEBUFFER)===r.FRAMEBUFFER_COMPLETE;return r.bindTexture(r.TEXTURE_2D,null),r.bindFramebuffer(r.FRAMEBUFFER,null),r.deleteTexture(a),r.deleteFramebuffer(i),s}(n)}return!1}function Es(e){var n=xs(e),t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,n.internalFormatFloat,1,1,0,n.textureFormatFloat,n.textureTypeFloat,null);var r=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,r),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0);var o=e.checkFramebufferStatus(e.FRAMEBUFFER)===e.FRAMEBUFFER_COMPLETE;return e.bindTexture(e.TEXTURE_2D,null),e.bindFramebuffer(e.FRAMEBUFFER,null),e.deleteTexture(t),e.deleteFramebuffer(r),o}function Eh(e){return 2===e&&null!=Kn(e).fenceSync}var Hg=Object.freeze({callAndCheck:ee,canBeRepresented:eh,getWebGLErrorMessage:nh,getExtensionOrThrow:Co,createVertexShader:th,createFragmentShader:rh,createProgram:oh,linkProgram:ah,validateProgram:Ea,createStaticVertexBuffer:ih,createStaticIndexBuffer:sh,getNumChannels:function(){return 2===q().getNumber("WEBGL_VERSION")?1:4},createTexture:uh,validateTextureSize:ch,createFramebuffer:lh,bindVertexBufferToProgramAttribute:bs,bindTextureUnit:hh,unbindTextureUnit:function(e,n,t){mh(e,t),ee(e,n,function(){return e.activeTexture(e.TEXTURE0+t)}),ee(e,n,function(){return e.bindTexture(e.TEXTURE_2D,null)})},getProgramUniformLocationOrThrow:fh,getProgramUniformLocation:ph,bindTextureToProgramUniformSampler:dh,bindCanvasToFramebuffer:function(e,n){ee(e,n,function(){return e.bindFramebuffer(e.FRAMEBUFFER,null)}),ee(e,n,function(){return e.viewport(0,0,e.canvas.width,e.canvas.height)}),ee(e,n,function(){return e.scissor(0,0,e.canvas.width,e.canvas.height)})},bindColorTextureToFramebuffer:_a,unbindColorTextureFromFramebuffer:ws,validateFramebuffer:Eo,getFramebufferErrorMessage:vh,getBatchDim:_o,getRowsCols:Io,getShapeAs3D:Ia,getTextureShapeFromLogicalShape:gh,isReshapeFree:Ro,getWebGLMaxTextureSize:yh,resetMaxTextureSize:function(){wa=null},resetMaxTexturesInShader:function(){Ca=null},getMaxTexturesInShader:xh,getWebGLDisjointQueryTimerVersion:bh,hasExtension:wn,isWebGLVersionEnabled:Cs,isCapableOfRenderingToFloatTexture:wh,isDownloadFloatTextureEnabled:Ch,isWebGLFenceEnabled:Eh}),le=q();function _s(e){q().getBool("DEPRECATION_WARNINGS_ENABLED")&&console.warn(e+" You can disable deprecation warnings with tf.disableDeprecationWarnings().")}function Q(e,n){return A.tidy(e,n)}function un(e){ms(e).forEach(function(n){return n.dispose()})}function _h(e){return A.keep(e)}function ka(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];q().getBool("IS_TEST")||console.warn.apply(console,e)}function Xn(e,n){var t=e;if(Ze(e))return"string"===n?[]:[e.length];if(!Array.isArray(e))return[];for(var r=[];Array.isArray(t)||Ze(t)&&"string"!==n;)r.push(t.length),t=t[0];return Array.isArray(e)&&q().getBool("TENSORLIKE_CHECK_SHAPE_CONSISTENCY")&&function o(a,i,s){if(s=s||[],Array.isArray(a)||Ze(a)){S(0<i.length,function(){return"Element arr["+s.join("][")+"] should be a primitive, but is an array of "+a.length+" elements"}),S(a.length===i[0],function(){return"Element arr["+s.join("][")+"] should have "+i[0]+" elements, but has "+a.length+" elements"});for(var u=i.slice(1),c=0;c<a.length;++c)o(a[c],u,s.concat(c))}else S(0===i.length,function(){return"Element arr["+s.join("][")+"] is a primitive, but should be an array/TypedArray of "+i[0]+" elements"})}(e,r,[]),r}function Ih(e,n,t,r){if(null!=e&&("numeric"!==e&&e!==n||"numeric"===e&&"string"===n))throw new Error("Argument '"+t+"' passed to '"+r+"' must be "+e+" tensor, but got "+n+" tensor")}function _(e,n,t,r){if(void 0===r&&(r="numeric"),e instanceof Re)return Ih(r,e.dtype,n,t),e;var o=Fr(e);if("string"!==o&&0<=["bool","int32","float32"].indexOf(r)&&(o=r),Ih(r,o,n,t),null==e||!Ze(e)&&!Array.isArray(e)&&"number"!=typeof e&&"boolean"!=typeof e&&"string"!=typeof e)throw new Error("Argument '"+n+"' passed to '"+t+"' must be a Tensor or TensorLike, but got '"+(null==e?"null":e.constructor.name)+"'");var i=Xn(e,o);Ze(e)||Array.isArray(e)||(e=[e]);var s="string"!==o?as(e,o,q().getBool("DEBUG")):st(e,[],!0);return A.makeTensor(s,i,o)}function ko(e,n,t,r){if(void 0===r&&(r="numeric"),!Array.isArray(e))throw new Error("Argument "+n+" passed to "+t+" must be a `Tensor[]` or `TensorLike[]`");return e.map(function(o,a){return _(o,n+"["+a+"]",t)},r)}function Is(e,n){for(var t=0;t<e.length;++t)if(e[e.length-t-1]!==n-1-t)return!1;return!0}function Rh(e,n,t){for(var r=e.length+n.length,o=[],a=0,i=0,s=0;s<r;s++)-1===t.indexOf(s)?o.push(e[a++]):o.push(n[i++]);return o}function en(e,n){for(var t=[],r=e.length,o=0;o<r;o++)-1===n.indexOf(o)&&t.push(e[o]);return[t,n.map(function(a){return e[a]})]}function cn(e,n){return Rh(e,n.map(function(t){return 1}),n)}function pn(e,n,t){S(Is(n,t),function(){return e+" supports only inner-most axes for now. Got axes "+n+" and rank-"+t+" input."})}function On(e,n){if(Is(e,n))return null;for(var t=[],r=0;r<n;++r)-1===e.indexOf(r)&&t.push(r);return e.forEach(function(o){return t.push(o)}),t}function Sa(e){return e.map(function(n,t){return[t,n]}).sort(function(n,t){return n[1]-t[1]}).map(function(n){return n[0]})}function Pn(e,n){for(var t=[],r=n-e;r<n;++r)t.push(r);return t}function kh(e,n){var t=e[0].length;e.forEach(function(o,a){S(o.length===t,function(){return"Error in concat"+t+"D: rank of tensors["+a+"] must be the same as the rank of the rest ("+t+")"})}),S(0<=n&&n<t,function(){return"Error in concat"+t+"D: axis must be between 0 and "+(t-1)+"."});var r=e[0];e.forEach(function(o,a){for(var i=0;i<t;i++)S(i===n||o[i]===r[i],function(){return"Error in concat"+t+"D: Shape of tensors["+a+"] ("+o+") does not match the shape of the rest ("+r+") along the non-concatenated axis "+a+"."})})}function cr(e,n){for(var t=e[0].slice(),r=1;r<e.length;r++)t[n]+=e[r][n];return t}function T(e){var n=Object.keys(e);if(1!==n.length)throw new Error("Please provide an object with a single key (operation name) mapping to a function. Got an object with "+n.length+" keys.");var t=n[0],r=e[t];function o(){for(var a=[],i=0;i<arguments.length;i++)a[i]=arguments[i];A.startScope(t);try{var s=r.apply(void 0,a);return s instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),A.endScope(s),s}catch(u){throw A.endScope(null),u}}return t.endsWith("_")&&(t=t.substring(0,t.length-1)),Object.defineProperty(o,"name",{value:t,configurable:!0}),o}le.registerFlag("HAS_WEBGL",function(){return 0<le.getNumber("WEBGL_VERSION")}),le.registerFlag("WEBGL_VERSION",function(){return Cs(2)?2:Cs(1)?1:0}),le.registerFlag("WEBGL_BUFFER_SUPPORTED",function(){return 2===le.get("WEBGL_VERSION")}),le.registerFlag("WEBGL_CPU_FORWARD",function(){return!0}),le.registerFlag("WEBGL_FORCE_F16_TEXTURES",function(){return!1}),le.registerFlag("WEBGL_PACK",function(){return le.getBool("HAS_WEBGL")}),le.registerFlag("WEBGL_PACK_NORMALIZATION",function(){return le.getBool("WEBGL_PACK")}),le.registerFlag("WEBGL_PACK_CLIP",function(){return le.getBool("WEBGL_PACK")}),le.registerFlag("WEBGL_PACK_DEPTHWISECONV",function(){return!1}),le.registerFlag("WEBGL_PACK_BINARY_OPERATIONS",function(){return le.getBool("WEBGL_PACK")}),le.registerFlag("WEBGL_PACK_UNARY_OPERATIONS",function(){return le.getBool("WEBGL_PACK")}),le.registerFlag("WEBGL_PACK_ARRAY_OPERATIONS",function(){return le.getBool("WEBGL_PACK")}),le.registerFlag("WEBGL_PACK_IMAGE_OPERATIONS",function(){return le.getBool("WEBGL_PACK")}),le.registerFlag("WEBGL_PACK_REDUCE",function(){return le.getBool("WEBGL_PACK")}),le.registerFlag("WEBGL_LAZILY_UNPACK",function(){return le.getBool("WEBGL_PACK")}),le.registerFlag("WEBGL_CONV_IM2COL",function(){return le.getBool("WEBGL_PACK")}),le.registerFlag("WEBGL_MAX_TEXTURE_SIZE",function(){return yh(le.getNumber("WEBGL_VERSION"))}),le.registerFlag("WEBGL_MAX_TEXTURES_IN_SHADER",function(){return xh(le.getNumber("WEBGL_VERSION"))}),le.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION",function(){var e=le.getNumber("WEBGL_VERSION");return 0===e?0:bh(e)}),le.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE",function(){return 0<le.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")&&(e=navigator.userAgent||navigator.vendor||window.opera,!(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))));var e}),le.registerFlag("WEBGL_RENDER_FLOAT32_CAPABLE",function(){return wh(le.getNumber("WEBGL_VERSION"))}),le.registerFlag("WEBGL_RENDER_FLOAT32_ENABLED",function(){return!le.getBool("WEBGL_FORCE_F16_TEXTURES")&&le.getBool("WEBGL_RENDER_FLOAT32_CAPABLE")}),le.registerFlag("WEBGL_DOWNLOAD_FLOAT_ENABLED",function(){return Ch(le.getNumber("WEBGL_VERSION"))}),le.registerFlag("WEBGL_FENCE_API_ENABLED",function(){return Eh(le.getNumber("WEBGL_VERSION"))}),le.registerFlag("WEBGL_SIZE_UPLOAD_UNIFORM",function(){return le.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?4:0}),Kl=_s;var $e=T({complex_:function(e,n){var t=_(e,"real","complex"),r=_(n,"imag","complex");return we(t.shape,r.shape,"real and imag shapes, "+t.shape+" and "+r.shape+", must match in call to tf.complex()."),A.runKernelFunc(function(o){return o.complex(t,r)},{$real:t,$imag:r})}}),Cn=T({real_:function(e){var n=_(e,"input","real");return A.runKernelFunc(function(t){return t.real(n)},{$input:n})}}),Bn=T({imag_:function(e){var n=_(e,"input","imag");return A.runKernelFunc(function(t){return t.imag(n)},{$input:n})}});function Je(e,n,t){return Mt(e,n,Xn(e,t),t)}function Mt(e,n,t,r){if(null==r&&(r=Fr(e)),"complex64"===r)throw new Error("Cannot construct a complex64 tensor directly. Please use tf.complex(real, imag).");if(!Ze(e)&&!Array.isArray(e)&&"number"!=typeof e&&"boolean"!=typeof e&&"string"!=typeof e)throw new Error("values passed to tensor(values) must be a number/boolean/string or an array of numbers/booleans/strings, or a TypedArray");if(null!=n){us(n);var o=ie(n),a=ie(t);S(o===a,function(){return"Based on the provided shape, ["+n+"], the tensor should have "+o+" values but has "+a});for(var i=0;i<t.length;++i){var u=i!==t.length-1||t[i]!==ie(n.slice(i));S(t[i]===n[i]||!u,function(){return"Error creating a new Tensor. Inferred shape ("+t+") does not match the provided shape ("+n+"). "})}}return Ze(e)||Array.isArray(e)||(e=[e]),n=n||t,e="string"!==r?as(e,r,q().getBool("DEBUG")):st(e,[],!0),A.makeTensor(e,n,r)}function $(e,n){if((Ze(e)&&"string"!==n||Array.isArray(e))&&"complex64"!==n)throw new Error("Error creating a new Scalar: value must be a primitive (number|boolean|string)");if("string"===n&&Ze(e)&&!(e instanceof Uint8Array))throw new Error("When making a scalar from encoded string, the value must be `Uint8Array`.");return Mt(e,[],[],n)}function Pe(e,n){rr(e);var t=Xn(e,n);if(1!==t.length)throw new Error("tensor1d() requires values to be a flat/TypedArray");return Mt(e,null,t,n)}function lt(e,n,t){if(rr(e),null!=n&&2!==n.length)throw new Error("tensor2d() requires shape to have two numbers");var r=Xn(e,t);if(2!==r.length&&1!==r.length)throw new Error("tensor2d() requires values to be number[][] or flat/TypedArray");if(1===r.length&&null==n)throw new Error("tensor2d() requires shape to be provided when `values` are a flat/TypedArray");return Mt(e,n,r,t)}function Da(e,n,t){if(rr(e),null!=n&&3!==n.length)throw new Error("tensor3d() requires shape to have three numbers");var r=Xn(e,t);if(3!==r.length&&1!==r.length)throw new Error("tensor3d() requires values to be number[][][] or flat/TypedArray");if(1===r.length&&null==n)throw new Error("tensor3d() requires shape to be provided when `values` are a flat array");return Mt(e,n,r,t)}function ln(e,n,t){if(rr(e),null!=n&&4!==n.length)throw new Error("tensor4d() requires shape to have four numbers");var r=Xn(e,t);if(4!==r.length&&1!==r.length)throw new Error("tensor4d() requires values to be number[][][][] or flat/TypedArray");if(1===r.length&&null==n)throw new Error("tensor4d() requires shape to be provided when `values` are a flat array");return Mt(e,n,r,t)}function Sh(e,n,t){if(rr(e),null!=n&&5!==n.length)throw new Error("tensor5d() requires shape to have five numbers");var r=Xn(e,t);if(5!==r.length&&1!==r.length)throw new Error("tensor5d() requires values to be number[][][][][] or flat/TypedArray");if(1===r.length&&null==n)throw new Error("tensor5d() requires shape to be provided when `values` are a flat array");return Mt(e,n,r,t)}function Dh(e,n,t){if(rr(e),null!=n&&6!==n.length)throw new Error("tensor6d() requires shape to have six numbers");var r=Xn(e,t);if(6!==r.length&&1!==r.length)throw new Error("tensor6d() requires values to be number[][][][][][] or flat/TypedArray");if(1===r.length&&null==n)throw new Error("tensor6d() requires shape to be provided when `values` are a flat array");return Mt(e,n=n||r,r,t)}function Ah(e,n,t,r){return void 0===n&&(n=!0),A.makeVariable(e,n,t,r)}function lr(e,n){if(void 0===n&&(n="float32"),"complex64"===n){var t=lr(e,"float32"),r=Se(e,"float32");return $e(t,r)}var o=ss(ie(e),n);return A.makeTensor(o,e,n)}function Se(e,n){if(void 0===n&&(n="float32"),"complex64"===n){var t=Se(e,"float32"),r=Se(e,"float32");return $e(t,r)}var o=Mr(ie(e),n);return A.makeTensor(o,e,n)}function Ln(e,n,t){return A.runKernelFunc(function(r){return r.fill(e,n,t)},{})}function Th(e,n,t){if(t<=0)throw new Error("The number of values should be positive.");return A.runKernelFunc(function(r){return r.linspace(e,n,t)},{})}function So(e,n,t,r){if(void 0===t&&(t=1),void 0===r&&(r="float32"),0===t)throw new Error("Cannot have a step of zero");if(e===n||e<n&&t<0||n<e&&1<t)return Se([0],r);var o=Mr(Math.abs(Math.ceil((n-e)/t)),r);n<e&&1===t&&(t=-1),o[0]=e;for(var a=1;a<o.length;a++)o[a]=o[a-1]+t;return Pe(o,r)}var Rs=T({onesLike_:function(e){var n=_(e,"x","onesLike");if("complex64"!==n.dtype)return A.runKernelFunc(function(o){return o.onesLike(n)},{$x:n},function(o,a){return{$x:function(){return xe(o)}}});var t=Rs(Cn(n)),r=xe(Bn(n));return $e(t,r)}}),xe=T({zerosLike_:function(e){var n=_(e,"x","zerosLike");return A.runKernelFunc(function(t){return t.zerosLike(n)},{$x:n},function(t,r){return{$x:function(){return xe(t)}}})}}),ze=T({concat_:function(e,n){void 0===n&&(n=0),S(1<=e.length,function(){return"Pass at least one tensor to concat"});var t=ko(e,"tensors","concat");"complex64"===t[0].dtype&&t.forEach(function(s){if("complex64"!==s.dtype)throw new Error("Cannot concatenate complex64 tensors with a tensor\n          with dtype "+s.dtype+". ")}),n=We(n,t[0].shape)[0];var r=cr(t.map(function(s){return s.shape}),n);if(0===ie(r))return Je([],r);if(1===(t=t.filter(function(s){return 0<s.size})).length)return t[0];var o=t.map(function(s){return s.shape});return kh(o,n),A.runKernelFunc(function(s){return s.concat(t,n)},t,function(s){var u=o.map(function(c){return c[n]});return Aa(s,u,n).map(function(c){return function(){return c}})},"Concat",{axis:n})}}),Nh=T({concat1d_:function(e){return ze(e,0)}}),Fh=T({concat2d_:function(e,n){return ze(e,n)}}),Mh=T({concat3d_:function(e,n){return ze(e,n)}}),Oh=T({concat4d_:function(e,n){return ze(e,n)}}),Aa=T({split_:function(e,n,t){void 0===t&&(t=0);var r,o=_(e,"x","split");return t=We(t,o.shape)[0],r="number"==typeof n?(S(o.shape[t]%n==0,function(){return"Number of splits must evenly divide the axis."}),new Array(n).fill(o.shape[t]/n)):(S(o.shape[t]===n.reduce(function(a,i){return a+i}),function(){return"The sum of sizes must match the size of the axis dimension."}),n),A.runKernelFunc(function(a){return a.split(o,r,t)},{$x:o},function(a){return{$x:function(){return ze(a,t)}}})}});function hr(e,n){return e(n={exports:{}},n.exports),n.exports}var qg=hr(function(e){!function(n,t){function r(i){var s,u=this,c=(s=4022871197,function(l){l=l.toString();for(var h=0;h<l.length;h++){var f=.02519603282416938*(s+=l.charCodeAt(h));f-=s=f>>>0,s=(f*=s)>>>0,s+=4294967296*(f-=s)}return 2.3283064365386963e-10*(s>>>0)});u.next=function(){var l=2091639*u.s0+2.3283064365386963e-10*u.c;return u.s0=u.s1,u.s1=u.s2,u.s2=l-(u.c=0|l)},u.c=1,u.s0=c(" "),u.s1=c(" "),u.s2=c(" "),u.s0-=c(i),u.s0<0&&(u.s0+=1),u.s1-=c(i),u.s1<0&&(u.s1+=1),u.s2-=c(i),u.s2<0&&(u.s2+=1),c=null}function o(i,s){return s.c=i.c,s.s0=i.s0,s.s1=i.s1,s.s2=i.s2,s}function a(i,s){var u=new r(i),c=s&&s.state,l=u.next;return l.int32=function(){return 4294967296*u.next()|0},l.double=function(){return l()+11102230246251565e-32*(2097152*l()|0)},l.quick=l,c&&("object"==typeof c&&o(c,u),l.state=function(){return o(u,{})}),l}t&&t.exports?t.exports=a:this.alea=a}(0,e)}),jg=hr(function(e){!function(n,t){function r(i){var s=this,u="";s.x=0,s.y=0,s.z=0,s.w=0,s.next=function(){var l=s.x^s.x<<11;return s.x=s.y,s.y=s.z,s.z=s.w,s.w^=s.w>>>19^l^l>>>8},i===(0|i)?s.x=i:u+=i;for(var c=0;c<u.length+64;c++)s.x^=0|u.charCodeAt(c),s.next()}function o(i,s){return s.x=i.x,s.y=i.y,s.z=i.z,s.w=i.w,s}function a(i,s){function u(){return(c.next()>>>0)/4294967296}var c=new r(i),l=s&&s.state;return u.double=function(){do{var h=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152}while(0===h);return h},u.int32=c.next,u.quick=u,l&&("object"==typeof l&&o(l,c),u.state=function(){return o(c,{})}),u}t&&t.exports?t.exports=a:this.xor128=a}(0,e)}),Kg=hr(function(e){!function(n,t){function r(i){var s=this,u="";s.next=function(){var l=s.x^s.x>>>2;return s.x=s.y,s.y=s.z,s.z=s.w,s.w=s.v,(s.d=s.d+362437|0)+(s.v=s.v^s.v<<4^l^l<<1)|0},s.x=0,s.y=0,s.z=0,s.w=0,i===((s.v=0)|i)?s.x=i:u+=i;for(var c=0;c<u.length+64;c++)s.x^=0|u.charCodeAt(c),c==u.length&&(s.d=s.x<<10^s.x>>>4),s.next()}function o(i,s){return s.x=i.x,s.y=i.y,s.z=i.z,s.w=i.w,s.v=i.v,s.d=i.d,s}function a(i,s){function u(){return(c.next()>>>0)/4294967296}var c=new r(i),l=s&&s.state;return u.double=function(){do{var h=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152}while(0===h);return h},u.int32=c.next,u.quick=u,l&&("object"==typeof l&&o(l,c),u.state=function(){return o(c,{})}),u}t&&t.exports?t.exports=a:this.xorwow=a}(0,e)}),Xg=hr(function(e){!function(n,t){function r(i){var s=this;s.next=function(){var u,c,l=s.x,h=s.i;return u=l[h],c=(u^=u>>>7)^u<<24,c^=(u=l[h+1&7])^u>>>10,c^=(u=l[h+3&7])^u>>>3,c^=(u=l[h+4&7])^u<<7,u=l[h+7&7],c^=(u^=u<<13)^u<<9,l[h]=c,s.i=h+1&7,c},function(u,c){var l,h=[];if(c===(0|c))h[0]=c;else for(c=""+c,l=0;l<c.length;++l)h[7&l]=h[7&l]<<15^c.charCodeAt(l)+h[l+1&7]<<13;for(;h.length<8;)h.push(0);for(l=0;l<8&&0===h[l];++l);for(8==l&&(h[7]=-1),u.x=h,u.i=0,l=256;0<l;--l)u.next()}(s,i)}function o(i,s){return s.x=i.x.slice(),s.i=i.i,s}function a(i,s){function u(){return(c.next()>>>0)/4294967296}null==i&&(i=+new Date);var c=new r(i),l=s&&s.state;return u.double=function(){do{var h=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152}while(0===h);return h},u.int32=c.next,u.quick=u,l&&(l.x&&o(l,c),u.state=function(){return o(c,{})}),u}t&&t.exports?t.exports=a:this.xorshift7=a}(0,e)}),Yg=hr(function(e){!function(n,t){function r(i){var s=this;s.next=function(){var u,c,l=s.w,h=s.X,f=s.i;return s.w=l=l+1640531527|0,c=h[f+34&127],u=h[f=f+1&127],c^=c<<13,u^=u<<17,c=h[f]=(c^=c>>>15)^(u^=u>>>12),s.i=f,c+(l^l>>>16)|0},function(u,c){var l,h,f,p,d,g=[],v=128;for(c===(0|c)?(h=c,c=null):(c+="\0",h=0,v=Math.max(v,c.length)),f=0,p=-32;p<v;++p)c&&(h^=c.charCodeAt((p+32)%c.length)),0===p&&(d=h),h^=h<<10,h^=h>>>15,h^=h<<4,h^=h>>>13,0<=p&&(f=0==(l=g[127&p]^=h+(d=d+1640531527|0))?f+1:0);for(128<=f&&(g[127&(c&&c.length||0)]=-1),f=127,p=512;0<p;--p)h=g[f+34&127],l=g[f=f+1&127],h^=h<<13,l^=l<<17,g[f]=(h^=h>>>15)^(l^=l>>>12);u.w=d,u.X=g,u.i=f}(s,i)}function o(i,s){return s.i=i.i,s.w=i.w,s.X=i.X.slice(),s}function a(i,s){function u(){return(c.next()>>>0)/4294967296}null==i&&(i=+new Date);var c=new r(i),l=s&&s.state;return u.double=function(){do{var h=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152}while(0===h);return h},u.int32=c.next,u.quick=u,l&&(l.X&&o(l,c),u.state=function(){return o(c,{})}),u}t&&t.exports?t.exports=a:this.xor4096=a}(0,e)}),$g=hr(function(e){!function(n,t){function r(i){var s=this,u="";s.next=function(){var l=s.b,h=s.c,f=s.d,p=s.a;return l=l<<25^l>>>7^h,h=h-f|0,f=f<<24^f>>>8^p,p=p-l|0,s.b=l=l<<20^l>>>12^h,s.c=h=h-f|0,s.d=f<<16^h>>>16^p,s.a=p-l|0},s.a=0,s.b=0,s.c=-1640531527,s.d=1367130551,i===Math.floor(i)?(s.a=i/4294967296|0,s.b=0|i):u+=i;for(var c=0;c<u.length+20;c++)s.b^=0|u.charCodeAt(c),s.next()}function o(i,s){return s.a=i.a,s.b=i.b,s.c=i.c,s.d=i.d,s}function a(i,s){function u(){return(c.next()>>>0)/4294967296}var c=new r(i),l=s&&s.state;return u.double=function(){do{var h=((c.next()>>>11)+(c.next()>>>0)/4294967296)/2097152}while(0===h);return h},u.int32=c.next,u.quick=u,l&&("object"==typeof l&&o(l,c),u.state=function(){return o(c,{})}),u}t&&t.exports?t.exports=a:this.tychei=a}(0,e)}),fr=hr(function(e){!function(n,t){var r,o=this,a=256,s="random",u=t.pow(a,6),c=t.pow(2,52),l=2*c,h=a-1;function f(m,y,x){function w(){for(var C=E.g(6),R=u,k=0;C<c;)C=(C+k)*a,R*=a,k=E.g(1);for(;l<=C;)C/=2,R/=2,k>>>=1;return(C+k)/R}var b=[],I=g(function C(R,k){var D,N=[],M=typeof R;if(k&&"object"==M)for(D in R)try{N.push(C(R[D],k-1))}catch{}return N.length?N:"string"==M?R:R+"\0"}((y=1==y?{entropy:!0}:y||{}).entropy?[m,v(n)]:m??function(){try{var C;return r&&(C=r.randomBytes)?C=C(a):(C=new Uint8Array(a),(o.crypto||o.msCrypto).getRandomValues(C)),v(C)}catch{var R=o.navigator,k=R&&R.plugins;return[+new Date,o,k,o.screen,v(n)]}}(),3),b),E=new p(b);return w.int32=function(){return 0|E.g(4)},w.quick=function(){return E.g(4)/4294967296},w.double=w,g(v(E.S),n),(y.pass||x||function(C,R,k,D){return D&&(D.S&&d(D,E),C.state=function(){return d(E,{})}),k?(t[s]=C,R):C})(w,I,"global"in y?y.global:this==t,y.state)}function p(m){var y,x=m.length,w=this,b=0,I=w.i=w.j=0,E=w.S=[];for(x||(m=[x++]);b<a;)E[b]=b++;for(b=0;b<a;b++)E[b]=E[I=h&I+m[b%x]+(y=E[b])],E[I]=y;(w.g=function(C){for(var R,k=0,D=w.i,N=w.j,M=w.S;C--;)R=M[D=h&D+1],k=k*a+M[h&(M[D]=M[N=h&N+R])+(M[N]=R)];return w.i=D,w.j=N,k})(a)}function d(m,y){return y.i=m.i,y.j=m.j,y.S=m.S.slice(),y}function g(m,y){for(var x,w=m+"",b=0;b<w.length;)y[h&b]=h&(x^=19*y[h&b])+w.charCodeAt(b++);return v(y)}function v(m){return String.fromCharCode.apply(0,m)}if(t["seed"+s]=f,g(t.random(),n),e.exports){e.exports=f;try{r=require("crypto")}catch{}}}([],Math)});fr.alea=qg,fr.xor128=jg,fr.xorwow=Kg,fr.xorshift7=Xg,fr.xor4096=Yg,fr.tychei=$g;var Ta=fr.alea,ks=(Na.prototype.nextValue=function(){if(!isNaN(this.nextVal)){var e=this.nextVal;return this.nextVal=NaN,e}for(var n,t,r=!1;!r;){for(var o=void 0,a=void 0,i=void 0;1<=(i=(o=2*this.random()-1)*o+(a=2*this.random()-1)*a)||0===i;);var s=Math.sqrt(-2*Math.log(i)/i);n=this.mean+this.stdDev*o*s,t=this.mean+this.stdDev*a*s,this.truncated&&!this.isValidTruncated(n)||(r=!0)}return this.truncated&&!this.isValidTruncated(t)||(this.nextVal=this.convertValue(t)),this.convertValue(n)},Na.prototype.convertValue=function(e){return null==this.dtype||"float32"===this.dtype?e:Math.round(e)},Na.prototype.isValidTruncated=function(e){return e<=this.upper&&e>=this.lower},Na),Jg=(Ds.prototype.nextValue=function(){for(var e,n,t,r,o,a;;){for(;r=this.randn.nextValue(),(a=1+this.c*r)<=0;);if(n=1-.331*(e=r*r)*e,t=.5*e+this.d*(1-(a*=a*a)+Math.log(a)),(o=this.randu())<n||Math.log(o)<t)break}return a*=1/this.beta*this.d,this.alpha<1&&(a*=Math.pow(this.randu(),1/this.alpha)),this.convertValue(a)},Ds.prototype.convertValue=function(e){return"float32"===this.dtype?e:Math.round(e)},Ds),Qg=(Ss.prototype.convertValue=function(e){return this.canReturnFloat()?e:Math.round(e)},Ss.prototype.nextValue=function(){return this.convertValue(this.min+this.range*this.random())},Ss);function Ss(e,n,t,r){var o=this;if(void 0===e&&(e=0),void 0===n&&(n=1),this.canReturnFloat=function(){return null==o.dtype||"float32"===o.dtype},this.min=e,this.range=n-e,this.dtype=t,null==r&&(r=Math.random()),"number"==typeof r&&(r=r.toString()),!this.canReturnFloat()&&this.range<=1)throw new Error("The difference between "+e+" - "+n+" <= 1 and dtype is not float");this.random=Ta(r)}function Ds(e,n,t,r){this.alpha=e,this.beta=1/n,this.dtype=t;var o=r||Math.random();this.randu=Ta(o.toString()),this.randn=new ks(0,1,t,!1,this.randu()),this.d=e<1?e+2/3:e-1/3,this.c=1/Math.sqrt(9*this.d)}function Na(e,n,t,r,o){this.mean=e,this.stdDev=n,this.dtype=t,this.nextVal=NaN,this.truncated=r,this.truncated&&(this.upper=this.mean+2*this.stdDev,this.lower=this.mean-2*this.stdDev);var a=o||Math.random();this.random=Ta(a.toString())}function he(e,n,t){return void 0===n&&(n="float32"),n=n||"float32",us(e),new Or(e,n,t)}function Ph(e,n){void 0===n&&(n=!1),console.log(e.toString(n))}function Bh(e,n){return oe(this,void 0,void 0,function(){var t,r,o,a,i,s,u,c,l,h;return ae(this,function(f){switch(f.label){case 0:return t=_(e,"x","setdiff1d"),r=_(n,"y","setdiff1d"),S(t.dtype===r.dtype,function(){return"x and y should have the same dtype, but got x ("+t.dtype+") and y ("+r.dtype+")."}),S(1===t.rank,function(){return"x should be 1D tensor, but got x ("+t.shape+")."}),S(1===r.rank,function(){return"y should be 1D tensor, but got y ("+r.shape+")."}),[4,t.data()];case 1:return o=f.sent(),[4,r.data()];case 2:for(a=f.sent(),i=new Set(a),l=s=0;l<o.length;l++)i.has(o[l])||s++;for(u=new Or([s],t.dtype),c=new Or([s],"int32"),h=l=0;l<o.length;l++)i.has(o[l])||(u.values[h]=o[l],c.values[h]=l,h++);return[2,[u.toTensor(),c.toTensor()]]}})})}var As=T({batchToSpaceND_:function(e,n,t){var r=_(e,"x","batchToSpaceND"),o=n.reduce(function(a,i){return a*i});return S(r.rank>=1+n.length,function(){return"input rank is "+r.rank+" but should be > than blockShape.length "+n.length}),S(t.length===n.length,function(){return"crops.length is "+t.length+" but should be equal to blockShape.length  "+n.length}),S(r.shape[0]%o==0,function(){return"input tensor batch is "+r.shape[0]+" but is not divisible by the product of the elements of blockShape "+n.join(" * ")+" === "+o}),A.runKernelFunc(function(a){return a.batchToSpaceND(r,n,t)},{$x:r},function(a){return{$x:function(){return a.spaceToBatchND(n,t)}}})}}),Lh=T({broadcastTo_:function(e,n){var t=_(e,"broadcastTo","x"),r=t.shape;if(n.some(function(u){return!(0<u)||u%1!=0}))throw new Error("broadcastTo(): Invalid broadcast shape ["+n+"].");if(n.length<t.rank)throw new Error("broadcastTo(): shape.length="+n.length+" < input.rank="+t.rank+".");if(n.length>t.rank){for(var o=t.shape.slice();o.length<n.length;)o.unshift(1);t=t.reshape(o)}for(var a=Array.from(n),i=n.length-1;0<=i;i--)if(t.shape[i]===n[i])a[i]=1;else if(1!==t.shape[i])throw new Error("broadcastTo(): ["+r+"] cannot be broadcast to ["+n+"].");var s=a.map(function(u,c){return 1<u?c:-1}).filter(function(u){return 0<=u});return 0===s.length?t.clone():A.runKernelFunc(function(u){return u.tile(t,a)},{input:t},function(u){return{input:function(){return u.sum(s,!0)}}})}}),Wh=T({cast_:function(e,n){var t=_(e,"x","cast");if(!Bl(n))throw new Error("Failed to cast to unknown dtype "+n);if("string"===n&&"string"!==t.dtype||"string"!==n&&"string"===t.dtype)throw new Error("Only strings can be casted to strings");return A.runKernelFunc(function(o){return o.cast(t,n)},{x:t},function(o){return{x:function(){return o.clone()}}},"Cast",{dtype:n})}}),zh=T({clone_:function(e){var n=_(e,"x","clone",null);return A.runKernelFunc(function(){return A.makeTensorFromDataId(n.dataId,n.shape,n.dtype)},{$x:n},function(t){return{$x:function(){return t.toFloat()}}})}}),Uh=T({cumsum_:function(e,n,t,r){void 0===n&&(n=0),void 0===t&&(t=!1),void 0===r&&(r=!1);var o=_(e,"x","cumsum"),a=On([n|=0],o.rank),i=o;null!=a&&(i=o.transpose(a));var s=Pn(1,o.rank)[0],u=A.runKernelFunc(function(c){return c.cumsum(i,s,t,r)},{permutedX:i},function(c){return{permutedX:function(){return c.cumsum(n,t,!r)}}});return null!=a&&(u=u.transpose(a)),u}}),Vh=T({depthToSpace_:function(e,n,t){void 0===t&&(t="NHWC");var r=_(e,"x","depthToSpace"),o="NHWC"===t?r.shape[1]:r.shape[2],a="NHWC"===t?r.shape[2]:r.shape[3],i="NHWC"===t?r.shape[3]:r.shape[1];return S(0<=o*n,function(){return"Negative dimension size caused by overflow when multiplying\n      "+o+" and "+n+"  for depthToSpace with input shape\n      "+r.shape}),S(0<=a*n,function(){return"Negative dimension size caused by overflow when multiplying\n      "+a+" and "+n+" for depthToSpace with input shape\n          "+r.shape}),S(i%(n*n)==0,function(){return"Dimension size must be evenly divisible by "+n*n+" but is "+i+" for depthToSpace with input shape "+r.shape}),A.runKernelFunc(function(s){return s.depthToSpace(r,n,t)},{$x:r})}}),En=T({expandDims_:function(e,n){void 0===n&&(n=0);var t=_(e,"x","expandDims",null);S(n<=t.rank,function(){return"Axis must be <= rank of the tensor"});var r=t.shape.slice();return n<0&&(S(-(t.rank+1)<=n,function(){return"Axis must be in the interval ["+-(t.rank+1)+", "+t.rank+"]"}),n=t.rank+n+1),r.splice(n,0,1),An(t,r)}}),Ts=T({eye_:function(e,n,t,r){void 0===r&&(r="float32"),null==n&&(n=e);for(var o=he([e,n],r),a=e<=n?e:n,i=0;i<a;++i)o.set(1,i,i);var s=o.toTensor().as2D(e,n);if(null==t)return s;if(1===t.length)return pr(En(s,0),[t[0],1,1]);if(2===t.length)return pr(En(En(s,0),0),[t[0],t[1],1,1]);if(3===t.length)return pr(En(En(En(s,0),0),0),[t[0],t[1],t[2],1,1]);throw new Error("eye() currently supports only 1D and 2D batchShapes, but received "+t.length+"D.")}}),Gh=T({multinomial_:function(e,n,t,r){void 0===r&&(r=!1);var o=_(e,"logits","multinomial"),a=o.size,i=o.rank;if(a<2)throw new Error("Error in multinomial: you need at least 2 outcomes, but got "+a+".");if(2<i)throw new Error("Rank of probabilities must be 1 or 2, but is "+i);t=t||Math.random();var s=1===i?o.as2D(1,-1):o,u=A.runKernelFunc(function(c){return c.multinomial(s,r,n,t)},{logits2D:s});return 1===i?u.as1D():u}}),Fa=T({oneHot_:function(e,n,t,r){if(void 0===t&&(t=1),void 0===r&&(r=0),n<2)throw new Error("Error in oneHot: depth must be >=2, but it is "+n);var o=_(e,"indices","oneHot","int32"),a=o.shape.concat([n]);return o=o.flatten(),A.runKernelFunc(function(i){return i.oneHot(o,n,t,r)},{$indices:o},function(i){return{$indices:function(){return Se(o.shape,"float32")}}}).reshape(a)}}),Ot=T({pad_:function(e,n,t){void 0===t&&(t=0);var r=_(e,"x","pad");if(0===r.rank)throw new Error("pad(scalar) is not defined. Pass non-scalar to pad");return A.runKernelFunc(function(a){return a.pad(r,n,t)},{x:r},function(a){var i=n.map(function(s){return s[0]});return{x:function(){return a.slice(i,r.shape)}}},"PadV2",{paddings:n,constantValue:t})}}),Hh=T({pad1d_:function(e,n,t){return void 0===t&&(t=0),S(2===n.length,function(){return"Invalid number of paddings. Must be length of 2."}),Ot(e,[n],t)}}),qh=T({pad2d_:function(e,n,t){return void 0===t&&(t=0),S(2===n.length&&2===n[0].length&&2===n[1].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),Ot(e,n,t)}}),jh=T({pad3d_:function(e,n,t){return void 0===t&&(t=0),S(3===n.length&&2===n[0].length&&2===n[1].length&&2===n[2].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),Ot(e,n,t)}}),Kh=T({pad4d_:function(e,n,t){return void 0===t&&(t=0),S(4===n.length&&2===n[0].length&&2===n[1].length&&2===n[2].length&&2===n[3].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),Ot(e,n,t)}}),Xh=T({rand_:function(e,n,t){var r=ie(e),o=null;if(null==t||"float32"===t)o=new Float32Array(r);else if("int32"===t)o=new Int32Array(r);else{if("bool"!==t)throw new Error("Unknown data type "+t);o=new Uint8Array(r)}for(var a=0;a<r;a++)o[a]=n();return A.makeTensor(o,e,t)}}),Yh=T({randomNormal_:function(e,n,t,r,o){if(void 0===n&&(n=0),void 0===t&&(t=1),null!=r&&"bool"===r)throw new Error("Unsupported data type "+r);for(var a=new ks(n,t,r,!1,o),i=he(e,r),s=0;s<i.values.length;s++)i.values[s]=a.nextValue();return i.toTensor()}}),$h=T({randomGamma_:function(e,n,t,r,o){if(void 0===t&&(t=1),void 0===r&&(r="float32"),null==t&&(t=1),null==r&&(r="float32"),"float32"!==r&&"int32"!==r)throw new Error("Unsupported data type "+r);for(var a=new Jg(n,t,r,o),i=he(e,r),s=0;s<i.values.length;s++)i.values[s]=a.nextValue();return i.toTensor()}}),Ns=T({randomUniform_:function(e,n,t,r,o){void 0===n&&(n=0),void 0===t&&(t=1),void 0===r&&(r="float32");for(var a=he(e,r),i=new Qg(n,t,null,o),s=0;s<a.values.length;s++)a.values[s]=i.nextValue();return a.toTensor()}}),An=T({reshape_:function(e,n){var t=_(e,"x","reshape",null);return n=Ol(n,t.size),S(t.size===ie(n),function(){return"new shape and old shape must have the same number of elements."}),A.runKernelFunc(function(o){return o.reshape(t,n)},{x:t},function(o){return{x:function(){return o.reshape(t.shape)}}},"Reshape",{shape:n})}}),Fs=T({spaceToBatchND_:function(e,n,t){var r=_(e,"x","spaceToBatchND");return S(r.rank>=1+n.length,function(){return"input rank "+r.rank+" should be > than [blockShape] "+n.length}),S(t.length===n.length,function(){return"paddings.shape[0] "+t.length+" must be equal to [blockShape] "+n.length}),S(r.shape.reduce(function(o,a,i){return 0<i&&i<=n.length?o&&(a+t[i-1][0]+t[i-1][1])%n[i-1]==0:o},!0),function(){return"input spatial dimensions "+r.shape.slice(1)+" with paddings "+t.toString()+" must be divisible by blockShapes "+n.toString()}),A.runKernelFunc(function(o){return o.spaceToBatchND(r,n,t)},{$x:r},function(o){return{$x:function(){return o.batchToSpaceND(n,t)}}})}}),Ms=T({squeeze_:function(e,n){var t=_(e,"x","squeeze");return An(t,At(t.shape,n).newShape)}}),dn=T({stack_:function(e,n){void 0===n&&(n=0);var t=ko(e,"tensors","stack");if(S(1<=t.length,function(){return"Pass at least one tensor to tf.stack"}),1===t.length)return t[0].expandDims(n);var o=t[0].shape,a=t[0].dtype;S(n<=t[0].rank,function(){return"Axis must be <= rank of the tensor"}),t.forEach(function(s){we(o,s.shape,"All tensors passed to stack must have matching shapes")}),t.forEach(function(s){S(a===s.dtype,function(){return"All tensors passed to stack must have matching dtypes"})});var i=t.map(function(s){return s.expandDims(n)});return ze(i,n)}}),pr=T({tile_:function(e,n){var t=_(e,"x","tile",null);return S(t.rank===n.length,function(){return"Error in transpose: rank of input "+t.rank+" must match length of reps "+n+"."}),A.runKernelFunc(function(a,i){var s=a.tile(t,n);return i([t]),s},{x:t},function(a,i){var s=i[0];return{x:function(){var u=xe(s);if(1===s.rank)for(var c=0;c<n[0];++c)u=u.add(a.slice([c*s.shape[0]],[s.shape[0]]));else if(2===s.rank)for(c=0;c<n[0];++c)for(var l=0;l<n[1];++l)u=u.add(a.slice([c*s.shape[0],l*s.shape[1]],[s.shape[0],s.shape[1]]));else if(3===s.rank)for(c=0;c<n[0];++c)for(l=0;l<n[1];++l)for(var h=0;h<n[2];++h)u=u.add(a.slice([c*s.shape[0],l*s.shape[1],h*s.shape[2]],[s.shape[0],s.shape[1],s.shape[2]]));else{if(4!==s.rank)throw new Error("Gradient for tile operation is not implemented for rank-"+s.rank+" tensors yet.");for(c=0;c<n[0];++c)for(l=0;l<n[1];++l)for(h=0;h<n[2];++h)for(var f=0;f<n[3];++f)u=u.add(a.slice([c*s.shape[0],l*s.shape[1],h*s.shape[2],f*s.shape[3]],[s.shape[0],s.shape[1],s.shape[2],s.shape[3]]))}return u}}},"Tile",{reps:n},[t])}}),Jh=T({truncatedNormal_:function(e,n,t,r,o){if(void 0===n&&(n=0),void 0===t&&(t=1),null!=r&&"bool"===r)throw new Error("Unsupported data type "+r);for(var a=new ks(n,t,r,!0,o),i=he(e,r),s=0;s<i.values.length;s++)i.values[s]=a.nextValue();return i.toTensor()}}),Ue=T({unstack_:function(e,n){void 0===n&&(n=0),n=n||0;var t=_(e,"x","unstack");return S(n>=-t.shape.length&&n<t.shape.length,function(){return"Axis = "+n+" is not in [-"+t.shape.length+", "+t.shape.length+")"}),n<0&&(n+=t.shape.length),A.runKernelFunc(function(o){return o.unstack(t,n)},{x:t},function(o){return{x:function(){return dn(o,n)}}},"Unpack",{axis:n})}});function Ma(e,n,t,r){void 0===r&&(r=!0);var o=[];if(r)(o=o.concat(n.slice(0))).push(e[0]/t),o=o.concat(e.slice(1));else{o=o.concat(e[0]);for(var a=n.length,i=0;i<a;++i)o=o.concat([e[i+1]/n[i],n[i]]);o=o.concat(e.slice(a+1))}return o}function Oa(e,n,t){void 0===t&&(t=!0);var r=[];if(t){r.push(n);for(var o=n+1;o<e;++o)o<=2*n?(r.push(o),r.push(o-(n+1))):r.push(o)}else{var a=[],i=[];for(o=1;o<e;++o)2*n+1<=o||o%2==1?i.push(o):a.push(o);r.push.apply(r,a),r.push(0),r.push.apply(r,i)}return r}function Pa(e,n,t,r){void 0===r&&(r=!0);var o=[];o.push(r?e[0]/t:e[0]*t);for(var a=1;a<e.length;++a)o.push(a<=n.length?r?n[a-1]*e[a]:e[a]/n[a-1]:e[a]);return o}function Qh(e,n){for(var t=[0],r=0;r<n;++r)t.push(e[r][0]);return t}function Zh(e,n,t){for(var r=e.slice(0,1),o=0;o<t;++o)r.push(e[o+1]-n[o][0]-n[o][1]);return r}function Os(e,n){if(e.rank<1)throw new Error("tf.gatherND() expects the input to be rank 1 or higher, but the rank was "+e.rank+".");if(n.rank<1)throw new Error("tf.gatherND() expects the indices to be rank 1 or higher, but the rank was "+n.rank+".");if("int32"!==n.dtype)throw new Error("tf.gatherND() expects the indices to be int32 type, but the dtype was "+n.dtype+".");if(n.shape[n.rank-1]>e.rank)throw new Error("index innermost dimension length must be <= tensor rank; saw: "+n.shape[n.rank-1]+" vs. "+e.rank);if(0===e.size)throw new Error("Requested more than 0 entries, but input is empty. Input shape: "+e.shape+".");for(var t=n.shape,r=t[t.length-1],o=1,a=0;a<t.length-1;++a)o*=t[a];var i=e.shape,s=t.slice();s.pop();var u=1;for(a=r;a<e.rank;++a)u*=i[a],s.push(i[a]);var c=Fn(e.shape).map(function(l){return l/u}).concat([1]).slice(0,r);return[s,o,u,c]}var Zg=Object.freeze({prepareAndValidate:Os});function Ba(e){return e<=30?e:fa(e,Math.floor(Math.sqrt(e)))}function ef(e,n,t){var r=1<n.rank?n.shape[n.rank-1]:1,o=1<n.rank?n.rank-1:1,a="Must have updates.shape = indices.shape[:batchDim] + shape[sliceDim:], got updates.shape: "+t.shape+", indices.shape: "+n.shape+", shape: "+e+", sliceDim: "+r+", and batchDim: "+o+".";if(t.rank<o)throw new Error(a+" update.rank < "+o+". ");if(e.length<r+(t.rank-o))throw new Error(a+" Output shape length < "+(r+(t.rank-o)));if(t.rank!==o+e.length-r)throw new Error(a+" update.rank != "+(o+e.length-r));for(var i=0;i<o;++i)if(t.shape[i]!==n.shape[i])throw new Error(a+" updates.shape["+i+"] ("+t.shape[i]+") != indices.shape["+i+"] ("+n.shape[i]+").");for(i=0;i<t.rank-o;++i)if(t.shape[i+o]!==e[i+r])throw new Error(a+" updates.shape["+(i+o)+"] ("+t.shape[i+o]+") != shape["+(i+o)+"] ("+e[i+o]+")")}function nf(e,n,t){if(n.rank<1)throw new Error("tf.scatterND() expects the indices to be rank 1 or higher, but the rank was "+n.rank+".");if(e.rank<1)throw new Error("tf.scatterND() expects the updates to be rank 1 or higher, but the rank was "+e.rank+".");if("int32"!==n.dtype)throw new Error("The dtype of 'indices' should be int32, but got dtype: "+n.dtype);if(t.length<1)throw new Error("Output rank must be greater or equal to 1, but got shape: "+t);if(0===t.length){if(0===n.size)throw new Error("Indices specified for empty output. indices shape: "+n.shape);if(0===e.size)throw new Error("Updates specified for empty output. updates shape: "+e.shape)}ef(t,n,e)}function Do(e,n,t){for(var r=n.shape.length,o=1<r?n.shape[r-1]:1,a=t.length,i=1,s=o;s<a;++s)i*=t[s];var u=o<1?1:o;return{sliceRank:o,numUpdates:ie(n.shape)/u,sliceSize:i,strides:Fn(t.slice(0,o)).concat([1]),outputSize:ie(t)}}var e0=Object.freeze({validateUpdateShape:ef,validateInput:nf,calculateShapes:Do});function tf(e,n,t){S(e.rank===n.length,function(){return"Error in slice"+e.rank+"D: Length of begin "+n+" must match the rank of the array ("+e.rank+")."}),S(e.rank===t.length,function(){return"Error in slice"+e.rank+"D: Length of size "+t+" must match the rank of the array ("+e.rank+")."});for(var r=function(a){S(n[a]+t[a]<=e.shape[a],function(){return"Error in slice"+e.rank+"D: begin["+a+"] + size["+a+"] ("+(n[a]+t[a])+") would overflow input.shape["+a+"] ("+e.shape[a]+")"})},o=0;o<e.rank;++o)r(o)}function Ps(e){for(var n=[],t=0;0<e;)1&e&&n.push(t),e/=2,t++;return n}function La(e,n,t){for(var r=[],o=0;o<e.length;o++)r[o]=Math.ceil((n[o]-e[o])/t[o]);return r}function rf(e,n,t,r,o){var a=n[o];(e&1<<o||null==a)&&(a=0<(t[o]||1)?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER);var s=r[o];return a<0&&(a+=s),la(0,a,s-1)}function of(e,n,t,r,o){var a=n[o],i=t[o]||1;(e&1<<o||null==a)&&(a=0<i?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER);var s=r[o];return a<0&&(a+=s),0<i?la(0,a,s):la(-1,a,s-1)}function Bs(e,n,t){for(var r=t.length,o=0;o<t.length;o++)if(1<t[o]){r=o;break}for(o=r+1;o<t.length;o++)if(0<n[o]||t[o]!==e[o])return!1;return!0}function Ls(e,n){for(var t=0<e.length?e[e.length-1]:1,r=0;r<e.length-1;r++)t+=e[r]*n[r];return t}var n0=Object.freeze({assertParamsValid:tf,maskToAxes:Ps,computeOutShape:La,startForAxis:rf,stopForAxis:of,isSliceContinous:Bs,computeFlatOffset:Ls});function af(e,n){S(Nt(e),function(){return"The f passed in variableGrads(f) must be a function"}),S(null==n||Array.isArray(n)&&n.every(function(l){return l instanceof sr}),function(){return"The varList passed in variableGrads(f, varList) must be an array of variables"});var t=null!=n;if(!t)for(var r in n=[],A.registeredVariables)n.push(A.registeredVariables[r]);var o=t?n.filter(function(l){return!l.trainable}):null,a=n.length;S(0<(n=n.filter(function(l){return l.trainable})).length,function(){return"variableGrads() expects at least one of the input variables to be trainable, but none of the "+a+" variables is trainable."});var i=A.gradients(e,n,null,!0),s=i.value,u=i.grads;S(u.some(function(l){return null!=l}),function(){return"Cannot find a connection between any variable and the result of the loss function y=f(x). Please make sure the operations that use variables are inside the function f passed to minimize()."}),S(0===s.rank,function(){return"The f passed in variableGrads(f) must return a scalar, but it returned a rank-"+s.rank+" tensor"});var c={};return n.forEach(function(l,h){null!=u[h]&&(c[l.name]=u[h])}),o?.forEach(function(l){return c[l.name]=null}),{value:s,grads:c}}function Ao(e){return A.customGrad(e)}function Wa(e){if(0<e.filter(function(n){return null==n}).length)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that\n    the f you passed encloses all operations that lead from x to y.")}var Yn=T({softmax_:function(e,n){void 0===n&&(n=-1);var t=_(e,"logits","softmax","float32");if(-1===n&&(n=t.rank-1),n!==t.rank-1)throw Error("Softmax along a non-last dimension is not yet supported. Logits was rank "+t.rank+" and dim was "+n);return A.runKernelFunc(function(r,o){var a=r.softmax(t,n);return o([a]),a},{logits:t},function(r,o){var a=o[0],i=r.mul(a);return{logits:function(){return i.sub(i.sum([n],!0).mul(a))}}},"Softmax",{dim:n},[],[!0])}}),sf=T({logSoftmax_:function(e,n){void 0===n&&(n=-1);var t=_(e,"logits","logSoftmax");if(-1===n&&(n=t.rank-1),n!==t.rank-1)throw Error("Log Softmax along a non-last dimension is not yet supported. Logits was rank "+t.rank+" and axis was "+n);return Ao(function(r,o){var a=r.max(n,!0),i=r.sub(a),s=i.toFloat().sub(i.exp().sum(n,!0).log());return o([s]),{value:s,gradFunc:function(u,c){var l=c[0].exp();return u.sub(u.sum(n,!0).mul(l))}}})(t)}}),Ws=(Pr.prototype.get=function(e){return this.data.has(e)||this.dataMover.moveData(this.backend,e),this.data.get(e)},Pr.prototype.set=function(e,n){this.dataIdsCount++,this.data.set(e,n)},Pr.prototype.has=function(e){return this.data.has(e)},Pr.prototype.delete=function(e){return this.dataIdsCount--,this.data.delete(e)},Pr.prototype.numDataIds=function(){return this.dataIdsCount},Pr),zs=(U.prototype.time=function(e){return V("time")},U.prototype.read=function(e){return V("read")},U.prototype.readSync=function(e){return V("readSync")},U.prototype.numDataIds=function(){return V("numDataIds")},U.prototype.disposeData=function(e){return V("disposeData")},U.prototype.write=function(e,n,t){return V("write")},U.prototype.move=function(e,n,t,r){return V("move")},U.prototype.memory=function(){return V("memory")},U.prototype.floatPrecision=function(){return V("floatPrecision")},U.prototype.epsilon=function(){return 32===this.floatPrecision()?1e-7:1e-4},U.prototype.batchMatMul=function(e,n,t,r){return V("batchMatMul")},U.prototype.fusedBatchMatMul=function(e){return V("fusedBatchMatMul")},U.prototype.slice=function(e,n,t){return V("slice")},U.prototype.stridedSlice=function(e,n,t,r){return V("stridedSlice")},U.prototype.unstack=function(e,n){return V("unstack")},U.prototype.reverse=function(e,n){return V("reverse")},U.prototype.concat=function(e,n){return V("concat")},U.prototype.neg=function(e){return V("neg")},U.prototype.add=function(e,n){return V("add")},U.prototype.addN=function(e){return V("addN")},U.prototype.subtract=function(e,n){return V("subtract")},U.prototype.multiply=function(e,n){return V("multiply")},U.prototype.realDivide=function(e,n){return V("realDivide")},U.prototype.floorDiv=function(e,n){return V("floorDiv")},U.prototype.sum=function(e,n){return V("sum")},U.prototype.prod=function(e,n){return V("prod")},U.prototype.unsortedSegmentSum=function(e,n,t){return V("unsortedSegmentSum")},U.prototype.argMin=function(e,n){return V("argMin")},U.prototype.argMax=function(e,n){return V("argMax")},U.prototype.equal=function(e,n){return V("equal")},U.prototype.notEqual=function(e,n){return V("notEqual")},U.prototype.less=function(e,n){return V("less")},U.prototype.lessEqual=function(e,n){return V("lessEqual")},U.prototype.greater=function(e,n){return V("greater")},U.prototype.greaterEqual=function(e,n){return V("greaterEqual")},U.prototype.logicalNot=function(e){return V("logicalNot")},U.prototype.logicalAnd=function(e,n){return V("logicalAnd")},U.prototype.logicalOr=function(e,n){return V("logicalOr")},U.prototype.where=function(e){return V("where")},U.prototype.select=function(e,n,t){return V("select")},U.prototype.topk=function(e,n,t){return V("topk")},U.prototype.min=function(e,n){return V("min")},U.prototype.minimum=function(e,n){return V("minimum")},U.prototype.mod=function(e,n){return V("mod")},U.prototype.max=function(e,n){return V("max")},U.prototype.maximum=function(e,n){return V("maximum")},U.prototype.all=function(e,n){return V("all")},U.prototype.any=function(e,n){return V("any")},U.prototype.squaredDifference=function(e,n){return V("squaredDifference")},U.prototype.ceil=function(e){return V("ceil")},U.prototype.floor=function(e){return V("floor")},U.prototype.round=function(e){return V("round")},U.prototype.sign=function(e){return V("sign")},U.prototype.isNaN=function(e){return V("isNaN")},U.prototype.isInf=function(e){return V("isInf")},U.prototype.isFinite=function(e){return V("isFinite")},U.prototype.pow=function(e,n){return V("pow")},U.prototype.exp=function(e){return V("exp")},U.prototype.expm1=function(e){return V("expm1")},U.prototype.softmax=function(e,n){return V("softmax")},U.prototype.log=function(e){return V("log")},U.prototype.log1p=function(e){return V("log1p")},U.prototype.sqrt=function(e){return V("sqrt")},U.prototype.rsqrt=function(e){return V("rsqrt")},U.prototype.square=function(e){return V("square")},U.prototype.reciprocal=function(e){return V("reciprocal")},U.prototype.relu=function(e){return V("relu")},U.prototype.relu6=function(e){return V("relu6")},U.prototype.prelu=function(e,n){return V("prelu")},U.prototype.elu=function(e){return V("elu")},U.prototype.eluDer=function(e,n){return V("eluDer")},U.prototype.selu=function(e){return V("selu")},U.prototype.int=function(e){return V("int")},U.prototype.clip=function(e,n,t){return V("clip")},U.prototype.abs=function(e){return V("abs")},U.prototype.complexAbs=function(e){return V("complexAbs")},U.prototype.sigmoid=function(e){return V("sigmoid")},U.prototype.softplus=function(e){return V("softplus")},U.prototype.sin=function(e){return V("sin")},U.prototype.cos=function(e){return V("cos")},U.prototype.tan=function(e){return V("tan")},U.prototype.asin=function(e){return V("asin")},U.prototype.acos=function(e){return V("acos")},U.prototype.atan=function(e){return V("atan")},U.prototype.atan2=function(e,n){return V("atan2")},U.prototype.sinh=function(e){return V("sinh")},U.prototype.cosh=function(e){return V("cosh")},U.prototype.tanh=function(e){return V("tanh")},U.prototype.asinh=function(e){return V("asinh")},U.prototype.acosh=function(e){return V("acosh")},U.prototype.atanh=function(e){return V("atanh")},U.prototype.erf=function(e){return V("erf")},U.prototype.step=function(e,n){return V("step")},U.prototype.fusedConv2d=function(e){return V("fusedConv2d")},U.prototype.conv2d=function(e,n,t){return V("conv2d")},U.prototype.conv2dDerInput=function(e,n,t){return V("conv2dDerInput")},U.prototype.conv2dDerFilter=function(e,n,t){return V("conv2dDerFilter")},U.prototype.fusedDepthwiseConv2D=function(e){return V("fusedDepthwiseConv2D")},U.prototype.depthwiseConv2D=function(e,n,t){return V("depthwiseConv2D")},U.prototype.depthwiseConv2DDerInput=function(e,n,t){return V("depthwiseConv2DDerInput")},U.prototype.depthwiseConv2DDerFilter=function(e,n,t){return V("depthwiseConv2DDerFilter")},U.prototype.conv3d=function(e,n,t){return V("conv3d")},U.prototype.conv3dDerInput=function(e,n,t){return V("conv3dDerInput")},U.prototype.conv3dDerFilter=function(e,n,t){return V("conv3dDerFilter")},U.prototype.maxPool=function(e,n){return V("maxPool")},U.prototype.maxPoolBackprop=function(e,n,t,r){return V("maxPoolBackprop")},U.prototype.avgPool=function(e,n){return V("avgPool")},U.prototype.avgPoolBackprop=function(e,n,t){return V("avgPoolBackprop")},U.prototype.avgPool3d=function(e,n){return V("avgPool3d")},U.prototype.avgPool3dBackprop=function(e,n,t){return V("avgPool3dBackprop")},U.prototype.maxPool3d=function(e,n){return V("maxPool3d")},U.prototype.maxPool3dBackprop=function(e,n,t,r){return V("maxPool3dBackprop")},U.prototype.reshape=function(e,n){return V("reshape")},U.prototype.cast=function(e,n){return V("cast")},U.prototype.tile=function(e,n){return V("tile")},U.prototype.pad=function(e,n,t){return V("pad")},U.prototype.transpose=function(e,n){return V("transpose")},U.prototype.gather=function(e,n,t){return V("gather")},U.prototype.gatherND=function(e,n){return V("gatherND")},U.prototype.scatterND=function(e,n,t){return V("scatterND")},U.prototype.batchToSpaceND=function(e,n,t){return V("batchToSpaceND")},U.prototype.spaceToBatchND=function(e,n,t){return V("spaceToBatchND")},U.prototype.resizeBilinear=function(e,n,t,r){return V("resizeBilinear")},U.prototype.resizeBilinearBackprop=function(e,n,t){return V("resizeBilinearBackprop")},U.prototype.resizeNearestNeighbor=function(e,n,t,r){return V("resizeNearestNeighbor")},U.prototype.resizeNearestNeighborBackprop=function(e,n,t){return V("resizeNearestNeighborBackprop")},U.prototype.batchNormalization=function(e,n,t,r,o,a){return V("batchNormalization")},U.prototype.localResponseNormalization4D=function(e,n,t,r,o){return V("localResponseNormalization4D")},U.prototype.LRNGrad=function(e,n,t,r,o,a,i){return V("LRNGrad")},U.prototype.multinomial=function(e,n,t,r){return V("multinomial")},U.prototype.oneHot=function(e,n,t,r){return V("oneHot")},U.prototype.cumsum=function(e,n,t,r){return V("cumsum")},U.prototype.nonMaxSuppression=function(e,n,t,r,o){return V("nonMaxSuppression")},U.prototype.fft=function(e){return V("fft")},U.prototype.ifft=function(e){return V("ifft")},U.prototype.complex=function(e,n){return V("complex")},U.prototype.real=function(e){return V("real")},U.prototype.imag=function(e){return V("imag")},U.prototype.cropAndResize=function(e,n,t,r,o,a){return V("cropAndResize")},U.prototype.depthToSpace=function(e,n,t){return V("depthToSpace")},U.prototype.split=function(e,n,t){return V("split")},U.prototype.sparseToDense=function(e,n,t,r){return V("sparseToDense")},U.prototype.diag=function(e){return V("diag")},U.prototype.fill=function(e,n,t){return V("fill")},U.prototype.onesLike=function(e){return V("onesLike")},U.prototype.zerosLike=function(e){return V("zerosLike")},U.prototype.linspace=function(e,n,t){return V("linspace")},U.prototype.dispose=function(){return V("dispose")},U);function U(){}function Pr(e,n){this.backend=e,this.dataMover=n,this.data=new WeakMap,this.dataIdsCount=0}function V(e){throw new Error("'"+e+"' not yet implemented or not found in the registry. Did you forget to import the kernel?")}function ht(e,n){for(var t=e.length,r=[],o=0;o<t;o++){var a=t-1-o;1<(n[n.length-1-o]||1)&&1===(e[a]||1)&&r.unshift(a)}return r}function Ve(e,n){for(var t=[],r=0;r<n.length;r++){var o=e[e.length-r-1],a=n.length-r-1;(null==o||1===o&&1<n[a])&&t.unshift(a)}return t}function ve(e,n){for(var t=[],r=Math.max(e.length,n.length),o=0;o<r;o++){var a=e[e.length-o-1];null==a&&(a=1);var i=n[n.length-o-1];if(null==i&&(i=1),1===a)t.unshift(i);else if(1===i)t.unshift(a);else{if(a!==i)throw Error("Operands could not be broadcast together with shapes "+e+" and "+n+".");t.unshift(a)}}return t}function Br(e,n,t,r,o,a,i){void 0===i&&(i="channelsLast");var s,u=za(n),c=u[0],l=u[1];if("channelsLast"===i)s=[c,l,e[3],e[3]];else{if("channelsFirst"!==i)throw new Error("Unknown dataFormat "+i);s=[c,l,e[1],e[1]]}return Pt(e,s,t,r,o,a,!1,i)}function To(e,n,t,r,o,a,i){void 0===i&&(i="NDHWC");var s,u,c=Vs(n),l=c[0],h=c[1],f=c[2];if("NDHWC"===i)u="channelsLast",s=[l,h,f,e[4],e[4]];else{if("NCDHW"!==i)throw new Error("Unknown dataFormat "+i);u="channelsFirst",s=[l,h,f,e[1],e[1]]}return No(e,s,t,r,o,!1,u,a)}function Pt(e,n,t,r,o,a,i,s){void 0===i&&(i=!1),void 0===s&&(s="channelsLast");var u=[-1,-1,-1,-1],c=u[0],l=u[1],h=u[2],f=u[3];if("channelsLast"===s)c=e[0],l=e[1],h=e[2],f=e[3];else{if("channelsFirst"!==s)throw new Error("Unknown dataFormat "+s);c=e[0],f=e[1],l=e[2],h=e[3]}var p,d=n[0],g=n[1],v=n[3],m=za(t),y=m[0],x=m[1],w=za(r),b=w[0],I=w[1],E=Lr(d,b),C=Lr(g,I),R=function(W,P,F,z,j,K,Y){var J,Z,ne;if("number"==typeof W){J={top:W,bottom:W,left:W,right:W,type:0===W?"VALID":"NUMBER"};var ce=function(ke,Ie,He,Ae,Te){null==Ae&&(Ae=Us(ke,Ie,He));var at=ke[1],it=Fo((ke[0]-Ie+2*Ae)/He+1,Te);S(Me(it),function(){return"The output # of rows ("+it+") must be an integer. Change the stride and/or zero pad parameters"});var Dn=Fo((at-Ie+2*Ae)/He+1,Te);return S(Me(Dn),function(){return"The output # of columns ("+Dn+") must be an integer. Change the stride and/or zero pad parameters"}),[it,Dn]}([P,F],K,z,W,a);Z=ce[0],ne=ce[1]}else if("same"===W){Z=Math.ceil(P/z),ne=Math.ceil(F/j);var me=Math.max(0,(Z-1)*z+K-P),ge=Math.max(0,(ne-1)*j+Y-F),ye=Math.floor(me/2),Be=me-ye,Ee=Math.floor(ge/2);J={top:ye,bottom:Be,left:Ee,right:ge-Ee,type:"SAME"}}else{if("valid"!==W)throw Error("Unknown padding parameter: "+W);J={top:0,bottom:0,left:0,right:0,type:"VALID"},Z=Math.ceil((P-K+1)/z),ne=Math.ceil((F-Y+1)/j)}return{padInfo:J,outHeight:Z,outWidth:ne}}(o,l,h,y,x,E,C),D=R.outHeight,N=R.outWidth,M=i?v*f:v;return"channelsFirst"===s?p=[c,M,D,N]:"channelsLast"===s&&(p=[c,D,N,M]),{batchSize:c,dataFormat:s,inHeight:l,inWidth:h,inChannels:f,outHeight:D,outWidth:N,outChannels:M,padInfo:R.padInfo,strideHeight:y,strideWidth:x,filterHeight:d,filterWidth:g,effectiveFilterHeight:E,effectiveFilterWidth:C,dilationHeight:b,dilationWidth:I,inShape:e,outShape:p,filterShape:n}}function No(e,n,t,r,o,a,i,s){void 0===a&&(a=!1),void 0===i&&(i="channelsLast");var u=[-1,-1,-1,-1,-1],c=u[0],l=u[1],h=u[2],f=u[3],p=u[4];if("channelsLast"===i)c=e[0],l=e[1],h=e[2],f=e[3],p=e[4];else{if("channelsFirst"!==i)throw new Error("Unknown dataFormat "+i);c=e[0],p=e[1],l=e[2],h=e[3],f=e[4]}var d,g=n[0],v=n[1],m=n[2],y=n[4],x=Vs(t),w=x[0],b=x[1],I=x[2],E=Vs(r),C=E[0],R=E[1],k=E[2],D=Lr(g,C),N=Lr(v,R),M=Lr(m,k),W=function(Y,J,Z,ne,ce,me,ge,ye,Be,Ee){var ke,Ie,He,Ae;if("number"==typeof Y){ke={top:Y,bottom:Y,left:Y,right:Y,front:Y,back:Y,type:0===Y?"VALID":"NUMBER"};var Te=function(St,fo,Pg,Dt,ca,Il){null==ca&&(ca=Us(St,fo,Dt));var Ux=St[1],Vx=St[2],Rl=Fo((St[0]-fo+2*ca)/Dt+1,Il);S(Me(Rl),function(){return"The output # of depths ("+Rl+") must be an integer. Change the stride and/or zero pad parameters"});var kl=Fo((Ux-fo+2*ca)/Dt+1,Il);S(Me(kl),function(){return"The output # of rows ("+kl+") must be an integer. Change the stride and/or zero pad parameters"});var Sl=Fo((Vx-fo+2*ca)/Dt+1,Il);return S(Me(Sl),function(){return"The output # of columns ("+Sl+") must be an integer. Change the stride and/or zero pad parameters"}),[Rl,kl,Sl,1]}([J,Z,ne,1],ye,0,ce,Y,s);Ie=Te[0],He=Te[1],Ae=Te[2]}else if("same"===Y){var at=((Ie=Math.ceil(J/ce))-1)*ce+ye-J,it=((He=Math.ceil(Z/me))-1)*me+Be-Z,Dn=((Ae=Math.ceil(ne/ge))-1)*ge+Ee-ne,Dr=Math.floor(at/2),nr=at-Dr,kt=Math.floor(it/2),tr=it-kt,$i=Math.floor(Dn/2);ke={top:kt,bottom:tr,left:$i,right:Dn-$i,front:Dr,back:nr,type:"SAME"}}else{if("valid"!==Y)throw Error("Unknown padding parameter: "+Y);ke={top:0,bottom:0,left:0,right:0,front:0,back:0,type:"VALID"},Ie=Math.ceil((J-ye+1)/ce),He=Math.ceil((Z-Be+1)/me),Ae=Math.ceil((ne-Ee+1)/ge)}return{padInfo:ke,outDepth:Ie,outHeight:He,outWidth:Ae}}(o,l,h,f,w,b,I,D,N,M),F=W.outDepth,z=W.outHeight,j=W.outWidth,K=a?y*p:y;return"channelsFirst"===i?d=[c,K,F,z,j]:"channelsLast"===i&&(d=[c,F,z,j,K]),{batchSize:c,dataFormat:i,inDepth:l,inHeight:h,inWidth:f,inChannels:p,outDepth:F,outHeight:z,outWidth:j,outChannels:K,padInfo:W.padInfo,strideDepth:w,strideHeight:b,strideWidth:I,filterDepth:g,filterHeight:v,filterWidth:m,effectiveFilterDepth:D,effectiveFilterHeight:N,effectiveFilterWidth:M,dilationDepth:C,dilationHeight:R,dilationWidth:k,inShape:e,outShape:d,filterShape:n}}function Us(e,n,t,r){void 0===r&&(r=1);var o=Lr(n,r);return Math.floor((e[0]*(t-1)-t+o)/2)}function za(e){return"number"==typeof e?[e,e,e]:2===e.length?[e[0],e[1],1]:e}function Vs(e){return"number"==typeof e?[e,e,e]:e}function Lr(e,n){return n<=1?e:e+(e-1)*(n-1)}function Fo(e,n){if(!n)return e;switch(n){case"round":return Math.round(e);case"ceil":return Math.ceil(e);case"floor":return Math.floor(e);default:throw new Error("Unknown roundingMode "+n)}}function dr(e){var n=za(e);return 1===n[0]&&1===n[1]&&1===n[2]}function hn(e,n){return dr(e)||dr(n)}function Ua(e){if("NHWC"===e)return"channelsLast";if("NCHW"===e)return"channelsFirst";throw new Error("Unknown dataFormat "+e)}function Gs(e,n,t){if("complex64"===n){if("complex64"===e.dtype)return e.clone();var r=Se(e.shape),o=e.toFloat(),a=t.complex(o,r);return r.dispose(),o.dispose(),a}if(!Ll(e.dtype,n))return A.makeTensorFromDataId(e.dataId,e.shape,n);if("complex64"===e.dtype){var i=t.real(e);return a=i.cast(n),i.dispose(),a}if("int32"===n)return t.int(e);if("bool"!==n)throw new Error("Error in Cast: failed to cast "+e.dtype+" to "+n);var s=$(0,e.dtype);return a=t.notEqual(e,s),s.dispose(),a}function Va(e,n){return A.makeTensorFromDataId(e.dataId,n,e.dtype)}function Hs(e,n,t){var r=(n-e)/(t-1),o=Mr(t,"float32");o[0]=e;for(var a=1;a<o.length;a++)o[a]=o[a-1]+r;return Pe(o,"float32")}var t0=Object.freeze({castTensor:Gs,reshapeTensor:Va,linspaceImpl:Hs,upcastType:Ye,axesAreInnerMostDims:Is,combineLocations:Rh,computeOutAndReduceShapes:en,expandShapeToKeepDim:cn,assertAxesAreInnerMostDims:pn,getAxesPermutation:On,getUndoAxesPermutation:Sa,getInnerMostAxes:Pn,getBroadcastDims:ht,getReductionAxes:Ve,assertAndGetBroadcastShape:ve,assertParamsConsistent:kh,computeOutShape:cr,computePool2DInfo:Br,computePool3DInfo:To,computeConv2DInfo:Pt,computeConv3DInfo:No,computeDefaultPad:Us,tupleValuesAreOne:dr,eitherStridesOrDilationsAreOne:hn,convertConv2DDataFormat:Ua,PARALLELIZE_THRESHOLD:30,computeOptimalWindowSize:Ba});function qs(e,n){if(e.length!==n.length)throw new Error("Cannot merge real and imag arrays of different lengths. real:"+e.length+", imag: "+n.length+".");for(var t=new Float32Array(2*e.length),r=0;r<t.length;r+=2)t[r]=e[r/2],t[r+1]=n[r/2];return t}function uf(e,n){return{real:e[2*n],imag:e[2*n+1]}}function r0(e,n){return n<e?1:e<n?-1:0}function js(e,n,t,r,o){return cf(e,n,t,r,o,0).selectedIndices}function Ks(e,n,t,r,o,a){var i=cf(e,n,t,r,o,a);return i.numValidOutputs.dispose(),{selectedIndices:i.selectedIndices,selectedScores:i.selectedScores}}function cf(e,n,t,r,o,a,i,s){void 0===s&&(s=!1);for(var u=Array.from(n).map(function(N,M){return{score:N,boxIndex:M,suppressBeginIndex:0}}).filter(function(N){return N.score>o}).sort(lf),c=0<a?-.5/a:0,l=[],h=[];l.length<t&&0<u.length;){var f=u.pop(),p=f.score,d=f.boxIndex,g=f.suppressBeginIndex;if(p<o)break;for(var v=!1,m=l.length-1;g<=m;--m){var y=o0(e,d,l[m]);if(r<=y){v=!0;break}if(f.score=f.score*(E=r,R=y,k=Math.exp(c*R*R),R<=E?k:0),f.score<=o)break}f.suppressBeginIndex=l.length,v||(f.score===p?(l.push(d),h.push(f.score)):f.score>o&&(b=function(N,M,W){for(var P=0,F=N.length,z=0,j=!1;P<F;){var K=W(M,N[z=P+(F-P>>>1)]);0<K?P=z+1:(F=z,j=!K)}return j?P:-P-1}(x=u,w=f,lf||r0),x.splice(b<0?-(b+1):b,0,w)))}var x,w,b,E,R,k,D=l.length;return s&&(l.fill(0,D),h.fill(0,D)),{selectedIndices:Pe(l,"int32"),selectedScores:Pe(h,"float32"),numValidOutputs:$(D,"int32")}}function o0(e,n,t){var r=e.subarray(4*n,4*n+4),o=e.subarray(4*t,4*t+4),a=Math.min(r[0],r[2]),i=Math.min(r[1],r[3]),s=Math.max(r[0],r[2]),u=Math.max(r[1],r[3]),c=Math.min(o[0],o[2]),l=Math.min(o[1],o[3]),h=Math.max(o[0],o[2]),f=Math.max(o[1],o[3]),p=(s-a)*(u-i),d=(h-c)*(f-l);if(p<=0||d<=0)return 0;var g=Math.max(a,c),v=Math.max(i,l),m=Math.min(s,h),y=Math.min(u,f),x=Math.max(m-g,0)*Math.max(y-v,0);return x/(p+d-x)}function lf(e,n){return e.score-n.score||e.score===n.score&&n.boxIndex-e.boxIndex}function hf(e,n,t){var r=new Array(e.rank).fill(0),o=e.shape.slice();return n.map(function(a){o[t]=a;var i=e.slice(r,o);return r[t]+=a,i})}function ff(e,n){for(var t=new Array(e.rank),r=0;r<t.length;r++)t[r]=e.shape[r]*n[r];var o=he(t,e.dtype);for(r=0;r<o.values.length;++r){for(var a=o.indexToLoc(r),i=new Array(e.rank),s=0;s<i.length;s++)i[s]=a[s]%e.shape[s];var u=e.locToIndex(i);o.values[r]=e.values[u]}return o.toTensor()}function pf(e,n,t,r){for(var o=n[n.length-1],a=[e.length/o,o],i=a[0],s=a[1],u=Nr(t,i*r),c=Nr("int32",i*r),l=0;l<i;l++){for(var h=l*s,f=e.subarray(h,h+s),p=[],d=0;d<f.length;d++)p.push({value:f[d],index:d});p.sort(function(x,w){return w.value-x.value});var g=l*r,v=u.subarray(g,g+r),m=c.subarray(g,g+r);for(d=0;d<r;d++)v[d]=p[d].value,m[d]=p[d].index}var y=n.slice();return y[y.length-1]=r,[Je(u,y,t),Je(c,y,"int32")]}function Xs(e,n){for(var t=[],r=0;r<n.length;r++)n[r]&&t.push(r);var o=he(e,"int32"),a=he([t.length,e.length],"int32");for(r=0;r<t.length;r++){var i=o.indexToLoc(t[r]);a.values.set(i,r*e.length)}return a.toTensor()}function a0(e,n){this.outputShape=[],this.outputShape=e,this.variableNames=n.map(function(o,a){return"T"+a});var t=[];this.variableNames.forEach(function(o){t.push("float v"+o+" = get"+o+"AtOutCoords();")});var r=this.variableNames.map(function(o){return"v"+o}).join(" + ");this.userCode="\n      void main() {\n        "+t.join("\n        ")+"\n\n        float result = "+r+";\n        setOutput(result);\n      }\n    "}function i0(e,n){this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e,this.variableNames=n.map(function(o,a){return"T"+a});var t=[];this.variableNames.forEach(function(o){t.push("vec4 v"+o+" = get"+o+"AtOutCoords();")});var r=this.variableNames.map(function(o){return"v"+o}).join(" + ");this.userCode="\n      void main() {\n        "+t.join("\n        ")+"\n\n        vec4 result = "+r+";\n        setOutput(result);\n      }\n    "}function s0(e,n,t){this.variableNames=["A"];var r=e.windowSize,o=e.batchSize,i=Math.ceil(e.inSize/r);t||this.variableNames.push("bestIndicesA"),this.outputShape=[o,i],this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+r+";\n\n        int bestIndex = inOffset;\n        float bestValue = getA(batch, bestIndex);\n\n        for (int i = 0; i < "+r+"; i++) {\n          int inIdx = "+(t?"inOffset + i;":"round(getBestIndicesA(batch, inOffset + i));")+";\n          float candidate = getA(batch, inIdx);\n          if (candidate "+("max"===n?">":"<")+" bestValue) {\n            bestValue = candidate;\n            bestIndex = inIdx;\n          }\n        }\n        setOutput(float(bestIndex));\n      }\n    "}function df(e,n){return["x","y","z","w","u","v"].slice(0,n).map(function(t){return e+"."+t})}function vn(e,n){return 1===n?[e]:df(e,n)}function an(){var e,n,t,r,o,a,i,s,u,c;return c=2===q().getNumber("WEBGL_VERSION")?(e="#version 300 es",t="out",r=n="in",o="texture",a="outputColor",i="out vec4 outputColor;",s="\n      bool isnan_custom(float val) {\n        return (val > 0.0 || val < 0.0) ? false : val != 0.0;\n      }\n\n      bvec4 isnan_custom(vec4 val) {\n        return bvec4(isnan_custom(val.x),\n          isnan_custom(val.y), isnan_custom(val.z), isnan_custom(val.w));\n      }\n\n      #define isnan(value) isnan_custom(value)\n    ",u="","\n      #define round(value) newRound(value)\n      int newRound(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 newRound(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "):(n="attribute",r=t="varying",o="texture2D",a="gl_FragColor",i=e="",s="\n      #define isnan(value) isnan_custom(value)\n      bool isnan_custom(float val) {\n        return (val > 0. || val < 1. || val == 0.) ? false : true;\n      }\n      bvec4 isnan_custom(vec4 val) {\n        return bvec4(isnan(val.x), isnan(val.y), isnan(val.z), isnan(val.w));\n      }\n    ",u="\n      uniform float INFINITY;\n\n      bool isinf(float val) {\n        return abs(val) == INFINITY;\n      }\n      bvec4 isinf(vec4 val) {\n        return equal(abs(val), vec4(INFINITY));\n      }\n    ","\n      int round(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 round(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "),{version:e,attribute:n,varyingVs:t,varyingFs:r,texture2D:o,output:a,defineOutput:i,defineSpecialNaN:s,defineSpecialInf:u,defineRound:c}}function vr(e,n,t){void 0===t&&(t="index");var r=Fn(n);return r.map(function(o,a){return"int "+e[a]+" = "+t+" / "+o+"; "+(a===r.length-1?"int "+e[a+1]+" = "+t+" - "+e[a]+" * "+o:"index -= "+e[a]+" * "+o)+";"}).join("")}function Ys(e){var n=Fn(e).map(function(t){return t.toString()});return"\n  int getFlatIndex(ivec3 coords) {\n    return coords.x * "+n[0]+" + coords.y * "+n[1]+" + coords.z;\n  }\n"}var vf="\n  const float FLOAT_MAX = 1.70141184e38;\n  const float FLOAT_MIN = 1.17549435e-38;\n\n  lowp vec4 encode_float(highp float v) {\n    if (isnan(v)) {\n      return vec4(255, 255, 255, 255);\n    }\n\n    highp float av = abs(v);\n\n    if(av < FLOAT_MIN) {\n      return vec4(0.0, 0.0, 0.0, 0.0);\n    } else if(v > FLOAT_MAX) {\n      return vec4(0.0, 0.0, 128.0, 127.0) / 255.0;\n    } else if(v < -FLOAT_MAX) {\n      return vec4(0.0, 0.0,  128.0, 255.0) / 255.0;\n    }\n\n    highp vec4 c = vec4(0,0,0,0);\n\n    highp float e = floor(log2(av));\n    highp float m = exp2(fract(log2(av))) - 1.0;\n\n    c[2] = floor(128.0 * m);\n    m -= c[2] / 128.0;\n    c[1] = floor(32768.0 * m);\n    m -= c[1] / 32768.0;\n    c[0] = floor(8388608.0 * m);\n\n    highp float ebias = e + 127.0;\n    c[3] = floor(ebias / 2.0);\n    ebias -= c[3] * 2.0;\n    c[2] += floor(ebias) * 128.0;\n\n    c[3] += 128.0 * step(0.0, -v);\n\n    return c / 255.0;\n  }\n";function mr(e){return"offset"+e}function Wr(e){var n=e.name,t=ie(e.shapeInfo.logicalShape);return t<2?"return "+n+";":"\n    for (int i = 0; i < "+t+"; i++) {\n      if (i == index) {\n        return "+n+"[i];\n      }\n    }\n  "}function De(e){if(e<=1)return"int";if(2===e)return"ivec2";if(3===e)return"ivec3";if(4===e)return"ivec4";if(5===e)return"ivec5";if(6===e)return"ivec6";throw Error("GPU for rank "+e+" is not yet supported")}function zr(e,n){var t=JSON.parse(JSON.stringify(e));return t.shapeInfo.logicalShape=n,t}function Ur(e,n){return n.map(function(t){return e[t]}).join(", ")}function c0(e,n,t,r){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,S(2<e.length,function(){return"Packed arg"+(t.charAt(0).toUpperCase()+t.slice(1))+" supports only inputs with rank above 2."});var a=Math.ceil(e[e.length-1]/n);this.outputShape=e.slice(0,-1),1<a&&this.outputShape.push(a),r||this.variableNames.push("bestIndicesA");var i,s,u=this.outputShape,c=u.length,l=De(c),h=vn("coords",c);if(1===a){var f=De(s=c+1);i="\n        "+f+" sourceLocR = "+f+"("+h.join()+", 0);\n        ++"+h[c-1]+";\n        "+f+" sourceLocG = "+f+"("+h.join()+", 0);\n        ++"+h[c-2]+";\n        "+f+" sourceLocA = "+f+"("+h.join()+", 0);\n        --"+h[c-1]+";\n        "+f+" sourceLocB = "+f+"("+h.join()+", 0);\n        --"+h[c-2]+";"}else i="\n        "+l+" sourceLocR = coords;\n        ++"+h[(s=c)-1]+";\n        "+l+" sourceLocG = coords;\n        ++"+h[c-2]+";\n        "+l+" sourceLocA = coords;\n        --"+h[c-1]+";\n        "+l+" sourceLocB = coords;\n        --"+h[c-2]+";";var p=["x","y","z","w","u","v"].slice(0,s),d="."+p[s-1],g=p.map(function(C){return"int "+C}),v=vn("sourceLocR",s-1).concat("inIdx.r"),m=vn("sourceLocG",s-1).concat("inIdx.g"),y=vn("sourceLocB",s-1).concat("inIdx.b"),x=vn("sourceLocA",s-1).concat("inIdx.a"),w="max"===t?"greaterThan":"lessThan",b=r?"":"\n          inIdx = round(vec4(getBestIndicesAChannel("+v.join()+"),\n                             getBestIndicesAChannel("+m.join()+"),\n                             getBestIndicesAChannel("+y.join()+"),\n                             getBestIndicesAChannel("+x.join()+")));",I="vec4(\n            getAChannel("+v.join()+"),\n            hasNextCol ? getAChannel("+m.join()+") : 0.,\n            hasNextRow ? getAChannel("+y.join()+") : 0.,\n            hasNextRow && hasNextCol ? getAChannel("+x.join()+") : 0.)",E=r?"":"\n      float getBestIndicesAChannel("+g.join()+") {\n        return getChannel(getBestIndicesA("+p.join()+"),\n                                          vec2("+p.slice(-2).join()+"));\n      }";this.userCode="\n      float getAChannel("+g.join()+") {\n        return getChannel(getA("+p.join()+"),\n                               vec2("+p.slice(-2).join()+"));\n      }\n      "+E+"\n      void main() {\n        "+l+" coords = getOutputCoords();\n        bool hasNextCol = "+h[c-1]+" < "+(u[c-1]-1)+";\n        bool hasNextRow = "+h[c-2]+" < "+(u[c-2]-1)+";\n        "+i+"\n        ivec4 srcIdx = ivec4(sourceLocR"+d+", sourceLocG"+d+",\n          sourceLocB"+d+", sourceLocA"+d+") * "+n+";\n        ivec4 inIdx = srcIdx;\n        vec4 bestIndex = vec4(inIdx);\n        vec4 bestValue = "+I+";\n\n        for (int i = 0; i < "+n+"; i++) {\n          inIdx = srcIdx;\n          "+b+"\n          vec4 candidate = "+I+";\n          bvec4 nan = isnan(candidate);\n          bvec4 replace = bvec4(\n            vec4("+w+"(candidate, bestValue)) * (vec4(1.0) - vec4(nan)));\n\n          bestValue = vec4(replace.x  ? candidate.x : bestValue.x,\n                           replace.y  ? candidate.y : bestValue.y,\n                           replace.z  ? candidate.z : bestValue.z,\n                           replace.w  ? candidate.w : bestValue.w);\n          bestIndex = mix(bestIndex, vec4(inIdx), vec4(replace));\n          srcIdx++;\n        }\n        setOutput(bestIndex);\n      }\n    "}function l0(e){this.variableNames=["dy"],this.outputShape=e.inShape;var s=e.effectiveFilterHeight,u=e.effectiveFilterWidth;this.userCode="\n      const ivec2 pads = ivec2("+(s-1-e.padInfo.top)+", "+(u-1-e.padInfo.left)+");\n      const float avgMultiplier = float("+1/(e.filterHeight*e.filterWidth)+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+s+";\n            wR += "+e.dilationHeight+") {\n          float dyR = float(dyRCorner + wR) / "+e.strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+e.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+u+";\n            wC+= "+e.dilationWidth+") {\n            float dyC = float(dyCCorner + wC) / "+e.strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+e.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n\n            dotProd += dyValue * avgMultiplier;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function h0(e){this.variableNames=["dy"],this.outputShape=e.inShape;var l=e.effectiveFilterDepth,h=e.effectiveFilterHeight,f=e.effectiveFilterWidth;this.userCode="\n      const ivec3 pads = ivec3("+(l-1-e.padInfo.front)+", "+(h-1-e.padInfo.top)+", "+(f-1-e.padInfo.left)+");\n      const float avgMultiplier = float("+1/(e.filterDepth*e.filterHeight*e.filterWidth)+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, d) with pos mask(:, :, :, ch) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+l+";\n            wD += "+e.dilationDepth+") {\n          float dyD = float(dyDCorner + wD) / "+e.strideDepth+".0;\n\n          if (dyD < 0.0 || dyD >= "+e.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+h+";\n              wR += "+e.dilationHeight+") {\n            float dyR = float(dyRCorner + wR) / "+e.strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+e.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+f+";\n                wC += "+e.dilationWidth+") {\n              float dyC = float(dyCCorner + wC) / "+e.strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+e.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n\n              dotProd += dyValue * avgMultiplier;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function f0(e,n,t,r,o,a){this.outputShape=[],this.variableNames=["x","mean","variance"],ve(e,n),ve(e,t);var i="0.0";null!=r&&(ve(e,r),this.variableNames.push("offset"),i="getOffsetAtOutCoords()");var s="1.0";null!=o&&(ve(e,o),this.variableNames.push("scale"),s="getScaleAtOutCoords()"),this.outputShape=e,this.userCode="\n      void main() {\n        float x = getXAtOutCoords();\n        float mean = getMeanAtOutCoords();\n        float variance = getVarianceAtOutCoords();\n        float offset = "+i+";\n        float scale = "+s+";\n        float inv = scale * inversesqrt(variance + float("+a+"));\n        setOutput(dot(vec3(x, -mean, offset), vec3(inv, inv, 1)));\n      }\n    "}function p0(e,n,t,r,o,a){this.packedInputs=!0,this.packedOutput=!0,this.variableNames=["x","mean","variance"],ve(e,n),ve(e,t);var i="vec4(0.0)";null!=r&&(ve(e,r),this.variableNames.push("offset"),i="getOffsetAtOutCoords()");var s="vec4(1.0)";null!=o&&(ve(e,o),this.variableNames.push("scale"),s="getScaleAtOutCoords()"),this.outputShape=e,this.userCode="\n      void main() {\n        vec4 offset = "+i+";\n        vec4 scale = "+s+";\n\n        vec4 x = getXAtOutCoords();\n        vec4 mean = getMeanAtOutCoords();\n        vec4 variance = getVarianceAtOutCoords();\n\n        vec4 inv = scale * inversesqrt(variance + vec4("+a+"));\n\n        setOutput((x - mean) * inv + offset);\n      }\n    "}function mf(e,n,t){this.variableNames=["AReal","AImag","BReal","BImag"],this.outputShape=ve(n,t),this.userCode="\n      float binaryOpComplex(\n          float areal, float aimag, float breal, float bimag) {\n        "+e+"\n      }\n\n      void main() {\n        float areal = getARealAtOutCoords();\n        float aimag = getAImagAtOutCoords();\n        float breal = getBRealAtOutCoords();\n        float bimag = getBImagAtOutCoords();\n        setOutput(binaryOpComplex(areal, aimag, breal, bimag));\n      }\n    "}function Oe(e,n,t){this.variableNames=["A","B"],this.outputShape=ve(n,t),this.userCode="\n      float binaryOperation(float a, float b) {\n        "+e+"\n      }\n\n      void main() {\n        float a = getAAtOutCoords();\n        float b = getBAtOutCoords();\n        setOutput(binaryOperation(a, b));\n      }\n    "}function ft(e,n,t,r){void 0===r&&(r=!1),this.variableNames=["A","B"],this.supportsBroadcasting=!0,this.packedInputs=!0,this.packedOutput=!0,this.outputShape=ve(n,t);var o=this.outputShape.length,a="";if(r)if(0===o||1===ie(this.outputShape))a="\n          result.y = 0.;\n          result.z = 0.;\n          result.w = 0.;\n        ";else if(a="\n          "+De(o)+" coords = getOutputCoords();\n        ",1===o)a+="\n            result.y = (coords + 1) >= "+this.outputShape[0]+" ? 0. : result.y;\n            result.z = 0.;\n            result.w = 0.;\n          ";else{var i=vn("coords",o);a+="\n            bool nextRowOutOfBounds =\n              ("+i[o-2]+" + 1) >= "+this.outputShape[o-2]+";\n            bool nextColOutOfBounds =\n              ("+i[o-1]+" + 1) >= "+this.outputShape[o-1]+";\n            result.y = nextColOutOfBounds ? 0. : result.y;\n            result.z = nextRowOutOfBounds ? 0. : result.z;\n            result.w = nextColOutOfBounds || nextRowOutOfBounds ? 0. : result.w;\n          "}this.userCode="\n      vec4 binaryOperation(vec4 a, vec4 b) {\n        "+e+"\n      }\n\n      void main() {\n        vec4 a = getAAtOutCoords();\n        vec4 b = getBAtOutCoords();\n\n        vec4 result = binaryOperation(a, b);\n        "+a+"\n\n        setOutput(result);\n      }\n    "}function d0(e){this.variableNames=["real","imag"],this.outputShape=e,this.userCode="\n      void main() {\n        float re = abs(getRealAtOutCoords());\n        float im = abs(getImagAtOutCoords());\n        float mx = max(re, im);\n\n        // sadly the length function in glsl is not underflow-safe\n        // (at least not on Intel GPUs). So the safe solution is\n        // to ensure underflow-safety in all cases.\n        setOutput(\n          mx == 0.0 ? 0.0 : mx * length(vec2(1, min(re, im)/mx))\n        );\n      }\n    "}function v0(e){this.outputShape=[],this.outputShape=cr(e,1),this.variableNames=e.map(function(s,u){return"T"+u});var n=new Array(e.length-1);n[0]=e[0][1];for(var t=1;t<n.length;t++)n[t]=n[t-1]+e[t][1];var r=["if (yC < "+n[0]+") setOutput(getT0(yR, yC));"];for(t=1;t<n.length;t++)r.push("else if (yC < "+n[t]+") setOutput(getT"+t+"(yR, yC-"+n[t-1]+"));");r.push("else setOutput(getT"+n.length+"(yR, yC-"+n[n.length-1]+"));"),this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int yR = coords.x;\n        int yC = coords.y;\n\n        "+r.join("\n        ")+"\n      }\n    "}function m0(e,n){this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[],this.outputShape=cr(e,n);var t=this.outputShape,r=t.length,o=De(r),a=vn("coords",r),i=["x","y","z","w","u","v"].slice(0,r);this.variableNames=e.map(function(v,m){return"T"+m});var s=new Array(e.length-1);s[0]=e[0][n];for(var u=1;u<s.length;u++)s[u]=s[u-1]+e[u][n];var c=i[n],l=i.slice(-2),h=i.join(),f="if ("+c+" < "+s[0]+") {\n        return getChannel(\n            getT0("+h+"), vec2("+l.join()+"));\n        }";for(u=1;u<s.length;u++){var p=s[u-1];f+="\n        if ("+c+" < "+s[u]+"  && "+c+" >= "+s[u-1]+") {\n          return getChannel(\n            getT"+u+"("+Ga(i,c,p)+"),\n            vec2("+Ga(l,c,p)+"));\n        }"}var g=s[s.length-1];f+="\n        return getChannel(\n          getT"+s.length+"("+Ga(i,c,g)+"),\n          vec2("+Ga(l,c,g)+"));",this.userCode="\n      float getValue("+i.map(function(v){return"int "+v})+") {\n        "+f+"\n      }\n\n      void main() {\n        "+o+" coords = getOutputCoords();\n        vec4 result = vec4(getValue("+a+"), 0., 0., 0.);\n\n        "+a[r-1]+" = "+a[r-1]+" + 1;\n        if ("+a[r-1]+" < "+t[r-1]+") {\n          result.g = getValue("+a+");\n        }\n\n        "+a[r-2]+" = "+a[r-2]+" + 1;\n        if ("+a[r-2]+" < "+t[r-2]+") {\n          result.a = getValue("+a+");\n        }\n\n        "+a[r-1]+" = "+a[r-1]+" - 1;\n        if ("+a[r-2]+" < "+t[r-2]+" &&\n            "+a[r-1]+" < "+t[r-1]+") {\n          result.b = getValue("+a+");\n        }\n        setOutput(result);\n      }\n    "}var $s="return a + b;",Js="return a - b;",gf="return a * b;",yf="return (a < 0.) ? b * a : a;",xf="\n  vec4 aLessThanZero = vec4(lessThan(a, vec4(0.)));\n  return (aLessThanZero * (b * a)) + ((vec4(1.0) - aLessThanZero) * a);\n",g0=(wf.prototype.getCustomSetupFunc=function(e,n){var t=this;return function(r,o){null==t.minLoc&&(t.minLoc=r.getUniformLocationNoThrow(o,"minVal"),t.maxLoc=r.getUniformLocationNoThrow(o,"maxVal")),r.gl.uniform1f(t.minLoc,e),r.gl.uniform1f(t.maxLoc,n)}},wf),y0=(bf.prototype.getCustomSetupFunc=function(e,n){var t=this;return function(r,o){null==t.minLoc&&(t.minLoc=r.getUniformLocationNoThrow(o,"minVal"),t.maxLoc=r.getUniformLocationNoThrow(o,"maxVal")),r.gl.uniform1f(t.minLoc,e),r.gl.uniform1f(t.maxLoc,n)}},bf);function bf(e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        vec4 value = getAAtOutCoords();\n\n        if (any(isnan(value))) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, vec4(minVal), vec4(maxVal)));\n      }\n    "}function wf(e){this.variableNames=["A"],this.outputShape=e,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        float value = getAAtOutCoords();\n        if (isnan(value)) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, minVal, maxVal));\n      }\n    "}function Ga(e,n,t){var r=e.indexOf(n);return e.map(function(o,a){return a===r?o+" - "+t:o}).join()}function x0(e){this.variableNames=["x","dy"],this.outputShape=e.filterShape,this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int d2 = coords.w;\n\n        // Convolve x(?, ?, d1) with dy(:, :, d2) to get dw(wR, wC, d1, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+e.batchSize+"; b++) {\n          for (int yR = 0; yR < "+e.outHeight+"; yR++) {\n            int xR = wR + yR * "+e.strideHeight+" - "+e.padInfo.top+";\n\n            if (xR < 0 || xR >= "+e.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+e.outWidth+"; yC++) {\n              int xC = wC + yC * "+e.strideWidth+" - "+e.padInfo.left+";\n\n              if (xC < 0 || xC >= "+e.inWidth+") {\n                continue;\n              }\n\n              if ("+("channelsLast"===e.dataFormat)+") {\n                float dyValue = getDy(b, yR, yC, d2);\n                float xValue = getX(b, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              } else {\n                float dyValue = getDy(b, d2, yR, yC);\n                float xValue = getX(b, d1, xR, xC);\n                dotProd += (xValue * dyValue);\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function b0(e){this.variableNames=["dy","W"],this.outputShape=e.inShape;var n=e.filterHeight,t=e.filterWidth,a="channelsLast"===e.dataFormat;this.userCode="\n      const ivec2 pads = ivec2("+(n-1-e.padInfo.top)+", "+(t-1-e.padInfo.left)+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords["+(a?3:1)+"];\n\n        ivec2 dyCorner = ivec2(coords["+(a?1:2)+"], coords["+(a?2:3)+"]) - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        // Convolve dy(?, ?, d2) with w(:, :, d1, d2) to compute dx(xR, xC, d1).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+n+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+e.strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+e.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+n+" - 1 - wR;\n\n          for (int wC = 0; wC < "+t+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+e.strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+e.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+t+" - 1 - wC;\n\n            for (int d2 = 0; d2 < "+e.outChannels+"; d2++) {\n\n              if ("+a+") {\n                float xValue = getDy(batch, idyR, idyC, d2);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              } else {\n                float xValue = getDy(batch, d2, idyR, idyC);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function w0(e){this.variableNames=["x","dy"],this.outputShape=e.filterShape,this.userCode="\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int wF = coords.x;\n        int wR = coords.y;\n        int wC = coords.z;\n        int d1 = coords.w;\n        int d2 = coords.u;\n\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+e.batchSize+"; b++) {\n          for (int yF = 0; yF < "+e.outDepth+"; yF++) {\n            int xF = wF + yF * "+e.strideDepth+" - "+e.padInfo.front+";\n\n            if (xF < 0 || xF >= "+e.inDepth+") {\n              continue;\n            }\n\n            for (int yR = 0; yR < "+e.outHeight+"; yR++) {\n              int xR = wR + yR * "+e.strideHeight+" - "+e.padInfo.top+";\n\n              if (xR < 0 || xR >= "+e.inHeight+") {\n                continue;\n              }\n\n              for (int yC = 0; yC < "+e.outWidth+"; yC++) {\n                int xC = wC + yC * "+e.strideWidth+" - "+e.padInfo.left+";\n\n                if (xC < 0 || xC >= "+e.inWidth+") {\n                  continue;\n                }\n\n                float dyValue = getDy(b, yF, yR, yC, d2);\n                float xValue = getX(b, xF, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function C0(e){this.variableNames=["dy","W"],this.outputShape=e.inShape;var n=e.filterDepth,t=e.filterHeight,r=e.filterWidth;this.userCode="\n      const ivec3 pads = ivec3("+(n-1-e.padInfo.front)+", "+(t-1-e.padInfo.top)+", "+(r-1-e.padInfo.left)+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d1 = coords.u;\n\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyFCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+n+"; wF++) {\n          float dyF = float(dyFCorner + wF) / "+e.strideDepth+".0;\n\n          if (dyF < 0.0 || dyF >= "+e.outDepth+".0 || fract(dyF) > 0.0) {\n            continue;\n          }\n          int idyF = int(dyF);\n\n          int wFPerm = "+n+" - 1 - wF;\n\n          for (int wR = 0; wR < "+t+"; wR++) {\n            float dyR = float(dyRCorner + wR) / "+e.strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+e.outHeight+".0 ||\n              fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            int wRPerm = "+t+" - 1 - wR;\n\n            for (int wC = 0; wC < "+r+"; wC++) {\n              float dyC = float(dyCCorner + wC) / "+e.strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+e.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              int wCPerm = "+r+" - 1 - wC;\n\n              for (int d2 = 0; d2 < "+e.outChannels+"; d2++) {\n                float xValue = getDy(batch, idyF, idyR, idyC, d2);\n                float wValue = getW(wFPerm, wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function E0(e){this.variableNames=["x","dy"],this.outputShape=e.filterShape,this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int dm = coords.w;\n        int d2 = d1 * "+e.outChannels/e.inChannels+" + dm;\n\n        float dotProd = 0.0;\n\n        // TO DO: Vec4 over the batch size\n        for (int b = 0; b < "+e.batchSize+"; b++) {\n          for (int yR = 0; yR < "+e.outHeight+"; yR++) {\n            int xR = wR + yR * "+e.strideHeight+" - "+e.padInfo.top+";\n\n            if (xR < 0 || xR >= "+e.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+e.outWidth+"; yC++) {\n              int xC = wC + yC * "+e.strideWidth+" - "+e.padInfo.left+";\n\n              if (xC < 0 || xC >= "+e.inWidth+") {\n                continue;\n              }\n\n              float dyValue = getDy(b, yR, yC, d2);\n              float xValue = getX(b, xR, xC, d1);\n              dotProd += (xValue * dyValue);\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function _0(e){this.variableNames=["dy","W"],this.outputShape=e.inShape;var n=e.filterHeight,t=e.filterWidth,s=e.outChannels/e.inChannels;this.userCode="\n      const ivec2 pads = ivec2("+(n-1-e.padInfo.top)+", "+(t-1-e.padInfo.left)+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords[3];\n        ivec2 dyCorner = coords.yz - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        float dotProd = 0.0;\n\n        for (int wR = 0; wR < "+n+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+e.strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+e.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+n+" - 1 - wR;\n\n          for (int wC = 0; wC < "+t+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+e.strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+e.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+t+" - 1 - wC;\n\n            // TO DO: Vec4 over the channelMul\n            for (int dm = 0; dm < "+s+"; dm++) {\n              int d2 = d1 * "+s+" + dm;\n              float xValue = getDy(batch, idyR, idyC, d2);\n              float wValue = getW(wRPerm, wCPerm, d1, dm);\n              dotProd += xValue * wValue;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function Cf(e,n,t,r){void 0===n&&(n=!1),void 0===t&&(t=null),void 0===r&&(r=!1),this.variableNames=["x","W"],this.outputShape=e.outShape;var o=e.padInfo.top,a=e.padInfo.left,i=e.strideHeight,s=e.strideWidth,u=e.dilationHeight,c=e.dilationWidth,l=e.filterHeight,h=e.filterWidth,f=4*Math.floor(e.inChannels/4),p=e.inChannels%4,d="channelsLast"===e.dataFormat,g=d?1:2,v=d?2:3,m=d?3:1,y="",x="";t&&(y=r?"float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          "+t+"\n        }":"\n          float activation(float x) {\n            "+t+"\n          }\n        ",x="result = activation(result);");var w=n?"result += getBiasAtOutCoords();":"";n&&this.variableNames.push("bias"),r&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+y+"\n\n      const ivec2 strides = ivec2("+i+", "+s+");\n      const ivec2 pads = ivec2("+o+", "+a+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d2 = coords["+m+"];\n\n        ivec2 xRCCorner =\n            ivec2(coords["+g+"], coords["+v+"]) * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, d2) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+l+"; wR++) {\n          int xR = xRCorner + wR * "+u+";\n\n          if (xR < 0 || xR >= "+e.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+h+"; wC++) {\n            int xC = xCCorner + wC * "+c+";\n\n            if (xC < 0 || xC >= "+e.inWidth+") {\n              continue;\n            }\n\n            for (int d1 = 0; d1 < "+f+"; d1 += 4) {\n              vec4 wValues = vec4(\n                getW(wR, wC, d1, d2),\n                getW(wR, wC, d1 + 1, d2),\n                getW(wR, wC, d1 + 2, d2),\n                getW(wR, wC, d1 + 3, d2)\n              );\n\n              if ("+d+") {\n                vec4 xValues = vec4(\n                  getX(batch, xR, xC, d1),\n                  getX(batch, xR, xC, d1 + 1),\n                  getX(batch, xR, xC, d1 + 2),\n                  getX(batch, xR, xC, d1 + 3)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec4 xValues = vec4(\n                  getX(batch, d1, xR, xC),\n                  getX(batch, d1 + 1, xR, xC),\n                  getX(batch, d1 + 2, xR, xC),\n                  getX(batch, d1 + 3, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n\n            if ("+(1==p)+") {\n\n              if ("+d+") {\n                dotProd +=\n                    getX(batch, xR, xC, "+f+") *\n                    getW(wR, wC, "+f+", d2);\n              } else {\n                dotProd +=\n                    getX(batch, "+f+", xR, xC) *\n                    getW(wR, wC, "+f+", d2);\n              }\n\n            } else if ("+(2==p)+") {\n              vec2 wValues = vec2(\n                getW(wR, wC, "+f+", d2),\n                getW(wR, wC, "+f+" + 1, d2)\n              );\n\n              if ("+d+") {\n                vec2 xValues = vec2(\n                  getX(batch, xR, xC, "+f+"),\n                  getX(batch, xR, xC, "+f+" + 1)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec2 xValues = vec2(\n                  getX(batch, "+f+", xR, xC),\n                  getX(batch, "+f+" + 1, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            } else if ("+(3==p)+") {\n              vec3 wValues = vec3(\n                getW(wR, wC, "+f+", d2),\n                getW(wR, wC, "+f+" + 1, d2),\n                getW(wR, wC, "+f+" + 2, d2)\n              );\n\n              if ("+d+") {\n                vec3 xValues = vec3(\n                  getX(batch, xR, xC, "+f+"),\n                  getX(batch, xR, xC, "+f+" + 1),\n                  getX(batch, xR, xC, "+f+" + 2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec3 xValues = vec3(\n                  getX(batch, "+f+", xR, xC),\n                  getX(batch, "+f+" + 1, xR, xC),\n                  getX(batch, "+f+" + 2, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            }\n          }\n        }\n\n        float result = dotProd;\n        "+w+"\n        "+x+"\n        setOutput(result);\n      }\n    "}function I0(e){this.variableNames=["x","W"],this.outputShape=e.outShape;var n=e.padInfo.front,t=e.padInfo.top,r=e.padInfo.left,o=e.strideDepth,a=e.strideHeight,i=e.strideWidth,s=e.dilationDepth,u=e.dilationHeight,c=e.dilationWidth,l=e.filterDepth,h=e.filterHeight,f=e.filterWidth,p=4*Math.floor(e.inChannels/4),d=e.inChannels%4;this.userCode="\n      const ivec3 strides = ivec3("+o+", "+a+", "+i+");\n      const ivec3 pads = ivec3("+n+", "+t+", "+r+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d2 = coords.u;\n\n        ivec3 xFRCCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xFCorner = xFRCCorner.x;\n        int xRCorner = xFRCCorner.y;\n        int xCCorner = xFRCCorner.z;\n\n        // Convolve x(?, ?, ?, d1) with w(:, :, :, d1, d2) to get\n        // y(yF, yR, yC, d2). ? = to be determined. : = across all\n        // values in that axis.\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+l+"; wF++) {\n          int xF = xFCorner + wF * "+s+";\n\n          if (xF < 0 || xF >= "+e.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+h+"; wR++) {\n            int xR = xRCorner + wR * "+u+";\n\n            if (xR < 0 || xR >= "+e.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+f+"; wC++) {\n              int xC = xCCorner + wC * "+c+";\n\n              if (xC < 0 || xC >= "+e.inWidth+") {\n                continue;\n              }\n\n              for (int d1 = 0; d1 < "+p+"; d1 += 4) {\n                vec4 xValues = vec4(\n                  getX(batch, xF, xR, xC, d1),\n                  getX(batch, xF, xR, xC, d1 + 1),\n                  getX(batch, xF, xR, xC, d1 + 2),\n                  getX(batch, xF, xR, xC, d1 + 3)\n                );\n                vec4 wValues = vec4(\n                  getW(wF, wR, wC, d1, d2),\n                  getW(wF, wR, wC, d1 + 1, d2),\n                  getW(wF, wR, wC, d1 + 2, d2),\n                  getW(wF, wR, wC, d1 + 3, d2)\n                );\n\n                dotProd += dot(xValues, wValues);\n              }\n\n              if ("+(1==d)+") {\n                dotProd +=\n                  getX(batch, xF, xR, xC, "+p+") *\n                  getW(wF, wR, wC, "+p+", d2);\n              } else if ("+(2==d)+") {\n                vec2 xValues = vec2(\n                  getX(batch, xF, xR, xC, "+p+"),\n                  getX(batch, xF, xR, xC, "+p+" + 1)\n                );\n                vec2 wValues = vec2(\n                  getW(wF, wR, wC, "+p+", d2),\n                  getW(wF, wR, wC, "+p+" + 1, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else if ("+(3==d)+") {\n                vec3 xValues = vec3(\n                  getX(batch, xF, xR, xC, "+p+"),\n                  getX(batch, xF, xR, xC, "+p+" + 1),\n                  getX(batch, xF, xR, xC, "+p+" + 2)\n                );\n                vec3 wValues = vec3(\n                  getW(wF, wR, wC, "+p+", d2),\n                  getW(wF, wR, wC, "+p+" + 1, d2),\n                  getW(wF, wR, wC, "+p+" + 2, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function Ef(e,n,t,r){void 0===n&&(n=!1),void 0===t&&(t=null),void 0===r&&(r=!1),this.variableNames=["x","W"],this.outputShape=e.outShape;var o=e.inHeight,a=e.inWidth,i=e.padInfo.top,s=e.padInfo.left,u=e.strideHeight,c=e.strideWidth,l=e.dilationHeight,h=e.dilationWidth,f=e.filterHeight,p=e.filterWidth,d=e.outChannels/e.inChannels,g="",v="";t&&(g=r?"float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          "+t+"\n        }":"\n          float activation(float x) {\n            "+t+"\n          }\n        ",v="result = activation(result);");var m=n?"result += getBiasAtOutCoords();":"";n&&this.variableNames.push("bias"),r&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+g+"\n\n      const ivec2 strides = ivec2("+u+", "+c+");\n      const ivec2 pads = ivec2("+i+", "+s+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2 / "+d+";\n        int q = d2 - d1 * "+d+";\n\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, q) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        // TO DO(dsmilkov): Flatten the two for loops and vec4 the operations.\n        for (int wR = 0; wR < "+f+"; wR++) {\n          int xR = xRCorner + wR * "+l+";\n\n          if (xR < 0 || xR >= "+o+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+p+"; wC++) {\n            int xC = xCCorner + wC * "+h+";\n\n            if (xC < 0 || xC >= "+a+") {\n              continue;\n            }\n\n            float xVal = getX(batch, xR, xC, d1);\n            float wVal = getW(wR, wC, d1, q);\n            dotProd += xVal * wVal;\n          }\n        }\n\n        float result = dotProd;\n        "+m+"\n        "+v+"\n        setOutput(result);\n      }\n    "}function _f(e,n,t,r){void 0===n&&(n=!1),void 0===t&&(t=null),void 0===r&&(r=!1),this.variableNames=["x","W"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e.outShape;for(var o=e.inHeight,a=e.inWidth,i=e.padInfo.top,s=e.padInfo.left,u=e.strideHeight,c=e.strideWidth,l=e.dilationHeight,h=e.dilationWidth,f=e.filterHeight,p=e.filterWidth,d=p,g="int xR; int xC; int xCOffset;",v=0;v<f;v++)for(var m=0;m<p;m++)g+="\n          vec4 xTexelR"+v+"C"+2*m+" = vec4(0.);\n          vec4 wR"+v+"C"+m+" = vec4(0.);\n          vec4 xR"+v+"C"+m+" = vec4(0.);";for(v=0;v<f;v++)for(var y=0;y<d;y++){if(g+="\n          xR = xRCorner + "+v*l+";\n          xC = xCCorner + "+(m=2*y)*h+";\n        ",1===c){if(m<p&&(g+=s%2==1?"\n                xCOffset = xC + 1;\n                if(xR >= 0 && xR < "+o+" && xCOffset >= 0 && xCOffset < "+a+") {\n                  xTexelR"+v+"C"+m+" = getX(batch, xR, xCOffset, d1);\n\n                  // Need to manually clear unused channels in case\n                  // we're reading from recycled texture.\n                  if(xCOffset + 1 >= "+a+") {\n                    xTexelR"+v+"C"+m+".zw = vec2(0.);\n                  }\n                } else {\n                  xTexelR"+v+"C"+m+" = vec4(0.);\n                }\n\n                xCOffset = xC + 1 - 2;\n                if(xR >= 0 && xR < "+o+" && xCOffset >= 0 && xCOffset < "+a+") {\n                  vec4 previous = getX(batch, xR, xCOffset, d1);\n\n                  // Need to manually clear unused channels in case\n                  // we're reading from recycled texture.\n                  if(xCOffset + 1 >= "+a+") {\n                    previous.zw = vec2(0.);\n                  }\n\n                  xR"+v+"C"+m+" = vec4(previous.zw, xTexelR"+v+"C"+m+".xy);\n                } else {\n                  xR"+v+"C"+m+" = vec4(0, 0, xTexelR"+v+"C"+m+".xy);\n                }\n              ":"\n                if(xR >= 0 && xR < "+o+" && xC >= 0 && xC < "+a+") {\n                  xTexelR"+v+"C"+m+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+v+"C"+m+" = vec4(0.);\n                }\n\n                xR"+v+"C"+m+" = xTexelR"+v+"C"+m+";\n              ",m+1<p)){var x=s%2==0?ts(h):h;h%2==0&&s%2==1||h%2!=0&&s%2!=1?(g+="\n                  xCOffset = xC + "+s%2+" + "+x+";\n\n                  if(xR >= 0 && xR < "+o+" &&\n                    xCOffset >= 0 && xCOffset < "+a+") {\n                    xTexelR"+v+"C"+(m+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n                ",1<h&&(g+="\n                    xCOffset -= 2;\n                    if(xR >= 0 && xR < "+o+" &&\n                      xCOffset >= 0 && xCOffset < "+a+") {\n                      xTexelR"+v+"C"+m+" = getX(batch, xR, xCOffset, d1);\n                    } else {\n                      xTexelR"+v+"C"+m+" = vec4(0.);\n                    }\n                  "),g+="\n                  xR"+v+"C"+(m+1)+" = vec4(\n                    xTexelR"+v+"C"+m+".zw, xTexelR"+v+"C"+(m+2)+".xy);\n                "):g+="\n                  xCOffset = xC + "+x+";\n\n                  if(xR >= 0 && xR < "+o+" &&\n                    xCOffset >= 0 && xCOffset < "+a+") {\n                    xTexelR"+v+"C"+(m+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n\n                  xR"+v+"C"+(m+1)+" = xTexelR"+v+"C"+(m+2)+";\n                "}}else m<p&&(g+="\n              if(xR >= 0 && xR < "+o+") {\n            ",s%2==1?(g+="\n                xCOffset = xC + 1 - "+c+";\n                if(xCOffset >= 0 && xCOffset < "+a+") {\n                  xTexelR"+v+"C"+m+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+v+"C"+m+" = vec4(0.);\n                }\n\n                if(xC + 1 >= 0 && xC + 1 < "+a+") {\n                  xTexelR"+v+"C"+(m+2)+" = getX(batch, xR, xC + 1, d1);\n                } else {\n                  xTexelR"+v+"C"+(m+2)+" = vec4(0.);\n                }\n\n                xR"+v+"C"+m+" = vec4(\n                  xTexelR"+v+"C"+m+".zw, xTexelR"+v+"C"+(m+2)+".zw);\n              ",m+1<p&&(g+="\n                  vec4 final = vec4(0.);\n                  xCOffset = xC + 1 + "+c+";\n                  if(xCOffset >= 0 && xCOffset < "+a+") {\n                    final = getX(batch, xR, xCOffset, d1);\n                  }\n                  xR"+v+"C"+(m+1)+" = vec4(xTexelR"+v+"C"+(m+2)+".xy, final.xy);\n                ")):(g+="\n                if(xC >= 0 && xC < "+a+") {\n                  xTexelR"+v+"C"+m+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+v+"C"+m+" = vec4(0.);\n                }\n\n                xCOffset = xC + "+c+";\n                if(xCOffset >= 0 && xCOffset < "+a+") {\n                  xTexelR"+v+"C"+(m+2)+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+v+"C"+(m+2)+" = vec4(0.);\n                }\n\n                xR"+v+"C"+m+" = vec4(\n                  xTexelR"+v+"C"+m+".xy, xTexelR"+v+"C"+(m+2)+".xy);\n              ",m+1<p&&(g+="\n                  xR"+v+"C"+(m+1)+" = vec4(\n                    xTexelR"+v+"C"+m+".zw, xTexelR"+v+"C"+(m+2)+".zw);\n                ")),g+="}");m<p&&(g+="\n            vec4 wTexelR"+v+"C"+m+" = getW("+v+", "+m+", d1, q);\n            wR"+v+"C"+m+" = vec4(wTexelR"+v+"C"+m+".xz, wTexelR"+v+"C"+m+".xz);\n          ",m+1<p&&(g+="\n              vec4 wTexelR"+v+"C"+(m+1)+" = getW("+v+", "+(m+1)+", d1, q);\n              wR"+v+"C"+(m+1)+" =\n                vec4(wTexelR"+v+"C"+(m+1)+".xz, wTexelR"+v+"C"+(m+1)+".xz);"))}for(v=0;v<f;v++)for(m=0;m<p;m++)g+="dotProd += xR"+v+"C"+m+" * wR"+v+"C"+m+";";var w="",b="";t&&(w=r?"vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          "+t+"\n        }":"vec4 activation(vec4 x) {\n          "+t+"\n        }",b="result = activation(result);");var I=n?"result += getBiasAtOutCoords();":"";n&&this.variableNames.push("bias"),r&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+w+"\n\n      const ivec2 strides = ivec2("+u+", "+c+");\n      const ivec2 pads = ivec2("+i+", "+s+");\n\n      void main() {\n\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2;\n        int q = 0;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        vec4 dotProd = vec4(0.);\n\n        "+g+"\n\n        vec4 result = dotProd;\n        "+I+"\n        "+b+"\n        setOutput(result);\n      }\n    "}function R0(e,n,t,r,o){this.variableNames=["Image","Boxes","BoxInd"],this.outputShape=[];var a=e[0],i=e[1],s=e[2],l=t[0],h=t[1];this.outputShape=[n[0],l,h,e[3]];var p=[i-1+".0",s-1+".0"],d=p[0],g=p[1],v=1<l?[""+(i-1)/(l-1),"(y2-y1) * height_ratio","y1*"+d+" + float(y)*(height_scale)"]:["0.0","0.0","0.5 * (y1+y2) * "+d],w=1<h?[""+(s-1)/(h-1),"(x2-x1) * width_ratio","x1*"+g+" + float(x)*(width_scale)"]:["0.0","0.0","0.5 * (x1+x2) * "+g];this.userCode="\n      const float height_ratio = float("+v[0]+");\n      const float width_ratio = float("+w[0]+");\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int y = coords[1];\n        int x = coords[2];\n        int d = coords[3];\n\n        // get box vals\n        float y1 = getBoxes(b,0);\n        float x1 = getBoxes(b,1);\n        float y2 = getBoxes(b,2);\n        float x2 = getBoxes(b,3);\n\n        // get image in batch index\n        int bInd = round(getBoxInd(b));\n        if(bInd < 0 || bInd >= "+a+") {\n          return;\n        }\n\n        float height_scale = "+v[1]+";\n        float width_scale = "+w[1]+";\n\n        float in_y = "+v[2]+";\n        if( in_y < 0.0 || in_y > "+d+" ) {\n          setOutput(float("+o+"));\n          return;\n        }\n        float in_x = "+w[2]+";\n        if( in_x < 0.0 || in_x > "+g+" ) {\n          setOutput(float("+o+"));\n          return;\n        }\n\n        vec2 sourceFracIndexCR = vec2(in_x,in_y);\n        if("+("bilinear"===r?1:0)+" == 1) {\n          // Compute the four integer indices.\n          ivec2 sourceFloorCR = ivec2(sourceFracIndexCR);\n          ivec2 sourceCeilCR = ivec2(ceil(sourceFracIndexCR));\n\n          float topLeft = getImage(b, sourceFloorCR.y, sourceFloorCR.x, d);\n          float bottomLeft = getImage(b, sourceCeilCR.y, sourceFloorCR.x, d);\n          float topRight = getImage(b, sourceFloorCR.y, sourceCeilCR.x, d);\n          float bottomRight = getImage(b, sourceCeilCR.y, sourceCeilCR.x, d);\n\n          vec2 fracCR = sourceFracIndexCR - vec2(sourceFloorCR);\n\n          float top = topLeft + (topRight - topLeft) * fracCR.x;\n          float bottom = bottomLeft + (bottomRight - bottomLeft) * fracCR.x;\n          float newValue = top + (bottom - top) * fracCR.y;\n          setOutput(newValue);\n        } else {\n          // Compute the coordinators of nearest neighbor point.\n          ivec2 sourceNearestCR = ivec2(floor(\n            sourceFracIndexCR + vec2(0.5,0.5)));\n          float newValue = getImage(b, sourceNearestCR.y, sourceNearestCR.x, d);\n          setOutput(newValue);\n        }\n      }\n    "}function k0(e,n,t){this.variableNames=["x"];var r=(this.outputShape=e).length,o=e[e.length-1],a=t?"<":">";this.userCode="\n      int getIndex(int i) {\n        "+(t?"return "+o+" -i - 1;":"return i;")+"\n      }\n\n      void main() {\n        "+De(r)+" coords = getOutputCoords();\n        int end = "+If(r,"coords")+";\n        float val = 0.0;\n        for (int i = "+o+" - 1; i >= 0; i -= 1) {\n          int idx = getIndex(i);\n          if (idx "+a+" end) {\n            continue;\n          }\n          if (idx == end && "+n+") {\n            continue;\n          }\n          "+If(r,"coords")+" = idx;\n          val += getX("+function(i,s){if(1===r)return s;if(2===r)return s+".x, "+s+".y";if(3===r)return"coords.x, coords.y, coords.z";if(4===r)return"coords.x, coords.y, coords.z, coords.w";throw Error("Cumulative sum for rank "+r+" is not yet supported")}(0,"coords")+");\n        }\n        setOutput(val);\n      }\n    "}function If(e,n){if(1===e)return""+n;if(2===e)return n+".y";if(3===e)return n+".z";if(4===e)return n+".w";throw Error("Cumulative sum for rank "+e+" is not yet supported")}function S0(e){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.outPackingScheme=xo.DENSE;var n=bo(e),t=an();this.outputShape=e,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+vr(["r","c","d"],e)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+n[0]+", "+n[1]+"));\n        int index = 4 * (resTexRC.x * "+n[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getA(rc.x, rc.y, rc.z);\n        }\n\n        "+t.output+" = result;\n      }\n    "}function D0(e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outPackingScheme=xo.DENSE;var n=bo(e),t=an();this.outputShape=e,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+vr(["r","c","d"],e)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+n[0]+", "+n[1]+"));\n        int index = 4 * (resTexRC.x * "+n[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getChannel(getA(rc.x, rc.y, rc.z), vec2(rc.y, rc.z));\n        }\n\n        "+t.output+" = result;\n      }\n    "}function A0(e){this.variableNames=["X"],this.outputShape=[e,e],this.userCode="\n      void main() {\n          ivec2 coords = getOutputCoords();\n          float val = coords[0] == coords[1] ? getX(coords[0]) : 0.0;\n          setOutput(val);\n      }\n    "}function T0(e){this.variableNames=["A"],this.outTexUsage=xn.DOWNLOAD;var n=an();this.outputShape=e,this.userCode="\n      "+vf+"\n\n      void main() {\n        float x = getAAtOutCoords();\n        "+n.output+" = encode_float(x);\n      }\n    "}function N0(e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1,this.outTexUsage=xn.DOWNLOAD;var n=an();this.outputShape=e,this.userCode="\n      "+vf+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n        float x = getChannel(getAAtOutCoords(), vec2(coords.y, coords.z));\n        "+n.output+" = encode_float(x);\n      }\n    "}function F0(e,n,t){void 0===t&&(t=!1),this.variableNames=["A"];var r=an(),o=n[0],a=n[1];this.outputShape=e;var i="result";t&&(i="floor(result * 255. + 0.5)"),this.userCode="\n      "+Ys(e)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        int flatIndex = getFlatIndex(coords);\n        int offset = imod(flatIndex, 4);\n\n        flatIndex = idiv(flatIndex, 4, 1.);\n        \n        int r = flatIndex / "+a+";\n        int c = imod(flatIndex, "+a+");\n        vec2 uv = (vec2(c, r) + halfCR) / vec2("+a+".0, "+o+".0);\n        vec4 values = "+r.texture2D+"(A, uv);\n\n        float result;\n\n        if(offset == 0) {\n          result = values[0];\n        } else if(offset == 1) {\n          result = values[1];\n        } else if(offset == 2) {\n          result = values[2];\n        } else {\n          result = values[3];\n        }\n\n        "+r.output+" = vec4("+i+", 0., 0., 0.);\n      }\n    "}function M0(e,n,t){void 0===t&&(t=!1),this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var r=an(),o=n[0],a=n[1];this.outputShape=e;var i="",s="result";t&&(s="floor(result * 255. + 0.5)");for(var u=0;u<=1;u++)for(var c=0;c<=1;c++){var l=2*u+c;i+="\n          localCoords = coords;\n          if(localCoords[2] + "+c+" < "+e[2]+") {\n            localCoords[2] += "+c+";\n            if(localCoords[1] + "+u+" < "+e[1]+") {\n              localCoords[1] += "+u+";\n\n              flatIndex = getFlatIndex(localCoords);\n              offset = imod(flatIndex, 4);\n\n              flatIndex = idiv(flatIndex, 4, 1.);\n\n              r = flatIndex / "+a+";\n              c = imod(flatIndex, "+a+");\n              uv = (vec2(c, r) + halfCR) / vec2("+a+".0, "+o+".0);\n              values = "+r.texture2D+"(A, uv);\n\n              if(offset == 0) {\n                result["+l+"] = values[0];\n              } else if(offset == 1) {\n                result["+l+"] = values[1];\n              } else if(offset == 2) {\n                result["+l+"] = values[2];\n              } else {\n                result["+l+"] = values[3];\n              }\n            }\n          }\n        "}this.userCode="\n      "+Ys(e)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        vec4 result = vec4(0.);\n        int flatIndex, r, c, offset;\n        ivec3 localCoords;\n        vec2 uv;\n        vec4 values;\n\n        "+i+"\n\n        "+r.output+" = "+s+";\n      }\n    "}function Rf(e,n,t){this.variableNames=["real","imag"];var r=n[1];this.outputShape=n;var o=t?"2.0 * "+Math.PI:"-2.0 * "+Math.PI;this.userCode="\n      const float exponentMultiplier = "+o+";\n\n      float unaryOpComplex(float real, float expR, float imag, float expI) {\n        "+e+"\n      }\n\n      float mulMatDFT(int batch, int index) {\n        float indexRatio = float(index) / float("+r+");\n        float exponentMultiplierTimesIndexRatio =\n            exponentMultiplier * indexRatio;\n\n        float result = 0.0;\n\n        for (int i = 0; i < "+r+"; i++) {\n          // x = (-2|2 * PI / N) * index * i;\n          float x = exponentMultiplierTimesIndexRatio * float(i);\n          float expR = cos(x);\n          float expI = sin(x);\n          float real = getReal(batch, i);\n          float imag = getImag(batch, i);\n\n          result +=\n              unaryOpComplex(real, expR, imag, expI) / "+(t?r+".0":"1.0")+";\n        }\n\n        return result;\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        setOutput(mulMatDFT(coords[0], coords[1]));\n      }\n    "}function O0(e,n,t){this.variableNames=["A","indices"];var r=e.slice();r[t]=n,this.outputShape=r,this.rank=r.length;var o=De(this.rank),a=function(i,s){var u=i.length;if(4<u)throw Error("Gather for rank "+u+" is not yet supported");if(1===u)return"int(getIndices(resRC))";for(var c=["resRC.x","resRC.y","resRC.z","resRC.w"],l=[],h=0;h<i.length;h++)l.push(h===s?"int(getIndices("+c[h]+"))":""+c[h]);return l.join()}(e,t);this.userCode="\n      void main() {\n        "+o+" resRC = getOutputCoords();\n        setOutput(getA("+a+"));\n      }\n    "}var P0=(Vr.prototype.getHeightCoordString=function(){return"NHWC"===this.dataFormat?"coords[1]":"coords[2]"},Vr.prototype.getWidthCoordString=function(){return"NHWC"===this.dataFormat?"coords[2]":"coords[3]"},Vr.prototype.getDepthCoordString=function(){return"NHWC"===this.dataFormat?"coords[3]":"coords[1]"},Vr.prototype.getOutputDepthSize=function(){return"NHWC"===this.dataFormat?this.outputShape[3]:this.outputShape[1]},Vr.prototype.getInputSamplingString=function(){return"NHWC"===this.dataFormat?"getX(b, in_h, in_w, in_d)":"getX(b, in_d, in_h, in_w)"},Vr),B0=(kf.prototype.getCustomSetupFunc=function(e){var n=this;return function(t,r){null==n.valueLoc&&(n.valueLoc=t.getUniformLocationNoThrow(r,"value")),t.gl.uniform1f(n.valueLoc,e)}},kf);function kf(e,n){this.outputShape=[],this.variableNames=["x"],this.outputShape=e,this.userCode="\n      uniform float value;\n      void main() {\n        // Input can be obtained from uniform value.\n        setOutput(value);\n      }\n    "}function Vr(e,n,t){this.variableNames=["x"],this.outputShape=[],this.outputShape=e,this.blockSize=n,this.dataFormat=t,this.userCode="\n    void main() {\n      ivec4 coords = getOutputCoords();\n      int b = coords[0];\n      int h = "+this.getHeightCoordString()+";\n      int w = "+this.getWidthCoordString()+";\n      int d = "+this.getDepthCoordString()+";\n\n      int in_h = h / "+n+";\n      int offset_h = imod(h, "+n+");\n      int in_w = w / "+n+";\n      int offset_w = imod(w, "+n+");\n      int offset_d = (offset_h * "+n+" + offset_w) *\n        "+this.getOutputDepthSize()+";\n      int in_d = d + offset_d;\n\n      float result = "+this.getInputSamplingString()+";\n      setOutput(result);\n    }\n  "}function L0(e,n,t){this.sliceDim=e,this.strides=n,this.variableNames=["x","indices"],this.outputShape=t;var r=De(n.length),o=De(t.length);this.userCode="\n        "+r+" strides = "+r+"("+this.strides+");\n         void main() {\n          "+o+" coords = getOutputCoords();\n          int flattenIndex = 0;\n          for (int j = 0; j < "+this.sliceDim+"; j++) {\n            int index = round(getIndices(coords[0], j));\n            flattenIndex += index * "+(1<this.sliceDim?"strides[j]":"strides")+";\n          }\n          setOutput(getX(flattenIndex, coords[1]));\n        }\n      "}function Sf(e,n){var t=an();return th(e,n,t.version+"\n    precision highp float;\n    "+t.attribute+" vec3 clipSpacePos;\n    "+t.attribute+" vec2 uv;\n    "+t.varyingVs+" vec2 resultUV;\n\n    void main() {\n      gl_Position = vec4(clipSpacePos, 1);\n      resultUV = uv;\n    }")}function Df(e,n){return ih(e,n,new Float32Array([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0]))}function Af(e,n){return sh(e,n,new Uint16Array([0,1,2,2,1,3]))}function Mo(e,n,t,r,o,a,i){ch(t,r);var s=uh(e,n),u=e.TEXTURE_2D;return ee(e,n,function(){return e.bindTexture(u,s)}),ee(e,n,function(){return e.texParameteri(u,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE)}),ee(e,n,function(){return e.texParameteri(u,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}),ee(e,n,function(){return e.texParameteri(u,e.TEXTURE_MIN_FILTER,e.NEAREST)}),ee(e,n,function(){return e.texParameteri(u,e.TEXTURE_MAG_FILTER,e.NEAREST)}),ee(e,n,function(){return e.texImage2D(u,0,o,t,r,0,a,i,null)}),ee(e,n,function(){return e.bindTexture(e.TEXTURE_2D,null)}),s}function Tf(e,n,t,r,o){var a=ba(t,r);return Mo(e,n,a[0],a[1],o.internalFormatFloat,o.textureFormatFloat,e.FLOAT)}function Nf(e,n,t,r,o){var a=ba(t,r);return Mo(e,n,a[0],a[1],o.internalFormatHalfFloat,o.textureFormatFloat,o.textureTypeHalfFloat)}function Ff(e,n,t,r,o){var a=ba(t,r);return Mo(e,n,a[0],a[1],e.RGBA,e.RGBA,e.UNSIGNED_BYTE)}function Mf(e,n,t,r,o){var a=wo(t,r);return Mo(e,n,a[0],a[1],o.internalFormatPackedFloat,e.RGBA,e.FLOAT)}function Of(e,n,t,r,o){var a=wo(t,r);return Mo(e,n,a[0],a[1],o.internalFormatPackedHalfFloat,e.RGBA,o.textureTypeHalfFloat)}function Pf(e,n,t,r){return ee(e,n,function(){return e.bindBuffer(e.ARRAY_BUFFER,r)}),bs(e,n,t,"clipSpacePos",r,3,20,0)&&bs(e,n,t,"uv",r,2,20,12)}function Bf(e,n,t,r,o,a,i){var s,u,c;ee(e,n,function(){return e.bindTexture(e.TEXTURE_2D,t)}),c=a instanceof Uint8Array?(s=new Uint8Array(r*o*4),u=e.UNSIGNED_BYTE,e.RGBA):(s=new Float32Array(r*o*4),u=e.FLOAT,i.internalFormatPackedFloat),s.set(a),ee(e,n,function(){return e.texImage2D(e.TEXTURE_2D,0,c,r,o,0,e.RGBA,u,s)}),ee(e,n,function(){return e.bindTexture(e.TEXTURE_2D,null)})}function Lf(e,n,t,r){ee(e,n,function(){return e.bindTexture(e.TEXTURE_2D,t)}),r.data instanceof Uint8Array?ee(e,n,function(){return e.texImage2D(e.TEXTURE_2D,0,e.RGBA,r.width,r.height,0,e.RGBA,e.UNSIGNED_BYTE,r.data)}):ee(e,n,function(){return e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r)}),ee(e,n,function(){return e.bindTexture(e.TEXTURE_2D,null)})}function Wf(e,n,t,r,o){var a=e.createBuffer();ee(e,n,function(){return e.bindBuffer(e.PIXEL_PACK_BUFFER,a)});var i=16*t*r;return ee(e,n,function(){return e.bufferData(e.PIXEL_PACK_BUFFER,i,e.STREAM_READ)}),ee(e,n,function(){return e.readPixels(0,0,r,t,e.RGBA,e.FLOAT,0)}),ee(e,n,function(){return e.bindBuffer(e.PIXEL_PACK_BUFFER,null)}),a}function zf(e,n,t){var r=e,o=new Float32Array(t);return r.bindBuffer(r.PIXEL_PACK_BUFFER,n),r.getBufferSubData(r.PIXEL_PACK_BUFFER,0,o),r.bindBuffer(r.PIXEL_PACK_BUFFER,null),o}function Uf(e,n,t,r,o){var a=ba(t,r),i=a[0],s=a[1],u=new Uint8Array(t*r*4);return ee(e,n,function(){return e.readPixels(0,0,i,s,o.downloadTextureFormat,e.UNSIGNED_BYTE,u)}),new Float32Array(u.buffer)}function Vf(e,n,t,r,o,a,i,s){var u,c=e,l=new Float32Array((u=wo(a,i))[0]*u[1]*4);return c.bindBuffer(c.PIXEL_PACK_BUFFER,n),c.getBufferSubData(c.PIXEL_PACK_BUFFER,0,l),c.bindBuffer(c.PIXEL_PACK_BUFFER,null),l}function Gf(e,n,t,r){var o=new Float32Array(t*r*4);return ee(e,n,function(){return e.readPixels(0,0,r,t,e.RGBA,e.FLOAT,o)}),o}var W0=Object.freeze({createVertexShader:Sf,createVertexBuffer:Df,createIndexBuffer:Af,createFloat32MatrixTexture:Tf,createFloat16MatrixTexture:Nf,createUnsignedBytesMatrixTexture:Ff,createPackedMatrixTexture:Mf,createFloat16PackedMatrixTexture:Of,bindVertexProgramAttributeStreams:Pf,uploadDenseMatrixToTexture:Bf,uploadPixelDataToTexture:Lf,createBufferFromOutputTexture:Wf,downloadFloat32MatrixFromBuffer:zf,downloadByteEncodedFloatMatrixFromOutputTexture:Uf,downloadPackedMatrixFromBuffer:Vf,downloadMatrixFromPackedOutputTexture:Gf}),Hf=(Object.defineProperty(ue.prototype,"debug",{get:function(){return q().getBool("DEBUG")},enumerable:!0,configurable:!0}),ue.prototype.dispose=function(){var e=this;if(!this.disposed){null!=this.program&&console.warn("Disposing a GPGPUContext that still has a bound WebGLProgram. This is probably a resource leak, delete the program with GPGPUContext.deleteProgram before disposing."),null!=this.outputTexture&&console.warn("Disposing a GPGPUContext that still has a bound output matrix texture.  This is probably a resource leak, delete the output matrix texture with GPGPUContext.deleteMatrixTexture before disposing.");var n=this.gl;ee(n,this.debug,function(){return n.finish()}),ee(n,this.debug,function(){return n.bindFramebuffer(n.FRAMEBUFFER,null)}),ee(n,this.debug,function(){return n.deleteFramebuffer(e.framebuffer)}),ee(n,this.debug,function(){return n.bindBuffer(n.ARRAY_BUFFER,null)}),ee(n,this.debug,function(){return n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null)}),ee(n,this.debug,function(){return n.deleteBuffer(e.indexBuffer)}),this.disposed=!0}},ue.prototype.createFloat32MatrixTexture=function(e,n){return this.throwIfDisposed(),Tf(this.gl,this.debug,e,n,this.textureConfig)},ue.prototype.createFloat16MatrixTexture=function(e,n){return this.throwIfDisposed(),Nf(this.gl,this.debug,e,n,this.textureConfig)},ue.prototype.createUnsignedBytesMatrixTexture=function(e,n){return this.throwIfDisposed(),Ff(this.gl,this.debug,e,n)},ue.prototype.uploadPixelDataToTexture=function(e,n){this.throwIfDisposed(),Lf(this.gl,this.debug,e,n)},ue.prototype.uploadDenseMatrixToTexture=function(e,n,t,r){this.throwIfDisposed(),Bf(this.gl,this.debug,e,n,t,r,this.textureConfig)},ue.prototype.createFloat16PackedMatrixTexture=function(e,n){return this.throwIfDisposed(),Of(this.gl,this.debug,e,n,this.textureConfig)},ue.prototype.createPackedMatrixTexture=function(e,n){return this.throwIfDisposed(),Mf(this.gl,this.debug,e,n,this.textureConfig)},ue.prototype.deleteMatrixTexture=function(e){var n=this;this.throwIfDisposed(),this.outputTexture===e&&(ws(this.gl,this.debug,this.framebuffer),this.outputTexture=null),ee(this.gl,this.debug,function(){return n.gl.deleteTexture(e)})},ue.prototype.downloadByteEncodedFloatMatrixFromOutputTexture=function(e,n,t){var r=this;return this.downloadMatrixDriver(e,function(){return Uf(r.gl,r.debug,n,t,r.textureConfig)})},ue.prototype.downloadPackedMatrixFromBuffer=function(e,n,t,r,o,a){return Vf(this.gl,e,0,0,0,o,a)},ue.prototype.downloadFloat32MatrixFromBuffer=function(e,n){return zf(this.gl,e,n)},ue.prototype.createBufferFromTexture=function(e,n,t){this.bindTextureToFrameBuffer(e);var r=Wf(this.gl,this.debug,n,t);return this.unbindTextureToFrameBuffer(),r},ue.prototype.createAndWaitForFence=function(){var e=this.createFence(this.gl);return this.pollFence(e)},ue.prototype.createFence=function(e){var n,t,r=this;if(q().getBool("WEBGL_FENCE_API_ENABLED")){var o=e,a=o.fenceSync(o.SYNC_GPU_COMMANDS_COMPLETE,0);e.flush(),t=function(){var i=o.clientWaitSync(a,0,0);return i===o.ALREADY_SIGNALED||i===o.CONDITION_SATISFIED},n=a}else t=0<q().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?(n=this.beginQuery(),this.endQuery(),function(){return r.isQueryAvailable(n,q().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))}):function(){return!0};return{query:n,isFencePassed:t}},ue.prototype.downloadMatrixFromPackedTexture=function(e,n,t){var r=this;return this.downloadMatrixDriver(e,function(){return Gf(r.gl,r.debug,n,t)})},ue.prototype.createProgram=function(e){this.throwIfDisposed();var n=this.gl,t=rh(n,this.debug,e),r=Sf(n,this.debug),o=oh(n,this.debug);return ee(n,this.debug,function(){return n.attachShader(o,r)}),ee(n,this.debug,function(){return n.attachShader(o,t)}),ah(n,this.debug,o),this.debug&&Ea(n,this.debug,o),this.vertexAttrsAreBound||(this.setProgram(o),this.vertexAttrsAreBound=Pf(n,this.debug,this.program,this.vertexBuffer)),o},ue.prototype.deleteProgram=function(e){var n=this;this.throwIfDisposed(),e===this.program&&(this.program=null),null!=e&&ee(this.gl,this.debug,function(){return n.gl.deleteProgram(e)})},ue.prototype.setProgram=function(e){var n=this;this.throwIfDisposed(),this.program=e,null!=this.program&&this.debug&&Ea(this.gl,this.debug,this.program),ee(this.gl,this.debug,function(){return n.gl.useProgram(e)})},ue.prototype.getUniformLocation=function(e,n,t){return void 0===t&&(t=!0),this.throwIfDisposed(),t?fh(this.gl,this.debug,e,n):ph(this.gl,e,n)},ue.prototype.getAttributeLocation=function(e,n){var t=this;return this.throwIfDisposed(),ee(this.gl,this.debug,function(){return t.gl.getAttribLocation(e,n)})},ue.prototype.getUniformLocationNoThrow=function(e,n){return this.throwIfDisposed(),this.gl.getUniformLocation(e,n)},ue.prototype.setInputMatrixTexture=function(e,n,t){this.throwIfDisposed(),this.throwIfNoProgram(),dh(this.gl,this.debug,0,e,n,t)},ue.prototype.setOutputMatrixTexture=function(e,n,t){this.setOutputMatrixTextureDriver(e,t,n)},ue.prototype.setOutputPackedMatrixTexture=function(e,n,t){this.throwIfDisposed();var r=wo(n,t);this.setOutputMatrixTextureDriver(e,r[0],r[1])},ue.prototype.setOutputMatrixWriteRegion=function(e,n,t,r){this.setOutputMatrixWriteRegionDriver(t,e,r,n)},ue.prototype.setOutputPackedMatrixWriteRegion=function(e,n,t,r){throw new Error("setOutputPackedMatrixWriteRegion not implemented.")},ue.prototype.debugValidate=function(){null!=this.program&&Ea(this.gl,this.debug,this.program),Eo(this.gl)},ue.prototype.executeProgram=function(){this.throwIfDisposed(),this.throwIfNoProgram();var e=this.gl;this.debug&&this.debugValidate(),ee(e,this.debug,function(){return e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0)})},ue.prototype.blockUntilAllProgramsCompleted=function(){var e=this;this.throwIfDisposed(),ee(this.gl,this.debug,function(){return e.gl.finish()})},ue.prototype.getQueryTimerExtension=function(){return null==this.disjointQueryTimerExtension&&(this.disjointQueryTimerExtension=Co(this.gl,this.debug,2===q().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?"EXT_disjoint_timer_query_webgl2":"EXT_disjoint_timer_query")),this.disjointQueryTimerExtension},ue.prototype.getQueryTimerExtensionWebGL2=function(){return this.getQueryTimerExtension()},ue.prototype.getQueryTimerExtensionWebGL1=function(){return this.getQueryTimerExtension()},ue.prototype.beginQuery=function(){if(2===q().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var e=this.gl,n=this.getQueryTimerExtensionWebGL2(),t=e.createQuery();return e.beginQuery(n.TIME_ELAPSED_EXT,t),t}var r=this.getQueryTimerExtensionWebGL1(),o=r.createQueryEXT();return r.beginQueryEXT(r.TIME_ELAPSED_EXT,o),o},ue.prototype.endQuery=function(){if(2!==q().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var e=this.getQueryTimerExtensionWebGL1();e.endQueryEXT(e.TIME_ELAPSED_EXT)}else{var n=this.gl,t=this.getQueryTimerExtensionWebGL2();n.endQuery(t.TIME_ELAPSED_EXT)}},ue.prototype.waitForQueryAndGetTime=function(e){return oe(this,void 0,void 0,function(){var n=this;return ae(this,function(t){switch(t.label){case 0:return[4,rs(function(){return n.disposed||n.isQueryAvailable(e,q().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))})];case 1:return t.sent(),[2,this.getQueryTime(e,q().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))]}})})},ue.prototype.getQueryTime=function(e,n){if(0===n)return null;if(2===n){var t=this.gl;return t.getQueryParameter(e,t.QUERY_RESULT)/1e6}var r=this.getQueryTimerExtensionWebGL1();return r.getQueryObjectEXT(e,r.QUERY_RESULT_EXT)/1e6},ue.prototype.isQueryAvailable=function(e,n){if(0===n)return!0;if(2!==n)return o=(r=this.getQueryTimerExtensionWebGL1()).getQueryObjectEXT(e,r.QUERY_RESULT_AVAILABLE_EXT),null==this.disjoint&&(this.disjoint=this.gl.getParameter(r.GPU_DISJOINT_EXT)),o&&!this.disjoint;var t=this.gl,r=this.getQueryTimerExtensionWebGL2(),o=t.getQueryParameter(e,t.QUERY_RESULT_AVAILABLE);return null==this.disjoint&&(this.disjoint=this.gl.getParameter(r.GPU_DISJOINT_EXT)),o&&!this.disjoint},ue.prototype.pollFence=function(e){var n=this;return new Promise(function(t){n.addItemToPoll(function(){return e.isFencePassed()},function(){return t()})})},ue.prototype.pollItems=function(){for(var e=function(t){for(var r=0;r<t.length&&t[r]();++r);return r-1}(this.itemsToPoll.map(function(t){return t.isDoneFn})),n=0;n<=e;++n)(0,this.itemsToPoll[n].resolveFn)();this.itemsToPoll=this.itemsToPoll.slice(e+1)},ue.prototype.addItemToPoll=function(e,n){var t=this;this.itemsToPoll.push({isDoneFn:e,resolveFn:n}),1<this.itemsToPoll.length||rs(function(){return t.pollItems(),0===t.itemsToPoll.length})},ue.prototype.bindTextureToFrameBuffer=function(e){this.throwIfDisposed(),_a(this.gl,this.debug,e,this.framebuffer),this.debug&&Eo(this.gl)},ue.prototype.unbindTextureToFrameBuffer=function(){null!=this.outputTexture?(_a(this.gl,this.debug,this.outputTexture,this.framebuffer),this.debug&&Eo(this.gl)):ws(this.gl,this.debug,this.framebuffer)},ue.prototype.downloadMatrixDriver=function(e,n){this.bindTextureToFrameBuffer(e);var t=n();return this.unbindTextureToFrameBuffer(),t},ue.prototype.setOutputMatrixTextureDriver=function(e,n,t){this.throwIfDisposed();var r=this.gl;_a(r,this.debug,e,this.framebuffer),this.debug&&Eo(r),this.outputTexture=e,ee(r,this.debug,function(){return r.viewport(0,0,n,t)}),ee(r,this.debug,function(){return r.scissor(0,0,n,t)})},ue.prototype.setOutputMatrixWriteRegionDriver=function(e,n,t,r){var o=this;this.throwIfDisposed(),ee(this.gl,this.debug,function(){return o.gl.scissor(e,n,t,r)})},ue.prototype.throwIfDisposed=function(){if(this.disposed)throw new Error("Attempted to use disposed GPGPUContext.")},ue.prototype.throwIfNoProgram=function(){if(null==this.program)throw new Error("No GPU program is currently set.")},ue);function ue(e){this.outputTexture=null,this.program=null,this.disposed=!1,this.vertexAttrsAreBound=!1,this.itemsToPoll=[];var n=q().getNumber("WEBGL_VERSION");null!=e?Zl(n,this.gl=e):this.gl=Kn(n);var t="WEBGL_color_buffer_float";if(1===q().getNumber("WEBGL_VERSION")){if(this.textureFloatExtension=Co(this.gl,this.debug,"OES_texture_float"),wn(this.gl,"OES_texture_half_float"))this.textureHalfFloatExtension=Co(this.gl,this.debug,"OES_texture_half_float");else if(q().get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support half float textures, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.");if(this.colorBufferFloatExtension=this.gl.getExtension(t),wn(this.gl,"EXT_color_buffer_half_float"))this.colorBufferHalfFloatExtension=Co(this.gl,this.debug,"EXT_color_buffer_half_float");else if(q().get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support color renderable half floats, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.")}else if(wn(this.gl,t="EXT_color_buffer_float"))this.colorBufferFloatExtension=this.gl.getExtension(t);else{if(!wn(this.gl,"EXT_color_buffer_half_float"))throw new Error("GL context does not support color renderable floats");this.colorBufferHalfFloatExtension=this.gl.getExtension("EXT_color_buffer_half_float")}this.vertexBuffer=Df(this.gl,this.debug),this.indexBuffer=Af(this.gl,this.debug),this.framebuffer=lh(this.gl,this.debug),this.textureConfig=xs(this.gl,this.textureHalfFloatExtension)}function qf(e,n){if(e.length!==n.length)throw Error("Binary was compiled with "+e.length+" inputs, but was executed with "+n.length+" inputs");e.forEach(function(t,r){var o=t.logicalShape,a=n[r],i=a.shape;if(!Le(o,i))throw Error("Binary was compiled with different shapes than the current args. Shapes "+o+" and "+i+" must match");if(!t.isUniform||!a.isUniform){var s=t.texShape,u=a.isUniform?null:a.texData.texShape;if(!Le(s,u))throw Error("Binary was compiled with different texture shapes than the current args. Shape "+s+" and "+u+" must match")}})}function z0(e,n,t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e;for(var o=t.inChannels,a=t.strideWidth,i=t.strideHeight,s=t.padInfo,u=t.outWidth,c=t.dilationWidth,l=t.dilationHeight,h=t.dataFormat,f=s.left,p=s.top,d=o*t.filterWidth,g=an(),v="channelsLast"===h,m=v?0:1,y=v?1:2,x="",w=0;w<=1;w++)for(var b=0;b<=1;b++)x+="\n          blockIndex = rc.y + "+b+";\n          pos = rc.x + "+w+";\n\n          if(blockIndex < "+e[1]+" && pos < "+e[0]+") {\n            offsetY = int(blockIndex / ("+u+")) * "+i+" - "+p+";\n            d0 = offsetY + "+l+" * (pos / "+d+");\n\n            if(d0 < "+n[m]+" && d0 >= 0) {\n\n              offsetX = int(mod(float(blockIndex), "+u+".) * "+a+". - "+f+".);\n              d1 = offsetX + "+c+" * (int(mod(float(pos), "+d+".) / "+o+".));\n\n              if(d1 < "+n[y]+" && d1 >= 0) {\n\n                ch = int(mod(float(pos), "+o+".));\n\n                if ("+v+") {\n                  innerDims = vec2(d1, ch);\n                  result["+(2*w+b)+"] = getChannel(\n                    getA(d0, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                } else {\n                  innerDims = vec2(d0, d1);\n                  result["+(2*w+b)+"] = getChannel(\n                    getA(ch, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                }\n              }\n            }\n          }\n        ";this.userCode="\n      void main() {\n        ivec2 rc = getOutputCoords();\n\n        vec4 result = vec4(0);\n\n        int blockIndex, pos, offsetY, d0, offsetX, d1, ch;\n        vec2 innerDims;\n\n        "+x+"\n\n        "+g.output+" = result;\n      }\n    "}function U0(e,n,t,r,o){this.variableNames=["x"],this.outputShape=[];var i=n,s=e[3]-1;this.outputShape=e;var u="float("+t+") + float("+r+") * sum";this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n        int d = coords[3];\n        float x = getX(b, r, c, d);\n        float sum = 0.0;\n        for (int j = -"+i+"; j <= "+i+"; j++) {\n          int idx = d + j;\n          if (idx >= 0 && idx <=  "+s+") {\n            float z = getX(b, r, c, idx);\n            sum += z * z;\n          }\n        }\n        float val = x * "+(.5===o?"inversesqrt("+u+")":1===o?"1.0/("+u+")":"exp(log("+u+") * float(-"+o+"));")+";\n        setOutput(val);\n      }\n    "}function V0(e,n,t,r,o){this.variableNames=["inputImage","outputImage","dy"],this.outputShape=[],this.outputShape=e,this.depth=e[3],this.depthRadius=n,this.bias=t,this.alpha=r,this.beta=o,this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n\n        float result = 0.0;\n        for (int d = 0; d < "+this.depth+"; ++d) {\n          int depthBegin = int(max(0.0, float(d - "+n+")));\n          int depthEnd = int(min(float("+this.depth+"),\n              float(d + "+n+" + 1)));\n\n          const int MIN_DEPTH_BEGIN = 0;\n          const int MAX_DEPTH_END = "+this.depth+";\n\n          float norm = 0.0;\n          for (int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k) {\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd) {\n              norm += getInputImage(b, r, c, k) * getInputImage(b, r, c, k);\n            }\n            else {\n              break;\n            }\n          }\n\n          norm = float("+r+") * norm + float("+t+");\n\n          for(int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k){\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd){\n              float dyi = -2.0 * float("+r+")\n                * float("+o+")\n                * getInputImage(b ,r ,c, k) * getOutputImage(b, r, c, d)\n                / norm;\n              if (k == d) {\n                dyi += pow(norm, -1.0 * "+o+");\n              }\n              if (k == coords[3]) {\n                dyi *= getDy(b, r, c, d);\n                result += dyi;\n              }\n            }\n            else {\n              break;\n            }\n          }\n      }\n      setOutput(result);\n      }\n    "}function G0(e,n,t,r,o){this.variableNames=["x"],this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0;var i=n,s=e[3]-1;this.outputShape=e;var u="float("+t+") + float("+r+") * sum";this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords.x;\n        int r = coords.y;\n        int c = coords.z;\n        int d = coords.w;\n\n        bool hasNextCol = d < "+this.outputShape[3]+";\n        bool hasNextRow = c < "+this.outputShape[2]+";\n\n        vec4 sum = vec4(0.);\n        vec4 xFragAtOutputCoords = getX(b, r, c, d);\n\n        vec4 xAtOutputCoords = vec4(\n          getChannel(xFragAtOutputCoords, vec2(c, d)),\n          hasNextCol ?\n            getChannel(xFragAtOutputCoords, vec2(c, d + 1)) : 0.0,\n          hasNextRow ?\n            getChannel(xFragAtOutputCoords , vec2(c + 1, d)) : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getChannel(xFragAtOutputCoords, vec2(c + 1, d + 1)) : 0.0\n        );\n\n        int firstChannel = d - "+i+";\n        vec2 cache = vec2(0.);\n        if(firstChannel >= 0){\n          vec4 firstChannelFrag = getX(b, r, c, firstChannel);\n          cache.x = getChannel(firstChannelFrag, vec2(c, firstChannel));\n            if(hasNextRow){\n              cache.y = getChannel(firstChannelFrag, vec2(c + 1, firstChannel));\n            }\n        }\n\n        ivec2 depth = ivec2(d, d + 1);\n        for (int j = - "+i+"; j <= "+i+"; j++) {\n          ivec2 idx = depth + j;\n          bvec2 aboveLowerBound = greaterThanEqual(idx, ivec2(0));\n          bvec2 belowUpperBound = lessThanEqual(idx, ivec2("+s+"));\n\n          bool depthInRange = aboveLowerBound.x && belowUpperBound.x;\n          bool depthPlusOneInRange = aboveLowerBound.y && belowUpperBound.y;\n\n          if(depthInRange || depthPlusOneInRange){\n            vec4 z = vec4(0.);\n            vec4 xFragAtCurrentDepth;\n            z.xz = cache.xy;\n            if(depthPlusOneInRange && hasNextCol){\n              xFragAtCurrentDepth = idx.y != d ?\n                getX(b, r, c, idx.y) : xFragAtOutputCoords;\n              z.y = getChannel(xFragAtCurrentDepth, vec2(c, idx.y));\n              if(hasNextRow){\n                z.w = getChannel(xFragAtCurrentDepth, vec2(c + 1, idx.y));\n              }\n            }\n            cache.xy = z.yw;\n            sum += z * z;\n          }\n        }\n        vec4 result = xAtOutputCoords * "+(.5===o?"inversesqrt("+u+")":1===o?"1.0/("+u+")":"exp(log("+u+") * float(-"+o+"));")+";\n        setOutput(result);\n      }\n    "}function H0(e){this.variableNames=["dy","maxPos"],this.outputShape=e.inShape;var o=e.effectiveFilterHeight,a=e.effectiveFilterWidth;this.userCode="\n      const ivec2 pads = ivec2("+(o-1-e.padInfo.top)+", "+(a-1-e.padInfo.left)+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+o+";\n          wR += "+e.dilationHeight+") {\n          float dyR = float(dyRCorner + wR) / "+e.strideHeight+".0;\n\n          if (dyR < 0.0 || dyR >= "+e.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+a+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+e.strideWidth+".0;\n\n            if (dyC < 0.0 || dyC >= "+e.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n            int maxPosValue = "+(o*a-1)+" - int(getMaxPos(b, idyR, idyC, d));\n\n            // Get the current value, check it against the value from the\n            // position matrix.\n            int curPosValue = wR * "+a+" + wC;\n            float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n            dotProd += dyValue * mask;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function q0(e){this.variableNames=["dy","maxPos"],this.outputShape=e.inShape;var s=e.effectiveFilterDepth,u=e.effectiveFilterHeight,c=e.effectiveFilterWidth;this.userCode="\n      const ivec3 pads = ivec3("+(s-1-e.padInfo.front)+", "+(u-1-e.padInfo.top)+", "+(c-1-e.padInfo.left)+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, ch) with pos mask(:, :, :, d) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+s+";\n           wD += "+e.dilationDepth+") {\n          float dyD = float(dyDCorner + wD) / "+e.strideDepth+".0;\n\n          if (dyD < 0.0 || dyD >= "+e.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+u+";\n              wR += "+e.dilationHeight+") {\n            float dyR = float(dyRCorner + wR) / "+e.strideHeight+".0;\n\n            if (dyR < 0.0 || dyR >= "+e.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+c+";\n                wC += "+e.dilationWidth+") {\n              float dyC = float(dyCCorner + wC) / "+e.strideWidth+".0;\n\n              if (dyC < 0.0 || dyC >= "+e.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n              int maxPosValue = "+(s*u*c-1)+" -\n                  int(getMaxPos(batch, idyD, idyR, idyC, ch));\n\n              // Get the current value, check it against the value from the\n              // position matrix.\n              int curPosValue =\n                  wD * "+u+" * "+c+" +\n                  wR * "+c+" + wC;\n              float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n              dotProd += dyValue * mask;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "}function Qs(e,n,t,r,o,a,i){void 0===t&&(t=!1),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=null),void 0===i&&(i=!1),this.variableNames=["matrixA","matrixB"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=n;var u=Math.ceil((t?e[1]:e[2])/2),c=t?"i * 2, rc.y":"rc.y, i * 2",l=r?"rc.z, i * 2":"i * 2, rc.z",h=t?["a.xxyy","a.zzww"]:["a.xxzz","a.yyww"],f=r?["b.xzxz","b.ywyw"]:["b.xyxy","b.zwzw"],p="",d="";a&&(p=i?"vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          "+a+"\n        }":"vec4 activation(vec4 x) {\n          "+a+"\n        }",d="result = activation(result);");var g=o?"result += getBiasAtOutCoords();":"";o&&this.variableNames.push("bias"),i&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+p+"\n\n      const float sharedDimension = "+u+".0;\n\n      vec4 dot2x2ARowBCol(ivec3 rc) {\n        vec4 result = vec4(0);\n        for (int i = 0; i < "+u+"; i++) {\n          vec4 a = getMatrixA(rc.x, "+c+");\n          vec4 b = getMatrixB(rc.x, "+l+");\n\n          // These swizzled products need to be separately added.\n          // See: https://github.com/tensorflow/tfjs/issues/1735\n          result += ("+h[0]+" * "+f[0]+");\n          result += ("+h[1]+" * "+f[1]+");\n        }\n        return result;\n      }\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n        vec4 result = dot2x2ARowBCol(rc);\n\n        "+g+"\n\n        "+d+"\n\n        setOutput(result);\n      }\n    "}function j0(e,n,t,r){this.variableNames=["indices"],this.outputShape=[e,n],this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int index = round(getIndices(coords.x));\n        setOutput(mix(float("+r+"), float("+t+"),\n                      float(index == coords.y)));\n      }\n    "}function K0(e){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var n,r,o,a=(this.outputShape=e).length;if(0===a)this.userCode="\n        void main() {\n          setOutput(vec4(getA(), 0., 0., 0.));\n        }\n      ";else{var i=vn("rc",a),s=De(a),u=function(h,f,p){if(1===h)return"rc > "+f[0];for(var d="",g=h-2;g<h;g++)d+=p[g]+" >= "+f[g],g<h-1&&(d+="||");return d}(a,e,i),c=function(h,f,p){if(1===h)return"";var d=i.slice(-2);return"\n    int r = "+d[0]+";\n    int c = "+d[1]+";\n    int rp1 = r + 1;\n    int cp1 = c + 1;\n\n    bool cEdge = cp1 >= "+f+";\n    bool rEdge = rp1 >= "+p+";\n  "}(a,e[e.length-1],e[e.length-2]),l=(o=function(h,f){for(var p=[],d=0;d<=1;d++)for(var g=0;g<=1;g++){for(var v=(0===d?"r":"rp1")+", "+(0===g?"c":"cp1"),m=2;m<h;m++)v=f[f.length-1-m]+","+v;p.push(v)}return p}(r=(n=e).length,i),1===r?"getA(rc),\n            rc + 1 >= "+n[0]+" ? 0. : getA(rc + 1),\n            0, 0":"getA("+o[0]+"),\n          cEdge ? 0. : getA("+o[1]+"),\n          rEdge ? 0. : getA("+o[2]+"),\n          rEdge || cEdge ? 0. : getA("+o[3]+")");this.userCode="\n        void main() {\n          "+s+" rc = getOutputCoords();\n\n          if("+u+") {\n            setOutput(vec4(0));\n          } else {\n            "+c+"\n\n            setOutput(vec4("+l+"));\n          }\n        }\n      "}}var X0=(jf.prototype.getCustomSetupFunc=function(e){var n=this;return function(t,r){null==n.seedLoc&&(n.seedLoc=t.getUniformLocation(r,"seed")),t.gl.uniform1f(n.seedLoc,e)}},jf);function jf(e,n,t){this.variableNames=["probs"],this.outputShape=[e,t],this.userCode="\n      uniform float seed;\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n\n        float r = random(seed);\n        float cdf = 0.0;\n\n        for (int i = 0; i < "+(n-1)+"; i++) {\n          cdf += getProbs(batch, i);\n\n          if (r < cdf) {\n            setOutput(float(i));\n            return;\n          }\n        }\n\n        // If no other event happened, last event happened.\n        setOutput(float("+(n-1)+"));\n      }\n    "}function Y0(e,n,t){this.variableNames=["x"],this.outputShape=n.map(function(u,c){return u[0]+e[c]+u[1]});var r=e.length,o=De(r),a=n.map(function(u){return u[0]}).join(","),i=n.map(function(u,c){return u[0]+e[c]}).join(","),s=["coords[0]","coords[1]","coords[2]","coords[3]"].slice(0,r);this.userCode=1!==r?"\n      "+o+" start = "+o+"("+a+");\n      "+o+" end = "+o+"("+i+");\n\n      void main() {\n        "+o+" outC = getOutputCoords();\n        if (any(lessThan(outC, start)) || any(greaterThanEqual(outC, end))) {\n          setOutput(float("+t+"));\n        } else {\n          "+o+" coords = outC - start;\n          setOutput(getX("+s+"));\n        }\n      }\n    ":"\n        int start = "+a+";\n        int end = "+i+";\n\n        void main() {\n          int outC = getOutputCoords();\n          if (outC < start || outC >= end) {\n            setOutput(float("+t+"));\n          } else {\n            setOutput(getX(outC - start));\n          }\n        }\n      "}function $0(e,n,t){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=n.map(function(v,m){return v[0]+e[m]+v[1]});for(var r=e.length,o=De(r),a=n.map(function(v){return v[0]}).join(","),i=n.map(function(v,m){return v[0]+e[m]}).join(","),s=vn("rc",r),u=vn("source",r),c=s[r-1]+" < "+this.outputShape[r-1],l=1===r?"source":"vec2("+u.slice(-2).join()+")",h=[o+" rc = outputLoc;",s[r-1]+" += 1;\n       if("+c+") {\n      ",1===r?"":"}\n       rc = outputLoc;\n       "+s[r-2]+" += 1;\n       if("+s[r-2]+" < "+this.outputShape[r-2]+") {",1===r?"":"  "+s[r-1]+" += 1;\n         if("+c+") {"],f=1===r?"rc < start || rc >= end":"any(lessThan(rc, start)) || any(greaterThanEqual(rc, end))",p="",d=0,g=1===r?2:4;d<g;d++)p+="\n        "+h[d]+"\n        if ("+f+") {\n          result["+d+"] = float("+t+");\n        } else {\n          "+o+" source = rc - start;\n          result["+d+"] = getChannel(getX("+u.join()+"), "+l+");\n        }\n      ";this.userCode="\n      const "+o+" start = "+o+"("+a+");\n      const "+o+" end = "+o+"("+i+");\n\n      void main() {\n        "+o+" outputLoc = getOutputCoords();\n        vec4 result = vec4(0.);\n        "+(p+=1===r?"} ":"}}")+"\n        setOutput(result);\n      }\n    "}function Zs(e,n,t){if(this.variableNames=["x"],"avg"===n&&t)throw new Error("Cannot compute positions for average pool.");var r=e.filterWidth,o=e.strideHeight,a=e.strideWidth,i=e.dilationHeight,s=e.dilationWidth,u=e.effectiveFilterHeight,c=e.effectiveFilterWidth,l=e.padInfo.top,h=e.padInfo.left;this.outputShape=e.outShape;var f="avg"===n,p="0.0";if(f||(p="-1.0 / 1e-20"),t)this.userCode="\n        const ivec2 strides = ivec2("+o+", "+a+");\n        const ivec2 pads = ivec2("+l+", "+h+");\n\n        void main() {\n          ivec4 coords = getOutputCoords();\n          int batch = coords[0];\n          int d = coords[3];\n\n          ivec2 xRCCorner = coords.yz * strides - pads;\n          int xRCorner = xRCCorner.x;\n          int xCCorner = xRCCorner.y;\n\n          // max/min x(?, ?, d) to get y(yR, yC, d).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n          float avgValue = 0.0;\n\n          for (int wR = 0; wR < "+u+";\n              wR += "+i+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+e.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+c+";\n                wC += "+s+") {\n              int xC = xCCorner + wC;\n\n              if (xC < 0 || xC >= "+e.inWidth+") {\n                continue;\n              }\n\n              float value = getX(batch, xR, xC, d);\n\n              // If a min / max value has already been found, use it. If not,\n              // use the current value.\n              float currMinMaxValue = mix(\n                  value, minMaxValue, minMaxValueFound);\n              if (value >= currMinMaxValue) {\n                minMaxValue = value;\n                minMaxValueFound = 1.0;\n                minMaxPosition = wR * "+c+" + wC;\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var d=n+"("+n+"("+n+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===n&&(d="avgValue / count");var g=4*Math.floor(r/4),v=r%4,m="\n      if ("+f+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec2 strides = ivec2("+o+", "+a+");\n      const ivec2 pads = ivec2("+l+", "+h+");\n      const float initializationValue = "+p+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xR, int xC, int d) {\n        if (xC < 0 || xC >= "+e.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xR, xC, d);\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d = coords[3];\n\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // max/min x(?, ?, d) to get y(yR, yC, d).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+p+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wR = 0; wR < "+u+";\n            wR += "+i+") {\n          int xR = xRCorner + wR;\n\n          if (xR < 0 || xR >= "+e.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+g+"; wC += 4) {\n            int xC = xCCorner + wC * "+s+";\n\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+s+", d),\n              getValue(batch, xR, xC + 2 * "+s+", d),\n              getValue(batch, xR, xC + 3 * "+s+", d)\n            );\n\n            "+m+"\n          }\n\n          int xC = xCCorner + "+g+";\n          if ("+(1==v)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              initializationValue,\n              initializationValue,\n              initializationValue\n            );\n\n            "+m+"\n          } else if ("+(2==v)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+s+", d),\n              initializationValue,\n              initializationValue\n            );\n\n            "+m+"\n          } else if ("+(3==v)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+s+", d),\n              getValue(batch, xR, xC + 2 * "+s+", d),\n              initializationValue\n            );\n\n            "+m+"\n          }\n        }\n        setOutput("+d+");\n      }\n    "}}function eu(e,n,t){if(this.variableNames=["x"],"avg"===n&&t)throw new Error("Cannot compute positions for average pool.");var r=e.filterWidth,o=e.strideDepth,a=e.strideHeight,i=e.strideWidth,s=e.dilationDepth,u=e.dilationHeight,c=e.dilationWidth,l=e.effectiveFilterDepth,h=e.effectiveFilterHeight,f=e.effectiveFilterWidth,p=e.padInfo.front,d=e.padInfo.top,g=e.padInfo.left;this.outputShape=e.outShape;var v="avg"===n,m="0.0";if(v||(m="-1.0 / 1e-20"),t)this.userCode="\n        const ivec3 strides =\n            ivec3("+o+", "+a+", "+i+");\n        const ivec3 pads = ivec3("+p+", "+d+", "+g+");\n\n        void main() {\n          ivec5 coords = getOutputCoords();\n          int batch = coords.x;\n          int ch = coords.u;\n\n          ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n          int xDCorner = xCorner.x;\n          int xRCorner = xCorner.y;\n          int xCCorner = xCorner.z;\n\n          // max/min x(?, ?, ?, ch) to get y(yD, yR, yC, ch).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n\n          for (int wD = 0; wD < "+l+";\n              wD += "+s+") {\n            int xD = xDCorner + wD;\n\n            if (xD < 0 || xD >= "+e.inDepth+") {\n              continue;\n            }\n\n            for (int wR = 0; wR < "+h+";\n                wR += "+u+") {\n              int xR = xRCorner + wR;\n\n              if (xR < 0 || xR >= "+e.inHeight+") {\n                continue;\n              }\n\n              for (int wC = 0; wC < "+f+";\n                  wC += "+c+") {\n                int xC = xCCorner + wC;\n\n                if (xC < 0 || xC >= "+e.inWidth+") {\n                  continue;\n                }\n\n                float value = getX(batch, xD, xR, xC, ch);\n\n                // If a min / max value has already been found, use it. If not,\n                // use the current value.\n                float currMinMaxValue = mix(\n                    value, minMaxValue, minMaxValueFound);\n                if (value >= currMinMaxValue) {\n                  minMaxValue = value;\n                  minMaxValueFound = 1.0;\n                  minMaxPosition =\n                      wD * "+h+" * "+f+" +\n                      wR * "+f+" + wC;;\n                }\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var y=n+"("+n+"("+n+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===n&&(y="avgValue / count");var x=4*Math.floor(r/4),w=r%4,b="\n      if ("+v+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec3 strides =\n        ivec3("+o+", "+a+", "+i+");\n      const ivec3 pads = ivec3("+p+", "+d+", "+g+");\n      const float initializationValue = "+m+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xD, int xR, int xC, int ch) {\n        if (xC < 0 || xC >= "+e.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xD, xR, xC, ch);\n      }\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xDCorner = xCorner.x;\n        int xRCorner = xCorner.y;\n        int xCCorner = xCorner.z;\n\n        // max/min x(?, ?, ?, d) to get y(yD, yR, yC, ch).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+m+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wD = 0; wD < "+l+";\n            wD += "+s+") {\n          int xD = xDCorner + wD;\n\n          if (xD < 0 || xD >= "+e.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+h+";\n            wR += "+u+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+e.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+x+"; wC += 4) {\n              int xC = xCCorner + wC * "+c+";\n\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+c+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+c+", ch),\n                getValue(batch, xD, xR, xC + 3 * "+c+", ch)\n              );\n\n              "+b+"\n            }\n\n            int xC = xCCorner + "+x+";\n            if ("+(1==w)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                initializationValue,\n                initializationValue,\n                initializationValue\n              );\n\n              "+b+"\n            } else if ("+(2==w)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+c+", ch),\n                initializationValue,\n                initializationValue\n              );\n\n              "+b+"\n            } else if ("+(3==w)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+c+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+c+", ch),\n                initializationValue\n              );\n\n              "+b+"\n            }\n          }\n          setOutput("+y+");\n        }\n      }\n    "}}function J0(e,n){this.variableNames=["x"];var t=e.windowSize,r=e.batchSize,o=e.inSize,a=Math.ceil(o/t);this.outputShape=[r,a];var i="0.0",s="";"prod"===n?i="1.0":"min"===n?(i="1.0 / 1e-20",s="min"):"max"===n&&(i="-1.0 / 1e-20",s="max");var u=n+"("+n+"("+n+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"sum"===n?u="sumValue":"prod"===n?u="prodValue":"all"===n?u="allValue":"any"===n&&(u="anyValue");var c=4*Math.floor(t/4),l=t%4,h="\n      if ("+("sum"===n)+") {\n        sumValue += dot(values, ones);\n      } else if ("+("prod"===n)+") {\n        vec2 tmp = vec2(values[0], values[1]) * vec2(values[2], values[3]);\n        prodValue *= tmp[0] * tmp[1];\n      } else {\n        minMaxValue = "+s+"(values, minMaxValue);\n      }\n    ",f="vec4";"all"===n?(i="1.0",h="\n        bool reducedAllValue = all(values);\n        float floatedReducedAllValue = float(reducedAllValue);\n        allValue = float(allValue >= 1.0 && floatedReducedAllValue >= 1.0);\n      ",f="bvec4"):"any"===n&&(i="0.0",h="\n        bool reducedAnyValue = any(values);\n        float floatedReducedAnyValue = float(reducedAnyValue);\n        anyValue = float(anyValue >= 1.0 || floatedReducedAnyValue >= 1.0);\n      ",f="bvec4");var p="";0<o%t&&(p="\n        if (inIdx < 0 || inIdx >= "+o+") {\n          return initializationValue;\n        }\n      "),this.userCode="\n      const float initializationValue = "+i+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float getValue(int batch, int inIdx) {\n        "+p+"\n        return getX(batch, inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+t+";\n\n        vec4 minMaxValue = vec4("+i+");\n        float prodValue = 1.0;\n        float sumValue = 0.0;\n        float allValue = 1.0;\n        float anyValue = 0.0;\n\n        for (int i = 0; i < "+c+"; i += 4) {\n          int inIdx = inOffset + i;\n          "+f+" values = "+f+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          "+h+"\n        }\n\n        int inIdx = inOffset + "+c+";\n        if ("+(1==l)+") {\n          "+f+" values = "+f+"(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          "+h+"\n        } else if ("+(2==l)+") {\n          "+f+" values = "+f+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          "+h+"\n        } else if ("+(3==l)+") {\n          "+f+" values = "+f+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          "+h+"\n        }\n        setOutput("+u+");\n      }\n    "}function Q0(e,n){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e;for(var t="",r=0;r<4;r++){var o="thisRC = rc;";r%2==1&&(o+="thisRC.z += 1;"),1<r&&(o+="thisRC.y += 1;"),t+="\n        "+o+"\n        "+(0<r?"if(thisRC.y < rows && thisRC.z < cols){":"")+"\n          int flatIndex = getFlatIndex(thisRC);\n\n          ivec3 inputRC = inputCoordsFromReshapedOutCoords(flatIndex);\n          vec2 inputRCInnerDims = vec2(float(inputRC.y),float(inputRC.z));\n\n          result["+r+"] =\n            getChannel(getA(inputRC.x, inputRC.y, inputRC.z), inputRCInnerDims);\n        "+(0<r?"}":"")+"\n      "}this.userCode="\n      \n    ivec3 inputCoordsFromReshapedOutCoords(int index) {\n      "+vr(["r","c","d"],n)+"\n      return ivec3(r, c, d);\n    }\n  \n      "+Ys(e)+"\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n\n        vec4 result = vec4(0.);\n\n        ivec3 thisRC;\n        int rows = "+e[1]+";\n        int cols = "+e[2]+";\n\n        "+t+"\n\n        setOutput(result);\n      }\n    "}function Z0(e,n,t){this.variableNames=["dy"],this.outputShape=[],this.outputShape=n.shape;var r=n.shape,o=r[1],a=r[2],i=e.shape,s=i[1],u=i[2],c=[t&&1<s?o-1:o,t&&1<u?a-1:a],l=[t&&1<s?s-1:s,t&&1<u?u-1:u],h=c[0]/l[0],f=c[1]/l[1],p=1/h,d=1/f,g=2*Math.ceil(p)+2,v=2*Math.ceil(d)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+h+");\n        const float widthScale = float("+f+");\n\n        const float invHeightScale = float("+p+");\n        const float invWidthScale = float("+d+");\n\n        const int winHeight = int("+g+");\n        const int winWidth = int("+v+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(startRLerp - float(winHeight / 2));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(startCLerp - float(winWidth / 2));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+s+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+u+") {\n              continue;\n            }\n\n            float dxR = float(dyR) * heightScale;\n            int topDxRIndex = int(floor(dxR));\n            int bottomDxRIndex = int(min(ceil(dxR), "+(o-1)+".0));\n            float dxRLerp = dxR - float(topDxRIndex);\n            float inverseDxRLerp = 1.0 - dxRLerp;\n\n            float dxC = float(dyC) * widthScale;\n            int leftDxCIndex = int(floor(dxC));\n            int rightDxCIndex = int(min(ceil(dxC), "+(a-1)+".0));\n            float dxCLerp = dxC - float(leftDxCIndex);\n            float inverseDxCLerp = 1.0 - dxCLerp;\n\n            if (r == topDxRIndex && c == leftDxCIndex) {\n              // topLeft\n              accumulator +=\n                getDy(b, dyR, dyC, d) * inverseDxRLerp * inverseDxCLerp;\n            }\n\n            if (r == topDxRIndex && c == rightDxCIndex) {\n              // topRight\n              accumulator += getDy(b, dyR, dyC, d) * inverseDxRLerp * dxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == leftDxCIndex) {\n              // bottomLeft\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * inverseDxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == rightDxCIndex) {\n              // bottomRight\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * dxCLerp;\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "}function ey(e,n,t,r){this.variableNames=["A"],this.outputShape=[];var a=e[1],i=e[2];this.outputShape=[e[0],n,t,e[3]];var u=[r&&1<n?a-1:a,r&&1<t?i-1:i],c=[r&&1<n?n-1:n,r&&1<t?t-1:t];this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+u[0]/c[0]+",\n          "+u[1]/c[1]+");\n      const vec2 inputShapeRC = vec2("+a+".0, "+i+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec2 sourceFloorRC = ivec2(sourceFracIndexRC);\n        ivec2 sourceCeilRC = ivec2(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        float topLeft = getA(b, sourceFloorRC.x, sourceFloorRC.y, d);\n        float bottomLeft = getA(b, sourceCeilRC.x, sourceFloorRC.y, d);\n        float topRight = getA(b, sourceFloorRC.x, sourceCeilRC.y, d);\n        float bottomRight = getA(b, sourceCeilRC.x, sourceCeilRC.y, d);\n\n        vec2 fracRC = sourceFracIndexRC - vec2(sourceFloorRC);\n\n        float top = topLeft + (topRight - topLeft) * fracRC.y;\n        float bottom = bottomLeft + (bottomRight - bottomLeft) * fracRC.y;\n        float newValue = top + (bottom - top) * fracRC.x;\n\n        setOutput(newValue);\n      }\n    "}function ny(e,n,t,r){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[];var a=e[1],i=e[2],s=e[3];this.outputShape=[e[0],n,t,s];var u=[r&&1<n?a-1:a,r&&1<t?i-1:i],c=[r&&1<n?n-1:n,r&&1<t?t-1:t];this.userCode="\n      const vec3 effectiveInputOverOutputRatioRC = vec3(\n          "+u[0]/c[0]+",\n          "+u[1]/c[1]+",\n          "+u[1]/c[1]+");\n      const vec3 inputShapeRC = vec3("+a+".0, "+i+".0,\n                                     "+i+".0);\n\n      float getAValue(int b, int r, int c, int d) {\n        return getChannel(getA(b, r, c, d), vec2(c, d));\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        // Calculate values for next column in yRC.z.\n        ivec3 yRC = coords.yzz + ivec3(0, 0, 1);\n\n        // Fractional source index.\n        vec3 sourceFracIndexRC = vec3(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec3 sourceFloorRC = ivec3(sourceFracIndexRC);\n        ivec3 sourceCeilRC = ivec3(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        // Should we calculate next column and row elements in 2x2 packed cell.\n        bool hasNextCol = d < "+(s-1)+";\n        bool hasNextRow = coords.z < "+(t-1)+";\n\n        // In parallel, construct four corners for all four components in\n        // packed 2x2 cell.\n        vec4 topLeft = vec4(\n          getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 bottomLeft = vec4(\n          getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 topRight = vec4(\n          getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec4 bottomRight = vec4(\n          getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec3 fracRC = sourceFracIndexRC - vec3(sourceFloorRC);\n\n        vec4 top = mix(topLeft, topRight, fracRC.yyzz);\n        vec4 bottom = mix(bottomLeft, bottomRight, fracRC.yyzz);\n        vec4 newValue = mix(top, bottom, fracRC.x);\n\n        setOutput(newValue);\n      }\n    "}function ty(e,n,t){this.variableNames=["dy"],this.outputShape=[],this.outputShape=n.shape;var r=n.shape,o=r[1],a=r[2],i=e.shape,s=i[1],u=i[2],c=[t&&1<s?o-1:o,t&&1<u?a-1:a],l=[t&&1<s?s-1:s,t&&1<u?u-1:u],h=c[0]/l[0],f=c[1]/l[1],p=1/h,d=1/f,g=2*Math.ceil(p)+2,v=2*Math.ceil(d)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+h+");\n        const float widthScale = float("+f+");\n\n        const float invHeightScale = float("+p+");\n        const float invWidthScale = float("+d+");\n\n        const int winHeight = int("+g+");\n        const int winWidth = int("+v+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(floor(startRLerp - float(winHeight / 2)));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(floor(startCLerp - float(winWidth / 2)));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+s+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+u+") {\n              continue;\n            }\n\n            float sourceFracRow =\n              float("+c[0]+") *\n                (float(dyR) / float("+l[0]+"));\n\n            float sourceFracCol =\n                float("+c[1]+") *\n                  (float(dyC) / float("+l[1]+"));\n\n            int sourceNearestRow = int(min(\n                float(int("+o+") - 1),\n                "+t+" ? float(round(sourceFracRow)) :\n                                  float(floor(sourceFracRow))));\n\n            int sourceNearestCol = int(min(\n                float(int("+a+") - 1),\n                "+t+" ? float(round(sourceFracCol)) :\n                                  float(floor(sourceFracCol))));\n\n            if (r == sourceNearestRow && c == sourceNearestCol) {\n              accumulator += getDy(b, dyR, dyC, d);\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "}function ry(e,n,t,r){this.variableNames=["A"],this.outputShape=[];var a=e[1],i=e[2];this.outputShape=[e[0],n,t,e[3]];var u=[r&&1<n?a-1:a,r&&1<t?i-1:i],c=[r&&1<n?n-1:n,r&&1<t?t-1:t];this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+u[0]/c[0]+",\n          "+u[1]/c[1]+");\n      const vec2 inputShapeRC = vec2("+a+".0, "+i+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the coordinators of nearest neighbor point.\n        ivec2 sourceNearestRC = ivec2(\n          min(inputShapeRC - 1.0, floor(sourceFracIndexRC + "+(r?"0.5":"0.0")+")));\n\n        float newValue = getA(b, sourceNearestRC.x, sourceNearestRC.y, d);\n\n        setOutput(newValue);\n      }\n    "}function oy(e,n){this.variableNames=["x"];var t=e.length;if(4<t)throw new Error("WebGL backend: Reverse of rank-"+t+" tensor is not yet supported");if(this.outputShape=e,1!==t){var r=e.map(function(a,i){return-1!==n.indexOf(s=i)&&1!==e[s]?e[s]+" - coords["+s+"] - 1":"coords["+s+"]";var s}).join(","),o=De(t);this.userCode="\n      void main() {\n        "+o+" coords = getOutputCoords();\n        setOutput(getX("+r+"));\n      }\n    "}else this.userCode="\n        void main() {\n          int coord = getOutputCoords();\n          setOutput(getX("+e[0]+" - coord - 1));\n        }\n      "}function ay(e,n){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0;var t=e.length;if(4<t)throw new Error("WebGL backend: Reverse of rank-"+t+" tensor is not yet supported");this.outputShape=e;var r,o,a,i=vn("rc",t),s=i[t-1]+" + 1 < "+this.outputShape[t-1],u=i[t-2]+" + 1 < "+this.outputShape[t-2],c=De(t);function l(h){var f=e.map(function(p,d){return v=h,-1!==n.indexOf(g=d)&&1!==e[g]?e[g]+" - "+v[g]+" - 1":""+v[g];var g,v});return"getChannel(getX("+f.join(",")+"), vec2("+f.slice(-2).join(",")+"))"}this.userCode=1===t?"\n        void main(){\n          int rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = getChannel(getX("+e[0]+" - rc - 1),\n            "+e[0]+" - rc - 1);\n          if("+s+"){\n              result.g = getChannel(getX("+e[0]+" - (rc  + 1) - 1),\n                "+e[0]+" - (rc  + 1) - 1);\n          }\n          setOutput(result);\n        }\n      ":"\n        void main() {\n          "+c+" rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = "+l(i.slice())+";\n          if("+s+"){\n            result.g = "+((a=i.slice())[t-1]="("+a[t-1]+" + 1)",l(a)+";\n          }\n          if(")+u+") {\n            result.b = "+((o=i.slice())[t-2]="("+o[t-2]+" + 1)",l(o)+";\n            if(")+s+") {\n              result.a = "+((r=i.slice())[t-1]="("+r[t-1]+" + 1)",r[t-2]="("+r[t-2]+" + 1)",l(r)+";\n            }\n          }\n          setOutput(result);\n        }\n    ")}function Kf(e,n,t,r,o,a,i){this.variableNames=["updates","indices","defaultValue"],this.outputShape=a;var s=De(o.length),u=De(a.length),c="";1===t?c="i":2===t&&(c="i, j");var h="";1===r?h="i":2===r&&(h="i, coords[1]"),this.userCode="\n        "+s+" strides = "+s+"("+o+");\n\n        void main() {\n          "+u+" coords = getOutputCoords();\n          float sum = 0.0;\n          bool found = false;\n          for (int i = 0; i < "+e+"; i++) {\n            int flattenedIndex = 0;\n            for (int j = 0; j < "+n+"; j++) {\n              int index = round(getIndices("+c+"));\n              flattenedIndex += index * "+(1<n?"strides[j]":"strides")+";\n            }\n            if (flattenedIndex == coords[0]) {\n              sum += getUpdates("+h+");\n              found = true;\n            }\n          }\n          setOutput(mix(getDefaultValue(), sum, float(found)));\n        }\n      "}function iy(e,n){this.variableNames=["x","segmentIds"];var t=e.windowSize,r=e.batchSize,o=e.inSize,a=e.numSegments,i=a*Math.ceil(o/t);this.outputShape=[r,i];var s=4*Math.floor(t/4),u=t%4,c="\n        sumValue += dot(values, segFilter);\n    ",l="";0<o%t&&(l="\n        if (inIdx < 0 || inIdx >= "+o+") {\n          return initializationValue;\n        }\n      ");var h="";0<o%t&&(h="\n        if (inIdx < 0 || inIdx >= "+o+") {\n          return -1.0;\n        }\n      "),this.userCode="\n      const float initializationValue = 0.0;\n\n      float getValue(int batch, int inIdx) {\n        "+l+"\n        return getX(batch, inIdx);\n      }\n\n      float getSegmentIdAtIndex(int inIdx) {\n        "+h+"\n        return getSegmentIds(inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = int(floor(float(outIdx) / float(\n          "+a+")) * float("+t+"));\n        int currentSeg = int(mod(float(outIdx), float("+a+")));\n\n        float sumValue = 0.0;\n\n        for (int i = 0; i < "+s+"; i += 4) {\n          int inIdx = inOffset + i;\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 3)) == currentSeg ? 1 : 0\n          );\n\n          "+c+"\n        }\n\n        int inIdx = inOffset + "+s+";\n        if ("+(1==u)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          int inIdxSeg = int(getSegmentIdAtIndex(inIdx));\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            0,\n            0,\n            0\n          );\n\n          "+c+"\n        } else if ("+(2==u)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n              0,\n              0\n          );\n\n          "+c+"\n        } else if ("+(3==u)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            0\n          );\n\n          "+c+"\n        }\n        setOutput(sumValue);\n      }\n    "}function sy(e,n,t){var r,o;if(this.variableNames=["c","a","b"],this.outputShape=n,4<t)throw Error("Where for rank "+t+" is not yet supported");if(1===t)r=o="resRC";else{for(var a=["resRC.x","resRC.y","resRC.z","resRC.w"],i=[],s=[],u=0;u<n.length;u++)s.push(""+a[u]),u<e&&i.push(""+a[u]);r=i.join(),o=s.join()}var c=De(t);this.userCode="\n      void main() {\n        "+c+" resRC = getOutputCoords();\n        float cVal = getC("+r+");\n        if (cVal >= 1.0) {\n          setOutput(getA("+o+"));\n        } else {\n          setOutput(getB("+o+"));\n        }\n      }\n    "}var uy=(Xf.prototype.getCustomSetupFunc=function(e){var n=this;if(e.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+e.length+")");return function(t,r){null==n.startLoc&&(n.startLoc=t.getUniformLocationNoThrow(r,"start"),null==n.startLoc)||t.gl.uniform1iv(n.startLoc,e)}},Xf),nu=["x","y","z","w","u","v"];function Xf(e){this.variableNames=["source"],this.outputShape=e,this.rank=e.length;var n,t=De(this.rank),r="uniform int start["+this.rank+"];",o=function(a){if(1===a)return"sourceLoc";if(a<=6)return nu.slice(0,a).map(function(i){return"sourceLoc."+i}).join(",");throw Error("Slicing for rank "+a+" is not yet supported")}(this.rank);n="\n        "+t+" sourceLoc;\n        "+t+" coords = getOutputCoords();\n        "+e.map(function(a,i){return"sourceLoc."+nu[i]+" = start["+i+"] + coords."+nu[i]+";"}).join("\n")+"\n      ",this.userCode="\n      "+r+"\n      void main() {\n        "+n+"\n        setOutput(getSource("+o+"));\n      }\n    "}function cy(e,n,t){this.variableNames=["x"];var r=(this.outputShape=t).length,o=De(t.length),a=De(t.length),i="";if(1===r)i="coords * strides + begin";else{var s=0;i=t.map(function(u,c){return s++,1===t.length?"coords * strides["+c+"] + begin["+c+"]":"coords["+(s-1)+"] * strides["+c+"] + begin["+c+"]"}).join(",")}this.userCode="\n      "+o+" begin = "+o+"("+e+");\n      "+o+" strides = "+o+"("+n+");\n\n      void main() {\n        "+a+" coords = getOutputCoords();\n        setOutput(getX("+i+"));\n      }\n    "}var ly=(Yf.prototype.getCustomSetupFunc=function(e){var n=this;if(e.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+e.length+")");return function(t,r){null==n.startLoc&&(n.startLoc=t.getUniformLocationNoThrow(r,"start"),null==n.startLoc)||t.gl.uniform1iv(n.startLoc,e)}},Yf),hy=(gr.prototype.acquireTexture=function(e,n,t){var r,o=$f(n,t),a=Jf(e,o,t);if(a in this.freeTextures||(this.freeTextures[a]=[]),a in this.usedTextures||(this.usedTextures[a]=[]),0<this.freeTextures[a].length){this.numFreeTextures--,this.numUsedTextures++,this.log();var i=this.freeTextures[a].shift();return this.usedTextures[a].push(i),i}return this.numUsedTextures++,this.log(),o===bn.PACKED_2X2_FLOAT32?r=this.gpgpu.createPackedMatrixTexture(e[0],e[1]):o===bn.PACKED_2X2_FLOAT16?r=this.gpgpu.createFloat16PackedMatrixTexture(e[0],e[1]):o===bn.UNPACKED_FLOAT32?r=this.gpgpu.createFloat32MatrixTexture(e[0],e[1]):o===bn.UNPACKED_FLOAT16?r=this.gpgpu.createFloat16MatrixTexture(e[0],e[1]):o===bn.PACKED_4X1_UNSIGNED_BYTE&&(r=this.gpgpu.createUnsignedBytesMatrixTexture(e[0],e[1])),this.usedTextures[a].push(r),r},gr.prototype.releaseTexture=function(e,n,t,r){if(null!=this.freeTextures){var o=Jf(n,$f(t,r),r);o in this.freeTextures||(this.freeTextures[o]=[]),this.freeTextures[o].push(e),this.numFreeTextures++,this.numUsedTextures--;var a=this.usedTextures[o],i=a.indexOf(e);if(i<0)throw new Error("Cannot release a texture that was never provided by this texture manager");a.splice(i,1),this.log()}},gr.prototype.log=function(){this.logEnabled&&console.log("Free/Used",this.numFreeTextures+" / "+this.numUsedTextures,"("+(this.numFreeTextures+this.numUsedTextures)+")")},gr.prototype.getNumUsedTextures=function(){return this.numUsedTextures},gr.prototype.getNumFreeTextures=function(){return this.numFreeTextures},gr.prototype.dispose=function(){var e=this;if(null!=this.freeTextures){for(var n in this.freeTextures)this.freeTextures[n].forEach(function(t){e.gpgpu.deleteMatrixTexture(t)});for(var n in this.usedTextures)this.usedTextures[n].forEach(function(r){e.gpgpu.deleteMatrixTexture(r)});this.freeTextures=null,this.usedTextures=null,this.numUsedTextures=0,this.numFreeTextures=0}},gr);function gr(e){this.gpgpu=e,this.numUsedTextures=0,this.numFreeTextures=0,this.freeTextures={},this.logEnabled=!1,this.usedTextures={}}function Yf(e){this.variableNames=["source"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e,this.rank=e.length;var n=De(this.rank),t=vn("coords",this.rank),r=vn("sourceLoc",this.rank),o=1===this.rank?"sourceLoc":"vec2("+r.slice(-2).join()+")",a="getChannel(getSource("+r.join()+"), "+o+")",i="\n      result.x = "+a+";\n      if (++"+t[this.rank-1]+" < "+e[this.rank-1]+") {\n        ++"+r[this.rank-1]+";\n        result.y = "+a+";\n        --"+r[this.rank-1]+";\n      }\n    ",s=1===this.rank?"":"\n      --"+t[this.rank-1]+";\n      if (++"+t[this.rank-2]+" < "+e[this.rank-2]+") {\n        ++"+r[this.rank-2]+";\n        result.z = "+a+";\n        if (++"+t[this.rank-1]+" < "+e[this.rank-1]+") {\n          ++"+r[this.rank-1]+";\n          result.w = "+a+";\n        }\n      }\n    ",u=this.rank<=4?"sourceLoc = coords +\n            "+n+"("+e.map(function(c,l){return"start["+l+"]"}).join()+");":e.map(function(c,l){return r[l]+" = "+t[l]+" + start["+l+"];"}).join("\n");this.userCode="\n      uniform int start["+this.rank+"];\n      void main() {\n        "+n+" coords = getOutputCoords();\n        "+n+" sourceLoc;\n        "+u+"\n        vec4 result = vec4(0.);\n        "+i+"\n        "+s+"\n        setOutput(result);\n      }\n    "}function $f(e,n){if(e===xn.UPLOAD)return bn.PACKED_2X2_FLOAT32;if(e===xn.RENDER||null==e)return t=n,q().getBool("WEBGL_RENDER_FLOAT32_ENABLED")?t?bn.PACKED_2X2_FLOAT32:bn.UNPACKED_FLOAT32:t?bn.PACKED_2X2_FLOAT16:bn.UNPACKED_FLOAT16;var t;if(e===xn.DOWNLOAD||e===xn.PIXELS)return bn.PACKED_4X1_UNSIGNED_BYTE;throw new Error("Unknown logical texture type "+e)}function Jf(e,n,t){return e[0]+"_"+e[1]+"_"+n+"_"+t}function fy(e,n){this.variableNames=["A"];for(var t=new Array(e.length),r=0;r<t.length;r++)t[r]=e[r]*n[r];this.outputShape=t,this.rank=t.length;var o=De(this.rank),a=function(i){var s=i.length;if(5<s)throw Error("Tile for rank "+s+" is not yet supported");if(1===s)return"imod(resRC, "+i[0]+")";for(var u=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u"],c=[],l=0;l<i.length;l++)c.push("imod("+u[l]+", "+i[l]+")");return c.join()}(e);this.userCode="\n      void main() {\n        "+o+" resRC = getOutputCoords();\n        setOutput(getA("+a+"));\n      }\n    "}function py(e,n){this.variableNames=["A"];for(var t=new Array(e.length),r=0;r<t.length;r++)t[r]=e[n[r]];this.outputShape=t,this.rank=t.length;var o=De(this.rank),a=function(i){var s=i.length;if(6<s)throw Error("Transpose for rank "+s+" is not yet supported");for(var u=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u","resRC.v"],c=new Array(s),l=0;l<i.length;l++)c[i[l]]=u[l];return c.join()}(n);this.userCode="\n    void main() {\n      "+o+" resRC = getOutputCoords();\n      setOutput(getA("+a+"));\n    }\n    "}function dy(e,n){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0;for(var t=new Array(e.length),r=0;r<t.length;r++)t[r]=e[n[r]];if(this.outputShape=t,this.rank=t.length,6<this.rank)throw Error("Packed transpose for rank "+this.rank+" is not yet supported.");var o=De(this.rank),a=df("rc",this.rank),i=new Array(this.rank);for(r=0;r<n.length;r++)i[n[r]]=a[r];var s="vec2("+i.slice(-2).join()+")",u="++"+a[this.rank-1]+" < "+t[this.rank-1],c="getChannel(getA("+i.join()+"), "+s+")";this.userCode="\n    void main() {\n      "+o+" rc = getOutputCoords();\n      vec4 result = vec4(0.);\n      result[0] = "+c+";\n      if("+u+") {\n        result[1] = "+c+";\n      }\n      --"+a[this.rank-1]+";\n      if(++"+a[this.rank-2]+" < "+t[this.rank-2]+") {\n        result[2] = "+c+";\n        if("+u+") {\n          result[3] = "+c+";\n        }\n      }\n      setOutput(result);\n    }\n    "}function pe(e,n){this.variableNames=["A"],this.outputShape=e,this.userCode="\n      float unaryOperation(float x) {\n        "+n+"\n      }\n\n      void main() {\n        float x = getAAtOutCoords();\n        float y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "}function Oo(e,n){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e,this.userCode="\n      vec4 unaryOperation(vec4 x) {\n        "+n+"\n      }\n\n      void main() {\n        vec4 x = getAAtOutCoords();\n        vec4 y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "}function vy(e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1;var n=(this.outputShape=e).length,t=vn("rc",n),r=De(n),o=function(s,u){if(1===s)return"rc";for(var c="",l=0;l<s;l++)c+=u[l],l<s-1&&(c+=",");return c}(n,t),a=t.slice(-2),i=n<=1?"rc":"vec2("+a.join(",")+")";this.userCode="\n      void main() {\n        "+r+" rc = getOutputCoords();\n        vec4 packedInput = getA("+o+");\n\n        setOutput(getChannel(packedInput, "+i+"));\n      }\n    "}var tu="if (isnan(x)) return x;",Qf="return abs(x);",Zf=tu+"\n  return (x < 0.0) ? 0.0 : x;\n",ep=tu+"\n  return (x < 0.0) ? 0.0 : min(6.0, x);\n",np="return (x >= 0.0) ? x : (exp(x) - 1.0);",tp="return -x;",rp="return ceil(x);",op="return floor(x);",ap="return exp(x);",ip="return exp(x) - 1.0;",Ha="return x;",sp="\n  vec4 result = x * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n",up="\n  vec4 result = min(x, vec4(6.)) * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n",cp="\n  vec4 result;\n\n  result.r = (x.r >= 0.0) ? x.r : (exp(x.r) - 1.0);\n  result.g = (x.g >= 0.0) ? x.g : (exp(x.g) - 1.0);\n  result.b = (x.b >= 0.0) ? x.b : (exp(x.b) - 1.0);\n  result.a = (x.a >= 0.0) ? x.a : (exp(x.a) - 1.0);\n\n  return result;\n",ru={};function qa(e,n){if(void 0===n&&(n=!1),"linear"===e)return"return x;";if("relu"===e)return n?sp:Zf;if("elu"===e)return n?cp:np;if("relu6"===e)return n?up:ep;if("prelu"===e)return n?xf:yf;throw new Error("Activation "+e+" has not been implemented for the WebGL backend.")}var lp,hp=(Nn(O,lp=zs),O.prototype.numDataIds=function(){return this.texData.numDataIds()+(this.cpuBackend?this.cpuBackend.numDataIds():0)-this.pendingDeletes},O.prototype.write=function(e,n,t){if(q().getBool("DEBUG")&&this.checkNumericalProblems(e),"complex64"===t&&null!=e)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");var r={};return this.texData.set(r,{shape:n,dtype:t,values:e,usage:xn.UPLOAD}),r},O.prototype.move=function(e,n,t,r){if(q().getBool("DEBUG")&&this.checkNumericalProblems(n),"complex64"===r)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");this.texData.set(e,{shape:t,dtype:r,values:n,usage:xn.UPLOAD})},O.prototype.readSync=function(e){var n=this.texData.get(e),t=n.values,r=n.dtype,o=n.complexTensors,i=n.shape;if(null!=n.slice){var u;u=n.isPacked?new Oo(i,Ha):new pe(i,Ha);var c=this.runWebGLProgram(u,[{dataId:e,shape:i,dtype:r}],r),l=this.readSync(c.dataId);return this.disposeData(c.dataId),l}if(null!=t)return this.convertAndCacheOnCPU(e);if("string"===r)return t;var h,f,p=null!=this.activeTimers;return p&&(h=Mn()),f="complex64"===r?qs(o.real.dataSync(),o.imag.dataSync()):this.getValuesFromTexture(e),p&&(this.downloadWaitMs+=Mn()-h),this.convertAndCacheOnCPU(e,f)},O.prototype.read=function(e){return oe(this,void 0,void 0,function(){var n,t,r,o,i,s,u,c,l,h,f,p,d,g,v,x,w,b,I;return ae(this,function(E){switch(E.label){case 0:if(this.pendingRead.has(e))return n=this.pendingRead.get(e),[2,new Promise(function(C){return n.push(C)})];if(t=this.texData.get(e),r=t.values,o=t.shape,i=t.dtype,s=t.complexTensors,u=t.isPacked,null!=t.slice)return c=u?new Oo(o,Ha):new pe(o,Ha),l=this.runWebGLProgram(c,[{dataId:e,shape:o,dtype:i}],i),h=this.read(l.dataId),this.disposeData(l.dataId),[2,h];if(null!=r)return[2,this.convertAndCacheOnCPU(e)];if(!q().getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")&&2===q().getNumber("WEBGL_VERSION"))throw new Error("tensor.data() with WEBGL_DOWNLOAD_FLOAT_ENABLED=false and WEBGL_VERSION=2 not yet supported.");return f=null,"complex64"!==i&&q().get("WEBGL_BUFFER_SUPPORTED")&&(p=this.decode(e),d=this.texData.get(p.dataId),f=(I=this.gpgpu).createBufferFromTexture.apply(I,[d.texture].concat(bo(o)))),this.pendingRead.set(e,[]),"complex64"===i?[3,2]:[4,this.gpgpu.createAndWaitForFence()];case 1:E.sent(),E.label=2;case 2:return"complex64"!==i?[3,4]:[4,Promise.all([s.real.data(),s.imag.data()])];case 3:return v=E.sent(),g=qs(v[0],v[1]),[3,5];case 4:g=null==f?this.getValuesFromTexture(e):(x=ie(o),this.gpgpu.downloadFloat32MatrixFromBuffer(f,x)),E.label=5;case 5:return null!=p&&this.disposeData(p.dataId),w=this.convertAndCacheOnCPU(e,g),b=this.pendingRead.get(e),this.pendingRead.delete(e),b.forEach(function(C){return C(w)}),this.pendingDisposal.has(e)&&(this.pendingDisposal.delete(e),this.disposeData(e),this.pendingDeletes--),[2,w]}})})},O.prototype.checkNumericalProblems=function(e){if(null!=e)for(var n=0;n<e.length;n++){var t=e[n];if(!eh(t))throw q().getBool("WEBGL_RENDER_FLOAT32_CAPABLE")?Error("The value "+t+" cannot be represented with your current settings. Consider enabling float32 rendering: 'tf.env().set('WEBGL_RENDER_FLOAT32_ENABLED', true);'"):Error("The value "+t+" cannot be represented on this device.")}},O.prototype.getValuesFromTexture=function(e){var n,t=this.texData.get(e),r=t.shape,o=t.dtype,a=t.isPacked,i=ie(r);if(q().getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")){var s=this.decode(e),u=this.texData.get(s.dataId),c=(n=this.gpgpu).downloadMatrixFromPackedTexture.apply(n,[u.texture].concat(bo(r))).subarray(0,i);return this.disposeData(s.dataId),c}var l=q().getBool("WEBGL_PACK")&&!0===a,h=l?Ia(r):r,f=l?new N0(h):new T0(h),p=this.runWebGLProgram(f,[{shape:h,dtype:o,dataId:e}],"float32"),d=this.texData.get(p.dataId),g=this.gpgpu.downloadByteEncodedFloatMatrixFromOutputTexture(d.texture,d.texShape[0],d.texShape[1]).subarray(0,i);return this.disposeData(p.dataId),g},O.prototype.time=function(e){return oe(this,void 0,void 0,function(){var n,t,r,o,a,i,s;return ae(this,function(u){switch(u.label){case 0:return n=this.activeTimers,r=!(t=[]),null==this.programTimersStack?(this.programTimersStack=t,r=!0):this.activeTimers.push(t),this.activeTimers=t,e(),o=st(this.activeTimers.map(function(c){return c.query})).filter(function(c){return null!=c}),a=st(this.activeTimers.map(function(c){return c.name})).filter(function(c){return null!=c}),this.activeTimers=n,r&&(this.programTimersStack=null),i={uploadWaitMs:this.uploadWaitMs,downloadWaitMs:this.downloadWaitMs,kernelMs:null,wallMs:null},0<q().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")?[4,Promise.all(o)]:[3,2];case 1:return s=u.sent(),i.kernelMs=Fl(s),i.getExtraProfileInfo=function(){return s.map(function(c,l){return{name:a[l],ms:c}}).map(function(c){return c.name+": "+c.ms}).join(", ")},[3,3];case 2:i.kernelMs={error:"WebGL query timers are not supported in this environment."},u.label=3;case 3:return this.uploadWaitMs=0,this.downloadWaitMs=0,[2,i]}})})},O.prototype.memory=function(){return{unreliable:!1,numBytesInGPU:this.numBytesInGPU}},O.prototype.startTimer=function(){return 0<q().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")?this.gpgpu.beginQuery():{startMs:Mn(),endMs:null}},O.prototype.endTimer=function(e){return 0<q().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")?this.gpgpu.endQuery():e.endMs=Mn(),e},O.prototype.getQueryTime=function(e){return oe(this,void 0,void 0,function(){var n;return ae(this,function(t){return 0<q().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")?[2,this.gpgpu.waitForQueryAndGetTime(e)]:[2,(n=e).endMs-n.startMs]})})},O.prototype.disposeData=function(e){if(!this.pendingDisposal.has(e)){if(this.pendingRead.has(e))return this.pendingDisposal.add(e),void this.pendingDeletes++;if(this.texData.has(e)){this.releaseGPUData(e);var n=this.texData.get(e).complexTensors;null!=n&&(n.real.dispose(),n.imag.dispose()),this.texData.delete(e)}}},O.prototype.releaseGPUData=function(e){var n=this.texData.get(e),t=n.texture,r=n.dtype,o=n.texShape,a=n.usage,i=n.isPacked,s=n.slice,u=s&&s.origDataId||e,c=this.dataRefCount.get(u);1<c?this.dataRefCount.set(u,c-1):(this.dataRefCount.delete(u),null!=t&&(this.numBytesInGPU-=this.computeBytes(o,r),this.textureManager.releaseTexture(t,o,a,i)));var l=this.texData.get(e);l.texture=null,l.texShape=null,l.isPacked=!1,l.slice=null},O.prototype.getTexture=function(e){return this.uploadToGPU(e),this.texData.get(e).texture},O.prototype.getDataInfo=function(e){return this.texData.get(e)},O.prototype.getCPUBackend=function(){return q().getBool("WEBGL_CPU_FORWARD")?(null==this.cpuBackend&&(this.cpuBackend=A.findBackend("cpu")),this.cpuBackend):null},O.prototype.shouldExecuteOnCPU=function(e,n){var t=this;return void 0===n&&(n=128),null!=this.getCPUBackend()&&e.every(function(r){return null==t.texData.get(r.dataId).texture&&r.size<n})},O.prototype.getGPGPUContext=function(){return this.gpgpu},O.prototype.complex=function(e,n){var t=this.makeOutput(e.shape,"complex64");return this.texData.get(t.dataId).complexTensors={real:A.keep(e.clone()),imag:A.keep(n.clone())},t},O.prototype.real=function(e){return this.texData.get(e.dataId).complexTensors.real.clone()},O.prototype.imag=function(e){return this.texData.get(e.dataId).complexTensors.imag.clone()},O.prototype.slice=function(e,n,t){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.slice(e,n,t);if(0===ie(t))return Je([],t,e.dtype);var r=this.texData.get(e.dataId).isPacked,o=Bs(e.shape,n,t);if(!r&&o)return this.uploadToGPU(e.dataId),this.shallowSlice(e,n,t);var a=q().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new ly(t):new uy(t),i=a.getCustomSetupFunc(n);return this.compileAndRun(a,[e],null,i)},O.prototype.shallowSlice=function(e,n,t){var r=this.texData.get(e.dataId),o=this.makeOutput(t,e.dtype),a=this.texData.get(o.dataId);Object.assign(a,r),a.shape=t,a.dtype=e.dtype;var i=Ls(n,e.strides);r.slice&&(i+=r.slice.flatOffset),a.slice={flatOffset:i,origDataId:r.slice&&r.slice.origDataId||e.dataId};var s=this.dataRefCount.get(a.slice.origDataId)||1;return this.dataRefCount.set(a.slice.origDataId,s+1),o},O.prototype.stridedSlice=function(e,n,t,r){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.stridedSlice(e,n,t,r);var o=La(n,t,r);if(o.some(function(i){return 0===i}))return Je([],o);var a=new cy(n,r,o);return this.compileAndRun(a,[e])},O.prototype.reverse=function(e,n){var t=q().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new ay(e.shape,n):new oy(e.shape,n);return this.compileAndRun(t,[e])},O.prototype.concat=function(e,n){if("complex64"===e[0].dtype){var t=e.map(function(h){return Cn(h)}),r=e.map(function(h){return Bn(h)});return $e(this.concat(t,n),this.concat(r,n))}if(this.shouldExecuteOnCPU(e))return this.cpuBackend.concat(e,n);if(1===e.length)return e[0];if(e.length>q().getNumber("WEBGL_MAX_TEXTURES_IN_SHADER")){var o=Math.floor(e.length/2),a=this.concat(e.slice(0,o),n),i=this.concat(e.slice(o),n);return this.concat([a,i],n)}if(q().getBool("WEBGL_PACK_ARRAY_OPERATIONS")&&1<e[0].rank){var s=new m0(e.map(function(h){return h.shape}),n);return this.compileAndRun(s,e)}var u=cr(e.map(function(h){return h.shape}),n),c=e.map(function(h){return h.as2D(-1,ie(h.shape.slice(n)))}),l=new v0(c.map(function(h){return h.shape}));return this.compileAndRun(l,c).reshape(u)},O.prototype.neg=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.neg(e);if(q().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,tp,e.dtype);var n=new pe(e.shape,tp);return this.compileAndRun(n,[e])},O.prototype.batchMatMul=function(e,n,t,r){var o=t?e.shape[2]:e.shape[1],a=r?n.shape[1]:n.shape[2],i=t?e.shape[1]:e.shape[2],s=e.shape[0];if((1===o||1===a)&&1e3<i){t&&(e=e.transpose([0,2,1])),r&&(n=n.transpose([0,2,1]));var u=1===a?e:e.as3D(s,i,1),c=1===a?2:1,l=1===a?n.as3D(s,1,i):n;return this.multiply(u,l).sum(c,!0)}var h=Ye(e.dtype,n.dtype),f=new Qs(e.shape,[s,o,a],t,r);return this.compileAndRun(f,[e,n],h)},O.prototype.fusedBatchMatMul=function(e){var n=e.a,t=e.b,r=e.transposeA,o=e.transposeB,a=e.bias,i=e.activation,s=e.preluActivationWeights,u=r?n.shape[2]:n.shape[1],c=o?t.shape[1]:t.shape[2],l=n.shape[0],h=Ye(n.dtype,t.dtype),f=null!=a,p=null!=s,d=i?qa(i,!0):null,g=new Qs(n.shape,[l,u,c],r,o,f,d,p),v=[n,t];return a&&v.push(a),s&&v.push(s),this.compileAndRun(g,v,h)},O.prototype.multiply=function(e,n){if("complex64"===e.dtype){var t=this.texData.get(e.dataId),r=this.texData.get(n.dataId),o=new mf("return areal * breal - aimag * bimag;",e.shape,n.shape),a=new mf("return areal * bimag + aimag * breal;",e.shape,n.shape),i=[this.makeComplexComponentTensorInfo(e,t.complexTensors.real),this.makeComplexComponentTensorInfo(e,t.complexTensors.imag),this.makeComplexComponentTensorInfo(n,r.complexTensors.real),this.makeComplexComponentTensorInfo(n,r.complexTensors.imag)],s=this.compileAndRun(o,i),u=this.compileAndRun(a,i),c=this.complex(s,u);return s.dispose(),u.dispose(),c}if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.multiply(e,n);if(q().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,gf,e.dtype);var l=new Oe(gf,e.shape,n.shape);return this.compileAndRun(l,[e,n],e.dtype)},O.prototype.batchNormalization=function(e,n,t,r,o,a){var i=[e,n,t],s=null;null!=a&&(s=a.shape,i.push(a));var u=null;if(null!=o&&(u=o.shape,i.push(o)),q().getBool("WEBGL_PACK_NORMALIZATION")){var c=new p0(e.shape,n.shape,t.shape,s,u,r);return this.compileAndRun(c,i)}var l=new f0(e.shape,n.shape,t.shape,s,u,r);return this.compileAndRun(l,i)},O.prototype.localResponseNormalization4D=function(e,n,t,r,o){var a=q().getBool("WEBGL_PACK_NORMALIZATION")?new G0(e.shape,n,t,r,o):new U0(e.shape,n,t,r,o);return this.compileAndRun(a,[e])},O.prototype.LRNGrad=function(e,n,t,r,o,a,i){var s=new V0(n.shape,r,o,a,i);return this.compileAndRun(s,[n,t,e])},O.prototype.tile=function(e,n){if("string"===e.dtype){var t=this.readSync(e.dataId).map(function(o){return mo(o)});return ff(he(e.shape,e.dtype,t),n)}var r=new fy(e.shape,n);return this.compileAndRun(r,[e])},O.prototype.pad=function(e,n,t){var r=q().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new $0(e.shape,n,t):new Y0(e.shape,n,t);return this.compileAndRun(r,[e])},O.prototype.transpose=function(e,n){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.transpose(e,n);var t=q().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new dy(e.shape,n):new py(e.shape,n);return this.compileAndRun(t,[e])},O.prototype.gather=function(e,n,t){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.gather(e,n,t);var r=new O0(e.shape,n.size,t);return this.compileAndRun(r,[e,n])},O.prototype.batchToSpaceND=function(e,n,t){S(e.rank<=4,function(){return"batchToSpaceND for rank > 4 with a WebGL backend not implemented yet"});var r=n.reduce(function(c,l){return c*l}),o=Ma(e.shape,n,r),a=Oa(o.length,n.length),i=Pa(e.shape,n,r),s=Qh(t,n.length),u=Zh(i,t,n.length);return e.reshape(o).transpose(a).reshape(i).slice(s,u)},O.prototype.spaceToBatchND=function(e,n,t){S(e.rank<=4,function(){return"spaceToBatchND for rank > 4 with a WebGL backend not implemented yet"});var r=n.reduce(function(l,h){return l*h}),o=[[0,0]];o.push.apply(o,t);for(var a=1+n.length;a<e.shape.length;++a)o.push([0,0]);var i=e.pad(o),s=Ma(i.shape,n,r,!1),u=Oa(s.length,n.length,!1),c=Pa(i.shape,n,r,!1);return i.reshape(s).transpose(u).reshape(c)},O.prototype.reduce=function(e,n,t){var r=e.shape[0],o=e.shape[1],i=new J0({windowSize:Ba(o),inSize:o,batchSize:r},n),s=this.compileAndRun(i,[e],t);return 1===s.shape[1]?s:this.reduce(s,n,t)},O.prototype.argReduce=function(e,n,t){void 0===t&&(t=null);var r=e.shape[0],o=e.shape[1];null!=t&&(r=t.shape[0],o=t.shape[1]);var i=new s0({windowSize:Ba(o),inSize:o,batchSize:r},n,null==t),s=[e];null!=t&&s.push(t);var u=this.compileAndRun(i,s,"int32");return 1===u.shape[1]?u:this.argReduce(e,n,u)},O.prototype.argReducePacked=function(e,n,t){void 0===t&&(t=null);var r=null!=t?t.shape:e.shape,a=new c0(r,Ba(r[r.length-1]),n,null==t),s=this.compileAndRun(a,null==t?[e]:[e,t],"int32");return s.rank===e.rank?this.argReducePacked(e,n,s):s},O.prototype.sum=function(e,n){pn("sum",n,e.rank);var t=en(e.shape,n),r=t[0],o=ie(t[1]),a=e.as2D(-1,o),i=ya(e.dtype);return this.reduce(a,"sum",i).reshape(r)},O.prototype.prod=function(e,n){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.prod(e,n);var t=en(e.shape,n),r=t[0],o=ie(t[1]),a=e.as2D(-1,o),i=ya(e.dtype);return this.reduce(a,"prod",i).reshape(r)},O.prototype.unsortedSegmentSum=function(e,n,t){var r=0,o=On([r],e.rank),a=e;null!=o&&(a=e.transpose(o),r=Pn(1,e.rank)[0]);var i=function(h,f,p){for(var d=[],g=h.length,v=0;v<g;v++)d.push(v!==f?h[v]:p);return d}(a.shape,r,t),s=ie([a.shape[r]]),u=a.as2D(-1,s),c=ya(e.dtype),l=this.segOpCompute(u,"unsortedSegmentSum",n,c,t).reshape(i);return null!=o&&(l=l.transpose(Sa(o))),l},O.prototype.segOpCompute=function(e,n,t,r,o){var a=e.shape[0],i=e.shape[1],s=function(l,h){var f,p=!1;for(l<=30?(f=l,p=!0):f=fa(l,Math.floor(Math.sqrt(l)));!p;)h<f||f===l?p=!0:f=fa(l,f+1);return f}(i,o),u=new iy({windowSize:s,inSize:i,batchSize:a,numSegments:o},n),c=this.compileAndRun(u,[e,t],r);return c.shape[1]===o?c:(t=So(0,o).tile([i/s]),this.segOpCompute(c,n,t,r,o))},O.prototype.argMinMaxReduce=function(e,n,t){var r=[n];if(pn("arg"+t.charAt(0).toUpperCase()+t.slice(1),r,e.rank),!q().getBool("WEBGL_PACK_REDUCE")||e.rank<=2){var o=en(e.shape,r),a=o[0],i=ie(o[1]),s=e.as2D(-1,i);return this.argReduce(s,t).reshape(a)}return this.argReducePacked(e,t)},O.prototype.argMin=function(e,n){return this.argMinMaxReduce(e,n,"min")},O.prototype.argMax=function(e,n){return this.argMinMaxReduce(e,n,"max")},O.prototype.cumsum=function(e,n,t,r){if(n!==e.rank-1)throw new Error("WebGL cumsum shader expects an inner-most axis="+(e.rank-1)+" but got axis="+n);var o=new k0(e.shape,t,r);return this.compileAndRun(o,[e])},O.prototype.equal=function(e,n){if(q().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(equal(a, b));\n","bool");var t=new Oe("return float(a == b);",e.shape,n.shape);return this.compileAndRun(t,[e,n],"bool")},O.prototype.notEqual=function(e,n){if(q().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(notEqual(a, b));\n","bool");var t=new Oe("return float(a != b);",e.shape,n.shape);return this.compileAndRun(t,[e,n],"bool")},O.prototype.less=function(e,n){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.less(e,n);if(q().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(lessThan(a, b));\n","bool");var t=new Oe("return float(a < b);",e.shape,n.shape);return this.compileAndRun(t,[e,n],"bool")},O.prototype.lessEqual=function(e,n){if(q().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(lessThanEqual(a, b));\n","bool");var t=new Oe("return float(a <= b);",e.shape,n.shape);return this.compileAndRun(t,[e,n],"bool")},O.prototype.greater=function(e,n){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.greater(e,n);if(q().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(greaterThan(a, b));\n","bool");var t=new Oe("return float(a > b);",e.shape,n.shape);return this.compileAndRun(t,[e,n],"bool")},O.prototype.greaterEqual=function(e,n){if(q().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(greaterThanEqual(a, b));\n","bool");var t=new Oe("return float(a >= b);",e.shape,n.shape);return this.compileAndRun(t,[e,n],"bool")},O.prototype.logicalNot=function(e){var n=new pe(e.shape,"return float(!(x >= 1.0));");return this.compileAndRun(n,[e])},O.prototype.logicalAnd=function(e,n){if(q().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return vec4(\n    vec4(greaterThanEqual(a, vec4(1.0))) *\n    vec4(greaterThanEqual(b, vec4(1.0))));\n","bool");var t=new Oe("return float(a >= 1.0 && b >= 1.0);",e.shape,n.shape);return this.compileAndRun(t,[e,n],"bool")},O.prototype.logicalOr=function(e,n){if(q().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  return min(\n    vec4(greaterThanEqual(a, vec4(1.0))) +\n    vec4(greaterThanEqual(b, vec4(1.0))),\n    vec4(1.0));\n","bool");var t=new Oe("return float(a >= 1.0 || b >= 1.0);",e.shape,n.shape);return this.compileAndRun(t,[e,n],"bool")},O.prototype.select=function(e,n,t){var r=new sy(e.rank,n.shape,n.rank);return this.compileAndRun(r,[e,n,t],Ye(n.dtype,t.dtype))},O.prototype.where=function(e){ka("tf.where() in webgl locks the UI thread. Call tf.whereAsync() instead");var n=e.dataSync();return Xs(e.shape,n)},O.prototype.topk=function(e,n,t){return pf(e.dataSync(),e.shape,e.dtype,n)},O.prototype.min=function(e,n){pn("min",n,e.rank);var t=en(e.shape,n),r=t[0],o=ie(t[1]),a=e.as2D(-1,o);return this.reduce(a,"min",a.dtype).reshape(r)},O.prototype.minimum=function(e,n){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.minimum(e,n);var t=q().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new ft("\n  vec4 result = vec4(min(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,n.shape):new Oe("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return min(a, b);\n",e.shape,n.shape);return this.compileAndRun(t,[e,n])},O.prototype.mod=function(e,n){var t=q().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new ft("\n  vec4 result = mod(a, b);\n  vec4 isNaN = vec4(equal(b, vec4(0.0)));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,n.shape):new Oe("if (b == 0.0) return NAN;\n  return mod(a, b);",e.shape,n.shape);return this.compileAndRun(t,[e,n])},O.prototype.max=function(e,n){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.max(e,n);pn("max",n,e.rank);var t=en(e.shape,n),r=t[0],o=ie(t[1]),a=e.as2D(-1,o);return this.reduce(a,"max",a.dtype).reshape(r)},O.prototype.maximum=function(e,n){if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.maximum(e,n);var t=q().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new ft("\n  vec4 result = vec4(max(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,n.shape):new Oe("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return max(a, b);\n",e.shape,n.shape);return this.compileAndRun(t,[e,n])},O.prototype.all=function(e,n){pn("all",n,e.rank);var t=en(e.shape,n),r=t[0],o=ie(t[1]),a=e.as2D(-1,o);return this.reduce(a,"all",a.dtype).reshape(r)},O.prototype.any=function(e,n){pn("any",n,e.rank);var t=en(e.shape,n),r=t[0],o=ie(t[1]),a=e.as2D(-1,o);return this.reduce(a,"any",a.dtype).reshape(r)},O.prototype.realDivide=function(e,n){if(q().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  // vec4 one = vec4(equal(a, b));\n  // return one + (vec4(1.0) - one) * a / b;\n  vec4 result = a / b;\n  if(a.x == b.x) {\n    result.x = 1.;\n  }\n  if(a.y == b.y) {\n    result.y = 1.;\n  }\n  if(a.z == b.z) {\n    result.z = 1.;\n  }\n  if(a.w == b.w) {\n    result.w = 1.;\n  }\n\n  return result;\n","float32",!0);var t=new Oe("\nif (a == b) {\n  return 1.0;\n};\nreturn a / b;",e.shape,n.shape);return this.compileAndRun(t,[e,n],"float32")},O.prototype.floorDiv=function(e,n){if(q().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,"\n  ivec4 ia = round(a);\n  ivec4 ib = round(b);\n  bvec4 cond = notEqual(ib, ivec4(0));\n  ivec4 result = ivec4(0);\n  vec4 s = sign(a) * sign(b);\n\n  // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n  if (cond[0]) {\n    result[0] = idiv(ia[0], ib[0], s[0]);\n  }\n  if (cond[1]) {\n    result[1] = idiv(ia[1], ib[1], s[1]);\n  }\n  if (cond[2]) {\n    result[2] = idiv(ia[2], ib[2], s[2]);\n  }\n  if (cond[3]) {\n    result[3] = idiv(ia[3], ib[3], s[3]);\n  }\n  return vec4(result);\n","int32");var t=new Oe("\n  float s = sign(a) * sign(b);\n  int ia = round(a);\n  int ib = round(b);\n  if (ib != 0) {\n    // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n    return float(idiv(ia, ib, s));\n  } else {\n    return NAN;\n  }\n",e.shape,n.shape);return this.compileAndRun(t,[e,n],"int32")},O.prototype.add=function(e,n){if("complex64"===e.dtype&&"complex64"===n.dtype)return this.complexSeparableBinaryOp(e,n,$s);if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.add(e,n);var t=Ye(e.dtype,n.dtype);if(q().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,$s,t);var r=new Oe($s,e.shape,n.shape);return this.compileAndRun(r,[e,n],t)},O.prototype.packedUnaryOp=function(e,n,t){var r=new Oo(e.shape,n);return this.compileAndRun(r,[e],t)},O.prototype.packedBinaryOp=function(e,n,t,r,o){void 0===o&&(o=!1);var a=new ft(t,e.shape,n.shape,o);return this.compileAndRun(a,[e,n],r)},O.prototype.complexSeparableBinaryOp=function(e,n,t){var r=this,o=this.texData.get(e.dataId),a=this.texData.get(n.dataId),i=[[o.complexTensors.real,a.complexTensors.real],[o.complexTensors.imag,a.complexTensors.imag]].map(function(l){var h=l[0],f=l[1],p=r.makeComplexComponentTensorInfo(e,h),d=r.makeComplexComponentTensorInfo(n,f),g=new Oe(t,e.shape,n.shape);return r.compileAndRun(g,[p,d],Ye(h.dtype,f.dtype))}),s=i[0],u=i[1],c=this.complex(s,u);return s.dispose(),u.dispose(),c},O.prototype.makeComplexComponentTensorInfo=function(e,n){return{dataId:n.dataId,dtype:n.dtype,shape:e.shape}},O.prototype.addN=function(e){if(1===e.length)return e[0];if(e.length>q().get("WEBGL_MAX_TEXTURES_IN_SHADER")){var n=Math.floor(e.length/2),t=this.addN(e.slice(0,n)),r=this.addN(e.slice(n));return this.addN([t,r])}var o=e.map(function(s){return s.dtype}).reduce(function(s,u){return Ye(s,u)}),a=e.map(function(s){return s.shape}),i=q().getBool("WEBGL_PACK")?new i0(e[0].shape,a):new a0(e[0].shape,a);return this.compileAndRun(i,e,o)},O.prototype.subtract=function(e,n){if("complex64"===e.dtype&&"complex64"===n.dtype)return this.complexSeparableBinaryOp(e,n,Js);if(this.shouldExecuteOnCPU([e,n]))return this.cpuBackend.subtract(e,n);var t=Ye(e.dtype,n.dtype);if(q().getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(e,n,Js,e.dtype);var r=new Oe(Js,e.shape,n.shape);return this.compileAndRun(r,[e,n],t)},O.prototype.pow=function(e,n){var t=q().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new ft("\n  // isModRound1 has 1 for components with round(mod(b, 2.0)) == 1, 0 otherwise.\n  vec4 isModRound1 = vec4(equal(round(mod(b, 2.0)), ivec4(1)));\n  vec4 multiplier = sign(a) * isModRound1 + (vec4(1.0) - isModRound1);\n  vec4 result = multiplier * pow(abs(a), b);\n\n  // Ensure that a^0 = 1, including 0^0 = 1 as this correspond to TF and JS\n  bvec4 isExpZero = equal(b, vec4(0.0));\n  result.r = isExpZero.r ? 1.0 : result.r;\n  result.g = isExpZero.g ? 1.0 : result.g;\n  result.b = isExpZero.b ? 1.0 : result.b;\n  result.a = isExpZero.a ? 1.0 : result.a;\n\n  vec4 isNaN = vec4(lessThan(a, vec4(0.0))) * vec4(lessThan(floor(b), b));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,n.shape):new Oe("\nif(a < 0.0 && floor(b) < b){\n  return NAN;\n}\nif (b == 0.0) {\n  return 1.0;\n}\nreturn (round(mod(b, 2.0)) != 1) ?\n    pow(abs(a), b) : sign(a) * pow(abs(a), b);\n",e.shape,n.shape),r=Ye(e.dtype,n.dtype);return this.compileAndRun(t,[e,n],r)},O.prototype.ceil=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.ceil(e);if(q().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,rp,e.dtype);var n=new pe(e.shape,rp);return this.compileAndRun(n,[e])},O.prototype.floor=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.floor(e);if(q().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,op,e.dtype);var n=new pe(e.shape,op);return this.compileAndRun(n,[e])},O.prototype.sign=function(e){var n=new pe(e.shape,"\n  if (isnan(x)) { return 0.0; }\n  return sign(x);\n");return this.compileAndRun(n,[e])},O.prototype.isNaN=function(e){var n=new pe(e.shape,"return float(isnan(x));");return this.compileAndRun(n,[e],"bool")},O.prototype.isInf=function(e){var n=new pe(e.shape,"return float(isinf(x));");return this.compileAndRun(n,[e],"bool")},O.prototype.isFinite=function(e){var n=new pe(e.shape,"return float(!isnan(x) && !isinf(x));");return this.compileAndRun(n,[e],"bool")},O.prototype.round=function(e){var n=new pe(e.shape,"\n  // OpenGL ES does not support round function.\n  // The algorithm is based on banker's rounding.\n  float base = floor(x);\n  if ((x - base) < 0.5) {\n    return floor(x);\n  } else if ((x - base) > 0.5) {\n    return ceil(x);\n  } else {\n    if (mod(base, 2.0) == 0.0) {\n      return base;\n    } else {\n      return base + 1.0;\n    }\n  }\n");return this.compileAndRun(n,[e])},O.prototype.exp=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.exp(e);if(q().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,ap,e.dtype);var n=new pe(e.shape,ap);return this.compileAndRun(n,[e])},O.prototype.expm1=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.expm1(e);if(q().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,ip,e.dtype);var n=new pe(e.shape,ip);return this.compileAndRun(n,[e])},O.prototype.softmax=function(e,n){var t=We([n],e.shape),r=this.max(e,t),o=cn(r.shape,t),a=this.subtract(e,r.reshape(o)),i=this.exp(a),s=this.sum(i,t).reshape(o);return this.realDivide(i,s)},O.prototype.log=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.log(e);if(q().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,"\n  vec4 result = log(x);\n  vec4 isNaN = vec4(lessThan(x, vec4(0.0)));\n  result.r = isNaN.r == 1.0 ? NAN : result.r;\n  result.g = isNaN.g == 1.0 ? NAN : result.g;\n  result.b = isNaN.b == 1.0 ? NAN : result.b;\n  result.a = isNaN.a == 1.0 ? NAN : result.a;\n\n  return result;\n",e.dtype);var n=new pe(e.shape,"if (x < 0.0) return NAN;\n  return log(x);");return this.compileAndRun(n,[e])},O.prototype.log1p=function(e){var n=new pe(e.shape,"return log(1.0 + x);");return this.compileAndRun(n,[e])},O.prototype.sqrt=function(e){var n=new pe(e.shape,"return sqrt(x);");return this.compileAndRun(n,[e])},O.prototype.rsqrt=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.rsqrt(e);var n=new pe(e.shape,"return inversesqrt(x);");return this.compileAndRun(n,[e])},O.prototype.reciprocal=function(e){var n=new pe(e.shape,"return 1.0 / x;");return this.compileAndRun(n,[e])},O.prototype.relu=function(e){var n;return n=q().getBool("WEBGL_PACK")?new Oo(e.shape,sp):new pe(e.shape,Zf),this.compileAndRun(n,[e])},O.prototype.relu6=function(e){var n;return n=q().getBool("WEBGL_PACK")?new Oo(e.shape,up):new pe(e.shape,ep),this.compileAndRun(n,[e])},O.prototype.prelu=function(e,n){var t=q().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new ft(xf,e.shape,n.shape):new Oe(yf,e.shape,n.shape);return this.compileAndRun(t,[e,n])},O.prototype.elu=function(e){if(q().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,cp,e.dtype);var n=new pe(e.shape,np);return this.compileAndRun(n,[e])},O.prototype.eluDer=function(e,n){var t=q().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new ft("\n  vec4 bGTEZero = vec4(greaterThanEqual(b, vec4(0.)));\n  return (bGTEZero * a) + ((vec4(1.0) - bGTEZero) * (a * (b + vec4(1.0))));\n",e.shape,n.shape):new Oe("return (b >= 1.0) ? a : a * (b + 1.0);",e.shape,n.shape);return this.compileAndRun(t,[e,n])},O.prototype.selu=function(e){var n=new pe(e.shape,"\n  // Stable and Attracting Fixed Point (0, 1) for Normalized Weights.\n  // see: https://arxiv.org/abs/1706.02515\n  float scaleAlpha = 1.7580993408473768;\n  float scale = 1.0507009873554805;\n  return (x >= 0.0) ? scale * x : scaleAlpha * (exp(x) - 1.0);\n");return this.compileAndRun(n,[e])},O.prototype.int=function(e){var n=new pe(e.shape,"return float(int(x));");return this.compileAndRun(n,[e],"int32")},O.prototype.clip=function(e,n,t){var r,o=(r=q().getBool("WEBGL_PACK_CLIP")?new y0(e.shape):new g0(e.shape)).getCustomSetupFunc(n,t);return this.compileAndRun(r,[e],null,o)},O.prototype.abs=function(e){if(this.shouldExecuteOnCPU([e]))return this.cpuBackend.abs(e);if(q().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,Qf,e.dtype);var n=new pe(e.shape,Qf);return this.compileAndRun(n,[e])},O.prototype.complexAbs=function(e){var n=this.texData.get(e.dataId),t=new d0(e.shape),r=[this.makeComplexComponentTensorInfo(e,n.complexTensors.real),this.makeComplexComponentTensorInfo(e,n.complexTensors.imag)];return this.compileAndRun(t,r)},O.prototype.sigmoid=function(e){var n=new pe(e.shape,"return 1.0 / (1.0 + exp(-1.0 * x));");return this.compileAndRun(n,[e])},O.prototype.softplus=function(e){var n=new pe(e.shape,"\n  float epsilon = 1.1920928955078125e-7;\n  float threshold = log(epsilon) + 2.0;\n\n  bool too_large = x > -threshold;\n  bool too_small = x < threshold;\n\n  float result;\n  float exp_x = exp(x);\n\n  if (too_large){\n    result = x;\n  }\n  else if (too_small){\n    result = exp_x;\n  }\n  else{\n    result = log(exp_x + 1.0);\n  }\n  return result;\n");return this.compileAndRun(n,[e])},O.prototype.sin=function(e){var n=new pe(e.shape,"if (isnan(x)) return x;\n  return sin(x);\n");return this.compileAndRun(n,[e])},O.prototype.cos=function(e){var n=new pe(e.shape,"if (isnan(x)) return x;\n  return cos(x);\n");return this.compileAndRun(n,[e])},O.prototype.tan=function(e){var n=new pe(e.shape,"return tan(x);");return this.compileAndRun(n,[e])},O.prototype.asin=function(e){var n=new pe(e.shape,"if (isnan(x)) return x;\n  if (abs(x) > 1.) {\n    return NAN;\n  }\n  return asin(x);\n");return this.compileAndRun(n,[e])},O.prototype.acos=function(e){var n=new pe(e.shape,"if (isnan(x)) return x;\n  if (abs(x) > 1.) {\n    return NAN;\n  }\n  return acos(x);\n");return this.compileAndRun(n,[e])},O.prototype.atan=function(e){var n=new pe(e.shape,"if (isnan(x)) return x;\n  return atan(x);\n");return this.compileAndRun(n,[e])},O.prototype.atan2=function(e,n){var t=q().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new ft("\n  vec4 result = atan(a, b);\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",e.shape,n.shape):new Oe("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return atan(a, b);\n",e.shape,n.shape);return this.compileAndRun(t,[e,n])},O.prototype.sinh=function(e){var n=new pe(e.shape,"\n  float e2x = exp(x);\n  return (e2x - 1.0 / e2x) / 2.0;\n");return this.compileAndRun(n,[e])},O.prototype.cosh=function(e){var n=new pe(e.shape,"\n  float e2x = exp(-x);\n  return (e2x + 1.0 / e2x) / 2.0;\n");return this.compileAndRun(n,[e])},O.prototype.tanh=function(e){var n=new pe(e.shape,"\n  float e2x = exp(-2.0 * abs(x));\n  return sign(x) * (1.0 - e2x) / (1.0 + e2x);\n");return this.compileAndRun(n,[e])},O.prototype.asinh=function(e){var n=new pe(e.shape,"if (isnan(x)) return x;return log(x + sqrt(x * x + 1.0));");return this.compileAndRun(n,[e])},O.prototype.acosh=function(e){var n=new pe(e.shape,"if (isnan(x)) return x;\n  if (x < 1.0) return NAN;\n  return log(x + sqrt(x * x - 1.0));");return this.compileAndRun(n,[e])},O.prototype.atanh=function(e){var n=new pe(e.shape,"if (isnan(x)) return x;\n  if ((x < -1.0) || (x > 1.0)) return NAN;\n  return (log(1.0 + x) - log(1.0 - x)) / 2.0;");return this.compileAndRun(n,[e])},O.prototype.erf=function(e){var n=new pe(e.shape,'\n  // Error function is calculated approximately with elementary function.\n  // See "Handbook of Mathematical Functions with Formulas,\n  // Graphs, and Mathematical Tables", Abramowitz and Stegun.\n  float p = 0.3275911;\n  float a1 = 0.254829592;\n  float a2 = -0.284496736;\n  float a3 = 1.421413741;\n  float a4 = -1.453152027;\n  float a5 = 1.061405429;\n\n  float sign = sign(x);\n  x = abs(x);\n  float t = 1.0 / (1.0 + p * x);\n  return sign * (1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*exp(-x*x));\n');return this.compileAndRun(n,[e])},O.prototype.step=function(e,n){var t,r=new pe(e.shape,(void 0===(t=n)&&(t=0),tu+"\n    return x > 0.0 ? 1.0 : float("+t+");\n  "));return this.compileAndRun(r,[e])},O.prototype.conv2dByMatMul=function(e,n,t,r,o,a){var i=e.shape,s=this.texData.get(e.dataId),h="channelsLast"===t.dataFormat,p=i[2]%2!=0&&!!s.isPacked;if((1==i[0]*i[1]*i[2]||1===t.outChannels)&&1e3<t.inChannels||!q().getBool("WEBGL_LAZILY_UNPACK")||!q().getBool("WEBGL_PACK_BINARY_OPERATIONS")||!p){var g=this.reshape(e,[1,h?i[0]*i[1]*i[2]:i[0]*i[2]*i[3],t.inChannels]),v=this.reshape(n,[1,t.inChannels,t.outChannels]);return this.reshape(this.fusedBatchMatMul({a:g,b:v,transposeA:!1,transposeB:!1,bias:r,activation:o,preluActivationWeights:a}),t.outShape)}var y={dataId:e.dataId,shape:[1,h?i[0]*i[1]*(i[2]+1):i[0]*i[2]*(i[3]+1),t.inChannels],dtype:e.dtype},x=s.shape;s.shape=s.shape.slice(),s.shape[s.shape.length-2]++,S(Ro(s.shape,y.shape),function(){return"packed reshape "+s.shape+" to "+y.shape+" isn't free"});var w=this.reshape(n,[1,t.inChannels,t.outChannels]),b=this.fusedBatchMatMul({a:y,b:w,transposeA:!1,transposeB:!1,bias:r,activation:o,preluActivationWeights:a}),I=this.texData.get(b.dataId);return S(I.isPacked,function(){return"batchMatMul result is expected to be packed"}),s.shape=x,I.shape=t.outShape,A.makeTensorFromDataId(b.dataId,t.outShape,b.dtype)},O.prototype.conv2dWithIm2Row=function(e,n,t,r,o,a){var c=t.outWidth,l=t.outHeight,h="channelsLast"===t.dataFormat,f=t.filterWidth*t.filterHeight*t.inChannels,p=l*c,d=[f,p],g=e.squeeze([0]),v=n.reshape([1,f,-1]),m=new z0(d,g.shape,t),y=this.compileAndRun(m,[g]).reshape([1,d[0],d[1]]),x=null!=r,w=null!=a,b=o?qa(o,!0):null,I=new Qs(y.shape,[1,p,t.outChannels],!0,!1,x,b,w),E=[y,v];return r&&E.push(r),w&&E.push(a),this.compileAndRun(I,E).reshape(h?[1,l,c,t.outChannels]:[1,t.outChannels,l,c])},O.prototype.fusedConv2d=function(e){var n=e.input,t=e.filter,r=e.convInfo,o=e.bias,a=e.activation,i=e.preluActivationWeights;if(1===r.filterHeight&&1===r.filterWidth&&1===r.dilationHeight&&1===r.dilationWidth&&1===r.strideHeight&&1===r.strideWidth&&("SAME"===r.padInfo.type||"VALID"===r.padInfo.type))return this.conv2dByMatMul(n,t,r,o,a,i);if(q().getBool("WEBGL_CONV_IM2COL")&&1===n.shape[0])return this.conv2dWithIm2Row(n,t,r,o,a,i);var u=null!=i,l=new Cf(r,null!=o,a?qa(a,!1):null,u),h=[n,t];return o&&h.push(o),i&&h.push(i),this.compileAndRun(l,h)},O.prototype.conv2d=function(e,n,t){if(1===t.filterHeight&&1===t.filterWidth&&1===t.dilationHeight&&1===t.dilationWidth&&1===t.strideHeight&&1===t.strideWidth&&("SAME"===t.padInfo.type||"VALID"===t.padInfo.type))return this.conv2dByMatMul(e,n,t);if(q().getBool("WEBGL_CONV_IM2COL")&&1===e.shape[0])return this.conv2dWithIm2Row(e,n,t);var r=new Cf(t);return this.compileAndRun(r,[e,n])},O.prototype.conv2dDerInput=function(e,n,t){var r=new b0(t);return this.compileAndRun(r,[e,n])},O.prototype.conv2dDerFilter=function(e,n,t){var r=new x0(t);return this.compileAndRun(r,[e,n])},O.prototype.fusedDepthwiseConv2D=function(e){var n,t=e.input,r=e.filter,o=e.convInfo,a=e.bias,i=e.activation,s=e.preluActivationWeights,u=q().getBool("WEBGL_PACK_DEPTHWISECONV")&&o.strideWidth<=2&&o.outChannels/o.inChannels==1,c=i?qa(i,u):null,l=[t,r],h=null!=a,f=null!=s;return h&&l.push(a),f&&l.push(s),n=u?new _f(o,h,c,f):new Ef(o,h,c,f),this.compileAndRun(n,l)},O.prototype.depthwiseConv2D=function(e,n,t){var r;return r=q().getBool("WEBGL_PACK_DEPTHWISECONV")&&t.strideWidth<=2&&t.outChannels/t.inChannels==1?new _f(t):new Ef(t),this.compileAndRun(r,[e,n])},O.prototype.depthwiseConv2DDerInput=function(e,n,t){var r=new _0(t);return this.compileAndRun(r,[e,n])},O.prototype.depthwiseConv2DDerFilter=function(e,n,t){var r=new E0(t);return this.compileAndRun(r,[e,n])},O.prototype.conv3d=function(e,n,t){var r=new I0(t);return this.compileAndRun(r,[e,n])},O.prototype.conv3dDerInput=function(e,n,t){var r=new C0(t);return this.compileAndRun(r,[e,n])},O.prototype.conv3dDerFilter=function(e,n,t){var r=new w0(t);return this.compileAndRun(r,[e,n])},O.prototype.maxPool=function(e,n){var t=new Zs(n,"max",!1);return this.compileAndRun(t,[e])},O.prototype.avgPool=function(e,n){var t=new Zs(n,"avg",!1);return this.compileAndRun(t,[e],"float32")},O.prototype.maxPoolBackprop=function(e,n,t,r){var o=new Zs(r,"max",!0),a=this.compileAndRun(o,[n]),i=new H0(r),s=this.compileAndRun(i,[e,a],n.dtype);return a.dispose(),s},O.prototype.avgPoolBackprop=function(e,n,t){var r=new l0(t);return this.compileAndRun(r,[e],n.dtype)},O.prototype.cast=function(e,n){return Gs(e,n,this)},O.prototype.unstack=function(e,n){for(var t=e.shape[n],r=new Array(e.rank-1),o=0,a=0;a<e.rank;a++)a!==n&&(r[o++]=e.shape[a]);var i=new Array(e.rank).fill(0),s=e.shape.slice();s[n]=1;var u=new Array(t);for(a=0;a<u.length;a++)u[i[n]=a]=this.slice(e,i,s).reshape(r);return u},O.prototype.avgPool3d=function(e,n){var t=new eu(n,"avg",!1);return this.compileAndRun(t,[e],"float32")},O.prototype.avgPool3dBackprop=function(e,n,t){var r=new h0(t);return this.compileAndRun(r,[e],n.dtype)},O.prototype.maxPool3d=function(e,n){var t=new eu(n,"max",!1);return this.compileAndRun(t,[e],"float32")},O.prototype.maxPool3dBackprop=function(e,n,t,r){var o=new eu(r,"max",!0),a=this.compileAndRun(o,[n]),i=new q0(r),s=this.compileAndRun(i,[e,a],n.dtype);return a.dispose(),s},O.prototype.reshape=function(e,n){var t=this.texData.get(e.dataId);if(!t.isPacked||Ro(e.shape,n)||null!==t.texture&&Ro(t.shape,n))return Va(e,n);var r=this.packedReshape(e,n);return A.makeTensorFromDataId(r.dataId,r.shape,r.dtype)},O.prototype.resizeBilinear=function(e,n,t,r){var o=q().getBool("WEBGL_PACK_IMAGE_OPERATIONS")?new ny(e.shape,n,t,r):new ey(e.shape,n,t,r);return this.compileAndRun(o,[e],"float32")},O.prototype.resizeBilinearBackprop=function(e,n,t){var r=new Z0(e,n,t);return this.compileAndRun(r,[e])},O.prototype.resizeNearestNeighbor=function(e,n,t,r){var o=new ry(e.shape,n,t,r);return this.compileAndRun(o,[e])},O.prototype.resizeNearestNeighborBackprop=function(e,n,t){var r=new ty(e,n,t);return this.compileAndRun(r,[e])},O.prototype.multinomial=function(e,n,t,r){var o=n?e:Yn(e),s=new X0(o.shape[0],o.shape[1],t),u=s.getCustomSetupFunc(r);return this.compileAndRun(s,[o],"int32",u)},O.prototype.oneHot=function(e,n,t,r){var o=new j0(e.size,n,t,r);return this.compileAndRun(o,[e])},O.prototype.diag=function(e){var n=new A0(e.size);return this.compileAndRun(n,[e])},O.prototype.nonMaxSuppression=function(e,n,t,r,o){return ka("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead"),js(e.dataSync(),n.dataSync(),t,r,o)},O.prototype.cropAndResize=function(e,n,t,r,o,a){var i=new R0(e.shape,n.shape,r,o,a);return this.compileAndRun(i,[e,n,t],"float32")},O.prototype.depthToSpace=function(e,n,t){S(1<n,function(){return"blockSize should be > 1 for depthToSpace, but was: "+n});var r=e.shape[0],s=("NHWC"===t?e.shape[1]:e.shape[2])*n,u=("NHWC"===t?e.shape[2]:e.shape[3])*n,c=("NHWC"===t?e.shape[3]:e.shape[1])/(n*n),l=new P0("NHWC"===t?[r,s,u,c]:[r,c,s,u],n,t);return this.compileAndRun(l,[e])},O.prototype.split=function(e,n,t){return hf(e,n,t)},O.prototype.scatterND=function(e,n,t){var r=Do(0,e,t),o=r.sliceRank,a=r.numUpdates,i=r.sliceSize,s=r.strides,u=r.outputSize,c=[u/i,i],l=e.reshape([a,o]),h=n.reshape([a,i]);if(0===u)return Va(Je([]),t);var f=$(0),p=new Kf(a,o,l.rank,h.rank,s,c);return this.compileAndRun(p,[h,l,f]).reshape(t)},O.prototype.sparseToDense=function(e,n,t,r){var o=Do(0,e,t),c=new Kf(o.numUpdates,o.sliceRank,e.rank,n.rank,o.strides,[o.outputSize,1],!1);return this.compileAndRun(c,[n,e,r]).reshape(t)},O.prototype.fft=function(e){return this.fftImpl(e,!1)},O.prototype.ifft=function(e){return this.fftImpl(e,!0)},O.prototype.fftImpl=function(e,n){var t=this.texData.get(e.dataId),r=new Rf("return real * expR - imag * expI;",e.shape,n),o=new Rf("return real * expI + imag * expR;",e.shape,n),a=[this.makeComplexComponentTensorInfo(e,t.complexTensors.real),this.makeComplexComponentTensorInfo(e,t.complexTensors.imag)],i=this.compileAndRun(r,a),s=this.compileAndRun(o,a),u=this.complex(i,s).as2D(e.shape[0],e.shape[1]);return i.dispose(),s.dispose(),u},O.prototype.gatherND=function(e,n){var t=n.shape,r=t[t.length-1],o=Os(e,n),a=o[0],i=o[1],s=o[2],u=o[3],c=n.reshape([i,r]),l=e.reshape([e.size/s,s]),h=new L0(r,u,[i,s]);return this.compileAndRun(h,[l,c]).reshape(a)},O.prototype.fill=function(e,n,t){if("string"===(t=t||Fr(n))){var r=vo(t,ie(e));return r.fill(n),A.makeTensor(r,e,t,this)}var o=new B0(e,n),a=o.getCustomSetupFunc(n);return this.compileAndRun(o,[],t,a)},O.prototype.onesLike=function(e){if("string"===e.dtype)throw new Error("onesLike is not supported under string dtype");return this.fill(e.shape,1,e.dtype)},O.prototype.zerosLike=function(e){return this.fill(e.shape,"string"===e.dtype?"":0,e.dtype)},O.prototype.linspace=function(e,n,t){return Hs(e,n,t)},O.prototype.makeTensorInfo=function(e,n){var t=this.write(null,e,n);return this.texData.get(t).usage=null,{dataId:t,shape:e,dtype:n}},O.prototype.makeOutput=function(e,n){var t=this.makeTensorInfo(e,n).dataId;return A.makeTensorFromDataId(t,e,n,this)},O.prototype.unpackTensor=function(e){var n=new vy(e.shape);return this.runWebGLProgram(n,[e],e.dtype)},O.prototype.packTensor=function(e){var n=new K0(e.shape);return this.runWebGLProgram(n,[e],e.dtype,null,!0)},O.prototype.packedReshape=function(e,n){var t=[_o(e.shape)].concat(Io(e.shape)),r={dtype:e.dtype,shape:t,dataId:e.dataId},a=new Q0([_o(n)].concat(Io(n)),t),i=this.runWebGLProgram(a,[r],e.dtype,null,!0);return{dataId:i.dataId,shape:n,dtype:i.dtype}},O.prototype.decode=function(e){var n,t=this.texData.get(e),r=t.isPacked,o=t.shape,a=t.dtype,i=Ia(o);return n=r?new D0(i):new S0(i),{dtype:a,shape:o,dataId:this.runWebGLProgram(n,[{shape:i,dtype:a,dataId:e}],a,null,!0).dataId}},O.prototype.runWebGLProgram=function(e,n,t,r,o){var a=this;void 0===o&&(o=!1);var i=this.makeTensorInfo(e.outputShape,t),s=this.texData.get(i.dataId);if(e.packedOutput&&(s.isPacked=!0),e.outPackingScheme===xo.DENSE){var u=bo(e.outputShape);s.texShape=u.map(function(m){return 2*m})}if(null!=e.outTexUsage&&(s.usage=e.outTexUsage),0===ie(i.shape))return s.values=Nr(i.dtype,0),i;var c=[],l=n.map(function(m){if("complex64"===m.dtype)throw new Error("GPGPUProgram does not support complex64 input. For complex64 dtypes, please separate the program into real and imaginary parts.");var y=a.texData.get(m.dataId);if(null==y.texture){if(!e.packedInputs&&ie(m.shape)<=q().getNumber("WEBGL_SIZE_UPLOAD_UNIFORM"))return{shape:m.shape,texData:null,isUniform:!0,uniformValues:y.values};e.packedInputs&&(y.isPacked=!0,y.shape=m.shape)}else if(!!y.isPacked!=!!e.packedInputs)m=y.isPacked?a.unpackTensor(m):a.packTensor(m),c.push(m),y=a.texData.get(m.dataId);else if(y.isPacked&&!Ro(y.shape,m.shape)){var x=m,w=m.shape;m.shape=y.shape,m=a.packedReshape(m,w),c.push(m),y=a.texData.get(m.dataId),x.shape=w}return a.uploadToGPU(m.dataId),{shape:m.shape,texData:y,isUniform:!1}});this.uploadToGPU(i.dataId);var h,m,w,f={shape:i.shape,texData:s,isUniform:!1},p=(m=e,w="",l.concat(f).forEach(function(I){w+=I.shape+"_"+(I.isUniform?"uniform":I.texData.texShape)+"_"+(null!=I.texData&&null!=I.texData.slice&&0<I.texData.slice.flatOffset)}),m.constructor.name+"_"+w+"_"+m.userCode),d=this.getAndSaveBinary(p,function(){return function(m,y,x,w){var b=y.userCode,I=x.map(function(F,z){var j={logicalShape:F.shape,texShape:F.isUniform?null:F.texData.texShape,isUniform:F.isUniform,isPacked:!F.isUniform&&F.texData.isPacked,flatOffset:null};return null!=F.texData&&null!=F.texData.slice&&0<F.texData.slice.flatOffset&&(j.flatOffset=F.texData.slice.flatOffset),{name:y.variableNames[z],shapeInfo:j}}),E=I.map(function(F){return F.shapeInfo}),C={logicalShape:w.shape,texShape:w.texData.texShape,isUniform:!1,isPacked:w.texData.isPacked,flatOffset:null},R=function u0(e,n,t,r){var o=[];e.forEach(function(d){var g=ie(d.shapeInfo.logicalShape);d.shapeInfo.isUniform?o.push("uniform float "+d.name+(1<g?"["+g+"]":"")+";"):(o.push("uniform sampler2D "+d.name+";"),o.push("uniform int offset"+d.name+";"))});var a,i,s,u=o.join("\n"),c=e.map(function(d){return function(g,v,m){void 0===m&&(m=!1);var y="";return y+=m?function b(I){var E,k,D,N,M,W,P;switch(I.shapeInfo.logicalShape.length){case 0:return"\n    vec4 get"+(E=I.name).charAt(0).toUpperCase()+E.slice(1)+"() {\n      return "+an().texture2D+"("+E+", halfCR);\n    }\n  ";case 1:return N="get"+(D=(k=I).name).charAt(0).toUpperCase()+D.slice(1),M=k.shapeInfo.texShape,W=[Math.ceil(M[0]/2),Math.ceil(M[1]/2)],P=an(),"\n    vec4 "+N+"(int index) {\n      vec2 uv = packedUVfrom1D(\n        "+W[0]+", "+W[1]+", index);\n      return "+P.texture2D+"("+D+", uv);\n    }\n  ";case 2:return function(k){var D=k.shapeInfo.logicalShape,N=k.name,M="get"+N.charAt(0).toUpperCase()+N.slice(1),W=k.shapeInfo.texShape,P=W[0],F=W[1],z=an();if(null!=W&&Le(D,W))return"\n      vec4 "+M+"(int row, int col) {\n        vec2 uv = (vec2(col, row) + halfCR) / vec2("+F+".0, "+P+".0);\n\n        return "+z.texture2D+"("+N+", uv);\n      }\n    ";var j=[Math.ceil(W[0]/2),Math.ceil(W[1]/2)];return"\n    vec4 "+M+"(int row, int col) {\n      vec2 uv = packedUVfrom2D("+Math.ceil(D[1]/2)+", "+j[0]+", "+j[1]+", row, col);\n      return "+z.texture2D+"("+N+", uv);\n    }\n  "}(I);case 3:return function(k){var D=k.shapeInfo.logicalShape,N=k.name,M="get"+N.charAt(0).toUpperCase()+N.slice(1),W=k.shapeInfo.texShape,P=[Math.ceil(W[0]/2),Math.ceil(W[1]/2)];if(1===D[0]){var z=zr(k,D.slice(1));return"\n        "+b(z)+"\n        vec4 "+M+"(int b, int row, int col) {\n          return "+M+"("+Ur(["b","row","col"],[1,2])+");\n        }\n      "}var j=P[0],K=P[1],Y=Math.ceil(D[2]/2);return"\n    vec4 "+M+"(int b, int row, int col) {\n      vec2 uv = packedUVfrom3D(\n        "+j+", "+K+", "+Y*Math.ceil(D[1]/2)+", "+Y+", b, row, col);\n      return "+an().texture2D+"("+N+", uv);\n    }\n  "}(I);default:return function(k){for(var D=k.shapeInfo.logicalShape,N=D.length,M=k.name,W="get"+M.charAt(0).toUpperCase()+M.slice(1),P=k.shapeInfo.texShape,F=[Math.ceil(P[0]/2),Math.ceil(P[1]/2)],z=F[0],j=F[1],K=Math.ceil(D[N-1]/2),Y=K*Math.ceil(D[N-2]/2),J="int b, int row, int col",Z="b * "+Y+" + (row / 2) * "+K+" + (col / 2)",ne=2;ne<N-1;ne++)J="int b"+ne+", "+J,Z="b"+ne+" * "+(Y*=D[N-ne-1])+" + "+Z;return"\n    vec4 "+W+"("+J+") {\n      int index = "+Z+";\n      int texR = index / "+j+";\n      int texC = index - texR * "+j+";\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+j+", "+z+");\n      return "+an().texture2D+"("+M+", uv);\n    }\n  "}(I)}}(g):function b(I){var E=I.shapeInfo.logicalShape;switch(E.length){case 0:return function(C){var R=C.name,k="get"+R.charAt(0).toUpperCase()+R.slice(1);if(C.shapeInfo.isUniform)return"float "+k+"() {return "+R+";}";var D=C.shapeInfo.texShape;if(1===D[0]&&1===D[1])return"\n      float "+k+"() {\n        return sampleTexture("+R+", halfCR);\n      }\n    ";var W=C.shapeInfo.texShape;return"\n    float "+k+"() {\n      vec2 uv = uvFromFlat("+W[0]+", "+W[1]+", "+mr(R)+");\n      return sampleTexture("+R+", uv);\n    }\n  "}(I);case 1:return function(C){var R=C.name,k="get"+R.charAt(0).toUpperCase()+R.slice(1);if(C.shapeInfo.isUniform)return"\n      float "+k+"(int index) {\n        "+Wr(C)+"\n      }\n    ";var D=C.shapeInfo.texShape,N=D[0],M=D[1];if(1===M&&1===N)return"\n      float "+k+"(int index) {\n        return sampleTexture("+R+", halfCR);\n      }\n    ";var W=mr(R);return 1===M?"\n      float "+k+"(int index) {\n        vec2 uv = vec2(0.5, (float(index + "+W+") + 0.5) / "+N+".0);\n        return sampleTexture("+R+", uv);\n      }\n    ":1===N?"\n      float "+k+"(int index) {\n        vec2 uv = vec2((float(index + "+W+") + 0.5) / "+M+".0, 0.5);\n        return sampleTexture("+R+", uv);\n      }\n    ":"\n    float "+k+"(int index) {\n      vec2 uv = uvFromFlat("+N+", "+M+", index + "+W+");\n      return sampleTexture("+R+", uv);\n    }\n  "}(I);case 2:return function(C){var R=C.shapeInfo.logicalShape,k=C.name,D="get"+k.charAt(0).toUpperCase()+k.slice(1),N=C.shapeInfo.texShape;if(null!=N&&Le(R,N))return"\n    float "+D+"(int row, int col) {\n      vec2 uv = (vec2(col, row) + halfCR) / vec2("+N[1]+".0, "+N[0]+".0);\n      return sampleTexture("+k+", uv);\n    }\n  ";var P=At(R),F=P.newShape,z=P.keptDims;if(F.length<R.length){var K=zr(C,F);return"\n      "+b(K)+"\n      float "+D+"(int row, int col) {\n        return "+D+"("+Ur(["row","col"],z)+");\n      }\n    "}if(C.shapeInfo.isUniform)return"\n      float "+D+"(int row, int col) {\n        int index = round(dot(vec2(row, col), vec2("+R[1]+", 1)));\n        "+Wr(C)+"\n      }\n    ";var Y=N[0],J=N[1],Z=mr(k);return 1===J?"\n    float "+D+"(int row, int col) {\n      float index = dot(vec3(row, col, "+Z+"), vec3("+R[1]+", 1, 1));\n      vec2 uv = vec2(0.5, (index + 0.5) / "+Y+".0);\n      return sampleTexture("+k+", uv);\n    }\n  ":1===Y?"\n    float "+D+"(int row, int col) {\n      float index = dot(vec3(row, col, "+Z+"), vec3("+R[1]+", 1, 1));\n      vec2 uv = vec2((index + 0.5) / "+J+".0, 0.5);\n      return sampleTexture("+k+", uv);\n    }\n  ":"\n  float "+D+"(int row, int col) {\n    // Explicitly use integer operations as dot() only works on floats.\n    int index = row * "+R[1]+" + col + "+Z+";\n    vec2 uv = uvFromFlat("+Y+", "+J+", index);\n    return sampleTexture("+k+", uv);\n  }\n"}(I);case 3:return function(C){var R=C.shapeInfo.logicalShape,k=C.name,D="get"+k.charAt(0).toUpperCase()+k.slice(1),N=R[1]*R[2],M=R[2],W=At(R),P=W.newShape,F=W.keptDims;if(P.length<R.length){var j=zr(C,P);return"\n        "+b(j)+"\n        float "+D+"(int row, int col, int depth) {\n          return "+D+"("+Ur(["row","col","depth"],F)+");\n        }\n      "}if(C.shapeInfo.isUniform)return"\n      float "+D+"(int row, int col, int depth) {\n        int index = round(dot(vec3(row, col, depth),\n                          vec3("+N+", "+M+", 1)));\n        "+Wr(C)+"\n      }\n    ";var K=C.shapeInfo.texShape,Y=K[0],J=K[1],Z=C.shapeInfo.flatOffset;return J===N&&null==Z?"\n        float "+D+"(int row, int col, int depth) {\n          float texR = float(row);\n          float texC = dot(vec2(col, depth), vec2("+M+", 1));\n          vec2 uv = (vec2(texC, texR) + halfCR) /\n                     vec2("+J+".0, "+Y+".0);\n          return sampleTexture("+k+", uv);\n        }\n      ":J===M&&null==Z?"\n    float "+D+"(int row, int col, int depth) {\n      float texR = dot(vec2(row, col), vec2("+R[1]+", 1));\n      float texC = float(depth);\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+J+".0, "+Y+".0);\n      return sampleTexture("+k+", uv);\n    }\n  ":"\n      float "+D+"(int row, int col, int depth) {\n        // Explicitly use integer operations as dot() only works on floats.\n        int index = row * "+N+" + col * "+M+" + depth + "+mr(k)+";\n        vec2 uv = uvFromFlat("+Y+", "+J+", index);\n        return sampleTexture("+k+", uv);\n      }\n  "}(I);case 4:return function(C){var R=C.shapeInfo.logicalShape,k=C.name,D="get"+k.charAt(0).toUpperCase()+k.slice(1),N=R[3],M=R[2]*N,W=R[1]*M,P=At(R),F=P.newShape,z=P.keptDims;if(F.length<R.length){var j=zr(C,F);return"\n      "+b(j)+"\n      float "+D+"(int row, int col, int depth, int depth2) {\n        return "+D+"("+Ur(["row","col","depth","depth2"],z)+");\n      }\n    "}if(C.shapeInfo.isUniform)return"\n      float "+D+"(int row, int col, int depth, int depth2) {\n        int index = round(dot(vec4(row, col, depth, depth2),\n                          vec4("+W+", "+M+", "+N+", 1)));\n        "+Wr(C)+"\n      }\n    ";var K=C.shapeInfo.flatOffset,Y=C.shapeInfo.texShape,J=Y[0],Z=Y[1];return Z===W&&null==K?"\n      float "+D+"(int row, int col, int depth, int depth2) {\n        float texR = float(row);\n        float texC =\n            dot(vec3(col, depth, depth2),\n                vec3("+M+", "+N+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+Z+".0, "+J+".0);\n        return sampleTexture("+k+", uv);\n      }\n    ":Z===N&&null==K?"\n      float "+D+"(int row, int col, int depth, int depth2) {\n        float texR = dot(vec3(row, col, depth),\n                         vec3("+R[1]*R[2]+", "+R[2]+", 1));\n        float texC = float(depth2);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+Z+".0, "+J+".0);\n        return sampleTexture("+k+", uv);\n      }\n    ":"\n    float "+D+"(int row, int col, int depth, int depth2) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+W+" + col * "+M+" +\n          depth * "+N+" + depth2;\n      vec2 uv = uvFromFlat("+J+", "+Z+", index + "+mr(k)+");\n      return sampleTexture("+k+", uv);\n    }\n  "}(I);case 5:return function(C){var R=C.shapeInfo.logicalShape,k=C.name,D="get"+k.charAt(0).toUpperCase()+k.slice(1),N=R[4],M=R[3]*N,W=R[2]*M,P=R[1]*W,F=At(R),z=F.newShape,j=F.keptDims;if(z.length<R.length){var K=zr(C,z);return"\n      "+b(K)+"\n      float "+D+"(int row, int col, int depth, int depth2, int depth3) {\n        return "+D+"("+Ur(["row","col","depth","depth2","depth3"],j)+");\n      }\n    "}if(C.shapeInfo.isUniform)return"\n      float "+D+"(int row, int col, int depth, int depth2, int depth3) {\n        float index = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+P+", "+W+", "+M+", "+N+")) +\n          depth3;\n        "+Wr(C)+"\n      }\n    ";var Y=C.shapeInfo.flatOffset,J=C.shapeInfo.texShape,Z=J[0],ne=J[1];return ne===P&&null==Y?"\n      float "+D+"(int row, int col, int depth, int depth2, int depth3) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n                         vec4("+W+", "+M+", "+N+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+ne+".0, "+Z+".0);\n        return sampleTexture("+k+", uv);\n      }\n    ":ne===N&&null==Y?"\n      float "+D+"(int row, int col, int depth, int depth2, int depth3) {\n        float texR = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+R[1]*R[2]*R[3]+",\n               "+R[2]*R[3]+", "+R[3]+", 1));\n        int texC = depth3;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+ne+".0, "+Z+".0);\n        return sampleTexture("+k+", uv);\n      }\n    ":"\n    float "+D+"(int row, int col, int depth, int depth2, int depth3) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+P+" + col * "+W+" + depth * "+M+" +\n          depth2 * "+N+" + depth3 + "+mr(k)+";\n      vec2 uv = uvFromFlat("+Z+", "+ne+", index);\n      return sampleTexture("+k+", uv);\n    }\n  "}(I);case 6:return function(C){var R=C.shapeInfo.logicalShape,k=C.name,D="get"+k.charAt(0).toUpperCase()+k.slice(1),N=At(R),M=N.newShape,W=N.keptDims;if(M.length<R.length){var P=zr(C,M);return"\n      "+b(P)+"\n      float "+D+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        return "+D+"("+Ur(["row","col","depth","depth2","depth3","depth4"],W)+");\n      }\n    "}var F=R[5],z=R[4]*F,j=R[3]*z,K=R[2]*j,Y=R[1]*K;if(C.shapeInfo.isUniform)return"\n      float "+D+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n        int index = round(dot(\n          vec4(row, col, depth, depth2),\n          vec4("+Y+", "+K+", "+j+", "+z+")) +\n          dot(\n            vec2(depth3, depth4),\n            vec2("+F+", 1)));\n        "+Wr(C)+"\n      }\n    ";var J=C.shapeInfo.flatOffset,Z=C.shapeInfo.texShape,ne=Z[0],ce=Z[1];return ce===Y&&null==J?"\n      float "+D+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n          vec4("+K+", "+j+", "+z+", "+F+")) +\n               float(depth4);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+ce+".0, "+ne+".0);\n        return sampleTexture("+k+", uv);\n      }\n    ":ce===F&&null==J?"\n      float "+D+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        float texR = dot(vec4(row, col, depth, depth2),\n          vec4("+R[1]*R[2]*R[3]*R[4]+",\n               "+R[2]*R[3]*R[4]+",\n               "+R[3]*R[4]+",\n               "+R[4]+")) + float(depth3);\n        int texC = depth4;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+ce+".0, "+ne+".0);\n        return sampleTexture("+k+", uv);\n      }\n    ":"\n    float "+D+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+Y+" + col * "+K+" + depth * "+j+" +\n          depth2 * "+z+" + depth3 * "+F+" + depth4 + "+mr(k)+";\n      vec2 uv = uvFromFlat("+ne+", "+ce+", index);\n      return sampleTexture("+k+", uv);\n    }\n  "}(I);default:throw new Error(E.length+"-D input sampling is not yet supported")}}(g),g.shapeInfo.logicalShape.length<=v.logicalShape.length&&(y+=m?function(b,I){var E,z,C=b.name,R=C.charAt(0).toUpperCase()+C.slice(1),k="get"+R+"AtOutCoords",D=b.shapeInfo.logicalShape.length,N=I.logicalShape.length,M=ht(b.shapeInfo.logicalShape,I.logicalShape),W=De(N),P=N-D,F=["x","y","z","w","u","v"];E=0===D?"":N<2&&1<=M.length?"coords = 0;":M.map(function(ne){return"coords."+F[ne+P]+" = 0;"}).join("\n"),z=N<2&&0<D?"coords":b.shapeInfo.logicalShape.map(function(ne,ce){return"coords."+F[ce+P]}).join(", ");var j="return outputValue;",K=1===ie(b.shapeInfo.logicalShape),Y=1===ie(I.logicalShape);if(1!==D||K||Y){if(K&&!Y)j=1===N?"\n        return vec4(outputValue.x, outputValue.x, 0., 0.);\n      ":"\n        return vec4(outputValue.x);\n      ";else if(M.length){var J=D-2,Z=D-1;-1<M.indexOf(J)&&-1<M.indexOf(Z)?j="return vec4(outputValue.x);":-1<M.indexOf(J)?j="return vec4(outputValue.x, outputValue.y, outputValue.x, outputValue.y);":-1<M.indexOf(Z)&&(j="return vec4(outputValue.xx, outputValue.zz);")}}else j="\n      return vec4(outputValue.xy, outputValue.xy);\n    ";return"\n    vec4 "+k+"() {\n      "+W+" coords = getOutputCoords();\n      "+E+"\n      vec4 outputValue = get"+R+"("+z+");\n      "+j+"\n    }\n  "}(g,v):function(b,I){var E=b.name,C=E.charAt(0).toUpperCase()+E.slice(1),R="get"+C+"AtOutCoords",N=b.shapeInfo.logicalShape.length,M=I.logicalShape.length;if(!b.shapeInfo.isUniform&&N===M&&null==b.shapeInfo.flatOffset&&Le(b.shapeInfo.texShape,I.texShape))return"\n      float "+R+"() {\n        return sampleTexture("+E+", resultUV);\n      }\n    ";var W=De(M),P=ht(b.shapeInfo.logicalShape,I.logicalShape),F=M-N,z=["x","y","z","w","u","v"];return"\n    float "+R+"() {\n      "+W+" coords = getOutputCoords();\n      "+(0===N?"":M<2&&1<=P.length?"coords = 0;":P.map(function(j){return"coords."+z[j+F]+" = 0;"}).join("\n"))+"\n      return get"+C+"("+(M<2&&0<N?"coords":b.shapeInfo.logicalShape.map(function(j,K){return"coords."+z[K+F]}).join(", "))+");\n    }\n  "}(g,v)),y}(d,n,r)}).join("\n"),l=n.texShape,h=an(),f="\n    float sampleTexture(sampler2D textureSampler, vec2 uv) {\n      return "+h.texture2D+"(textureSampler, uv).r;\n    }\n  ",p=(s=h).version+"\n    precision highp float;\n    precision highp int;\n    precision highp sampler2D;\n    "+s.varyingFs+" vec2 resultUV;\n    "+s.defineOutput+"\n    const vec2 halfCR = vec2(0.5, 0.5);\n\n    struct ivec5\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n    };\n\n    struct ivec6\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n      int v;\n    };\n\n    uniform float NAN;\n    "+s.defineSpecialNaN+"\n    "+s.defineSpecialInf+"\n    "+s.defineRound+"\n\n    int imod(int x, int y) {\n      return x - y * (x / y);\n    }\n\n    int idiv(int a, int b, float sign) {\n      int res = a / b;\n      int mod = imod(a, b);\n      if (sign < 0. && mod != 0) {\n        res -= 1;\n      }\n      return res;\n    }\n\n    //Based on the work of Dave Hoskins\n    //https://www.shadertoy.com/view/4djSRW\n    #define HASHSCALE1 443.8975\n    float random(float seed){\n      vec2 p = resultUV * seed;\n      vec3 p3  = fract(vec3(p.xyx) * HASHSCALE1);\n      p3 += dot(p3, p3.yzx + 19.19);\n      return fract((p3.x + p3.y) * p3.z);\n    }\n\n    \nvec2 uvFromFlat(int texNumR, int texNumC, int index) {\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\nvec2 packedUVfrom1D(int texNumR, int texNumC, int index) {\n  int texelIndex = index / 2;\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n\n    \nvec2 packedUVfrom2D(int texelsInLogicalRow, int texNumR,\n  int texNumC, int row, int col) {\n  int texelIndex = (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n\n    \nvec2 packedUVfrom3D(int texNumR, int texNumC,\n    int texelsInBatch, int texelsInLogicalRow, int b,\n    int row, int col) {\n  int index = b * texelsInBatch + (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n\n  ";return i=n.isPacked?(a=function(d,g){switch(d.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return v=g,1===(m=[Math.ceil(v[0]/2),Math.ceil(v[1]/2)])[0]?"\n      int getOutputCoords() {\n        return 2 * int(resultUV.x * "+m[1]+".0);\n      }\n    ":1===m[1]?"\n      int getOutputCoords() {\n        return 2 * int(resultUV.y * "+m[0]+".0);\n      }\n    ":"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+m[0]+", "+m[1]+"));\n      return 2 * (resTexRC.x * "+m[1]+" + resTexRC.y);\n    }\n  ";case 2:return function(E,C){var R=[Math.ceil(C[0]/2),Math.ceil(C[1]/2)];if(Le(E,C))return"\n      ivec2 getOutputCoords() {\n        return 2 * ivec2(resultUV.yx * vec2("+R[0]+", "+R[1]+"));\n      }\n    ";var k=Math.ceil(E[1]/2);return"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+R[0]+", "+R[1]+"));\n\n      int index = resTexRC.x * "+R[1]+" + resTexRC.y;\n      int r = 2 * (index / "+k+");\n      int c = imod(index, "+k+") * 2;\n\n      return ivec2(r, c);\n    }\n  "}(d,g);case 3:return y=d,x=g,w=[Math.ceil(x[0]/2),Math.ceil(x[1]/2)],I=(b=Math.ceil(y[2]/2))*Math.ceil(y[1]/2),"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+w[0]+", "+w[1]+"));\n      int index = resTexRC.x * "+w[1]+" + resTexRC.y;\n\n      int b = index / "+I+";\n      index -= b * "+I+";\n\n      int r = 2 * (index / "+b+");\n      int c = imod(index, "+b+") * 2;\n\n      return ivec3(b, r, c);\n    }\n  ";default:return function(E,C){for(var R=[Math.ceil(C[0]/2),Math.ceil(C[1]/2)],k=Math.ceil(E[E.length-1]/2),D=k*Math.ceil(E[E.length-2]/2),N=D,M="",W="b, r, c",P=2;P<E.length-1;P++)M="\n      int b"+P+" = index / "+(N*=E[E.length-P-1])+";\n      index -= b"+P+" * "+N+";\n    "+M,W="b"+P+", "+W;return"\n    ivec"+E.length+" getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+R[0]+", "+R[1]+"));\n      int index = resTexRC.x * "+R[1]+" + resTexRC.y;\n\n      "+M+"\n\n      int b = index / "+D+";\n      index -= b * "+D+";\n\n      int r = 2 * (index / "+k+");\n      int c = imod(index, "+k+") * 2;\n\n      return ivec"+E.length+"("+W+");\n    }\n  "}(d,g)}var v,m,y,x,w,b,I}(n.logicalShape,l),"\n    void setOutput(vec4 val) {\n      "+h.output+" = val;\n    }\n  "):(a=function(d,g){switch(d.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return 1===(C=g)[0]?"\n      int getOutputCoords() {\n        return int(resultUV.x * "+C[1]+".0);\n      }\n    ":1===C[1]?"\n      int getOutputCoords() {\n        return int(resultUV.y * "+C[0]+".0);\n      }\n    ":"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+C[0]+", "+C[1]+"));\n      return resTexRC.x * "+C[1]+" + resTexRC.y;\n    }\n  ";case 2:return Le(I=d,E=g)?"\n      ivec2 getOutputCoords() {\n        return ivec2(resultUV.yx * vec2("+E[0]+", "+E[1]+"));\n      }\n    ":1===I[1]?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+E[0]+", "+E[1]+"));\n        int index = resTexRC.x * "+E[1]+" + resTexRC.y;\n        return ivec2(index, 0);\n      }\n    ":1===I[0]?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+E[0]+", "+E[1]+"));\n        int index = resTexRC.x * "+E[1]+" + resTexRC.y;\n        return ivec2(0, index);\n      }\n    ":"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+E[0]+", "+E[1]+"));\n      int index = resTexRC.x * "+E[1]+" + resTexRC.y;\n      int r = index / "+I[1]+";\n      int c = index - r * "+I[1]+";\n      return ivec2(r, c);\n    }\n  ";case 3:return R=g,k=vr(["r","c","d"],d),"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+R[0]+", "+R[1]+"));\n      int index = resTexRC.x * "+R[1]+" + resTexRC.y;\n      "+k+"\n      return ivec3(r, c, d);\n    }\n  ";case 4:return w=g,b=vr(["r","c","d","d2"],d),"\n    ivec4 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+w[0]+", "+w[1]+"));\n      int index = resTexRC.x * "+w[1]+" + resTexRC.y;\n      "+b+"\n      return ivec4(r, c, d, d2);\n    }\n  ";case 5:return y=g,x=vr(["r","c","d","d2","d3"],d),"\n    ivec5 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx * vec2("+y[0]+",\n                             "+y[1]+"));\n\n      int index = resTexRC.x * "+y[1]+" + resTexRC.y;\n\n      "+x+"\n\n      ivec5 outShape = ivec5(r, c, d, d2, d3);\n      return outShape;\n    }\n  ";case 6:return v=g,m=vr(["r","c","d","d2","d3","d4"],d),"\n    ivec6 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+v[0]+", "+v[1]+"));\n      int index = resTexRC.x * "+v[1]+" + resTexRC.y;\n\n      "+m+"\n\n      ivec6 result = ivec6(r, c, d, d2, d3, d4);\n      return result;\n    }\n  ";default:throw new Error(d.length+"-D output sampling is not yet supported")}var v,m,y,x,w,b,I,E,C,R,k}(n.logicalShape,l),"\n    void setOutput(float val) {\n      "+h.output+" = vec4(val, 0, 0, 0);\n    }\n  "),r&&(p+="\n  float getChannel(vec4 frag, vec2 innerDims) {\n    vec2 modCoord = mod(innerDims, 2.);\n    return modCoord.x == 0. ?\n      (modCoord.y == 0. ? frag.r : frag.g) :\n      (modCoord.y == 0. ? frag.b : frag.a);\n  }\n  float getChannel(vec4 frag, int dim) {\n    float modCoord = mod(float(dim), 2.);\n    return modCoord == 0. ? frag.r : frag.g;\n  }\n"),[p,f,i,u,a,c,t].join("\n")}(I,C,b,y.packedInputs),k=m.createProgram(R),D=null,N=m.getUniformLocation(k,"NAN",!1);1===q().getNumber("WEBGL_VERSION")&&(D=m.getUniformLocation(k,"INFINITY",!1));for(var M={},W=0;W<y.variableNames.length;W++){var P=y.variableNames[W];M[P]=m.getUniformLocation(k,P,!1),M["offset"+P]=m.getUniformLocation(k,"offset"+P,!1)}return{program:y,source:R,webGLProgram:k,uniformLocations:M,inShapeInfos:E,outShapeInfo:C,infLoc:D,nanLoc:N}}(a.gpgpu,e,l,f)}),g=null!=this.activeTimers;if(g&&(h=this.startTimer()),function(m,y,x,w,b){qf(y.inShapeInfos,x),qf([y.outShapeInfo],[w]);var I=w.texData.texture,E=w.texData.texShape;w.texData.isPacked?m.setOutputPackedMatrixTexture(I,E[0],E[1]):m.setOutputMatrixTexture(I,E[0],E[1]),m.setProgram(y.webGLProgram),1===q().getNumber("WEBGL_VERSION")&&null!==y.infLoc&&m.gl.uniform1f(y.infLoc,1/0),null!==y.nanLoc&&m.gl.uniform1f(y.nanLoc,NaN),x.forEach(function(C,R){var k=y.program.variableNames[R],D=y.uniformLocations[k],N=y.uniformLocations["offset"+k];if(null!=D)if(C.isUniform)if(ie(C.shape)<2)m.gl.uniform1f(D,C.uniformValues[0]);else{var M=C.uniformValues;M instanceof Float32Array||(M=new Float32Array(M)),m.gl.uniform1fv(D,M)}else null!=C.texData.slice&&null!=N&&m.gl.uniform1i(N,C.texData.slice.flatOffset),m.setInputMatrixTexture(C.texData.texture,D,R)}),b?.(m,y.webGLProgram),m.executeProgram()}(this.gpgpu,d,l,f,r),c.forEach(function(m){return a.disposeData(m.dataId)}),g&&(h=this.endTimer(h),this.activeTimers.push({name:e.constructor.name,query:this.getQueryTime(h)})),q().getBool("WEBGL_LAZILY_UNPACK")||!s.isPacked||!1!==o)return i;var v=this.unpackTensor(i);return this.disposeData(i.dataId),v},O.prototype.compileAndRun=function(e,n,t,r,o){void 0===o&&(o=!1);var a=this.runWebGLProgram(e,n,t=t||n[0].dtype,r,o);return A.makeTensorFromDataId(a.dataId,a.shape,a.dtype)},O.prototype.getAndSaveBinary=function(e,n){return e in this.binaryCache||(this.binaryCache[e]=n()),this.binaryCache[e]},O.prototype.getTextureManager=function(){return this.textureManager},O.prototype.dispose=function(){var e=this;this.disposed||(q().getBool("IS_TEST")||Object.keys(this.binaryCache).forEach(function(n){e.gpgpu.deleteProgram(e.binaryCache[n].webGLProgram),delete e.binaryCache[n]}),this.textureManager.dispose(),null!=this.canvas&&typeof HTMLCanvasElement<"u"&&this.canvas instanceof HTMLCanvasElement?this.canvas.remove():this.canvas=null,this.gpgpuCreatedLocally&&(this.gpgpu.program=null,this.gpgpu.dispose()),this.disposed=!0)},O.prototype.floatPrecision=function(){var e=this;return null==this.floatPrecisionValue&&(this.floatPrecisionValue=Q(function(){if(!q().get("WEBGL_RENDER_FLOAT32_ENABLED")){var n=q().getBool("DEBUG");q().set("DEBUG",!1);var t=e.abs($(1e-8)).dataSync()[0];if(q().set("DEBUG",n),0<t)return 32}return 16})),this.floatPrecisionValue},O.prototype.epsilon=function(){return 32===this.floatPrecision()?1e-7:1e-4},O.prototype.uploadToGPU=function(e){var n,t=this.texData.get(e),r=t.shape,o=t.dtype,a=t.values,s=t.usage,u=t.isPacked;if(null==t.texture){var c,l=null!=this.activeTimers;l&&(c=Mn());var h=t.texShape;if(null==h&&(h=gh(r,u),t.texShape=h),null!=a){var p,f=Ia(r),d=h[1],g=h[0],v=a instanceof Uint8Array;p=u?(d=(n=wo(h[0],h[1]))[0],new M0(f,[g=n[1],d],v)):new F0(f,[g,d],v);var m=this.makeTensorInfo([g,d],o);this.texData.get(m.dataId).usage=v?xn.PIXELS:xn.UPLOAD,this.gpgpu.uploadDenseMatrixToTexture(this.getTexture(m.dataId),d,g,a);var y=this.runWebGLProgram(p,[m],o,null,!0),x=this.texData.get(y.dataId);t.texture=x.texture,t.texShape=x.texShape,t.isPacked=x.isPacked,t.usage=x.usage,this.disposeData(m.dataId),this.texData.delete(y.dataId),t.values=null,l&&(this.uploadWaitMs+=Mn()-c)}else{var w=this.acquireTexture(h,s,o,u);t.texture=w}}},O.prototype.convertAndCacheOnCPU=function(e,n){var t=this.texData.get(e),r=t.dtype;return this.releaseGPUData(e),null!=n&&(t.values=function(o,a){if("float32"===a||"complex64"===a)return o;if("int32"!==a&&"bool"!==a)throw new Error("Unknown dtype "+a);for(var i="int32"===a?new Int32Array(o.length):new Uint8Array(o.length),s=0;s<i.length;++s)i[s]=Math.round(o[s]);return i}(n,r)),t.values},O.prototype.acquireTexture=function(e,n,t,r){if(this.numBytesInGPU+=this.computeBytes(e,t),!this.warnedAboutMemory&&this.numBytesInGPU>1024*this.numMBBeforeWarning*1024){var o=(this.numBytesInGPU/1024/1024).toFixed(2);this.warnedAboutMemory=!0,console.warn("High memory usage in GPU: "+o+" MB, most likely due to a memory leak")}return this.textureManager.acquireTexture(e,n,r)},O.prototype.computeBytes=function(e,n){return e[0]*e[1]*os(n)},O);function O(e){var n,t=lp.call(this)||this;if(t.pendingRead=new WeakMap,t.pendingDisposal=new WeakSet,t.dataRefCount=new WeakMap,t.numBytesInGPU=0,t.uploadWaitMs=0,t.downloadWaitMs=0,t.warnedAboutMemory=!1,t.pendingDeletes=0,t.disposed=!1,!q().getBool("HAS_WEBGL"))throw new Error("WebGL is not supported on this device");if(null==e){var r=Kn(q().getNumber("WEBGL_VERSION"));t.binaryCache=((n=q().getNumber("WEBGL_VERSION"))in ru||(ru[n]={}),ru[n]),t.gpgpu=new Hf(r),t.canvas=r.canvas,t.gpgpuCreatedLocally=!0}else t.gpgpu=e,t.binaryCache={},t.gpgpuCreatedLocally=!1,t.canvas=e.gl.canvas;return t.textureManager=new hy(t.gpgpu),t.numMBBeforeWarning=null==q().global.screen?1024:q().global.screen.height*q().global.screen.width*window.devicePixelRatio*600/1024/1024,t.texData=new Ws(t,A),t}Ql()&&A.registerBackend("webgl",function(){return new hp},2);var fp=T({square_:function(e){var n=_(e,"x","square");return A.runKernelFunc(function(r,o){return o([n]),r.square(n)},{x:n},null,"Square",{},[n],[])}}),Po="SquaredDifference",ou=T({squaredDifference_:function(e,n){var t,r=_(e,"a","squaredDifference"),o=_(n,"b","squaredDifference");return t=Ne(r,o),ve((r=t[0]).shape,(o=t[1]).shape),A.runKernelFunc(function(s,u){var c=s.squaredDifference(r,o);return u([r,o]),c},{a:r,b:o},function(s,u){var c=u[0],l=u[1],h=$(2);return{a:function(){return s.mul(c.sub(l).mul(h))},b:function(){return s.mul(l.sub(c).mul(h))}}},Po,{},[r,o],[])}}),pp=T({abs_:function(e){var n=_(e,"x","abs");return"complex64"===n.dtype?A.runKernelFunc(function(t){return t.complexAbs(n)},{$x:n}):A.runKernelFunc(function(t,r){var o=t.abs(n);return r([n]),o},{x:n},function(t,r){var o=r[0];return{x:function(){return t.mul(o.toFloat().step(-1))}}},"Abs")}}),dp=T({acos_:function(e){var n=_(e,"x","acos");return A.runKernelFunc(function(t,r){var o=t.acos(n);return r([n]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){return t.divStrict($(1).sub(o.toFloat().square()).sqrt()).neg()}}})}}),vp=T({acosh_:function(e){var n=_(e,"x","acosh");return A.runKernelFunc(function(t,r){var o=t.acosh(n);return r([n]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){return t.divStrict(o.toFloat().square().sub(1).sqrt())}}})}}),mp=T({asin_:function(e){var n=_(e,"x","asin");return A.runKernelFunc(function(t,r){var o=t.asin(n);return r([n]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){return t.divStrict($(1).sub(o.toFloat().square()).sqrt())}}})}}),gp=T({asinh_:function(e){var n=_(e,"x","asinh");return A.runKernelFunc(function(t,r){var o=t.asinh(n);return r([n]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){return t.divStrict($(1).add(o.toFloat().square()).sqrt())}}})}}),yp=T({atan_:function(e){var n=_(e,"x","atan");return A.runKernelFunc(function(t,r){var o=t.atan(n);return r([n]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){return t.div(o.toFloat().square().add(1))}}})}}),xp=T({atanh_:function(e){var n=_(e,"x","atanh");return A.runKernelFunc(function(t,r){var o=t.atanh(n);return r([n]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){return t.div($(1).sub(o.toFloat().square()))}}})}}),bp=T({ceil_:function(e){var n=_(e,"x","ceil");return A.runKernelFunc(function(t){return t.ceil(n)},{$x:n},function(t){return{$x:function(){return xe(t)}}})}}),ja=T({clipByValue_:function(e,n,t){var r=_(e,"x","clipByValue");return S(n<=t,function(){return"Error in clip: min ("+n+") must be less than or equal to max ("+t+")."}),A.runKernelFunc(function(i,s){var u=i.clip(r,n,t);return s([r]),u},{x:r},function(i,s){var u=s[0];return{x:function(){return i.where(u.greaterEqual(n).logicalAnd(u.lessEqual(t)),xe(i))}}},"ClipByValue",{min:n,max:t},[r])}}),wp=T({cos_:function(e){var n=_(e,"x","cos");return A.runKernelFunc(function(r,o){var a=r.cos(n);return o([n]),a},{x:n},function(r,o){var a=o[0];return{x:function(){return a.toFloat().sin().neg().mul(r)}}},"Cos",{},[n])}}),Cp=T({cosh_:function(e){var n=_(e,"x","cosh");return A.runKernelFunc(function(t,r){var o=t.cosh(n);return r([n]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){return o.toFloat().sinh().mulStrict(t)}}})}}),Ep=T({erf_:function(e){var n=_(e,"x","erf");return S("int32"===n.dtype||"float32"===n.dtype,function(){return"Input dtype must be `int32` or `float32`."}),"int32"===n.dtype&&(n=n.toFloat()),A.runKernelFunc(function(t,r){var o=t.erf(n);return r([n]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){return t.mul(o.square().neg().exp().mul(2/Math.sqrt(Math.PI)))}}})}}),Ka=T({exp_:function(e){var n=_(e,"x","exp");return A.runKernelFunc(function(t,r){var o=t.exp(n);return r([o]),o},{x:n},function(t,r){return{x:function(){return t.mulStrict(r[0])}}},"Exp",{},[],[!0])}}),_p=T({expm1_:function(e){var n=_(e,"x","expm1");return A.runKernelFunc(function(t,r){var o=t.expm1(n);return r([n]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){return t.mul(o.exp())}}})}}),Ip=T({floor_:function(e){var n=_(e,"x","floor");return A.runKernelFunc(function(t){return t.floor(n)},{$x:n},function(t){return{$x:function(){return xe(t)}}})}}),Rp=T({log_:function(e){var n=_(e,"x","log");return A.runKernelFunc(function(r,o){var a=r.log(n);return o([n]),a},{x:n},function(r,o){var a=o[0];return{x:function(){return r.div(a.toFloat())}}},"Log",{},[n])}}),kp=T({log1p_:function(e){var n=_(e,"x","log1p");return A.runKernelFunc(function(t,r){var o=t.log1p(n);return r([n]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){return t.div(o.add(1))}}})}}),Sp=T({logSigmoid_:function(e){var n=_(e,"x","logSigmoid");return A.runKernelFunc(function(t,r){var o=t.softplus(n.neg()).neg();return r([n]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){return t.mul(o.neg().sigmoid())}}})}}),Bo=T({neg_:function(e){var n=_(e,"x","neg");return A.runKernelFunc(function(r){return r.neg(n)},{x:n},function(r){return{x:function(){return r.neg()}}},"Neg",{},[n])}}),Dp=T({reciprocal_:function(e){var n=_(e,"x","reciprocal");return A.runKernelFunc(function(t,r){var o=t.reciprocal(n);return r([n]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){return t.div(o.square().neg())}}})}}),Ap=T({round_:function(e){var n=_(e,"x","round");return A.runKernelFunc(function(t){return t.round(n)},{$x:n},function(t){return{$x:function(){return xe(t)}}})}}),au=T({rsqrt_:function(e){var n=_(e,"x","rsqrt");return A.runKernelFunc(function(r,o){var a=r.rsqrt(n);return o([n]),a},{x:n},function(r,o){var a=o[0];return{x:function(){return r.div(a.pow(1.5).mul(2)).neg()}}},"Rsqrt",{},[n])}}),iu=T({sigmoid_:function(e){var n=_(e,"x","sigmoid");return A.runKernelFunc(function(t,r){var o=t.sigmoid(n);return r([o]),o},{x:n},function(t,r){var o=r[0];return{x:function(){return t.mul(o.mul($(1).sub(o)))}}},"Sigmoid")}}),Tp=T({sign_:function(e){var n=_(e,"x","sign");return A.runKernelFunc(function(t){return t.sign(n)},{$x:n},function(t){return{$x:function(){return xe(t)}}})}}),Np=T({isNaN_:function(e){var n=_(e,"x","isNaN");return A.runKernelFunc(function(t){return t.isNaN(n)},{$x:n},function(t){return{$x:function(){return xe(t)}}})}}),Fp=T({isInf_:function(e){var n=_(e,"x","isInf");return A.runKernelFunc(function(t){return t.isInf(n)},{$x:n},function(t){return{$x:function(){return xe(t)}}})}}),Mp=T({isFinite_:function(e){var n=_(e,"x","isFinite");return A.runKernelFunc(function(t){return t.isFinite(n)},{$x:n},function(t){return{$x:function(){return xe(t)}}})}}),Op=T({sin_:function(e){var n=_(e,"x","sin");return A.runKernelFunc(function(r,o){var a=r.sin(n);return o([n]),a},{x:n},function(r,o){var a=o[0];return{x:function(){return a.toFloat().cos().mul(r)}}},"Sin",{},[n])}}),Pp=T({sinh_:function(e){var n=_(e,"x","sinh");return A.runKernelFunc(function(t,r){var o=t.sinh(n);return r([n]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){return o.toFloat().cosh().mulStrict(t)}}})}}),Bp=T({softplus_:function(e){var n=_(e,"x","softplus");return A.runKernelFunc(function(t,r){var o=t.softplus(n);return r([n]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){return t.mul(o.sigmoid())}}})}}),Lp=T({sqrt_:function(e){var n=_(e,"x","sqrt");return A.runKernelFunc(function(t,r){var o=t.sqrt(n);return r([n]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){return t.div(o.toFloat().sqrt().mul(2))}}})}}),Wp=T({step_:function(e,n){void 0===n&&(n=0);var t=_(e,"x","step");return A.runKernelFunc(function(r){return r.step(t,n)},{$x:t},function(r){return{$x:function(){return xe(r)}}})}}),zp=T({tan_:function(e){var n=_(e,"x","tan");return A.runKernelFunc(function(t,r){var o=t.tan(n);return r([n]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){return t.div(o.cos().square())}}})}}),Up=T({tanh_:function(e){var n=_(e,"x","tanh");return A.runKernelFunc(function(t,r){var o=t.tanh(n);return r([o]),o},{x:n},function(t,r){var o=r[0];return{x:function(){return $(1).sub(o.square()).mulStrict(t)}}},"Tanh",{},null,[!0])}});function Vp(e,n,t,r,o,a){var i,s,u=_(e,"x","batchNorm"),c=_(n,"mean","batchNorm"),l=_(t,"variance","batchNorm");return null!=o&&(i=_(o,"scale","batchNorm")),null!=r&&(s=_(r,"offset","batchNorm")),S(2===u.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+u.rank+"."}),S(2===c.rank||1===c.rank,function(){return"Error in batchNorm2D: mean must be rank 2 or rank 1 but got rank "+c.rank+"."}),S(2===l.rank||1===l.rank,function(){return"Error in batchNorm2D: variance must be rank 2 or rank 1 but got rank "+l.rank+"."}),null!=i&&S(2===i.rank||1===i.rank,function(){return"Error in batchNorm2D: scale must be rank 2 or rank 1 but got rank "+i.rank+"."}),null!=s&&S(2===s.rank||1===s.rank,function(){return"Error in batchNorm2D: offset must be rank 2 or rank 1 but got rank "+s.rank+"."}),Lo(u,c,l,s,i,a)}function Gp(e,n,t,r,o,a){var i,s,u=_(e,"x","batchNorm"),c=_(n,"mean","batchNorm"),l=_(t,"variance","batchNorm");return null!=o&&(i=_(o,"scale","batchNorm")),null!=r&&(s=_(r,"offset","batchNorm")),S(3===u.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+u.rank+"."}),S(3===c.rank||1===c.rank,function(){return"Error in batchNorm3D: mean must be rank 3 or rank 1 but got rank "+c.rank+"."}),S(3===l.rank||1===l.rank,function(){return"Error in batchNorm3D: variance must be rank 3 or rank 1 but got rank "+l.rank+"."}),null!=i&&S(3===i.rank||1===i.rank,function(){return"Error in batchNorm3D: scale must be rank 3 or rank 1 but got rank "+i.rank+"."}),null!=s&&S(3===s.rank||1===s.rank,function(){return"Error in batchNorm3D: offset must be rank 3 or rank 1 but got rank "+s.rank+"."}),Lo(u,c,l,s,i,a)}function Hp(e,n,t,r,o,a){var i,s,u=_(e,"x","batchNorm"),c=_(n,"mean","batchNorm"),l=_(t,"variance","batchNorm");return null!=o&&(i=_(o,"scale","batchNorm")),null!=r&&(s=_(r,"offset","batchNorm")),S(4===u.rank,function(){return"Error in batchNorm4D: x must be rank 4 but got rank "+u.rank+"."}),S(4===c.rank||1===c.rank,function(){return"Error in batchNorm4D: mean must be rank 4 or rank 1 but got rank "+c.rank+"."}),S(4===l.rank||1===l.rank,function(){return"Error in batchNorm4D: variance must be rank 4 or rank 1 but got rank "+l.rank+"."}),null!=i&&S(4===i.rank||1===i.rank,function(){return"Error in batchNorm4D: scale must be rank 4 or rank 1 but got rank "+i.rank+"."}),null!=s&&S(4===s.rank||1===s.rank,function(){return"Error in batchNorm4D: offset must be rank 4 or rank 1 but got rank "+s.rank+"."}),Lo(u,c,l,s,i,a)}function Lo(e,n,t,r,o,a){null==a&&(a=.001);var i,s,u,c=_(e,"x","batchNorm"),l=_(n,"mean","batchNorm"),h=_(t,"variance","batchNorm");return null!=o&&(i=_(o,"scale","batchNorm")),null!=r&&(s=_(r,"offset","batchNorm")),S(l.rank===h.rank,function(){return"Batch normalization gradient requires mean and variance to have equal ranks."}),S(null==s||l.rank===s.rank,function(){return"Batch normalization gradient requires mean and offset to have equal ranks."}),S(null==i||l.rank===i.rank,function(){return"Batch normalization gradient requires mean and scale to have equal ranks."}),u=0===c.rank||1===c.rank?c.as4D(1,1,1,c.size):2===c.rank?c.as4D(1,1,c.shape[0],c.shape[1]):3===c.rank?c.as4D(1,c.shape[0],c.shape[1],c.shape[2]):c,A.runKernelFunc(function(p,d){var g=p.batchNormalization(u,Xa(l),Xa(h),a,Xa(i),Xa(s));return d([c,l,h,i]),g},{x:c,mean:l,variance:h,scale:i,offset:s},function(p,d){var v=d[0],m=d[1],y=d[2],w=d[3]??$(1),b=Ve(m.shape,u.shape),I=[];if(1===m.rank){for(var E=0;E<u.shape.length-1;++E)I.push(u.shape[E]);I.push(1)}var C=v.sub(m),R=p.mul(w),k=au(y.add($(a))),D=k.mul(k).mul(k).mul($(-.5));return{x:function(){return 1===m.rank?p.mul(pr(k.as4D(1,1,1,m.shape[0]),I)).mul(w).reshape(v.shape):p.mul(k).mul(w).reshape(v.shape)},mean:function(){var N=k.mul($(-1)).mul(R);return 1===m.rank&&(N=N.sum(b)),N.reshape(m.shape)},variance:function(){var N=D.mul(C).mul(R);return 1===m.rank&&(N=N.sum(b)),N.reshape(m.shape)},scale:function(){var N=C.mul(k),M=p.mul(N);return 1===m.rank&&(M=M.sum(b)),M.reshape(m.shape)},offset:function(){var N=p;return 1===m.rank&&(N=N.sum(b)),N.reshape(m.shape)}}},"BatchNormalization",{varianceEpsilon:a},[c,l,h,i]).reshape(c.shape)}function Xa(e){return null==e?null:0===e.rank?e.as1D():1===e.rank?e:2===e.rank?e.as4D(1,1,e.shape[0],e.shape[1]):3===e.rank?e.as4D(1,e.shape[0],e.shape[1],e.shape[2]):e}function Ya(){_s("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon")}function su(e){return oe(this,void 0,void 0,function(){var n,t,r;return ae(this,function(o){switch(o.label){case 0:return[4,(n=_(e,"condition","whereAsync","bool")).data()];case 1:return t=o.sent(),r=Xs(n.shape,t),e!==n&&n.dispose(),[2,r]}})})}var qp=T({batchNormalization2d_:function(e,n,t,r,o,a){return void 0===r&&(r=.001),Ya(),Vp(e,n,t,a,o,r)}}),jp=T({batchNormalization3d_:function(e,n,t,r,o,a){return void 0===r&&(r=.001),Ya(),Gp(e,n,t,a,o,r)}}),Kp=T({batchNormalization4d_:function(e,n,t,r,o,a){return void 0===r&&(r=.001),Ya(),Hp(e,n,t,a,o,r)}}),Xp=T({batchNormalization_:function(e,n,t,r,o,a){return void 0===r&&(r=.001),Ya(),Lo(e,n,t,a,o,r)}}),uu=T({batchNorm_:Lo}),Yp=T({batchNorm2d_:Vp}),$p=T({batchNorm3d_:Gp}),Jp=T({batchNorm4d_:Hp}),Wo=T({logicalAnd_:function(e,n){var t=_(e,"a","logicalAnd","bool"),r=_(n,"b","logicalAnd","bool");return ve(t.shape,r.shape),A.runKernelFunc(function(o){return o.logicalAnd(t,r)},{a:t,b:r},null,"LogicalAnd")}}),Qp=T({logicalNot_:function(e){var n=_(e,"x","logicalNot","bool");return A.runKernelFunc(function(t){return t.logicalNot(n)},{$x:n})}}),cu=T({logicalOr_:function(e,n){var t=_(e,"a","logicalOr","bool"),r=_(n,"b","logicalOr","bool");return ve(t.shape,r.shape),A.runKernelFunc(function(o){return o.logicalOr(t,r)},{$a:t,$b:r})}}),Zp=T({logicalXor_:function(e,n){var t=_(e,"a","logicalXor","bool"),r=_(n,"b","logicalXor","bool");return ve(t.shape,r.shape),cu(e,n).logicalAnd(Wo(e,n).logicalNot())}}),Bt=T({where_:function(e,n,t){var r=_(n,"a","where"),o=_(t,"b","where"),a=_(e,"condition","where","bool");return we(r.shape,o.shape,"Error in where: "),1===a.rank?S(a.shape[0]===r.shape[0],function(){return"The first dimension of `a` must match the size of `condition`."}):we(a.shape,o.shape,"Error in where: "),A.runKernelFunc(function(i,s){var u=i.select(a,r,o);return s([a]),u},{$condition:a,$a:r,$b:o},function(i,s){var u=s[0];return{$condition:function(){return xe(u).toFloat()},$a:function(){return i.mul(u.cast(i.dtype))},$b:function(){return i.mul(u.logicalNot().cast(i.dtype))}}})}}),de=T({add_:function(e,n){var t,r=_(e,"a","add"),o=_(n,"b","add");t=Ne(r,o);var a=ve((r=t[0]).shape,(o=t[1]).shape);return A.runKernelFunc(function(i){return i.add(r,o)},{a:r,b:o},function(i){return{a:function(){var s=i,u=Ve(r.shape,a);return 0<u.length&&(s=s.sum(u)),s.reshape(r.shape)},b:function(){var s=i,u=Ve(o.shape,a);return 0<u.length&&(s=s.sum(u)),s.reshape(o.shape)}}},"Add")}}),ed=T({addN_:function(e){S(Array.isArray(e),function(){return"The argument passed to tf.addN() must be a list of tensors"}),S(1<=e.length,function(){return"Must pass at least one tensor to tf.addN(), but got "+e.length});var n=e.map(function(o,a){return _(o,"tensors"+a,"addN")}),t=n[0];return n.forEach(function(o){if(o.dtype!==t.dtype)throw new Error("All tensors passed to tf.addN() must have the same dtype")}),n.forEach(function(o){if(!Le(o.shape,t.shape))throw new Error("All tensors passed to tf.addN() must have the same shape")}),A.runKernelFunc(function(o){return o.addN(n)},n,function(o){var a={};return n.forEach(function(i,s){a[s]=function(){return o.clone()}}),a},"AddN")}}),nd=T({addStrict_:function(e,n){var t=_(e,"a","addStrict"),r=_(n,"b","addStrict");return we(t.shape,r.shape,"Error in addStrict: "),t.add(r)}}),td=T({atan2_:function(e,n){var t,r=_(e,"a","atan2"),o=_(n,"b","atan2");t=Ne(r,o);var a=ve((r=t[0]).shape,(o=t[1]).shape);return A.runKernelFunc(function(i,s){var u=i.atan2(r,o);return s([r,o]),u},{$a:r,$b:o},function(i,s){var u=s[0],c=s[1];return{$a:function(){var l=de(u.square(),c.square()),h=i.mul(c.div(l)),f=Ve(u.shape,a);return 0<f.length&&(h=h.sum(f)),h.reshape(u.shape)},$b:function(){var l=de(u.square(),c.square()),h=Bo(i.mul(u.div(l))),f=Ve(c.shape,a);return 0<f.length&&(h=h.sum(f)),h.reshape(c.shape)}}})}}),Tn=T({div_:function(e,n){var t,r=_(e,"a","div"),o=_(n,"b","div");if(t=Ne(r,o),o=t[1],"int32"===(r=t[0]).dtype&&"int32"===o.dtype)return lu(r,o);var a=ve(r.shape,o.shape);return A.runKernelFunc(function(i,s){var u=i.realDivide(r,o);return s([r,o]),u},{a:r,b:o},function(i,s){var u=s[0],c=s[1];return{a:function(){var l=i.div(c.toFloat()),h=Ve(u.shape,a);return 0<h.length?l.sum(h).reshape(u.shape):l},b:function(){var l=i.mul(u.toFloat()),h=Ve(c.shape,a);0<h.length&&(l=l.sum(h).reshape(c.shape));var f=c.square();return l.div(f.toFloat()).neg()}}},"Div")}}),rd=T({divNoNan_:function(e,n){var t,r=_(e,"a","div"),o=_(n,"b","div");r=(t=Ne(r,o))[0];var a=Tn(r,o=t[1]),i=xe(a),s=o.equal(i);return Bt(s,i,a)}}),od=T({divStrict_:function(e,n){var t=_(e,"a","div"),r=_(n,"b","div");return we(t.shape,r.shape,"Error in divideStrict: "),t.div(r)}}),lu=T({floorDiv_:function(e,n){var t,r=_(e,"a","floorDiv"),o=_(n,"b","floorDiv");t=Ne(r,o);var a=ve((r=t[0]).shape,(o=t[1]).shape);return A.runKernelFunc(function(i,s){var u=i.floorDiv(r,o);return s([r,o]),u},{a:r,b:o},function(i,s){var u=s[0],c=s[1];return{a:function(){var l=i.div(c.toFloat()),h=Ve(u.shape,a);return 0<h.length?l.sum(h).reshape(u.shape):l},b:function(){var l=i.mul(u.toFloat()),h=Ve(c.shape,a);0<h.length&&(l=l.sum(h).reshape(c.shape));var f=c.square();return l.div(f.toFloat()).neg()}}},"FloorDiv")}}),$a=T({maximum_:function(e,n){var t,r=_(e,"a","maximum"),o=_(n,"b","maximum");return t=Ne(r,o),o=t[1],"bool"===(r=t[0]).dtype&&(r=r.toInt(),o=o.toInt()),ve(r.shape,o.shape),A.runKernelFunc(function(a,i){var s=a.maximum(r,o);return i([r,o]),s},{a:r,b:o},function(a,i){var s=i[0],u=i[1];return{a:function(){return a.mul(s.greaterEqual(u).toFloat())},b:function(){return a.mul(s.less(u).toFloat())}}},"Maximum")}}),ad=T({maximumStrict_:function(e,n){var t=_(e,"a","maximumStrict"),r=_(n,"b","maximumStrict");return we(t.shape,r.shape,"Error in maximumStrict: "),t.maximum(r)}}),hu=T({minimum_:function(e,n){var t,r=_(e,"a","minimum"),o=_(n,"b","minimum");return t=Ne(r,o),o=t[1],"bool"===(r=t[0]).dtype&&(r=r.toInt(),o=o.toInt()),ve(r.shape,o.shape),A.runKernelFunc(function(a,i){var s=a.minimum(r,o);return i([r,o]),s},{a:r,b:o},function(a,i){var s=i[0],u=i[1];return{a:function(){return a.mul(s.lessEqual(u).toFloat())},b:function(){return a.mul(s.greater(u).toFloat())}}},"Minimum")}}),id=T({minimumStrict_:function(e,n){var t=_(e,"a","minimumStrict"),r=_(n,"b","minimumStrict");return we(t.shape,r.shape,"Error in minimumStrict: "),t.minimum(r)}}),sd=T({mod_:function(e,n){var t,r=_(e,"a","mod"),o=_(n,"b","mod");t=Ne(r,o);var a=ve((r=t[0]).shape,(o=t[1]).shape);return A.runKernelFunc(function(i,s){var u=i.mod(r,o);return s([r,o]),u},{$a:r,$b:o},function(i,s){var u=s[0],c=s[1];return{$a:function(){var l=Ve(u.shape,a);return 0<l.length?i.sum(l).reshape(u.shape):i},$b:function(){var l=i.mul(u.div(c).floor().neg()),h=Ve(c.shape,a);return 0<h.length?l.sum(h).reshape(c.shape):l}}})}}),ud=T({modStrict_:function(e,n){var t=_(e,"a","modStrict"),r=_(n,"b","modStrict");return we(t.shape,r.shape,"Error in modStrict: "),t.mod(r)}}),nn=T({mul_:function(e,n){var t,r=_(e,"a","mul"),o=_(n,"b","mul");t=Ne(r,o);var a=ve((r=t[0]).shape,(o=t[1]).shape);return A.runKernelFunc(function(i,s){var u=i.multiply(r,o);return s([r,o]),u},{a:r,b:o},function(i,s){var u=s[0],c=s[1];return{a:function(){var l=i.mul(c.toFloat()),h=Ve(u.shape,a);return 0<h.length?l.sum(h).reshape(u.shape):l},b:function(){var l=i.mul(u.toFloat()),h=Ve(c.shape,a);return 0<h.length?l.sum(h).reshape(c.shape):l}}},"Mul")}}),cd=T({mulStrict_:function(e,n){var t=_(e,"a","mul"),r=_(n,"b","mul");return we(t.shape,r.shape,"Error in multiplyStrict: "),t.mul(r)}}),zo=T({pow_:function(e,n){var t,r=_(e,"base","pow"),o=_(n,"exp","pow");t=Ne(r,o);var a=ve((r=t[0]).shape,(o=t[1]).shape);return A.runKernelFunc(function(s,u){var c=s.pow(r,o);return u([r,o,c]),c},{a:r,b:o},function(s,u){var c=u[0],l=u[1],h=u[2];return{a:function(){var f=l.toFloat(),p=s.mul(f.mul(c.pow(f.sub($(1))))),d=Ve(c.shape,a);return 0<d.length&&(p=p.sum(d)),p.reshape(c.shape)},b:function(){var f=c.greater(0),p=c.log().where(f,xe(c)),d=s.mul(h.mul(p)),g=Ve(l.shape,a);return 0<g.length&&(d=d.sum(g)),d.reshape(l.shape)}}},"Pow",{},[r,o],[!0])}}),ld=T({powStrict_:function(e,n){return we(e.shape,n.shape,"Error in powStrict: "),e.pow(n)}}),hd=T({squaredDifferenceStrict_:function(e,n){var t=_(e,"a","squaredDifferenceStrict"),r=_(n,"b","squaredDifferenceStrict");return we(t.shape,r.shape,"Error in squaredDifferenceStrict: "),t.squaredDifference(r)}}),Ge=T({sub_:function(e,n){var t,r=_(e,"a","sub"),o=_(n,"b","sub");t=Ne(r,o);var a=ve((r=t[0]).shape,(o=t[1]).shape);return A.runKernelFunc(function(i){return i.subtract(r,o)},{a:r,b:o},function(i){return{a:function(){var s=i,u=Ve(r.shape,a);return 0<u.length&&(s=s.sum(u)),s.reshape(r.shape)},b:function(){var s=i,u=Ve(o.shape,a);return 0<u.length&&(s=s.sum(u)),s.neg().reshape(o.shape)}}},"Sub")}}),fd=T({subStrict_:function(e,n){var t=_(e,"a","subStrict"),r=_(n,"b","subStrict");return we(t.shape,r.shape,"Error in subStrict: "),t.sub(r)}}),fu=T({equal_:function(e,n){var t,r=_(e,"a","equal"),o=_(n,"b","equal");return t=Ne(r,o),ve((r=t[0]).shape,(o=t[1]).shape),A.runKernelFunc(function(a){return a.equal(r,o)},{$a:r,$b:o})}}),pd=T({equalStrict_:function(e,n){var t=_(e,"a","equalStrict"),r=_(n,"b","equalStrict");return we(t.shape,r.shape,"Error in equalStrict: "),t.equal(r)}}),dd=T({greater_:function(e,n){var t,r=_(e,"a","greater"),o=_(n,"b","greater");return t=Ne(r,o),ve((r=t[0]).shape,(o=t[1]).shape),A.runKernelFunc(function(a){return a.greater(r,o)},{a:r,b:o},null,"Greater")}}),pu=T({greaterEqual_:function(e,n){var t,r=_(e,"a","greaterEqual"),o=_(n,"b","greaterEqual");return t=Ne(r,o),ve((r=t[0]).shape,(o=t[1]).shape),A.runKernelFunc(function(a,i){var s=a.greaterEqual(r,o);return i([r,o]),s},{a:r,b:o},function(a,i){var s=i[0],u=i[1];return{a:function(){return xe(s)},b:function(){return xe(u)}}},"GreaterEqual")}}),vd=T({greaterEqualStrict_:function(e,n){var t=_(e,"a","greaterEqualStrict"),r=_(n,"b","greaterEqualStrict");return we(t.shape,r.shape,"Error in greaterEqualStrict: "),t.greaterEqual(r)}}),md=T({greaterStrict_:function(e,n){var t=_(e,"a","greaterStrict"),r=_(n,"b","greaterStrict");return we(t.shape,r.shape,"Error in greaterStrict: "),t.greater(r)}}),gd=T({less_:function(e,n){var t,r=_(e,"a","less"),o=_(n,"b","less");return t=Ne(r,o),ve((r=t[0]).shape,(o=t[1]).shape),A.runKernelFunc(function(a){return a.less(r,o)},{a:r,b:o},null,"Less")}}),yd=T({lessEqual_:function(e,n){var t,r=_(e,"a","lessEqual"),o=_(n,"b","lessEqual");return t=Ne(r,o),ve((r=t[0]).shape,(o=t[1]).shape),A.runKernelFunc(function(a,i){var s=a.lessEqual(r,o);return i([r,o]),s},{a:r,b:o},null,"LessEqual")}}),xd=T({lessEqualStrict_:function(e,n){var t=_(e,"a","lessEqualStrict"),r=_(n,"b","lessEqualStrict");return we(t.shape,r.shape,"Error in lessEqualStrict: "),t.lessEqual(r)}}),bd=T({lessStrict_:function(e,n){var t=_(e,"a","lessStrict"),r=_(n,"b","lessStrict");return we(t.shape,r.shape,"Error in lessStrict: "),t.less(r)}}),wd=T({notEqual_:function(e,n){var t,r=_(e,"a","notEqual"),o=_(n,"b","notEqual");return t=Ne(r,o),ve((r=t[0]).shape,(o=t[1]).shape),A.runKernelFunc(function(a){return a.notEqual(r,o)},{a:r,b:o},null,"NotEqual")}}),Cd=T({notEqualStrict_:function(e,n){var t=_(e,"a","notEqualStrict"),r=_(n,"b","notEqualStrict");return we(t.shape,r.shape,"Error in notEqualStrict: "),t.notEqual(r)}});function Ed(e,n){for(var t=[],r=e;r<n;++r)t.push(r);return t}function _d(e){for(var n=[],t=0;t<e.length;++t)for(var r=0;r<e[t].length;++r)n.push(e[t][r]);return n}function Id(e,n,t){return oe(this,void 0,void 0,function(){var r,o,a,i,s,u,c,l,h,f,p,d,g;return ae(this,function(v){switch(v.label){case 0:for(r=_(e,"tensor","boolMask"),o=_(n,"mask","boolMask","bool"),a=t??0,s=r.shape,S(0<(i=o.rank),function(){return"mask cannot be scalar"}),we(s.slice(a,a+i),o.shape,"mask's shape must match the first K dimensions of tensor's shape,"),u=1,c=a;c<a+i;c++)u*=s[c];return l=s.slice(0,a).concat([u],s.slice(a+i)),h=r.reshape(l),[4,su(f=o.reshape([-1]))];case 1:return p=v.sent(),d=p.squeeze([1]),g=Ja(h,d,a),e!==r&&r.dispose(),n!==o&&o.dispose(),d.dispose(),h.dispose(),f.dispose(),p.dispose(),[2,g]}})})}var Ja=T({gather_:function(e,n,t){void 0===t&&(t=0);var r=_(e,"x","gather"),o=_(n,"indices","gather","int32");t=We(t,r.shape)[0];var a=function(i,s,u){for(var c=i.shape[u],l=[],h=1,f=1,p=0;p<u;p++)l.push(i.shape[p]),h*=i.shape[p];for(p=0;p<s.rank;p++)l.push(s.shape[p]);for(p=u+1;p<i.rank;p++)l.push(i.shape[p]),f*=i.shape[p];return{batchSize:h,sliceSize:f,dimSize:c,outputShape:l}}(r,o,t);return A.runKernelFunc(function(i,s){var u=i.gather(r,o.flatten(),t);return s([o]),u},{x:r,indices:o},function(i,s){var u=s[0];return{x:function(){var c=r.shape,l=u.size,h=c.slice(0,t),f=h.length,p=c.slice(t,c.length).slice(1),d=p.length,g=Ed(0,f),v=Ed(f+1,f+1+d),m=_d([h,[l],p]),y=i.reshape(m),x=u.reshape([l]),w=_d([[f],g,v]),b=y.transpose(w),I=du(b,x,r.shape[t]),E=Sa(w);return I.transpose(E)},indices:function(){return u}}},"Gather",{axis:t}).reshape(a.outputShape)}}),du=T({unsortedSegmentSum_:function(e,n,t){var r=_(e,"x","unsortedSegmentSum"),o=_(n,"segmentIds","unsortedSegmentSum","int32");return S(Me(t),function(){return"numSegments must be of dtype int"}),A.runKernelFunc(function(a,i){var s=a.unsortedSegmentSum(r,o,t);return i([o]),s},{$x:r},function(a,i){var s=i[0];return{$x:function(){return function(u,c){for(var l=$a(c,xe(c)),h=Ja(u,l),f=pu(c,$(0,"int32")),p=h.rank-f.rank,d=0;d<p;++d)f=En(f,d+1);f=Wo(f,lr(h.shape,"bool"));var g=xe(h);return Bt(f,h,g)}(a,s)}}})}});function Rd(e,n,t,r,o,a,i){void 0===a&&(a="NHWC"),S(e.length===n.rank,function(){return"Length of inShape ("+e.length+") and rank of dy ("+n.rank+") must match"});var s=e,u=n,c=!1;3===n.rank&&(c=!0,u=n.as4D(1,n.shape[0],n.shape[1],n.shape[2]),s=[1,e[0],e[1],e[2]]),S(4===s.length,function(){return"Error in conv2dDerInput: inShape must be length 4, but got length "+s.length+"."}),S(4===u.rank,function(){return"Error in conv2dDerInput: dy must be rank 4, but got rank "+u.rank}),S(4===t.rank,function(){return"Error in conv2dDerInput: filter must be rank 4, but got rank "+t.rank});var l="NHWC"===a?s[3]:s[1],h="NHWC"===a?u.shape[3]:u.shape[1];S(l===t.shape[2],function(){return"Error in conv2dDerInput: depth of input ("+l+") must match input depth for filter "+t.shape[2]+"."}),S(h===t.shape[3],function(){return"Error in conv2dDerInput: depth of output ("+h+") must match output depth for filter "+t.shape[3]+"."}),null!=i&&S(Me(o),function(){return"Error in conv2dDerInput: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+o+"."});var f=Ua(a),p=Pt(s,t.shape,r,1,o,i,!1,f),d=A.runKernelFunc(function(g,v){var m=g.conv2dDerInput(u,t,p);return v([t,u]),m},{dy4D:u,filter:t},function(g,v){var m=v[0],y=v[1];return{dy4D:function(){return _n(g,m,r,o,a,1,i)},filter:function(){return mu(g,y,m.shape,r,o,a,i)}}});return c?d.as3D(d.shape[1],d.shape[2],d.shape[3]):d}function vu(e){var n,t="number"==typeof(n=e)?[n,n,n]:2===n.length?[n[0],n[1],1]:n;return 1===t[0]&&1===t[1]&&1===t[2]}function kd(e,n,t,r,o){S(e.length===n.rank,function(){return"Length of inShape ("+e.length+") and rank of dy ("+n.rank+") must match"});var a=e,i=n,s=!1;4===n.rank&&(s=!0,i=n.as5D(1,n.shape[0],n.shape[1],n.shape[2],n.shape[3]),a=[1,e[0],e[1],e[2],e[3]]);var u=a[4],c=i.shape[4];S(5===a.length,function(){return"Error in conv3dDerInput: inShape must be length 5, but got length "+a.length+"."}),S(5===i.rank,function(){return"Error in conv3dDerInput: dy must be rank 5, but got rank "+i.rank}),S(5===t.rank,function(){return"Error in conv3dDerInput: filter must be rank 5, but got rank "+t.rank}),S(u===t.shape[3],function(){return"Error in conv3dDerInput: depth of input ("+u+") must match input depth for filter "+t.shape[3]+"."}),S(c===t.shape[4],function(){return"Error in conv3dDerInput: depth of output ("+c+") must match output depth for filter "+t.shape[4]+"."});var l=No(a,t.shape,r,1,o),h=A.runKernelFunc(function(f){return f.conv3dDerInput(i,t,l)},{dy5D:i});return s?h.as4D(h.shape[1],h.shape[2],h.shape[3],h.shape[4]):h}var Sd=T({conv1d_:function(e,n,t,r,o,a,i){void 0===o&&(o="NWC"),void 0===a&&(a=1);var s=_(e,"x","conv1d"),u=_(n,"filter","conv1d"),c=s,l=!1;2===s.rank&&(l=!0,c=s.as3D(1,s.shape[0],s.shape[1])),S(3===c.rank,function(){return"Error in conv1d: input must be rank 3, but got rank "+c.rank+"."}),S(3===u.rank,function(){return"Error in conv1d: filter must be rank 3, but got rank "+u.rank+"."}),null!=i&&S(Me(r),function(){return"Error in conv1d: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+r+"."}),S(c.shape[2]===u.shape[1],function(){return"Error in conv1d: depth of input ("+c.shape[2]+") must match input depth for filter "+u.shape[1]+"."}),S(hn(t,a),function(){return"Error in conv1D: Either stride or dilation must be 1. Got stride "+t+" and dilation '"+a+"'"}),S("NWC"===o,function(){return"Error in conv1d: got dataFormat of "+o+" but only NWC is currently supported."});var h=u.as4D(1,u.shape[0],u.shape[1],u.shape[2]),f=c.as4D(c.shape[0],1,c.shape[1],c.shape[2]),p=_n(f,h,[1,t],r,"NHWC",[1,a],i);return l?p.as2D(p.shape[2],p.shape[3]):p.as3D(p.shape[0],p.shape[2],p.shape[3])}}),_n=T({conv2d_:function(e,n,t,r,o,a,i){void 0===o&&(o="NHWC"),void 0===a&&(a=[1,1]);var s=_(e,"x","conv2d"),u=_(n,"filter","conv2d"),c=s,l=!1;3===s.rank&&(l=!0,c=s.as4D(1,s.shape[0],s.shape[1],s.shape[2])),S(4===c.rank,function(){return"Error in conv2d: input must be rank 4, but got rank "+c.rank+"."}),S(4===u.rank,function(){return"Error in conv2d: filter must be rank 4, but got rank "+u.rank+"."}),null!=i&&S(Me(r),function(){return"Error in conv2d: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+r+"."});var h="NHWC"===o?c.shape[3]:c.shape[1];S(h===u.shape[2],function(){return"Error in conv2d: depth of input ("+h+") must match input depth for filter "+u.shape[2]+"."}),S(hn(t,a),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+t+" and dilations '"+a+"'"});var f=Ua(o),p=Pt(c.shape,u.shape,t,a,r,i,!1,f),g=A.runKernelFunc(function(v,m){var y=v.conv2d(c,u,p);return m([u,c]),y},{x:c,filter:u},function(v,m){var x=m[0],w=m[1];return S(dr(a),function(){return"Error in gradient of conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+a+"'"}),{x:function(){return Ad(w.shape,v,x,t,r,o)},filter:function(){return mu(w,v,x.shape,t,r,o)}}},"Conv2D",p,[u,c]);return l?g.as3D(g.shape[1],g.shape[2],g.shape[3]):g}}),Dd=T({conv3d_:function(e,n,t,r,o,a){void 0===o&&(o="NDHWC"),void 0===a&&(a=[1,1,1]);var i,s=_(e,"x","conv3d"),u=_(n,"filter","conv3d"),c=s,l=!1;4===s.rank&&(l=!0,c=s.as5D(1,s.shape[0],s.shape[1],s.shape[2],s.shape[3])),S(5===c.rank,function(){return"Error in conv3d: input must be rank 5, but got rank "+c.rank+"."}),S(5===u.rank,function(){return"Error in conv3d: filter must be rank 5, but got rank "+u.rank+"."}),S(c.shape[4]===u.shape[3],function(){return"Error in conv3d: depth of input ("+c.shape[4]+") must match input depth for filter "+u.shape[3]+"."}),S((i=a,vu(t)||vu(i)),function(){return"Error in conv3D: Either strides or dilations must be 1. Got strides "+t+" and dilations '"+a+"'"}),S("NDHWC"===o,function(){return"Error in conv3d: got dataFormat of "+o+" but only NDHWC is currently supported."});var h=No(c.shape,u.shape,t,a,r),f=A.runKernelFunc(function(p,d){var g=p.conv3d(c,u,h);return d([c,u]),g},{x:c,$filter:u},function(p,d){S(vu(a),function(){return"Error in gradient of conv3D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+a+"'"});var g=d[0],v=d[1];return{x:function(){return kd(g.shape,p,v,t,r)},$filter:function(){return function(m,y,x,w,b){var I=m;4===m.rank&&(I=m.as5D(1,m.shape[0],m.shape[1],m.shape[2],m.shape[3]));var E=y;4===E.rank&&(E=y.as5D(1,y.shape[0],y.shape[1],y.shape[2],y.shape[3])),S(5===I.rank,function(){return"Error in conv3dDerFilter: input must be rank 5, but got shape "+I.shape+"."}),S(5===E.rank,function(){return"Error in conv3dDerFilter: dy must be rank 5, but got shape "+E.shape+"."}),S(5===x.length,function(){return"Error in conv3dDerFilter: filterShape must be length 5, but got "+x+"."}),S(I.shape[4]===x[3],function(){return"Error in conv3dDerFilter: depth of input "+I.shape[4]+") must match input depth in filter ("+x[3]+"."}),S(E.shape[4]===x[4],function(){return"Error in conv3dDerFilter: depth of dy ("+E.shape[4]+") must match output depth for filter ("+x[4]+")."});var C=No(I.shape,x,w,1,b);return A.runKernelFunc(function(R){return R.conv3dDerFilter(I,E,C)},{x5D:I,dy5D:E})}(g,p,v.shape,t,r)}}});return l?f.as4D(f.shape[1],f.shape[2],f.shape[3],f.shape[4]):f}}),mu=T({conv2dDerFilter_:function(e,n,t,r,o,a,i){void 0===a&&(a="NHWC");var s=e;3===e.rank&&(s=e.as4D(1,e.shape[0],e.shape[1],e.shape[2]));var u=n;3===u.rank&&(u=n.as4D(1,n.shape[0],n.shape[1],n.shape[2])),S(4===s.rank,function(){return"Error in conv2dDerFilter: input must be rank 4, but got shape "+s.shape+"."}),S(4===u.rank,function(){return"Error in conv2dDerFilter: dy must be rank 4, but got shape "+u.shape+"."}),S(4===t.length,function(){return"Error in conv2dDerFilter: filterShape must be length 4, but got "+t+"."});var c="NHWC"===a?s.shape[3]:s.shape[1],l="NHWC"===a?u.shape[3]:u.shape[1];S(c===t[2],function(){return"Error in conv2dDerFilter: depth of input "+c+") must match input depth in filter ("+t[2]+"."}),S(l===t[3],function(){return"Error in conv2dDerFilter: depth of dy ("+l+") must match output depth for filter ("+t[3]+")."}),null!=i&&S(Me(o),function(){return"Error in conv2dDerFilter: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+o+"."});var h=Ua(a),f=Pt(s.shape,t,r,1,o,i,!1,h);return A.runKernelFunc(function(p){return p.conv2dDerFilter(s,u,f)},{x4D:s,dy4D:u})}}),Ad=T({conv2dDerInput_:Rd}),Uo=T({depthwiseConv2d_:function(e,n,t,r,o,a,i){void 0===a&&(a=[1,1]);var s=_(e,"x","depthwiseConv2d"),u=_(n,"filter","depthwiseConv2d"),c=s,l=!1;3===s.rank&&(l=!0,c=s.as4D(1,s.shape[0],s.shape[1],s.shape[2])),S(4===c.rank,function(){return"Error in depthwiseConv2d: input must be rank 4, but got rank "+c.rank+"."}),S(4===u.rank,function(){return"Error in depthwiseConv2d: filter must be rank 4, but got rank "+u.rank+"."}),S(c.shape[3]===u.shape[2],function(){return"Error in depthwiseConv2d: number of input channels ("+c.shape[3]+") must match the inChannels dimension in filter "+u.shape[2]+"."}),null==a&&(a=[1,1]),S(hn(t,a),function(){return"Error in depthwiseConv2d: Either strides or dilations must be 1. Got strides "+t+" and dilations '"+a+"'"}),null!=i&&S(Me(r),function(){return"Error in depthwiseConv2d: pad must be an integer when using, dimRoundingMode "+i+" but got pad "+r+"."});var h=Pt(c.shape,u.shape,t,a,r,i,!0),p=A.runKernelFunc(function(d,g){var v=d.depthwiseConv2D(c,u,h);return g([c,u]),v},{x:c,filter:u},function(d,g){S(dr(a),function(){return"Error in gradient of depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+a+"'"});var v=g[0],m=g[1];return{x:function(){return Td(v.shape,d,m,h)},filter:function(){return Nd(v,d,m.shape,h)}}},"DepthwiseConv2dNative",h,[c,u]);return l?p.as3D(p.shape[1],p.shape[2],p.shape[3]):p}}),Td=T({depthwiseConv2dDerInput_:function(e,n,t,r){var o=n,a=!1;3===n.rank&&(a=!0,o=n.as4D(1,n.shape[0],n.shape[1],n.shape[2]));var i=A.runKernelFunc(function(s){return s.depthwiseConv2DDerInput(o,t,r)},{dy4D:o});return a?i.as3D(i.shape[1],i.shape[2],i.shape[3]):i}}),Nd=T({depthwiseConv2dDerFilter_:function(e,n,t,r){var o=e;3===e.rank&&(o=e.as4D(1,e.shape[0],e.shape[1],e.shape[2]));var a=n;return 3===a.rank&&(a=n.as4D(1,n.shape[0],n.shape[1],n.shape[2])),A.runKernelFunc(function(i){return i.depthwiseConv2DDerFilter(o,a,r)},{x4D:o,dy4D:a})}}),Qa=T({separableConv2d_:function(e,n,t,r,o,a,i){void 0===a&&(a=[1,1]),void 0===i&&(i="NHWC");var s=_(e,"x","separableConv2d"),u=_(n,"depthwiseFilter","separableConv2d"),c=_(t,"pointwiseFilter","separableConv2d"),l=s,h=!1;if(3===s.rank&&(h=!0,l=s.as4D(1,s.shape[0],s.shape[1],s.shape[2])),"NCHW"===i)throw new Error("separableConv2d currently does not support dataFormat NCHW; only NHWC is supported");S(4===l.rank,function(){return"Error in separableConv2d: input must be rank 4, but got rank "+l.rank+"."}),S(4===u.rank,function(){return"Error in separableConv2d: depthwise filter must be rank 4, but got rank "+u.rank+"."}),S(4===c.rank,function(){return"Error in separableConv2d: pointwise filter must be rank 4, but got rank "+u.rank+"."}),S(1===c.shape[0],function(){return"Error in separableConv2d: the first dimension of pointwise filter  must be 1, but got "+c.shape[0]+"."}),S(1===c.shape[1],function(){return"Error in separableConv2d: the second dimension of pointwise filter must be 1, but got "+c.shape[1]+"."});var f=u.shape[2],p=u.shape[3];S(c.shape[2]===f*p,function(){return"Error in separableConv2d: the third dimension of pointwise filter must be "+f*p+", but got "+c.shape[2]+"."});var d=Uo(l,u,r,o,i,a),g=_n(d,c,1,"valid",i);return h?g.as3D(g.shape[1],g.shape[2],g.shape[3]):g}}),Fd=T({conv2dTranspose_:function(e,n,t,r,o,a){return Rd(t,_(e,"x","conv2dTranspose"),_(n,"filter","conv2dTranspose"),r,o,"NHWC",a)}}),Md=T({conv3dTranspose_:function(e,n,t,r,o){return kd(t,_(e,"x","conv3dTranspose"),_(n,"filter","conv3dTranspose"),r,o)}}),Vo=T({matMul_:function(e,n,t,r){var o;void 0===t&&(t=!1),void 0===r&&(r=!1);var a=_(e,"a","matMul"),i=_(n,"b","matMul");o=Ne(a,i),a=o[0],i=o[1];var s=t?a.shape[a.rank-2]:a.shape[a.rank-1],u=r?i.shape[i.rank-1]:i.shape[i.rank-2],c=t?a.shape[a.rank-1]:a.shape[a.rank-2],l=r?i.shape[i.rank-2]:i.shape[i.rank-1],h=a.shape.slice(0,-2),f=i.shape.slice(0,-2),p=ie(h),d=ie(f);S(2<=a.rank&&2<=i.rank&&a.rank===i.rank,function(){return"Error in matMul: inputs must have the same rank of at least 2, got ranks "+a.rank+" and "+i.rank+"."}),S(Le(h,f),function(){return"Error in matMul: outer dimensions ("+h+") and ("+f+") of Tensors with shapes "+a.shape+" and "+i.shape+" must match."}),S(s===u,function(){return"Error in matMul: inner shapes ("+s+") and ("+u+") of Tensors with shapes "+a.shape+" and "+i.shape+" and transposeA="+t+" and transposeB="+r+" must match."});var g=a.shape.slice(0,-2).concat([c,l]),v=t?a.as3D(p,s,c):a.as3D(p,c,s),m=r?i.as3D(d,l,u):i.as3D(d,u,l);return A.runKernelFunc(function(x,w){var b=x.batchMatMul(v,m,t,r);return w([v,m]),b},{a:v,b:m},function(x,w){var I=w[0],E=w[1];return t||r?!t&&r?{a:function(){return x.matMul(E,!1,!1)},b:function(){return x.matMul(I,!0,!1)}}:t&&!r?{a:function(){return E.matMul(x,!1,!0)},b:function(){return I.matMul(x,!1,!1)}}:{a:function(){return E.matMul(x,!0,!0)},b:function(){return x.matMul(I,!0,!0)}}:{a:function(){return x.matMul(E,!1,!0)},b:function(){return I.matMul(x,!0,!1)}}},"BatchMatMul",{transposeA:t,transposeB:r}).reshape(g)}}),Od=T({dot_:function(e,n){var t=_(e,"t1","dot"),r=_(n,"t2","dot");S(!(1!==t.rank&&2!==t.rank||1!==r.rank&&2!==r.rank),function(){return"Error in dot: inputs must all be rank 1 or 2, but got ranks "+t.rank+" and "+r.rank+"."});var o=1===t.rank?t.size:t.shape[1],a=1===r.rank?r.size:r.shape[0];return S(o===a,function(){return"Error in dot: inner dimensions of inputs must match, but got "+o+" and "+a+"."}),1===t.rank&&1===r.rank?t.as2D(1,-1).matMul(r.as2D(-1,1)).asScalar():1===t.rank&&2===r.rank?t.as2D(1,-1).matMul(r.as2D(r.shape[0],r.shape[1])).as1D():2===t.rank&&1===r.rank?t.matMul(r.as2D(-1,1)).as1D():t.matMul(r.as2D(r.shape[0],r.shape[1]))}}),Pd=T({outerProduct_:function(e,n){var t=_(e,"v1","outerProduct"),r=_(n,"v2","outerProduct");return S(1===t.rank&&1===r.rank,function(){return"Error in outerProduct: inputs must be rank 1, but got ranks "+t.rank+" and "+r.rank+"."}),t.as2D(-1,1).matMul(r.as2D(1,-1))}}),Gr=T({reverse_:function(e,n){var t=_(e,"x","reverse");if(0===t.rank)return t.clone();var r=We(n,t.shape);return A.runKernelFunc(function(o){return o.reverse(t,r)},{$x:t},function(o){return{$x:function(){return o.reverse(r)}}}).reshapeAs(t)}}),Bd=T({reverse1d_:function(e){var n=_(e,"x","reverse");return S(1===n.rank,function(){return"Error in reverse1D: x must be rank 1 but got rank "+n.rank+"."}),Gr(n,0)}}),Ld=T({reverse2d_:function(e,n){var t=_(e,"x","reverse");return S(2===t.rank,function(){return"Error in reverse2D: x must be rank 2 but got rank "+t.rank+"."}),Gr(t,n)}}),Wd=T({reverse3d_:function(e,n){var t=_(e,"x","reverse");return S(3===t.rank,function(){return"Error in reverse3D: x must be rank 3 but got rank "+t.rank+"."}),Gr(t,n)}}),zd=T({reverse4d_:function(e,n){var t=_(e,"x","reverse");return S(4===t.rank,function(){return"Error in reverse4D: x must be rank 4 but got rank "+t.rank+"."}),Gr(t,n)}});function Ud(e,n,t,r,o,a){var i=_(e,"x","maxPool"),s=i,u=!1;3===i.rank&&(u=!0,s=i.as4D(1,i.shape[0],i.shape[1],i.shape[2])),null==r&&(r=[1,1]),S(4===s.rank,function(){return"Error in maxPool: input must be rank 4 but got rank "+s.rank+"."}),S(hn(t,r),function(){return"Error in maxPool: Either strides or dilations must be 1. Got strides "+t+" and dilations '"+r+"'"}),null!=a&&S(Me(o),function(){return"Error in maxPool: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+o+"."});var c=Br(s.shape,n,t,r,o,a);if(1===c.filterWidth&&1===c.filterHeight&&Le(c.inShape,c.outShape))return i.clone();var h=A.runKernelFunc(function(f,p){var d=f.maxPool(s,c);return p([s,d]),d},{x:s},function(f,p){var d=p[0],g=p[1];return{x:function(){return function(v,m,y,x,w,b,I){var E=_(f,"dy","maxPoolBackprop"),C=_(m,"input","maxPoolBackprop"),R=_(y,"output","maxPoolBackprop");S(C.rank===E.rank,function(){return"Rank of input ("+C.rank+") does not match rank of dy ("+E.rank+")"}),null==b&&(b=[1,1]),S(hn(w,b),function(){return"Error in maxPoolBackProp: Either strides or dilations must be 1. Got strides "+w+" and dilations '"+b+"'"}),S(4===E.rank,function(){return"Error in maxPoolBackprop: dy must be rank 4 but got rank "+E.rank+"."}),S(4===C.rank,function(){return"Error in maxPoolBackprop: input must be rank 4 but got rank "+C.rank+"."});var k=Br(C.shape,x,w,b,I,void 0);return A.runKernelFunc(function(D){return D.maxPoolBackprop(E,C,R,k)},{$dy:E,$input:C})}(0,d,g,n,t,r,o)}}},"MaxPool",c,[s]);return u?h.as3D(h.shape[1],h.shape[2],h.shape[3]):h}function Vd(e,n,t,r,o,a){var i=_(e,"x","avgPool","float32");null==r&&(r=[1,1]),S(hn(t,r),function(){return"Error in avgPool: Either strides or dilations must be 1. Got strides "+t+" and dilations '"+r+"'"});var s=i,u=!1;3===i.rank&&(u=!0,s=i.as4D(1,i.shape[0],i.shape[1],i.shape[2])),S(4===s.rank,function(){return"Error in avgPool: x must be rank 4 but got rank "+s.rank+"."}),null!=a&&S(Me(o),function(){return"Error in avgPool: pad must be an integer when using, dimRoundingMode "+a+" but got pad "+o+"."});var c=Br(s.shape,n,t,r,o,a);if(1===c.filterWidth&&1===c.filterHeight&&Le(c.inShape,c.outShape))return i.clone();var l=A.runKernelFunc(function(h){return h.avgPool(s,c)},{x:s},function(h){return{x:function(){return function(f,p,d,g,v,m){var y=_(h,"dy","avgPoolBackprop"),x=_(p,"input","avgPoolBackprop");S(x.rank===y.rank,function(){return"Rank of input ("+x.rank+") does not match rank of dy ("+y.rank+")"}),null==v&&(v=[1,1]),S(hn(g,v),function(){return"Error in avgPoolBackprop: Either strides or dilations must be 1. Got strides "+g+" and dilations '"+v+"'"});var w=x,b=y,I=!1;3===x.rank&&(I=!0,w=x.as4D(1,x.shape[0],x.shape[1],x.shape[2]),b=y.as4D(1,y.shape[0],y.shape[1],y.shape[2])),S(4===b.rank,function(){return"Error in avgPoolBackprop: dy must be rank 4 but got rank "+b.rank+"."}),S(4===w.rank,function(){return"Error in avgPoolBackprop: input must be rank 4 but got rank "+w.rank+"."});var E=Br(w.shape,d,g,v,m),C=A.runKernelFunc(function(R){return R.avgPoolBackprop(b,w,E)},{dy4D:b,input4D:w});return I?C.as3D(C.shape[1],C.shape[2],C.shape[3]):C}(0,s,n,t,r,o)}}},"AvgPool",c);return l=l.cast(i.dtype),u?l.as3D(l.shape[1],l.shape[2],l.shape[3]):l}var qe=T({maxPool_:function(e,n,t,r,o){return Ud(e,n,t,1,r,o)}}),Hr=T({avgPool_:function(e,n,t,r,o){return Vd(e,n,t,1,r,o)}}),Gd=T({pool_:function(e,n,t,r,o,a){null==o&&(o=[1,1]),null==a&&(a=1),0===r&&(r="valid");var i=_(e,"x","maxPool"),s=i,u=!1;3===i.rank&&(u=!0,s=i.as4D(1,i.shape[0],i.shape[1],i.shape[2])),S(hn(a,o),function(){return"Error in pool: Either strides or dilations must be 1. Got strides "+a+" and dilations '"+o+"'"});var c,h,f,p,d,g=Br(s.shape,n,a,o,r),v=[g.dilationHeight,g.dilationWidth];c="same"===r?(h=v,f=[g.filterHeight,g.filterWidth].map(function(F,z){return F+(F-1)*(h[z]-1)}).map(function(F){return F-1}),p=f.map(function(F){return Math.floor(F/2)}),d=f.map(function(F,z){return F-p[z]}),f.map(function(F,z){return[p[z],d[z]]})):[[0,0],[0,0]];var m,y,x,w,b,I,E,C,R=1===v[0]&&1===v[1],k=(m=[g.inHeight,g.inWidth],y=v,w=(x=c).map(function(F){return F[0]}),b=x.map(function(F){return F[1]}),I=m.concat(w,b),E=y.map(function(F,z){return(F-I[z]%F)%F}),C=b.map(function(F,z){return F+E[z]}),[y.map(function(F,z){return[w[z],C[z]]}),y.map(function(F,z){return[0,E[z]]})]),D=k[1],N=R?r:"valid",M=R?s:Fs(s,v,k[0]),W=("avg"===t?function(){return Vd(M,n,a,1,N)}:function(){return Ud(M,n,a,1,N)})(),P=R?W:As(W,v,D);return u?P.as3D(P.shape[1],P.shape[2],P.shape[3]):P}}),Hd=T({maxPool3d_:function(e,n,t,r,o,a,i){void 0===a&&(a="NDHWC");var s=_(e,"x","maxPool3d"),u=s,c=!1;4===s.rank&&(c=!0,u=s.as5D(1,s.shape[0],s.shape[1],s.shape[2],s.shape[3])),null==i&&(i=[1,1,1]),S(5===u.rank,function(){return"Error in maxPool3d: x must be rank 5 but got rank "+u.rank+"."}),S("NDHWC"===a,function(){return"Error in maxPool3d: Only NDHWC is currently supported, but got dataFormat of "+a}),S(hn(t,i),function(){return"Error in maxPool3d: Either strides or dilations must be 1. Got strides "+t+" and dilations '"+i+"'"}),null!=o&&S(Me(r),function(){return"Error in maxPool3d: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+r+"."});var l=To(u.shape,n,t,i,r,o,a),h=A.runKernelFunc(function(f,p){var d=f.maxPool3d(u,l);return p([u,d]),d},{x:u},function(f,p){var d=p[0],g=p[1];return{x:function(){return function(v,m,y,x,w,b,I,E){var C=_(f,"dy","maxPool3dBackprop"),R=_(m,"input","maxPool3dBackprop"),k=_(y,"output","maxPool3dBackprop"),D=C,N=R,M=k,W=!1;4===R.rank&&(W=!0,D=C.as5D(1,C.shape[0],C.shape[1],C.shape[2],C.shape[3]),N=R.as5D(1,R.shape[0],R.shape[1],R.shape[2],R.shape[3]),M=k.as5D(1,k.shape[0],k.shape[1],k.shape[2],k.shape[3])),S(5===D.rank,function(){return"Error in maxPool3dBackprop: dy must be rank 5 but got rank "+D.rank+"."}),S(5===N.rank,function(){return"Error in maxPool3dBackprop: input must be rank 5 but got rank "+N.rank+"."}),S(5===M.rank,function(){return"Error in maxPool3dBackprop: output must be rank 5 but got rank "+M.rank+"."}),null==b&&(b=[1,1,1]),S(hn(w,b),function(){return"Error in maxPool3dBackprop: Either strides or dilations must be 1. Got strides "+w+" and dilations '"+b+"'"}),null!=E&&S(Me(I),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+E+" but got pad "+I+"."});var P=To(N.shape,x,w,b,I,E),F=A.runKernelFunc(function(z){return z.maxPool3dBackprop(D,N,M,P)},{dy5D:D,input5D:N});return W?F.as4D(F.shape[1],F.shape[2],F.shape[3],F.shape[4]):F}(0,d,g,n,t,i,r,o)}}});return c?h.as4D(h.shape[1],h.shape[2],h.shape[3],h.shape[4]):h}}),qd=T({avgPool3d_:function(e,n,t,r,o,a,i){void 0===a&&(a="NDHWC");var s=_(e,"x","avgPool3d","float32"),u=s,c=!1;4===s.rank&&(c=!0,u=s.as5D(1,s.shape[0],s.shape[1],s.shape[2],s.shape[3])),null==i&&(i=[1,1,1]),S(5===u.rank,function(){return"Error in avgPool3d: x must be rank 5 but got rank "+u.rank+"."}),S("NDHWC"===a,function(){return"Error in avgPool3d: Only NDHWC is currently supported, but got dataFormat of "+a}),S(hn(t,i),function(){return"Error in avgPool3d: Either strides or dilations must be 1. Got strides "+t+" and dilations '"+i+"'"}),null!=o&&S(Me(r),function(){return"Error in avgPool3d: pad must be an integer when using, dimRoundingMode "+o+" but got pad "+r+"."});var l=To(u.shape,n,t,i,r,o,a),h=A.runKernelFunc(function(f){return f.avgPool3d(u,l)},{x:u},function(f){return{x:function(){return function(p,d,g,v,m,y,x){var w=_(f,"dy","avgPool3dBackprop"),b=_(d,"input","avgPool3dBackprop"),I=w,E=b,C=!1;4===b.rank&&(C=!0,I=w.as5D(1,w.shape[0],w.shape[1],w.shape[2],w.shape[3]),E=b.as5D(1,b.shape[0],b.shape[1],b.shape[2],b.shape[3])),S(5===I.rank,function(){return"Error in avgPool3dBackprop: dy must be rank 5 but got rank "+I.rank+"."}),S(5===E.rank,function(){return"Error in avgPool3dBackprop: input must be rank 5 but got rank "+E.rank+"."}),null==m&&(m=[1,1,1]),S(hn(v,m),function(){return"Error in avgPool3dBackprop: Either strides or dilations must be 1. Got strides "+v+" and dilations '"+m+"'"}),null!=x&&S(Me(y),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+x+" but got pad "+y+"."});var R=To(E.shape,g,v,m,y,x),k=A.runKernelFunc(function(D){return D.avgPool3dBackprop(I,E,R)},{dy5D:I,input5D:E});return C?k.as4D(k.shape[1],k.shape[2],k.shape[3],k.shape[4]):k}(0,u,n,t,i,r,o)}}});return h=h.cast(u.dtype),c?h.as4D(h.shape[1],h.shape[2],h.shape[3],h.shape[4]):h}}),Wn=T({slice_:function(e,n,t){var r,o,a=_(e,"x","slice");if(0===a.rank)throw new Error("Slicing scalar is not possible");(r="number"==typeof n?[n].concat(new Array(a.rank-1).fill(0)):n.length<a.rank?n.concat(new Array(a.rank-n.length).fill(0)):n.slice()).forEach(function(u){S(-1!==u,function(){return"slice() does not support negative begin indexing."})}),o=(o=null==t?new Array(a.rank).fill(-1):"number"==typeof t?[t].concat(new Array(a.rank-1).fill(-1)):t.length<a.rank?t.concat(new Array(a.rank-t.length).fill(-1)):t).map(function(u,c){return 0<=u?u:(S(-1===u,function(){return"Negative size values should be exactly -1 but got "+u+" for the slice() size at index "+c+"."}),a.shape[c]-r[c])}),tf(a,r,o);var i=a.shape;return A.runKernelFunc(function(u){return u.slice(a,r,o)},{x:a},function(u){for(var c=[],l=0;l<u.rank;l++)c.push([r[l],i[l]-r[l]-o[l]]);return{x:function(){return u.pad(c)}}},"Slice",{begin:r,size:o})}}),jd=T({slice1d_:function(e,n,t){var r=_(e,"x","slice1d");return S(1===r.rank,function(){return"slice1d expects a rank-1 tensor, but got a rank-"+r.rank+" tensor"}),Wn(r,[n],[t])}}),Kd=T({slice2d_:function(e,n,t){var r=_(e,"x","slice2d");return S(2===r.rank,function(){return"slice2d expects a rank-2 tensor, but got a rank-"+r.rank+" tensor"}),Wn(r,n,t)}}),gu=T({slice3d_:function(e,n,t){var r=_(e,"x","slice3d");return S(3===r.rank,function(){return"slice3d expects a rank-3 tensor, but got a rank-"+r.rank+" tensor"}),Wn(r,n,t)}}),Xd=T({slice4d_:function(e,n,t){var r=_(e,"x","slice4d");return S(4===r.rank,function(){return"slice4d expects a rank-4 tensor, but got a rank-"+r.rank+" tensor"}),Wn(r,n,t)}});function Yd(e,n,t,r,o){return n.rank<t.rank&&(n=n.reshape(cn(n.shape,r))),e.rank<t.rank&&(e=e.reshape(cn(e.shape,r))),{x:function(){var a=e.mul(t.equal(n).cast(e.dtype));return null==o?a:a.transpose(o)}}}var $d=T({all_:function(e,n,t){void 0===n&&(n=null),void 0===t&&(t=!1);var r=_(e,"x","all","bool"),o=We(n,r.shape),a=o,i=On(a,r.rank);null!=i&&(r=r.transpose(i),a=Pn(a.length,r.rank));var s=A.runKernelFunc(function(c){return c.all(r,a)},{$x:r});if(t){var u=cn(s.shape,o);return s.reshape(u)}return s}}),Jd=T({any_:function(e,n,t){void 0===n&&(n=null),void 0===t&&(t=!1);var r=_(e,"x","any","bool"),o=We(n,r.shape),a=o,i=On(a,r.rank);null!=i&&(r=r.transpose(i),a=Pn(a.length,r.rank));var s=A.runKernelFunc(function(c){return c.any(r,a)},{$x:r});if(t){var u=cn(s.shape,o);return s.reshape(u)}return s}}),Qd=T({argMax_:function(e,n){void 0===n&&(n=0);var t=_(e,"x","argMax");null==n&&(n=0);var r=We(n,t.shape),o=On(r,t.rank);return null!=o&&(t=t.transpose(o),r=Pn(r.length,t.rank)),A.runKernelFunc(function(s,u){var c=s.argMax(t,r[0]);return u([t]),c},{x:t},function(s,u){var c=u[0];return{x:function(){return xe(c)}}},"ArgMax",{axis:r[0]},[t])}}),Zd=T({argMin_:function(e,n){void 0===n&&(n=0);var t=_(e,"x","argMin");null==n&&(n=0);var r=We(n,t.shape),o=On(r,t.rank);return null!=o&&(t=t.transpose(o),r=Pn(r.length,t.rank)),A.runKernelFunc(function(a,i){var s=a.argMin(t,r[0]);return i([t]),s},{$x:t},function(a,i){var s=i[0];return{$x:function(){return xe(s)}}})}}),ev=T({logSumExp_:function(e,n,t){void 0===n&&(n=null),void 0===t&&(t=!1);var r=_(e,"x","logSumExp"),o=We(n,r.shape),a=r.max(o,!0),i=r.sub(a).exp().sum(o).log(),s=a.reshape(i.shape).add(i);if(t){var u=cn(s.shape,o);return s.reshape(u)}return s}}),Go=T({max_:function(e,n,t){void 0===n&&(n=null),void 0===t&&(t=!1);var r=_(e,"x","max"),o=r,a=We(n,r.shape),i=a,s=On(i,r.rank);null!=s&&(r=r.transpose(s),i=Pn(i.length,r.rank));var c=A.runKernelFunc(function(h,f){var p=h.max(r,i);return f([o,p]),p},{x:r},function(h,f){return Yd(h,f[1],f[0],a,s)},"Max",{axes:i},[r],[!0]);if(t){var l=cn(c.shape,a);c=c.reshape(l)}return c}}),nv=T({mean_:function(e,n,t){void 0===n&&(n=null),void 0===t&&(t=!1);var r=_(e,"x","mean"),o=We(n,r.shape),a=ie(en(r.shape,o)[1]);return Ao(function(i){var s=$(a);return{value:(s.dtype===i.dtype?i:i.cast(s.dtype)).div(s).sum(n,t),gradFunc:function(u){var c=i.shape.slice();return o.forEach(function(l){c[l]=1}),u.reshape(c).mul(lr(i.shape,"float32")).div(a)}}})(r)}}),tv=T({min_:function(e,n,t){void 0===n&&(n=null),void 0===t&&(t=!1);var r=_(e,"x","min"),o=r,a=We(n,r.shape),i=a,s=On(i,r.rank);null!=s&&(r=r.transpose(s),i=Pn(i.length,r.rank));var c=A.runKernelFunc(function(h,f){var p=h.min(r,i);return f([o,p]),p},{x:r},function(h,f){return Yd(h,f[1],f[0],a,s)},"Min",{axes:i},[r],[!0]);if(t){var l=cn(c.shape,a);c=c.reshape(l)}return c}}),rv=T({moments_:function(e,n,t){void 0===n&&(n=null),void 0===t&&(t=!1);var r=We(n,(e=_(e,"x","moments")).shape),o=e.mean(r,t),a=o.shape;t||(a=cn(o.shape,r));var i=e.toFloat().sub(o.reshape(a)).square();return{mean:o,variance:i.mean(r,t)}}}),yu=T({sum_:function(e,n,t){void 0===n&&(n=null),void 0===t&&(t=!1);var r=_(e,"x","sum");"bool"===r.dtype&&(r=r.toInt());var o=We(n,r.shape);return Ao(function(a){var i=On(o,a.rank),s=o,u=a;function c(p){var d=a.shape.slice();return o.forEach(function(g){d[g]=1}),p.reshape(d).mul(lr(a.shape,"float32"))}null!=i&&(u=a.transpose(i),s=Pn(s.length,a.rank));var h=A.runKernelFunc(function(p){return p.sum(u,s)},{x:u},function(p){return{x:function(){return c(p)}}},"Sum",{axes:s});if(t){var f=cn(h.shape,o);h=h.reshape(f)}return{value:h,gradFunc:c}})(r)}}),ov=T({prod_:function(e,n,t){void 0===n&&(n=null),void 0===t&&(t=!1);var r=_(e,"x","prod");"bool"===r.dtype&&(r=r.toInt());var o=We(n,r.shape),a=On(o,r.rank),i=o,s=r;null!=a&&(s=r.transpose(a),i=Pn(i.length,r.rank));var u=A.runKernelFunc(function(l){return l.prod(s,i)},{permutedX:s});if(t){var c=cn(u.shape,o);u=u.reshape(c)}return u}}),xu=T({elu_:function(e){var n=_(e,"x","elu");return A.runKernelFunc(function(t,r){var o=t.elu(n);return r([o]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){return A.runKernelFunc(function(a){return a.eluDer(t,o)},{dy:t,y:o})}}})}}),av=T({leakyRelu_:function(e,n){void 0===n&&(n=.2);var t=_(e,"x","leakyRelu");return $a($(n).mul(t),t)}}),bu=T({prelu_:function(e,n){var t=_(e,"x","prelu"),r=_(n,"alpha","prelu");return A.runKernelFunc(function(o,a){var i=o.prelu(t,r);return a([t,r]),i},{x:t,alpha:r},function(o,a){var i=a[0],s=a[1],u=i.greater(0);return{x:function(){return Bt(u,o,o.mul(s))},alpha:function(){var c=Bt(u,xe(o),o.mul(i)),l=Ve(s.shape,o.shape);return 0<l.length&&(c=c.sum(l)),c.reshape(s.shape)}}},"Prelu")}}),Fe=T({relu_:function(e){var n=_(e,"x","relu");return"bool"===n.dtype?n.toInt():A.runKernelFunc(function(t,r){var o=t.relu(n);return r([n]),o},{x:n},function(t,r){var o=r[0];return{x:function(){return t.mulStrict(o.step().toFloat())}}},"Relu")}}),wu=T({relu6_:function(e){var n=_(e,"x","relu6");return"bool"===n.dtype?n.toInt():A.runKernelFunc(function(t,r){var o=t.relu6(n);return r([n]),o},{x:n},function(t,r){var o=r[0],a=o.lessEqual(6).mul(o.step());return{x:function(){return t.mulStrict(a.toFloat())}}},"Relu6")}}),iv=T({selu_:function(e){var n=_(e,"x","selu");return A.runKernelFunc(function(t,r){var o=t.selu(n);return r([n]),o},{$x:n},function(t,r){var o=r[0];return{$x:function(){var a=o.greater($(0)),i=$(1.7580993408473768),s=$(1.0507009873554805),u=t.mul(s),c=t.mul(i).mul(o.toFloat().exp());return Bt(a,u,c)}}})}}),pt=T({transpose_:function(e,n){var t=_(e,"x","transpose");return null==n&&(n=t.shape.map(function(o,a){return a}).reverse()),S(t.rank===n.length,function(){return"Error in transpose: rank of input "+t.rank+" must match length of perm "+n+"."}),n.forEach(function(o){S(0<=o&&o<t.rank,function(){return"All entries in 'perm' must be between 0 and "+(t.rank-1)+" but got "+n})}),t.rank<=1?t.clone():A.runKernelFunc(function(o){return o.transpose(t,n)},{x:t},function(o){var a=Sa(n);return{x:function(){return o.transpose(a)}}},"Transpose",{perm:n})}}),sv=T({localResponseNormalization_:function(e,n,t,r,o){void 0===n&&(n=5),void 0===t&&(t=1),void 0===r&&(r=1),void 0===o&&(o=.5);var a=_(e,"x","localResponseNormalization");S(4===a.rank||3===a.rank,function(){return"Error in localResponseNormalization: x must be rank 3 or 4 but got\n               rank "+a.rank+"."}),S(Me(n),function(){return"Error in localResponseNormalization: depthRadius must be an integer but got depthRadius "+n+"."});var i=a,s=!1;3===a.rank&&(s=!0,i=a.as4D(1,a.shape[0],a.shape[1],a.shape[2]));var u=A.runKernelFunc(function(c,l){var h=c.localResponseNormalization4D(i,n,t,r,o);return l([i,h]),h},{x4D:i},function(c,l){var h=l[0],f=l[1];return{x4D:function(){return A.runKernelFunc(function(p){return p.LRNGrad(c,h,f,n,t,r,o)},{})}}});return s?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u}}),Cu=T({norm_:function(e,n,t,r){void 0===n&&(n="euclidean"),void 0===t&&(t=null),void 0===r&&(r=!1);var o=function s(u,c,l){if(void 0===l&&(l=null),0===u.rank)return u.abs();if(1!==u.rank&&null===l)return s(u.reshape([-1]),c,l);if(1===u.rank||"number"==typeof l||Array.isArray(l)&&1===l.length){if(1===c)return u.abs().sum(l);if(c===1/0)return u.abs().max(l);if(c===-1/0)return u.abs().min(l);if("euclidean"===c||2===c)return u.abs().pow($(2,"int32")).sum(l).sqrt();throw new Error("Error in norm: invalid ord value: "+c)}if(Array.isArray(l)&&2===l.length){if(1===c)return u.abs().sum(l[0]).max(l[1]-1);if(c===1/0)return u.abs().sum(l[1]).max(l[0]);if(c===-1/0)return u.abs().sum(l[1]).min(l[0]);if("fro"===c||"euclidean"===c)return u.square().sum(l).sqrt();throw new Error("Error in norm: invalid ord value: "+c)}throw new Error("Error in norm: invalid axis: "+l)}(e=_(e,"x","norm"),n,t),a=o.shape;if(r){var i=We(t,e.shape);a=cn(o.shape,i)}return o.reshape(a)}}),uv=T({basicLSTMCell_:function(e,n,t,r,o,a){var i=_(e,"forgetBias","basicLSTMCell"),s=_(n,"lstmKernel","basicLSTMCell"),u=_(t,"lstmBias","basicLSTMCell"),c=_(r,"data","basicLSTMCell"),l=_(o,"c","basicLSTMCell"),h=_(a,"h","basicLSTMCell"),f=c.concat(h,1).matMul(s).add(u),d=f.shape[1]/4,g=[f.shape[0],d],v=f.slice([0,0],g),m=f.slice([0,d],g),y=f.slice([0,2*d],g),x=f.slice([0,3*d],g),w=v.sigmoid().mulStrict(m.tanh()).addStrict(l.mulStrict(i.add(y).sigmoid())),b=w.tanh().mulStrict(x.sigmoid());return[w,b]}}),cv=T({multiRNNCell_:function(e,n,t,r){for(var o=_(n,"data","multiRNNCell"),a=ko(t,"c","multiRNNCell"),i=ko(r,"h","multiRNNCell"),s=o,u=[],c=0;c<e.length;c++){var l=e[c](s,a[c],i[c]);u.push(l[0]),u.push(l[1]),s=l[1]}var h=[],f=[];for(c=0;c<u.length;c+=2)h.push(u[c]),f.push(u[c+1]);return[h,f]}}),lv=T({movingAverage_:function(e,n,t,r,o){void 0===o&&(o=!0);var a=_(e,"v","movingAverage"),i=_(n,"x","movingAverage"),s=_(t,"decay","movingAverage");Yl(a,i),S(Le(a.shape,i.shape),function(){return"Shape mismatch in v and x"});var u=$(1),c=u.sub(s),l=i.sub(a).mul(c);if(o){S(null!=r,function(){return"When using zeroDebias: true, step is required."});var h=_(r,"step","movingAverage");l=l.div(u.sub(zo(s,h)))}return a.add(l)}}),hv=T({stridedSlice_:function(e,n,t,r,o,a,i,s,u){if(void 0===o&&(o=0),void 0===a&&(a=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===u&&(u=0),null==r&&(r=new Array(n.length)),0!==i)throw new Error("ellipsis mask is not yet supported");var c=_(e,"x","stridedSlice"),l=Ps(s),h=c.shape.slice();l.forEach(function(v){n[v]=0,t[v]=1,h.splice(v,0,1)}),c=c.reshape(h);for(var f=0;f<c.rank;f++)n[f]=rf(o,n,r,c.shape,f),t[f]=of(a,t,r,c.shape,f),r[f]=r[f]||1;var p=Ps(u);p.forEach(function(v){t[v]=n[v]+1,r[v]=1});var d=La(n,t,r),g=d.filter(function(v,m){return-1===p.indexOf(m)});return r.every(function(v){return 1===v})?Wn(c,n,d).reshape(g):A.runKernelFunc(function(v){return v.stridedSlice(c,n,t,r)},{$x:c}).reshape(g)}}),fv=T({topk_:function(e,n,t){void 0===n&&(n=1),void 0===t&&(t=!0);var r=_(e,"x","topk");if(0===r.rank)throw new Error("topk() expects the input to be of rank 1 or higher");var o=r.shape[r.shape.length-1];if(o<n)throw new Error("'k' passed to topk() must be <= the last dimension ("+o+") but got "+n);var a=A.runKernelFunc(function(i){return i.topk(r,n,t)},{$x:r});return{values:a[0],indices:a[1]}}}),pv=T({scatterND_:function(e,n,t){var r=_(e,"indices","scatterND","int32"),o=_(n,"updates","scatterND");return nf(o,r,t),A.runKernelFunc(function(a){return a.scatterND(r,o,t)},{indices:r,updates:o},null,"ScatterNd",{shape:t})}}),Za=T({fft_:function(e){S("complex64"===e.dtype,function(){return"The dtype for tf.spectral.fft() must be complex64 but got "+e.dtype+"."});var n=e.shape[e.shape.length-1],r=e.as2D(e.size/n,n);return A.runKernelFunc(function(o){return o.fft(r)},{input:e}).reshape(e.shape)}}),Ho=T({ifft_:function(e){S("complex64"===e.dtype,function(){return"The dtype for tf.spectral.ifft() must be complex64 but got "+e.dtype+"."});var n=e.shape[e.shape.length-1],r=e.as2D(e.size/n,n);return A.runKernelFunc(function(o){return o.ifft(r)},{input:e}).reshape(e.shape)}}),ei=T({rfft_:function(e,n){S("float32"===e.dtype,function(){return"The dtype for rfft() must be real value but got "+e.dtype});var t,r=e.shape[e.shape.length-1],o=e.size/r;if(null!=n&&n<r){var a=e.shape.map(function(m){return 0}),i=e.shape.map(function(m){return m});i[e.shape.length-1]=n,t=e.slice(a,i),r=n}else if(null!=n&&r<n){var s=e.shape.map(function(m){return m});s[e.shape.length-1]=n-r,t=e.concat(Se(s),e.shape.length-1),r=n}else t=e;var u=t.zerosLike(),c=$e(t,u).as2D(o,r),l=Za(c),h=Math.floor(r/2)+1,f=Cn(l),p=Bn(l),d=f.split([h,r-h],f.shape.length-1),g=p.split([h,r-h],p.shape.length-1),v=t.shape.slice();return v[t.shape.length-1]=h,$e(d[0],g[0]).reshape(v)}}),Eu=T({irfft_:function(e){var n=e.shape[e.shape.length-1],t=e.size/n;if(n<=2){var r=e.as2D(t,n),o=Ho(r);return Cn(o)}var a=[t,2*(n-1)],i=Cn(e).as2D(t,n),s=Bn(e).as2D(t,n),u=i.slice([0,1],[t,n-2]).reverse(1),c=s.slice([0,1],[t,n-2]).reverse(1).mul($(-1)),l=i.concat(u,1),h=s.concat(c,1);return r=$e(l,h).as2D(a[0],a[1]),o=Ho(r),Cn(o)}}),dv=Object.freeze({fft:Za,ifft:Ho,rfft:ei,irfft:Eu}),vv=T({sparseToDense_:function(e,n,t,r){void 0===r&&(r=0);var o=_(e,"sparseIndices","sparseToDense","int32"),a=_(n,"sparseValues","sparseToDense"),i=_(r,"defaultValue","sparseToDense",a.dtype);return function(s,u,c,l){if("int32"!==s.dtype)throw new Error("tf.sparseToDense() expects the indices to be int32 type, but the dtype was "+s.dtype+".");if(2<s.rank)throw new Error("sparseIndices should be a scalar, vector, or matrix, but got shape "+s.shape+".");var h=0<s.rank?s.shape[0]:1,f=1<s.rank?s.shape[1]:1;if(c.length!==f)throw new Error("outputShape has incorrect number of elements:, "+c.length+", should be: "+f+".");if(0!==u.rank&&(1!==u.rank||u.size!==h))throw new Error("sparseValues has incorrect shape "+u.shape+", should be [] or ["+h+"]");if(u.dtype!==l.dtype)throw new Error("sparseValues.dtype must match defaultValues.dtype")}(o,a,t,i),A.runKernelFunc(function(s){return s.sparseToDense(o,a,t,i)},{$sparseIndices:o,$sparseValues:a,$defaultValue:i})}}),mv=T({gatherND_:function(e,n){var t=_(n,"indices","gatherND","int32"),r=_(e,"x","gatherND");return A.runKernelFunc(function(o){return o.gatherND(r,t)},{x:r,indices:t},null,"GatherNd")}}),gv=T({diag_:function(e){var n=_(e,"x","diag").flatten(),t=e.shape.concat(e.shape);return A.runKernelFunc(function(r){return r.diag(n)},{$x:n}).reshape(t)}}),yv=T({dropout_:function(e,n,t,r){var o=_(e,"x","dropout");if(S("float32"===o.dtype,function(){return"x has to be a floating point tensor since it's going to be scaled, but got a "+o.dtype+" tensor instead."}),S(0<=n&&n<1,function(){return"rate must be a float in the range [0, 1), but got "+n+"."}),0===n)return e instanceof Re?o.clone():o;var a=function(u,c){if(null==c)return u.shape.slice();if(Le(u.shape,c)||u.shape.length!==c.length)return c;for(var l=[],h=0;h<u.shape.length;h++)l.push(null==c[h]&&null!=u.shape[h]?u.shape[h]:c[h]);return l}(o,t),i=1-n,s=Ns(a,0,1,"float32",r).add(i).floor().div(i);return o.mul(s)}});function xv(e,n,t){for(var r=1-e%2,o=new Float32Array(e),a=0;a<e;++a){var i=2*Math.PI*a/(e+r-1);o[a]=n-t*Math.cos(i)}return Pe(o,"float32")}function bv(e,n,t){return void 0===t&&(t=1),oe(this,void 0,void 0,function(){var r,o,a,i,s,u,c,l,h,f,p,d,g,v;return ae(this,function(m){switch(m.label){case 0:return r=_(e,"predictions","inTopK"),o=_(n,"targets","inTopK"),S(1<r.rank,function(){return"inTopK() expects the predictions to be of rank 2 or higher, but got "+r.rank}),S(r.rank-1===o.rank,function(){return"predictions rank should be 1 larger than targets rank, but got predictions rank "+r.rank+" and targets rank "+o.rank}),we(r.shape.slice(0,r.shape.length-1),o.shape,"predictions's shape should be align with the targets' shape, except the last dimension."),a=r.shape[r.shape.length-1],S(0<t&&t<=a,function(){return"'k' passed to inTopK() must be > 0 && <= the predictions last dimension ("+a+"), but got "+t}),[4,r.data()];case 1:return i=m.sent(),[4,o.data()];case 2:for(s=m.sent(),l=(u=[i.length/a,a])[1],h=Nr("bool",c=u[0]),f=0;f<c;f++){for(d=i.subarray(p=f*l,p+l),g=[],v=0;v<d.length;v++)g.push({value:d[v],index:v});for(g.sort(function(y,x){return x.value-y.value}),h[f]=0,v=0;v<t;v++)if(g[v].index===s[f]){h[f]=1;break}}return e!==r&&r.dispose(),n!==o&&o.dispose(),[2,Je(h,o.shape,"bool")]}})})}var tn,Lt,ni=T({hannWindow_:function(e){return xv(e,.5,.5)}}),_u=T({hammingWindow_:function(e){return xv(e,.54,.46)}}),ti=T({frame_:function(e,n,t,r,o){void 0===r&&(r=!1),void 0===o&&(o=0);for(var a=0,i=[];a+n<=e.size;)i.push(Wn(e,a,n)),a+=t;if(r)for(;a<e.size;){var s=a+n-e.size,u=ze([Wn(e,a,n-s),Ln([s],o)]);i.push(u),a+=t}return 0===i.length?lt([],[0,n]):ze(i).as2D(i.length,n)}}),Iu=T({stft_:function(e,n,t,r,o){void 0===o&&(o=ni),null==r&&(r=Math.floor(Math.pow(2,Math.ceil(Math.log(n)/Math.log(2)))));for(var i=ti(e,n,t),s=nn(i,o(n)),u=[],c=0;c<i.shape[0];c++)u.push(ei(s.slice([c,0],[1,n]),r));return ze(u)}}),wv=Object.freeze({hannWindow:ni,hammingWindow:_u,frame:ti,stft:Iu});(Lt=tn=tn||{})[Lt.NONE=0]="NONE",Lt[Lt.MEAN=1]="MEAN",Lt[Lt.SUM=2]="SUM",Lt[Lt.SUM_BY_NONZERO_WEIGHTS=3]="SUM_BY_NONZERO_WEIGHTS";var yy=T({absoluteDifference_:function(e,n,t,r){void 0===r&&(r=tn.SUM_BY_NONZERO_WEIGHTS);var o=_(e,"labels","absoluteDifference"),a=_(n,"predictions","absoluteDifference"),i=null;null!=t&&(i=_(t,"weights","absoluteDifference")),we(o.shape,a.shape,"Error in absoluteDifference: ");var s=o.sub(a).abs();return dt(s,i,r)}}),dt=T({computeWeightedLoss_:function(e,n,t){void 0===t&&(t=tn.SUM_BY_NONZERO_WEIGHTS);var r=_(e,"losses","computeWeightedLoss"),o=null;null!=n&&(o=_(n,"weights","computeWeightedLoss"));var a=null==o?r:r.mul(o);if(t===tn.NONE)return a;if(t===tn.SUM)return a.sum();if(t===tn.MEAN){if(null==o)return a.mean();var i=r.size/o.size,s=a.sum().div(o.sum());return 1<i?s.div($(i)):s}if(t!==tn.SUM_BY_NONZERO_WEIGHTS)throw Error("Unknown reduction: "+t);if(null==o)return a.sum().div($(r.size));var u=o.mul(lr(r.shape)).notEqual($(0)).sum().toFloat();return a.sum().div(u)}}),xy=T({cosineDistance_:function(e,n,t,r,o){void 0===o&&(o=tn.SUM_BY_NONZERO_WEIGHTS);var a=_(e,"labels","cosineDistance"),i=_(n,"predictions","cosineDistance"),s=null;null!=r&&(s=_(r,"weights","cosineDistance")),we(a.shape,i.shape,"Error in cosineDistance: ");var u=$(1).sub(a.mul(i).sum(t,!0));return dt(u,s,o)}}),by=T({hingeLoss_:function(e,n,t,r){void 0===r&&(r=tn.SUM_BY_NONZERO_WEIGHTS);var o=_(e,"labels","hingeLoss"),a=_(n,"predictions","hingeLoss"),i=null;null!=t&&(i=_(t,"weights","hingeLoss")),we(o.shape,a.shape,"Error in hingeLoss: ");var s=$(1);o=$(2).mul(o).sub(s);var u=s.sub(o.mul(a)).relu();return dt(u,i,r)}}),wy=T({huberLoss_:function(e,n,t,r,o){void 0===r&&(r=1),void 0===o&&(o=tn.SUM_BY_NONZERO_WEIGHTS);var a=_(e,"labels","huberLoss"),i=_(n,"predictions","huberLoss"),s=null;null!=t&&(s=_(t,"weights","huberLoss")),we(a.shape,i.shape,"Error in huberLoss: ");var u=$(r),c=i.sub(a).abs(),l=hu(c,u),h=c.sub(l),f=$(.5).mul(l.square()).add(u.mul(h));return dt(f,s,o)}}),Cy=T({logLoss_:function(e,n,t,r,o){void 0===r&&(r=1e-7),void 0===o&&(o=tn.SUM_BY_NONZERO_WEIGHTS);var a=_(e,"labels","logLoss"),i=_(n,"predictions","logLoss"),s=null;null!=t&&(s=_(t,"weights","logLoss")),we(a.shape,i.shape,"Error in logLoss: ");var u=$(1),c=$(r),l=a.mul(i.add(c).log()).neg().sub(u.sub(a).mul(u.sub(i).add(c).log()));return dt(l,s,o)}}),Ey=T({meanSquaredError_:function(e,n,t,r){void 0===r&&(r=tn.SUM_BY_NONZERO_WEIGHTS);var o=_(e,"labels","meanSquaredError"),a=_(n,"predictions","meanSquaredError"),i=null;null!=t&&(i=_(t,"weights","meanSquaredError")),we(o.shape,a.shape,"Error in meanSquaredError: ");var s=o.squaredDifference(a);return dt(s,i,r)}}),_y=T({sigmoidCrossEntropy_:function(e,n,t,r,o){void 0===r&&(r=0),void 0===o&&(o=tn.SUM_BY_NONZERO_WEIGHTS);var a=_(e,"multiClassLabels","sigmoidCrossEntropy"),i=_(n,"logits","sigmoidCrossEntropy"),s=null;if(null!=t&&(s=_(t,"weights","sigmoidCrossEntropy")),we(a.shape,i.shape,"Error in sigmoidCrossEntropy: "),0<r){var u=$(r),c=$(1),l=$(.5);a=a.mul(c.sub(u)).add(l.mul(u))}var h=function(f,p){var d=_(a,"labels","sigmoidCrossEntropyWithLogits"),g=_(p,"logits","sigmoidCrossEntropyWithLogits");we(d.shape,g.shape,"Error in sigmoidCrossEntropyWithLogits: ");var v=g.relu(),m=g.mul(d),y=g.abs().neg().exp().log1p();return v.sub(m).add(y)}(0,i);return dt(h,s,o)}}),Iy=T({softmaxCrossEntropy_:function(e,n,t,r,o){void 0===r&&(r=0),void 0===o&&(o=tn.SUM_BY_NONZERO_WEIGHTS);var a=_(e,"onehotLabels","softmaxCrossEntropy"),i=_(n,"logits","softmaxCrossEntropy"),s=null;if(null!=t&&(s=_(t,"weights","softmaxCrossEntropy")),we(a.shape,i.shape,"Error in softmaxCrossEntropy: "),0<r){var u=$(r),c=$(1),l=$(a.shape[1]);a=a.mul(c.sub(u)).add(u.div(l))}var h=function(f,p,d){if(void 0===d&&(d=-1),-1===d&&(d=p.rank-1),d!==p.rank-1)throw Error("Softmax cross entropy along a non-last dimension is not yet supported. Labels / logits was rank "+p.rank+" and dim was "+d);return Ao(function(g,v,m){var y=v.logSumExp([d],!0),x=v.toFloat().sub(y);return m([g,x]),{value:x.mul(g).neg().sum([d]),gradFunc:function(w,b){var I=b[0],E=b[1],C=cn(w.shape,[d]);return[w.reshape(C).mul(I.toFloat().sub(E.exp())),w.reshape(C).mul(E.exp().sub(I.toFloat()))]}}})(f,p)}(a,i);return dt(h,s,o)}}),Cv=Object.freeze({get Reduction(){return tn},absoluteDifference:yy,computeWeightedLoss:dt,cosineDistance:xy,hingeLoss:by,huberLoss:wy,logLoss:Cy,meanSquaredError:Ey,sigmoidCrossEntropy:_y,softmaxCrossEntropy:Iy});function Ev(e,n){return void 0===n&&(n=!1),A.tidy(function(){if(2!==e.shape.length)throw new Error("qr2d() requires a 2D Tensor, but got a "+e.shape.length+"D Tensor.");for(var t=e.shape[0],r=e.shape[1],o=Ts(t),a=e.clone(),i=lt([[1]],[1,1]),s=i.clone(),u=r<=t?r:t,c=function(h){var f,p=a,d=s,g=o;s=(f=A.tidy(function(){var v=a.slice([h,h],[t-h,1]),m=v.norm(),y=a.slice([h,h],[1,1]),x=lt([[-1]]).where(y.greater(0),lt([[1]])),w=y.sub(x.mul(m)),b=v.div(w);s=1===b.shape[0]?i.clone():i.concat(b.slice([1,0],[b.shape[0]-1,b.shape[1]]),0);var I=x.matMul(w).div(m).neg(),E=a.slice([h,0],[t-h,r]),C=I.mul(s);if(0===h)a=E.sub(C.matMul(s.transpose().matMul(E)));else{var R=E.sub(C.matMul(s.transpose().matMul(E)));a=a.slice([0,0],[h,r]).concat(R,0)}var k=o.slice([0,h],[t,o.shape[1]-h]);if(0===h)o=k.sub(k.matMul(s).matMul(C.transpose()));else{var D=k.sub(k.matMul(s).matMul(C.transpose()));o=o.slice([0,0],[t,h]).concat(D,1)}return[s,a,o]}))[0],a=f[1],o=f[2],un([p,d,g])},l=0;l<u;++l)c(l);return!n&&r<t&&(o=o.slice([0,0],[t,r]),a=a.slice([0,0],[r,r])),[o,a]})}var Ry=T({bandPart_:function(e,n,t){if(n%1!=0)throw new Error("bandPart(): numLower must be an integer, got "+n+".");if(t%1!=0)throw new Error("bandPart(): numUpper must be an integer, got "+t+".");var r=_(e,"a","bandPart");if(r.rank<2)throw new Error("bandPart(): Rank must be at least 2, got "+r.rank+".");var o=r.shape,a=r.shape.slice(-2),i=a[0],s=a[1];if(!(n<=i))throw new Error("bandPart(): numLower ("+n+") must not be greater than the number of rows ("+i+").");if(!(t<=s))throw new Error("bandPart(): numUpper ("+t+") must not be greater than the number of columns ("+s+").");n<0&&(n=i),t<0&&(t=s);var u=So(0,i,1,"int32").reshape([-1,1]),c=So(0,s,1,"int32"),l=Ge(u,c),h=Wo(l.lessEqual($(+n,"int32")),l.greaterEqual($(-t,"int32"))),f=Se([i,s],r.dtype);return dn(Ue(r.reshape([-1,i,s])).map(function(p){return Bt(h,p,f)})).reshape(o)}}),ky=T({gramSchmidt_:function(e){var n;if(Array.isArray(e)){n=!1,S(null!=e&&0<e.length,function(){return"Gram-Schmidt process: input must not be null, undefined, or empty"});for(var t=e[0].shape[0],r=function(u){S(e[u].shape[0]===t,function(){return"Gram-Schmidt: Non-unique lengths found in the input vectors: ("+e[u].shape[0]+" vs. "+t+")"})},o=1;o<e.length;++o)r(o)}else n=!0,e=Aa(e,e.shape[0],0).map(function(u){return Ms(u,[0])});function a(u){i.push(A.tidy(function(){var c=s[u];if(0<u)for(var l=0;l<u;++l){var h=yu(i[l].mulStrict(c)).mul(i[l]);c=c.sub(h)}return c.div(Cu(c,"euclidean"))}))}S(e.length<=e[0].shape[0],function(){return"Gram-Schmidt: Number of vectors ("+e.length+") exceeds number of dimensions ("+e[0].shape[0]+")."});var i=[],s=e;for(o=0;o<e.length;++o)a(o);return n?dn(i,0):i}}),Sy=T({qr_:function(e,n){if(void 0===n&&(n=!1),e.rank<2)throw new Error("qr() requires input tensor to have a rank >= 2, but got rank "+e.rank);if(2===e.rank)return Ev(e,n);var t=e.shape.slice(0,e.shape.length-2).reduce(function(i,s){return i*s}),r=Ue(e.reshape([t,e.shape[e.shape.length-2],e.shape[e.shape.length-1]]),0),o=[],a=[];return r.forEach(function(i){var s=Ev(i,n),c=s[1];o.push(s[0]),a.push(c)}),[dn(o,0).reshape(e.shape),dn(a,0).reshape(e.shape)]}}),_v=Object.freeze({bandPart:Ry,gramSchmidt:ky,qr:Sy});function ri(e,n,t,r,o,a){null==r&&(r=.5),null==o&&(o=Number.NEGATIVE_INFINITY),null==a&&(a=0);var i=e.shape[0];return t=Math.min(t,i),S(0<=r&&r<=1,function(){return"iouThreshold must be in [0, 1], but was '"+r+"'"}),S(2===e.rank,function(){return"boxes must be a 2D tensor, but was of rank '"+e.rank+"'"}),S(4===e.shape[1],function(){return"boxes must have 4 columns, but 2nd dimension was "+e.shape[1]}),S(1===n.rank,function(){return"scores must be a 1D tensor"}),S(n.shape[0]===i,function(){return"scores has incompatible shape with boxes. Expected "+i+", but was "+n.shape[0]}),S(0<=a&&a<=1,function(){return"softNmsSigma must be in [0, 1], but was '"+a+"'"}),{maxOutputSize:t,iouThreshold:r,scoreThreshold:o,softNmsSigma:a}}function Ru(e,n){return!(0<e)||"linear"===n}function ku(e,n,t){if(null==t||"linear"===t)return e;if("relu"===t)return e.mul(n.step());throw new Error("Gradient for activation "+t+" has not been implemented yet.")}function Su(e,n){var t=n,r=Ve(e.shape,n.shape);return 0<r.length&&(t=t.sum(r)),t.reshape(e.shape)}function Du(e,n,t){if("linear"===n)return e;if("relu"===n)return Fe(e);if("elu"===n)return xu(e);if("relu6"===n)return wu(e);if("prelu"===n)return bu(e,t);throw new Error("Unknown fused activation "+n+".")}var Dy=T({resizeBilinear_:function(e,n,t){void 0===t&&(t=!1);var r=_(e,"images","resizeBilinear");S(3===r.rank||4===r.rank,function(){return"Error in resizeBilinear: x must be rank 3 or 4, but got rank "+r.rank+"."}),S(2===n.length,function(){return"Error in resizeBilinear: new shape must 2D, but got shape "+n+"."});var o=r,a=!1;3===r.rank&&(a=!0,o=r.as4D(1,r.shape[0],r.shape[1],r.shape[2]));var i=n[0],s=n[1],u=A.runKernelFunc(function(c,l){return l([o]),c.resizeBilinear(o,i,s,t)},{x:o},function(c,l){return{x:function(){return A.runKernelFunc(function(h){return h.resizeBilinearBackprop(c,l[0],t)},{})}}},"ResizeBilinear",{alignCorners:t,newHeight:i,newWidth:s});return a?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u}}),Ay=T({resizeNearestNeighbor_:function(e,n,t){void 0===t&&(t=!1);var r=_(e,"images","resizeNearestNeighbor");S(3===r.rank||4===r.rank,function(){return"Error in resizeNearestNeighbor: x must be rank 3 or 4, but got rank "+r.rank+"."}),S(2===n.length,function(){return"Error in resizeNearestNeighbor: new shape must 2D, but got shape "+n+"."}),S("float32"===r.dtype||"int32"===r.dtype,function(){return"`images` must have `int32` or `float32` as dtype"});var o=r,a=!1;3===r.rank&&(a=!0,o=r.as4D(1,r.shape[0],r.shape[1],r.shape[2]));var i=n[0],s=n[1],u=A.runKernelFunc(function(c,l){return l([o]),c.resizeNearestNeighbor(o,i,s,t)},{batchImages:o},function(c,l){return{batchImages:function(){return A.runKernelFunc(function(h){return h.resizeNearestNeighborBackprop(c,l[0],t)},{})}}});return a?u.as3D(u.shape[1],u.shape[2],u.shape[3]):u}}),Ty=T({nonMaxSuppression_:function(e,n,t,r,o){void 0===r&&(r=.5),void 0===o&&(o=Number.NEGATIVE_INFINITY);var a=_(e,"boxes","nonMaxSuppression"),i=_(n,"scores","nonMaxSuppression"),s=ri(a,i,t,r,o);return A.runKernelFunc(function(c){return c.nonMaxSuppression(a,i,t,r,o)},{boxes:a,scores:i},null,"NonMaxSuppressionV3",{maxOutputSize:t=s.maxOutputSize,iouThreshold:r=s.iouThreshold,scoreThreshold:o=s.scoreThreshold})}}),Ny=T({nonMaxSuppressionWithScore_:function(e,n,t,r,o,a){void 0===r&&(r=.5),void 0===o&&(o=Number.NEGATIVE_INFINITY),void 0===a&&(a=0);var i=_(e,"boxes","nonMaxSuppression"),s=_(n,"scores","nonMaxSuppression"),u=ri(i,s,t,r,o,a),c={maxOutputSize:t=u.maxOutputSize,iouThreshold:r=u.iouThreshold,scoreThreshold:o=u.scoreThreshold,softNmsSigma:a=u.softNmsSigma},l=A.runKernel("NonMaxSuppressionV5",{boxes:i,scores:s},c);return{selectedIndices:l[0],selectedScores:l[1]}}}),Fy=T({cropAndResize_:function(e,n,t,r,o,a){var i=_(e,"image","cropAndResize"),s=_(n,"boxes","cropAndResize","float32"),u=_(t,"boxInd","cropAndResize","int32");o=o||"bilinear",a=a||0;var c=s.shape[0];return S(4===i.rank,function(){return"Error in cropAndResize: image must be rank 4,but got rank "+i.rank+"."}),S(2===s.rank&&4===s.shape[1],function(){return"Error in cropAndResize: boxes must be have size ["+c+",4] but had shape "+s.shape+"."}),S(1===u.rank&&u.shape[0]===c,function(){return"Error in cropAndResize: boxInd must be have size ["+c+"] but had shape "+s.shape+"."}),S(2===r.length,function(){return"Error in cropAndResize: cropSize must be of length 2, but got length "+r.length+"."}),S(1<=r[0]&&1<=r[1],function(){return"cropSize must be atleast [1,1], but was "+r}),S("bilinear"===o||"nearest"===o,function(){return"method must be bilinear or nearest, but was "+o}),A.runKernelFunc(function(l,h){return l.cropAndResize(i,s,u,r,o,a)},{images:i,boxes:s,boxInd:u},null,"CropAndResize",{method:o,extrapolationValue:a,cropSize:r})}}),oi=Object.freeze({resizeBilinear:Dy,resizeNearestNeighbor:Ay,nonMaxSuppression:Ty,nonMaxSuppressionAsync:function(e,n,t,r,o){return void 0===r&&(r=.5),void 0===o&&(o=Number.NEGATIVE_INFINITY),oe(this,void 0,void 0,function(){var a,i,s,u,h;return ae(this,function(f){switch(f.label){case 0:return a=_(e,"boxes","nonMaxSuppressionAsync"),i=_(n,"scores","nonMaxSuppressionAsync"),s=ri(a,i,t,r,o),t=s.maxOutputSize,r=s.iouThreshold,o=s.scoreThreshold,[4,Promise.all([a.data(),i.data()])];case 1:return u=f.sent(),h=js(u[0],u[1],t,r,o),a!==e&&a.dispose(),i!==n&&i.dispose(),[2,h]}})})},nonMaxSuppressionWithScore:Ny,nonMaxSuppressionWithScoreAsync:function(e,n,t,r,o,a){return void 0===r&&(r=.5),void 0===o&&(o=Number.NEGATIVE_INFINITY),void 0===a&&(a=0),oe(this,void 0,void 0,function(){var i,s,u,c,f;return ae(this,function(p){switch(p.label){case 0:return i=_(e,"boxes","nonMaxSuppressionAsync"),s=_(n,"scores","nonMaxSuppressionAsync"),u=ri(i,s,t,r,o,a),t=u.maxOutputSize,r=u.iouThreshold,o=u.scoreThreshold,a=u.softNmsSigma,[4,Promise.all([i.data(),s.data()])];case 1:return c=p.sent(),f=Ks(c[0],c[1],t,r,o,a),i!==e&&i.dispose(),s!==n&&s.dispose(),[2,f]}})})},cropAndResize:Fy}),My=T({fusedMatMul_:function(e){var n,t=e.a,r=e.b,o=e.transposeA,a=void 0!==o&&o,i=e.transposeB,s=void 0!==i&&i,u=e.bias,c=e.activation,l=void 0===c?"linear":c,h=e.preluActivationWeights;if(!1===Ru(A.state.gradientDepth,l)){var f=Vo(t,r,a,s);return null!=u&&(f=de(f,u)),Du(f,l,h)}var p=_(t,"a","fused matMul"),d=_(r,"b","fused matMul");n=Ne(p,d),p=n[0],d=n[1];var g=a?p.shape[p.rank-2]:p.shape[p.rank-1],v=s?d.shape[d.rank-1]:d.shape[d.rank-2],m=a?p.shape[p.rank-1]:p.shape[p.rank-2],y=s?d.shape[d.rank-2]:d.shape[d.rank-1],x=p.shape.slice(0,-2),w=d.shape.slice(0,-2),b=ie(x),I=ie(w);S(2<=p.rank&&2<=d.rank&&p.rank===d.rank,function(){return"Error in fused matMul: inputs must have the same rank of at least 2, got ranks "+p.rank+" and "+d.rank+"."}),S(Le(x,w),function(){return"Error in fused matMul: outer dimensions ("+x+") and ("+w+") of Tensors with shapes "+p.shape+" and "+d.shape+" must match."}),S(g===v,function(){return"Error in fused matMul: inner shapes ("+g+") and ("+v+") of Tensors with shapes "+p.shape+" and "+d.shape+" and transposeA="+a+" and transposeB="+s+" must match."});var E,C,R=p.shape.slice(0,-2).concat([m,y]),k=a?p.as3D(b,g,m):p.as3D(b,m,g),D=s?d.as3D(I,y,v):d.as3D(I,v,y);null!=u&&ve(R,(E=Ne(E=_(u,"bias","fused matMul"),p)[0]).shape),null!=h&&(C=_(h,"prelu weights","fused matMul"));var N={a:k,b:D};return null!=u&&(N.bias=E),null!=h&&(N.preluActivationWeights=C),A.runKernelFunc(function(W,P){var F=W.fusedBatchMatMul({a:k,b:D,transposeA:a,transposeB:s,bias:E,activation:l,preluActivationWeights:C});return P([k,D,F]),F},N,function(W,P){var F=P[0],z=P[1],K=ku(W,P[2],l),Y={};return null!=u&&(Y={bias:function(){return Su(E,K)}}),Object.assign(a||s?!a&&s?{a:function(){return K.matMul(z,!1,!1)},b:function(){return K.matMul(F,!0,!1)}}:a&&!s?{a:function(){return z.matMul(K,!1,!0)},b:function(){return F.matMul(K,!1,!1)}}:{a:function(){return z.matMul(K,!0,!0)},b:function(){return K.matMul(F,!0,!0)}}:{a:function(){return K.matMul(z,!1,!0)},b:function(){return F.matMul(K,!0,!1)}},Y)},"_FusedMatMul",{transposeA:a,transposeB:s,activation:l},[k,D],[!0]).reshape(R)}}),Oy=T({fusedConv2d_:function(e){var n=e.x,t=e.filter,r=e.strides,o=e.pad,a=e.dataFormat,i=void 0===a?"NHWC":a,s=e.dilations,u=void 0===s?[1,1]:s,c=e.dimRoundingMode,l=e.bias,h=e.activation,f=void 0===h?"linear":h,p=e.preluActivationWeights;if(!1===Ru(A.state.gradientDepth,f=f||"linear")){var d=_n(n,t,r,o,i,u,c);return null!=l&&(d=de(d,l)),Du(d,f,p)}var g=_(n,"x","conv2d"),v=_(t,"filter","conv2d"),m=g,y=!1;3===g.rank&&(y=!0,m=g.as4D(1,g.shape[0],g.shape[1],g.shape[2])),S(4===m.rank,function(){return"Error in fused conv2d: input must be rank 4, but got rank "+m.rank+"."}),S(4===v.rank,function(){return"Error in fused conv2d: filter must be rank 4, but got rank "+v.rank+"."}),null!=c&&S(Me(o),function(){return"Error in fused conv2d: pad must be an integer when using, dimRoundingMode "+c+" but got pad "+o+"."}),S(m.shape[3]===v.shape[2],function(){return"Error in conv2d: depth of input ("+m.shape[3]+") must match input depth for filter "+v.shape[2]+"."}),S(hn(r,u),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+r+" and dilations '"+u+"'"}),S("NHWC"===i,function(){return"Error in conv2d: got dataFormat of "+i+" but only NHWC is currently supported."});var x,w,b=Pt(m.shape,v.shape,r,u,o,c);null!=l&&(x=Ne(x=_(l,"bias","fused conv2d"),g)[0],ve(b.outShape,x.shape)),null!=p&&(w=_(p,"prelu weights","fused conv2d"));var I={x:m,filter:v};null!=l&&(I.bias=x),null!=p&&(I.preluActivationWeights=w);var C=A.runKernelFunc(function(R,k){var D=R.fusedConv2d({input:m,filter:v,convInfo:b,bias:x,activation:f,preluActivationWeights:w});return k([v,m,D]),D},I,function(R,k){var N=k[0],M=k[1],P=ku(R,k[2],f);S(dr(u),function(){return"Error in gradient of fused conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+u+"'"});var F={};return null!=l&&(F={bias:function(){return Su(x,P)}}),Object.assign({x:function(){return Ad(M.shape,P,N,r,o)},filter:function(){return mu(M,P,N.shape,r,o)}},F)},"FusedConv2D",{convInfo:b,activation:f},[v,m],[!0]);return y?C.as3D(C.shape[1],C.shape[2],C.shape[3]):C}}),Py=T({fusedDepthwiseConv2d_:function(e){var n=e.x,t=e.filter,r=e.strides,o=e.pad,a=e.dataFormat,i=void 0===a?"NHWC":a,s=e.dilations,u=void 0===s?[1,1]:s,c=e.dimRoundingMode,l=e.bias,h=e.activation,f=void 0===h?"linear":h,p=e.preluActivationWeights;if(!1===Ru(A.state.gradientDepth,f)){var d=Uo(n,t,r,o,i,u,c);return null!=l&&(d=de(d,l)),Du(d,f,p)}var g=_(n,"x","depthwiseConv2d"),v=_(t,"filter","depthwiseConv2d"),m=g,y=!1;3===g.rank&&(y=!0,m=g.as4D(1,g.shape[0],g.shape[1],g.shape[2])),S(4===m.rank,function(){return"Error in fused depthwiseConv2d: input must be rank 4, but got rank "+m.rank+"."}),S(4===v.rank,function(){return"Error in fused depthwiseConv2d: filter must be rank 4, but got rank "+v.rank+"."}),S(m.shape[3]===v.shape[2],function(){return"Error in fused depthwiseConv2d: number of input channels ("+m.shape[3]+") must match the inChannels dimension in filter "+v.shape[2]+"."}),null==u&&(u=[1,1]),S(hn(r,u),function(){return"Error in fused depthwiseConv2d: Either strides or dilations must be 1. Got strides "+r+" and dilations '"+u+"'"}),null!=c&&S(Me(o),function(){return"Error in fused depthwiseConv2d: pad must be an integer when using dimRoundingMode "+c+" but got pad "+o+"."});var x,w,b=Pt(m.shape,v.shape,r,u,o,c,!0);null!=l&&(x=Ne(x=_(l,"bias","fused conv2d"),g)[0],ve(b.outShape,x.shape)),null!=p&&(w=_(p,"prelu weights","fused depthwiseConv2d"));var I={x:m,filter:v};null!=l&&(I.bias=x),null!=p&&(I.preluActivationWeights=w);var C=A.runKernelFunc(function(R,k){var D=R.fusedDepthwiseConv2D({input:m,filter:v,convInfo:b,bias:x,activation:f,preluActivationWeights:w});return k([v,m,D]),D},I,function(R,k){S(dr(u),function(){return"Error in gradient of fused depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+u+"'"});var D=k[0],N=k[1],W=ku(R,k[2],f),P={};return null!=l&&(P={bias:function(){return Su(x,W)}}),Object.assign({x:function(){return Td(N.shape,W,D,b)},filter:function(){return Nd(N,W,D.shape,b)}},P)},"FusedDepthwiseConv2D",{convInfo:b,activation:f},[v,m],[!0]);return y?C.as3D(C.shape[1],C.shape[2],C.shape[3]):C}}),Iv=Object.freeze({matMul:My,conv2d:Oy,depthwiseConv2d:Py}),By=Object.freeze({image:oi,linalg:_v,losses:Cv,spectral:dv,fused:Iv,signal:wv,square:fp,squaredDifference:ou,conv1d:Sd,conv2d:_n,conv3d:Dd,depthwiseConv2d:Uo,separableConv2d:Qa,conv2dTranspose:Fd,conv3dTranspose:Md,op:T,batchNormalization2d:qp,batchNormalization3d:jp,batchNormalization4d:Kp,batchNormalization:Xp,batchNorm:uu,batchNorm2d:Yp,batchNorm3d:$p,batchNorm4d:Jp,booleanMaskAsync:Id,complex:$e,real:Cn,imag:Bn,concat:ze,concat1d:Nh,concat2d:Fh,concat3d:Mh,concat4d:Oh,split:Aa,matMul:Vo,dot:Od,outerProduct:Pd,reverse:Gr,reverse1d:Bd,reverse2d:Ld,reverse3d:Wd,reverse4d:zd,maxPool:qe,avgPool:Hr,pool:Gd,maxPool3d:Hd,avgPool3d:qd,slice:Wn,slice1d:jd,slice2d:Kd,slice3d:gu,slice4d:Xd,abs:pp,acos:dp,acosh:vp,asin:mp,asinh:gp,atan:yp,atanh:xp,ceil:bp,clipByValue:ja,cos:wp,cosh:Cp,erf:Ep,exp:Ka,expm1:_p,floor:Ip,log:Rp,log1p:kp,logSigmoid:Sp,neg:Bo,reciprocal:Dp,round:Ap,rsqrt:au,sigmoid:iu,sign:Tp,isNaN:Np,isInf:Fp,isFinite:Mp,sin:Op,sinh:Pp,softplus:Bp,sqrt:Lp,step:Wp,tan:zp,tanh:Up,all:$d,any:Jd,argMax:Qd,argMin:Zd,logSumExp:ev,max:Go,mean:nv,min:tv,moments:rv,sum:yu,prod:ov,equal:fu,equalStrict:pd,greater:dd,greaterEqual:pu,greaterEqualStrict:vd,greaterStrict:md,less:gd,lessEqual:yd,lessEqualStrict:xd,lessStrict:bd,notEqual:wd,notEqualStrict:Cd,add:de,addN:ed,addStrict:nd,atan2:td,div:Tn,divNoNan:rd,divStrict:od,floorDiv:lu,maximum:$a,maximumStrict:ad,minimum:hu,minimumStrict:id,mod:sd,modStrict:ud,mul:nn,mulStrict:cd,pow:zo,powStrict:ld,squaredDifferenceStrict:hd,sub:Ge,subStrict:fd,elu:xu,leakyRelu:av,prelu:bu,relu:Fe,relu6:wu,selu:iv,logicalAnd:Wo,logicalNot:Qp,logicalOr:cu,logicalXor:Zp,where:Bt,whereAsync:su,buffer:he,print:Ph,batchToSpaceND:As,broadcastTo:Lh,cast:Wh,clone:zh,cumsum:Uh,depthToSpace:Vh,expandDims:En,eye:Ts,multinomial:Gh,oneHot:Fa,pad:Ot,pad1d:Hh,pad2d:qh,pad3d:jh,pad4d:Kh,rand:Xh,randomNormal:Yh,randomGamma:$h,randomUniform:Ns,reshape:An,spaceToBatchND:Fs,squeeze:Ms,stack:dn,tile:pr,truncatedNormal:Jh,unstack:Ue,setdiff1dAsync:Bh,fill:Ln,linspace:Th,ones:lr,range:So,scalar:$,tensor:Je,tensor1d:Pe,tensor2d:lt,tensor3d:Da,tensor4d:ln,tensor5d:Sh,tensor6d:Dh,variable:Ah,zeros:Se,onesLike:Rs,zerosLike:xe,transpose:pt,softmax:Yn,logSoftmax:sf,localResponseNormalization:sv,norm:Cu,gather:Ja,unsortedSegmentSum:du,basicLSTMCell:uv,multiRNNCell:cv,movingAverage:lv,stridedSlice:hv,topk:fv,scatterND:pv,fft:Za,ifft:Ho,rfft:ei,irfft:Eu,sparseToDense:vv,gatherND:mv,diag:gv,dropout:yv,hannWindow:ni,hammingWindow:_u,frame:ti,stft:Iu,inTopKAsync:bv});function X(e,n){Array.isArray(e)||(e=[e]),e.forEach(function(t){null!=t&&S("complex64"!==t.dtype,function(){return n+" does not support complex64 tensors."})})}function Au(e,n,t,r){if("linear"===t)return e.linear(n);if("relu"===t)return e.relu(n);if("elu"===t)return e.elu(n);if("relu6"===t)return e.relu6(n);if("prelu"===t)return e.prelu(n,r);throw new Error("Activation "+t+" has not been implemented for the CPU backend.")}var Rv,Ly=(Nn(B,Rv=zs),B.prototype.write=function(e,n,t){this.firstUse&&(this.firstUse=!1,q().get("IS_NODE")&&ka("\n============================\nHi there \u{1f44b}. Looks like you are running TensorFlow.js in Node.js. To speed things up dramatically, install our node backend, which binds to TensorFlow C++, by running npm i @tensorflow/tfjs-node, or npm i @tensorflow/tfjs-node-gpu if you have CUDA. Then call require('@tensorflow/tfjs-node'); (-gpu suffix for CUDA) at the start of your program. Visit https://github.com/tensorflow/tfjs-node for more details.\n============================"));var r={};return this.data.set(r,{values:e,dtype:t}),r},B.prototype.move=function(e,n,t,r){this.data.set(e,{values:n,dtype:r})},B.prototype.numDataIds=function(){return this.data.numDataIds()},B.prototype.read=function(e){return oe(this,void 0,void 0,function(){return ae(this,function(n){return[2,this.readSync(e)]})})},B.prototype.readSync=function(e){var n=this.data.get(e),r=n.complexTensors;return"complex64"===n.dtype?qs(this.readSync(r.real.dataId),this.readSync(r.imag.dataId)):this.data.get(e).values},B.prototype.bufferSync=function(e){var n=this.readSync(e.dataId),t=n;if("string"===e.dtype)try{t=n.map(function(r){return mo(r)})}catch{throw new Error("Failed to decode encoded string bytes into utf-8")}return he(e.shape,e.dtype,t)},B.prototype.makeOutput=function(e,n,t){var r=this.write(e,n,t);return A.makeTensorFromDataId(r,n,t,this)},B.prototype.disposeData=function(e){if(this.data.has(e)){var n=this.data.get(e).complexTensors;null!=n&&(n.real.dispose(),n.imag.dispose()),this.data.delete(e)}},B.prototype.time=function(e){return oe(this,void 0,void 0,function(){var n;return ae(this,function(t){return n=Mn(),e(),[2,{kernelMs:Mn()-n}]})})},B.prototype.memory=function(){return{unreliable:!0,reasons:["The reported memory is an upper bound. Due to automatic garbage collection, the true allocated memory may be less."]}},B.prototype.complex=function(e,n){var t=this.makeOutput(null,e.shape,"complex64");return this.data.get(t.dataId).complexTensors={real:A.keep(e.clone()),imag:A.keep(n.clone())},t},B.prototype.real=function(e){return this.data.get(e.dataId).complexTensors.real.clone()},B.prototype.imag=function(e){return this.data.get(e.dataId).complexTensors.imag.clone()},B.prototype.slice=function(e,n,t){if(X(e,"slice"),Bs(e.shape,n,t)){var r=Ls(n,e.strides),o=ie(t);return Je(this.readSync(e.dataId).subarray(r,r+o),t,e.dtype)}for(var a=he(t,e.dtype),i=this.bufferSync(e),s=0;s<a.size;++s){var u=a.indexToLoc(s).map(function(c,l){return c+n[l]});a.values[s]=i.get.apply(i,u)}return a.toTensor()},B.prototype.stridedSlice=function(e,n,t,r){X(e,"stridedSlice");var o=La(n,t,r);if(o.some(function(h){return 0===h}))return Je([],o);for(var a=he(o,e.dtype),i=this.bufferSync(e),s=0;s<a.size;s++){for(var u=a.indexToLoc(s),c=new Array(u.length),l=0;l<c.length;l++)c[l]=u[l]*r[l]+n[l];a.set.apply(a,[i.get.apply(i,c)].concat(u))}return a.toTensor()},B.prototype.diag=function(e){for(var n=this.readSync(e.dataId),t=he([e.size,e.size],e.dtype),r=t.values,o=0;o<n.length;o++)r[o*e.size+o]=n[o];return t.toTensor()},B.prototype.unstack=function(e,n){for(var t=e.shape[n],r=new Array(e.rank-1),o=0,a=0;a<e.rank;a++)a!==n&&(r[o++]=e.shape[a]);var i=new Array(e.rank).fill(0),s=e.shape.slice();s[n]=1;var u=new Array(t);for(a=0;a<u.length;a++)u[i[n]=a]=this.slice(e,i,s).reshape(r);return u},B.prototype.reverse=function(e,n){X(e,"reverse");for(var t=he(e.shape,e.dtype),r=this.bufferSync(e),o=function(i){var s=t.indexToLoc(i),u=s.slice();n.forEach(function(c){return u[c]=e.shape[c]-1-u[c]}),t.set.apply(t,[r.get.apply(r,u)].concat(s))},a=0;a<t.size;a++)o(a);return t.toTensor()},B.prototype.concat=function(e,n){var t=this;if("complex64"===e[0].dtype){var r=e.map(function(h){return Cn(h)}),o=e.map(function(h){return Bn(h)});return $e(this.concat(r,n),this.concat(o,n))}var a=e.map(function(h){var f=ie(h.shape.slice(n));return h.as2D(-1,f)}),i=cr(a.map(function(h){return h.shape}),1),s=he(i,e[0].dtype).values;if(1===a[0].shape[0]){var u=0;a.forEach(function(h){s.set(t.readSync(h.dataId),u),u+=h.size})}else{var c=0;a.forEach(function(h){for(var f=t.readSync(h.dataId),p=0,d=0;d<h.shape[0];++d)for(var g=d*i[1]+c,v=0;v<h.shape[1];++v)s[g+v]=f[p++];c+=h.shape[1]})}var l=cr(e.map(function(h){return h.shape}),n);return Je(s,l,e[0].dtype)},B.prototype.neg=function(e){return X(e,"neg"),this.multiply($(-1),e)},B.prototype.add=function(e,n){return"complex64"===e.dtype||"complex64"===n.dtype?this.broadcastedBinaryComplexOp(e.cast("complex64"),n.cast("complex64"),function(t,r,o,a){return{real:t+o,imag:r+a}}):this.broadcastedBinaryOp(e,n,Ye(e.dtype,n.dtype),function(t,r){return t+r})},B.prototype.addN=function(e){var n=this;X(e,"addN");for(var t=e.map(function(u){return n.readSync(u.dataId)}),r=he(e[0].shape,e[0].dtype),o=r.values,a=0;a<e.length;a++)for(var i=t[a],s=0;s<o.length;s++)o[s]+=i[s];return r.toTensor()},B.prototype.softmax=function(e,n){var t=We([n],e.shape),r=this.max(e,t),o=cn(r.shape,t),a=this.subtract(e,r.reshape(o)),i=this.exp(a),s=this.sum(i,t).reshape(o);return this.realDivide(i,s)},B.prototype.subtract=function(e,n){return"complex64"===e.dtype||"complex64"===n.dtype?this.broadcastedBinaryComplexOp(e.cast("complex64"),n.cast("complex64"),function(t,r,o,a){return{real:t-o,imag:r-a}}):this.broadcastedBinaryOp(e,n,Ye(e.dtype,n.dtype),function(t,r){return t-r})},B.prototype.pow=function(e,n){return X([e,n],"pow"),this.broadcastedBinaryOp(e,n,e.dtype,function(t,r){return Math.pow(t,r)})},B.prototype.batchMatMul=function(e,n,t,r){X([e,n],"matMul");for(var o=t?e.shape[1]:e.shape[2],a=t?e.shape[2]:e.shape[1],i=r?n.shape[1]:n.shape[2],s=e.shape[0],u=this.readSync(e.dataId),c=this.readSync(n.dataId),l=t?[e.strides[0],1,e.strides[1]]:[e.strides[0],e.strides[1],1],h=l[0],f=l[1],p=l[2],d=r?[1,n.strides[1],n.strides[0]]:[n.strides[1],1,n.strides[0]],g=d[0],v=d[1],m=d[2],y=a*i,x=he([s,a,i],e.dtype),w=x.values,b=this.blockSize,I=0;I<s;I++)for(var E=0;E<a;E+=b)for(var C=0;C<i;C+=b)for(var R=0;R<o;R+=b)for(var k=Math.min(E+b,a),D=Math.min(C+b,i),N=Math.min(R+b,o),M=E;M<k;M++)for(var W=C;W<D;W++){for(var P=0,F=R;F<N;F++)P+=u[I*h+M*f+F*p]*c[F*g+W*v+I*m];w[I*y+(M*i+W)]+=P}return x.toTensor()},B.prototype.fusedBatchMatMul=function(e){var a=e.bias,i=e.activation,s=e.preluActivationWeights,u=this.batchMatMul(e.a,e.b,e.transposeA,e.transposeB);return a&&(u=this.add(u,a)),i&&(u=Au(this,u,i,s)),u},B.prototype.multiply=function(e,n){return"complex64"===e.dtype||"complex64"===n.dtype?this.broadcastedBinaryComplexOp(e.cast("complex64"),n.cast("complex64"),function(t,r,o,a){return{real:t*o-r*a,imag:t*a+r*o}}):this.broadcastedBinaryOp(e,n,Ye(e.dtype,n.dtype),function(t,r){return t*r})},B.prototype.realDivide=function(e,n){return X([e,n],"realDivide"),this.broadcastedBinaryOp(e,n,"float32",function(t,r){return t/r})},B.prototype.floorDiv=function(e,n){return X([e,n],"floorDiv"),this.broadcastedBinaryOp(e,n,"int32",function(t,r){return Math.floor(t/r)})},B.prototype.sum=function(e,n){X(e,"sum"),pn("sum",n,e.rank);for(var t=en(e.shape,n),o=t[1],a=Se(t[0],Ye(e.dtype,"int32")),i=ie(o),s=this.readSync(a.dataId),u=this.readSync(e.dataId),c=0;c<s.length;++c){for(var l=c*i,h=0,f=0;f<i;++f)h+=u[l+f];s[c]=h}return a},B.prototype.prod=function(e,n){X(e,"sum");for(var t=en(e.shape,n),o=t[1],a=Se(t[0],Ye(e.dtype,"int32")),i=ie(o),s=this.readSync(a.dataId),u=this.readSync(e.dataId),c=0;c<s.length;++c){for(var l=c*i,h=1,f=0;f<i;++f)h*=u[l+f];s[c]=h}return a},B.prototype.unsortedSegmentSum=function(e,n,t){X(e,"unsortedSegmentSum");for(var r=[],o=e.rank-n.rank,a=0;a<o;++a)n=n.expandDims(a+1);for(a=0;a<t;++a){var i=$(a,"int32"),s=fu(i,n).asType("float32").mul(e).sum(0);r.push(s)}return dn(r)},B.prototype.argMin=function(e,n){X(e,"argMin");var t=[n];pn("argMin",t,e.rank);for(var r=en(e.shape,t),a=r[1],i=Se(r[0],"int32"),s=ie(a),u=this.readSync(i.dataId),c=this.readSync(e.dataId),l=0;l<u.length;++l){for(var h=l*s,f=c[h],p=0,d=0;d<s;++d){var g=c[h+d];g<f&&(f=g,p=d)}u[l]=p}return i},B.prototype.argMax=function(e,n){X(e,"argMax");var t=[n];pn("argMax",t,e.rank);for(var r=en(e.shape,t),a=r[1],i=Se(r[0],"int32"),s=ie(a),u=this.readSync(i.dataId),c=this.readSync(e.dataId),l=0;l<u.length;++l){for(var h=l*s,f=c[h],p=0,d=0;d<s;++d){var g=c[h+d];f<g&&(f=g,p=d)}u[l]=p}return i},B.prototype.cumsum=function(e,n,t,r){if(X(e,"cumsum"),n!==e.rank-1)throw new Error("backend.cumsum in CPU expects an inner-most axis="+(e.rank-1)+" but got axis="+n);for(var o=Ye(e.dtype,"int32"),a=Se(e.shape,o),i=this.readSync(a.dataId),s=this.readSync(e.dataId),u=e.shape[e.rank-1],c=r?function(d,g){return d+u-g-1}:function(d,g){return d+g},l=0;l<s.length;l+=u)for(var h=0;h<u;h++){var f=c(l,h);if(0===h)i[f]=t?0:s[f];else{var p=c(l,h-1);i[f]=t?s[p]+i[p]:s[f]+i[p]}}return a},B.prototype.equal=function(e,n){return X([e,n],"equal"),this.broadcastedBinaryOp(e,n,"bool",function(t,r){return t===r?1:0})},B.prototype.notEqual=function(e,n){return X([e,n],"notEqual"),this.broadcastedBinaryOp(e,n,"bool",function(t,r){return t!==r?1:0})},B.prototype.less=function(e,n){return X([e,n],"less"),this.broadcastedBinaryOp(e,n,"bool",function(t,r){return t<r?1:0})},B.prototype.lessEqual=function(e,n){return X([e,n],"lessEqual"),this.broadcastedBinaryOp(e,n,"bool",function(t,r){return t<=r?1:0})},B.prototype.greater=function(e,n){return X([e,n],"greater"),this.broadcastedBinaryOp(e,n,"bool",function(t,r){return r<t?1:0})},B.prototype.greaterEqual=function(e,n){return X([e,n],"greaterEqual"),this.broadcastedBinaryOp(e,n,"bool",function(t,r){return r<=t?1:0})},B.prototype.logicalNot=function(e){X(e,"logicalNot");for(var n=this.readSync(e.dataId),t=new Uint8Array(n.length),r=0;r<n.length;++r)t[r]=n[r]?0:1;return this.makeOutput(t,e.shape,"bool")},B.prototype.logicalAnd=function(e,n){return X([e,n],"logicalAnd"),this.broadcastedBinaryOp(e,n,"bool",function(t,r){return t&&r})},B.prototype.logicalOr=function(e,n){return X([e,n],"logicalOr"),this.broadcastedBinaryOp(e,n,"bool",function(t,r){return t||r})},B.prototype.select=function(e,n,t){X([e,n,t],"select");for(var r=this.readSync(e.dataId),o=this.readSync(n.dataId),a=this.readSync(t.dataId),i=Se(n.shape,Ye(n.dtype,t.dtype)),s=this.readSync(i.dataId),u=0,c=0===e.rank||1<e.rank||1===n.rank?1:ie(n.shape.slice(1)),l=0;l<r.length;l++)for(var h=0;h<c;h++)s[u++]=1===r[l]?o[l]:a[l];return i},B.prototype.where=function(e){X([e],"where");var n=this.readSync(e.dataId);return Xs(e.shape,n)},B.prototype.topk=function(e,n,t){return X(e,"topk"),pf(this.readSync(e.dataId),e.shape,e.dtype,n)},B.prototype.min=function(e,n){X(e,"min"),pn("min",n,e.rank);for(var t=en(e.shape,n),o=t[1],a=Se(t[0],e.dtype),i=ie(o),s=this.readSync(a.dataId),u=this.readSync(e.dataId),c=0;c<s.length;++c){for(var l=c*i,h=u[l],f=0;f<i;++f){var p=u[l+f];p<h&&(h=p)}s[c]=h}return a},B.prototype.minimum=function(e,n){return X([e,n],"minimum"),this.broadcastedBinaryOp(e,n,e.dtype,function(t,r){return Math.min(t,r)})},B.prototype.mod=function(e,n){return X([e,n],"mod"),this.broadcastedBinaryOp(e,n,e.dtype,function(t,r){var o=t%r;return t<0&&r<0||0<=t&&0<=r?o:(o+r)%r})},B.prototype.max=function(e,n){X(e,"max"),pn("max",n,e.rank);for(var t=en(e.shape,n),o=t[1],a=Se(t[0],e.dtype),i=ie(o),s=this.readSync(a.dataId),u=this.readSync(e.dataId),c=0;c<s.length;++c){for(var l=c*i,h=u[l],f=0;f<i;++f){var p=u[l+f];h<p&&(h=p)}s[c]=h}return a},B.prototype.maximum=function(e,n){return X([e,n],"maximum"),this.broadcastedBinaryOp(e,n,e.dtype,function(t,r){return Math.max(t,r)})},B.prototype.all=function(e,n){X(e,"all"),pn("all",n,e.rank);for(var t=en(e.shape,n),o=t[1],a=Se(t[0],e.dtype),i=ie(o),s=this.readSync(a.dataId),u=this.readSync(e.dataId),c=0;c<s.length;++c){for(var l=c*i,h=u[l],f=0;f<i;++f)h=h&&u[l+f];s[c]=h}return a},B.prototype.any=function(e,n){X(e,"any"),pn("any",n,e.rank);for(var t=en(e.shape,n),o=t[1],a=Se(t[0],e.dtype),i=ie(o),s=this.readSync(a.dataId),u=this.readSync(e.dataId),c=0;c<s.length;++c){for(var l=c*i,h=u[l],f=0;f<i;++f)h=h||u[l+f];s[c]=h}return a},B.prototype.squaredDifference=function(e,n){return X([e,n],"squaredDifference"),this.broadcastedBinaryOp(e,n,e.dtype,function(t,r){var o=t-r;return o*o})},B.prototype.ceil=function(e){X(e,"ceil");for(var n=this.readSync(e.dataId),t=new Float32Array(n.length),r=0;r<n.length;++r)t[r]=Math.ceil(n[r]);return this.makeOutput(t,e.shape,"float32")},B.prototype.floor=function(e){X(e,"floor");for(var n=this.readSync(e.dataId),t=new Float32Array(n.length),r=0;r<n.length;++r)t[r]=Math.floor(n[r]);return this.makeOutput(t,e.shape,"float32")},B.prototype.sign=function(e){X(e,"x");for(var n=this.readSync(e.dataId),t=new Float32Array(n.length),r=0;r<n.length;++r)t[r]=n[r]<0?-1:0<n[r]?1:0;return this.makeOutput(t,e.shape,"float32")},B.prototype.isNaN=function(e){X(e,"x");for(var n=this.readSync(e.dataId),t=new Uint8Array(n.length),r=0;r<n.length;++r)Number.isNaN(n[r])&&(t[r]=1);return this.makeOutput(t,e.shape,"bool")},B.prototype.isInf=function(e){X(e,"x");for(var n=this.readSync(e.dataId),t=new Uint8Array(n.length),r=0;r<n.length;++r)Math.abs(n[r])===1/0&&(t[r]=1);return this.makeOutput(t,e.shape,"bool")},B.prototype.isFinite=function(e){X(e,"x");for(var n=this.readSync(e.dataId),t=new Uint8Array(n.length),r=0;r<n.length;++r)Number.isFinite(n[r])&&(t[r]=1);return this.makeOutput(t,e.shape,"bool")},B.prototype.round=function(e){X(e,"round");for(var n=this.readSync(e.dataId),t=new Float32Array(n.length),r=0;r<n.length;++r){var o=Math.floor(n[r]);t[r]=n[r]-o<.5?Math.floor(n[r]):.5<n[r]-o?Math.ceil(n[r]):o%2==0?o:o+1}return this.makeOutput(t,e.shape,"float32")},B.prototype.exp=function(e){X(e,"exp");for(var n=this.readSync(e.dataId),t=new Float32Array(n.length),r=0;r<n.length;++r)t[r]=Math.exp(n[r]);return this.makeOutput(t,e.shape,"float32")},B.prototype.expm1=function(e){X(e,"expm1");for(var n=this.readSync(e.dataId),t=new Float32Array(n.length),r=0;r<n.length;++r)t[r]=Math.expm1(n[r]);return this.makeOutput(t,e.shape,"float32")},B.prototype.log=function(e){X(e,"log");for(var n=this.readSync(e.dataId),t=new Float32Array(n.length),r=0;r<n.length;++r)t[r]=Math.log(n[r]);return this.makeOutput(t,e.shape,"float32")},B.prototype.log1p=function(e){X(e,"log1p");for(var n=this.readSync(e.dataId),t=new Float32Array(n.length),r=0;r<n.length;++r)t[r]=Math.log1p(n[r]);return this.makeOutput(t,e.shape,"float32")},B.prototype.sqrt=function(e){X(e,"sqrt");for(var n=this.readSync(e.dataId),t=new Float32Array(n.length),r=0;r<n.length;++r)t[r]=Math.sqrt(n[r]);return this.makeOutput(t,e.shape,"float32")},B.prototype.rsqrt=function(e){X(e,"rsqrt");for(var n=this.readSync(e.dataId),t=new Float32Array(n.length),r=0;r<n.length;++r)t[r]=1/Math.sqrt(n[r]);return this.makeOutput(t,e.shape,"float32")},B.prototype.reciprocal=function(e){X(e,"reciprocal");for(var n=this.readSync(e.dataId),t=new Float32Array(n.length),r=0;r<n.length;++r)t[r]=1/n[r];return this.makeOutput(t,e.shape,"float32")},B.prototype.linear=function(e){return e},B.prototype.relu=function(e){X(e,"relu");for(var n=Se(e.shape,e.dtype),t=this.readSync(n.dataId),r=this.readSync(e.dataId),o=0;o<r.length;++o)t[o]=Math.max(0,r[o]);return n},B.prototype.relu6=function(e){X(e,"relu");for(var n=Se(e.shape,e.dtype),t=this.readSync(n.dataId),r=this.readSync(e.dataId),o=0;o<r.length;++o)t[o]=Math.min(Math.max(0,r[o]),6);return n},B.prototype.prelu=function(e,n){return X([e,n],"prelu"),this.broadcastedBinaryOp(e,n,e.dtype,function(t,r){return t<0?r*t:t})},B.prototype.elu=function(e){X(e,"elu");for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r){var o=t[r];n[r]=0<=o?o:Math.exp(o)-1}return this.makeOutput(n,e.shape,"float32")},B.prototype.eluDer=function(e,n){X([e,n],"eluDer");for(var t=new Float32Array(n.size),r=this.readSync(n.dataId),o=this.readSync(e.dataId),a=0;a<r.length;++a){var i=r[a];t[a]=1<=i?o[a]:o[a]*(i+1)}return this.makeOutput(t,n.shape,"float32")},B.prototype.selu=function(e){X(e,"selu");for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r){var o=t[r];n[r]=0<=o?1.0507009873554805*o:1.7580993408473768*(Math.exp(o)-1)}return this.makeOutput(n,e.shape,"float32")},B.prototype.clip=function(e,n,t){X(e,"clip");for(var r=new Float32Array(e.size),o=this.readSync(e.dataId),a=0;a<o.length;++a){var i=o[a];r[a]=t<i?t:i<n?n:i}return this.makeOutput(r,e.shape,"float32")},B.prototype.abs=function(e){for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r)n[r]=Math.abs(t[r]);return this.makeOutput(n,e.shape,"float32")},B.prototype.complexAbs=function(e){for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<e.size;++r)n[r]=Math.hypot(t[2*r],t[2*r+1]);return this.makeOutput(n,e.shape,"float32")},B.prototype.int=function(e){X(e,"int");for(var n=new Int32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r)n[r]=t[r];return this.makeOutput(n,e.shape,"int32")},B.prototype.sigmoid=function(e){X(e,"sigmoid");for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r)n[r]=1/(1+Math.exp(-t[r]));return this.makeOutput(n,e.shape,"float32")},B.prototype.softplus=function(e){X(e,"softplus");for(var n=Math.log(1.1920928955078125e-7)+2,t=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o){var a,i=r[o]>-n,s=r[o]<n,u=Math.exp(r[o]);a=s?u:i?r[o]:Math.log(1+u),t[o]=a}return this.makeOutput(t,e.shape,"float32")},B.prototype.sin=function(e){X(e,"sin");for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r)n[r]=Math.sin(t[r]);return this.makeOutput(n,e.shape,"float32")},B.prototype.cos=function(e){X(e,"cos");for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r)n[r]=Math.cos(t[r]);return this.makeOutput(n,e.shape,"float32")},B.prototype.tan=function(e){X(e,"tan");for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r)n[r]=Math.tan(t[r]);return this.makeOutput(n,e.shape,"float32")},B.prototype.asin=function(e){X(e,"asin");for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r)n[r]=Math.asin(t[r]);return this.makeOutput(n,e.shape,"float32")},B.prototype.acos=function(e){X(e,"acos");for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r)n[r]=Math.acos(t[r]);return this.makeOutput(n,e.shape,"float32")},B.prototype.atan=function(e){X(e,"atan");for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r)n[r]=Math.atan(t[r]);return this.makeOutput(n,e.shape,"float32")},B.prototype.atan2=function(e,n){return X([e,n],"atan2"),this.broadcastedBinaryOp(e,n,e.dtype,function(t,r){return Math.atan2(t,r)})},B.prototype.sinh=function(e){X(e,"sinh");for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r)n[r]=Math.sinh(t[r]);return this.makeOutput(n,e.shape,"float32")},B.prototype.cosh=function(e){X(e,"cosh");for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r)n[r]=Math.cosh(t[r]);return this.makeOutput(n,e.shape,"float32")},B.prototype.tanh=function(e){X(e,"tanh");for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r)n[r]=Ml(t[r]);return this.makeOutput(n,e.shape,"float32")},B.prototype.asinh=function(e){X(e,"asinh");for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r)n[r]=Math.asinh(t[r]);return this.makeOutput(n,e.shape,"float32")},B.prototype.acosh=function(e){X(e,"acosh");for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r)n[r]=Math.acosh(t[r]);return this.makeOutput(n,e.shape,"float32")},B.prototype.atanh=function(e){X(e,"atanh");for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r)n[r]=Math.atanh(t[r]);return this.makeOutput(n,e.shape,"float32")},B.prototype.erf=function(e){X(e,"erf");for(var n=new Float32Array(e.size),t=this.readSync(e.dataId),r=0;r<t.length;++r){var o=Math.sign(t[r]),a=Math.abs(t[r]),i=1/(1+.3275911*a);n[r]=o*(1-((((1.061405429*i-1.453152027)*i+1.421413741)*i-.284496736)*i+.254829592)*i*Math.exp(-a*a))}return this.makeOutput(n,e.shape,"float32")},B.prototype.step=function(e,n){void 0===n&&(n=0),X(e,"step");for(var t=new Float32Array(e.size),r=this.readSync(e.dataId),o=0;o<r.length;++o){var a=r[o];t[o]=isNaN(a)?NaN:0<a?1:n}return this.makeOutput(t,e.shape,"float32")},B.prototype.fusedConv2d=function(e){var o=e.bias,a=e.activation,i=e.preluActivationWeights,s=this.conv2d(e.input,e.filter,e.convInfo);return o&&(s=this.add(s,o)),a&&(s=Au(this,s,a,i)),s},B.prototype.conv2d=function(e,n,t){X([e,n],"conv2d");for(var r=t.filterHeight,o=t.filterWidth,a=t.dilationHeight,i=t.dilationWidth,s=t.padInfo.left,u=t.padInfo.top,c="channelsLast"===t.dataFormat,l=he(t.outShape,e.dtype),h=e.strides[0],f=c?e.strides[1]:e.strides[2],p=c?e.strides[2]:1,d=c?1:e.strides[1],g=l.strides[0],v=c?l.strides[1]:l.strides[2],m=c?l.strides[2]:1,y=c?1:l.strides[1],x=this.readSync(e.dataId),w=this.readSync(n.dataId),b=l.values,I=0;I<t.batchSize;++I)for(var E=I*h,C=I*g,R=0;R<t.outHeight;++R)for(var k=C+R*v,D=R*t.strideHeight-u,N=0;N<r;N++){var M=D+N*a;if(!(M<0||M>=t.inHeight))for(var W=N*n.strides[0],P=E+M*f,F=0;F<t.outWidth;++F)for(var z=k+F*m,j=F*t.strideWidth-s,K=0;K<o;K++){var Y=j+K*i;if(!(Y<0||Y>=t.inWidth))for(var J=P+Y*p,Z=W+K*n.strides[1],ne=0;ne<t.inChannels;++ne){for(var ce=x[J+ne*d],me=0;me<t.outChannels;++me)b[z+me*y]+=ce*w[Z+me];Z+=t.outChannels}}}return l.toTensor()},B.prototype.conv3d=function(e,n,t){for(var r=t.filterDepth,o=t.filterHeight,a=t.filterWidth,i=t.dilationDepth,s=t.dilationHeight,u=t.dilationWidth,c=t.padInfo.front,l=t.padInfo.left,h=t.padInfo.top,f=he(t.outShape,e.dtype),p=this.readSync(e.dataId),d=this.readSync(n.dataId),g=f.values,v=0;v<t.batchSize;++v)for(var m=v*e.strides[0],y=v*f.strides[0],x=0;x<t.outDepth;++x)for(var w=y+x*f.strides[1],b=x*t.strideDepth-c,I=0;I<r;I++){var E=b+I*i;if(!(E<0||E>=t.inDepth))for(var C=I*n.strides[0],R=m+E*e.strides[1],k=0;k<t.outHeight;++k)for(var D=w+k*f.strides[2],N=k*t.strideHeight-h,M=0;M<o;M++){var W=N+M*s;if(!(W<0||W>=t.inHeight))for(var P=C+M*n.strides[1],F=R+W*e.strides[2],z=0;z<t.outWidth;++z)for(var j=D+z*t.outChannels,K=z*t.strideWidth-l,Y=0;Y<a;Y++){var J=K+Y*u;if(!(J<0||J>=t.inWidth))for(var ne=F+J*t.inChannels,ce=P+Y*n.strides[2],me=0;me<t.inChannels;++me){for(var ge=p[ne+me],ye=0;ye<t.outChannels;++ye)g[j+ye]+=ge*d[ce+ye];ce+=t.outChannels}}}}return f.toTensor()},B.prototype.conv2dDerInput=function(e,n,t){X([e,n],"conv2dDerInput");for(var r=he(t.inShape,"float32"),o=r.values,a=this.readSync(e.dataId),i=this.readSync(n.dataId),s=n.strides,u=s[0],c=s[1],l=s[2],h=t.batchSize,f=t.filterHeight,p=t.filterWidth,d=t.inChannels,g=t.inHeight,v=t.inWidth,m=t.outChannels,y=t.outHeight,x=t.outWidth,w=t.strideHeight,b=t.strideWidth,E=f-1-t.padInfo.top,C=p-1-t.padInfo.left,R="channelsLast"===t.dataFormat,k=r.strides[0],D=R?r.strides[1]:r.strides[2],N=R?r.strides[2]:1,M=R?1:r.strides[1],W=e.strides[0],P=R?e.strides[1]:e.strides[2],F=R?e.strides[2]:1,z=R?1:e.strides[1],j=0;j<h;++j)for(var K=0;K<d;++K)for(var Y=0;Y<g;++Y)for(var J=Y-E,Z=Math.max(0,Math.ceil(J/w)),ne=Math.min(y,(f+J)/w),ce=0;ce<v;++ce){for(var me=ce-C,ge=Math.max(0,Math.ceil(me/b)),ye=Math.min(x,(p+me)/b),Be=0,Ee=Z;Ee<ne;++Ee)for(var ke=Ee*w-J,Ie=ge;Ie<ye;++Ie)for(var He=W*j+P*Ee+F*Ie,Ae=u*(f-1-ke)+c*(p-1-(Ie*b-me))+l*K,Te=0;Te<m;++Te)Be+=a[He+z*Te]*i[Ae+Te];o[k*j+D*Y+N*ce+M*K]=Be}return r.toTensor()},B.prototype.conv3dDerInput=function(e,n,t){for(var r=he(t.inShape,"float32"),o=r.values,a=r.strides,i=a[0],s=a[1],u=a[2],c=a[3],l=this.readSync(e.dataId),h=e.strides,f=h[0],p=h[1],d=h[2],g=h[3],v=this.readSync(n.dataId),m=n.strides,y=m[0],x=m[1],w=m[2],b=m[3],I=t.batchSize,E=t.filterDepth,C=t.filterHeight,R=t.filterWidth,k=t.inChannels,D=t.inDepth,N=t.inHeight,M=t.inWidth,W=t.outChannels,P=t.outDepth,F=t.outHeight,z=t.outWidth,j=t.strideDepth,K=t.strideHeight,Y=t.strideWidth,J=E-1-t.padInfo.front,Z=C-1-t.padInfo.top,ne=R-1-t.padInfo.left,ce=0;ce<I;++ce)for(var me=0;me<k;++me)for(var ge=0;ge<D;++ge)for(var ye=ge-J,Be=Math.max(0,Math.ceil(ye/j)),Ee=Math.min(P,(E+ye)/j),ke=0;ke<N;++ke)for(var Ie=ke-Z,He=Math.max(0,Math.ceil(Ie/K)),Ae=Math.min(F,(C+Ie)/K),Te=0;Te<M;++Te){for(var at=Te-ne,it=Math.max(0,Math.ceil(at/Y)),Dn=Math.min(z,(R+at)/Y),Dr=0,nr=Be;nr<Ee;++nr)for(var kt=nr*j-ye,tr=He;tr<Ae;++tr)for(var $i=tr*K-Ie,St=it;St<Dn;++St)for(var fo=f*ce+p*nr+d*tr+g*St,Pg=y*(E-1-kt)+x*(C-1-$i)+w*(R-1-(St*Y-at))+b*me,Dt=0;Dt<W;++Dt)Dr+=l[fo+Dt]*v[Pg+Dt];o[i*ce+s*ge+u*ke+c*Te+me]=Dr}return r.toTensor()},B.prototype.conv2dDerFilter=function(e,n,t){X([e,n],"conv2dDerFilter");for(var r=t.strideHeight,o=t.strideWidth,a=t.filterHeight,i=t.filterWidth,s="channelsLast"===t.dataFormat,u=he(t.filterShape,"float32"),c=t.padInfo.left,l=t.padInfo.top,h=this.bufferSync(e),f=this.bufferSync(n),p=0;p<a;++p)for(var d=Math.max(0,Math.ceil((l-p)/r)),g=Math.min(t.outHeight,(t.inHeight+l-p)/r),v=0;v<i;++v)for(var m=Math.max(0,Math.ceil((c-v)/o)),y=Math.min(t.outWidth,(t.inWidth+c-v)/o),x=0;x<t.inChannels;++x)for(var w=0;w<t.outChannels;++w){for(var b=0,I=0;I<t.batchSize;++I)for(var E=d;E<g;++E)for(var C=p+E*r-l,R=m;R<y;++R){var k=v+R*o-c;b+=s?h.get(I,C,k,x)*f.get(I,E,R,w):h.get(I,x,C,k)*f.get(I,w,E,R)}u.set(b,p,v,x,w)}return u.toTensor()},B.prototype.conv3dDerFilter=function(e,n,t){for(var r=t.strideDepth,o=t.strideHeight,a=t.strideWidth,i=t.filterDepth,s=t.filterHeight,u=t.filterWidth,c=he(t.filterShape,"float32"),l=c.values,h=c.strides,f=h[0],p=h[1],d=h[2],g=h[3],v=this.readSync(n.dataId),m=n.strides,y=m[0],x=m[1],w=m[2],b=m[3],I=this.readSync(e.dataId),E=e.strides,C=E[0],R=E[1],k=E[2],D=E[3],N=t.padInfo.front,M=t.padInfo.left,W=t.padInfo.top,P=0;P<i;++P)for(var F=Math.max(0,Math.ceil((N-P)/r)),z=Math.min(t.outDepth,(t.inDepth+N-P)/r),j=P*f,K=0;K<s;++K)for(var Y=Math.max(0,Math.ceil((W-K)/o)),J=Math.min(t.outHeight,(t.inHeight+W-K)/o),Z=K*p+j,ne=0;ne<u;++ne)for(var ce=Math.max(0,Math.ceil((M-ne)/a)),me=Math.min(t.outWidth,(t.inWidth+M-ne)/a),ge=ne*d+Z,ye=0;ye<t.inChannels;++ye)for(var Be=ye*g+ge,Ee=0;Ee<t.outChannels;++Ee){for(var ke=0,Ie=0;Ie<t.batchSize;++Ie)for(var He=Ie*C,Ae=Ie*y,Te=F;Te<z;++Te)for(var at=(P+Te*r-N)*R+He,it=Te*x+Ae,Dn=Y;Dn<J;++Dn)for(var Dr=(K+Dn*o-W)*k+at,nr=Dn*w+it,kt=ce;kt<me;++kt)ke+=I[(ne+kt*a-M)*D+Dr+ye]*v[kt*b+nr+Ee];l[Be+Ee]=ke}return c.toTensor()},B.prototype.fusedDepthwiseConv2D=function(e){var o=e.bias,a=e.activation,i=e.preluActivationWeights,s=this.depthwiseConv2D(e.input,e.filter,e.convInfo);return o&&(s=this.add(s,o)),a&&(s=Au(this,s,a,i)),s},B.prototype.depthwiseConv2D=function(e,n,t){X([e,n],"depthwiseConv2D");for(var r=t.filterHeight,o=t.filterWidth,a=t.dilationHeight,i=t.dilationWidth,s=t.padInfo.left,u=t.padInfo.top,c=t.outChannels/t.inChannels,l=he(t.outShape,e.dtype),h=this.readSync(e.dataId),f=this.readSync(n.dataId),p=l.values,d=0;d<t.batchSize;++d)for(var g=d*e.strides[0],v=d*l.strides[0],m=0;m<t.outHeight;++m)for(var y=v+m*l.strides[1],x=m*t.strideHeight-s,w=0;w<r;++w){var b=x+w*a;if(!(b<0||b>=t.inHeight))for(var I=w*n.strides[0],E=g+b*e.strides[1],C=0;C<t.outWidth;++C)for(var R=y+C*l.strides[2],k=C*t.strideWidth-u,D=0;D<o;++D){var N=k+D*i;if(!(N<0||N>=t.inWidth))for(var W=E+N*t.inChannels,P=R,F=I+D*n.strides[1],z=0;z<t.inChannels;++z){for(var j=h[W+z],K=0;K<c;++K)p[P+K]+=j*f[F+K];P+=c,F+=c}}}return l.toTensor()},B.prototype.depthwiseConv2DDerInput=function(e,n,t){X([e,n],"depthwiseConv2DDerInput");for(var r=he(t.inShape,"float32"),o=r.values,a=r.strides,i=a[0],s=a[1],u=a[2],c=this.readSync(e.dataId),l=e.strides,h=l[0],f=l[1],p=l[2],d=this.readSync(n.dataId),g=n.strides,v=g[0],m=g[1],y=g[2],x=t.batchSize,w=t.filterHeight,b=t.filterWidth,I=t.inChannels,E=t.inHeight,C=t.inWidth,k=t.outHeight,D=t.outWidth,N=t.strideHeight,M=t.strideWidth,W=w-1-t.padInfo.top,P=b-1-t.padInfo.left,F=t.outChannels/I,z=0;z<x;++z)for(var j=0;j<I;++j)for(var K=0;K<E;++K)for(var Y=K-W,J=Math.max(0,Math.ceil(Y/N)),Z=Math.min(k,(w+Y)/N),ne=0;ne<C;++ne){for(var ce=ne-P,me=Math.max(0,Math.ceil(ce/M)),ge=Math.min(D,(b+ce)/M),ye=0,Be=J;Be<Z;++Be)for(var Ee=Be*N-Y,ke=me;ke<ge;++ke)for(var Ie=h*z+f*Be+p*ke,He=v*(w-1-Ee)+m*(b-1-(ke*M-ce))+y*j,Ae=0;Ae<F;++Ae)ye+=c[Ie+(j*F+Ae)]*d[He+Ae];o[i*z+s*K+u*ne+j]=ye}return r.toTensor()},B.prototype.depthwiseConv2DDerFilter=function(e,n,t){X([e,n],"depthwiseConv2DDerFilter");for(var r=t.strideHeight,o=t.strideWidth,a=t.filterHeight,i=t.filterWidth,s=he(t.filterShape,"float32"),u=t.padInfo.left,c=t.padInfo.top,l=t.outChannels/t.inChannels,h=this.bufferSync(e),f=this.bufferSync(n),p=0;p<a;++p)for(var d=Math.max(0,Math.ceil((c-p)/r)),g=Math.min(t.outHeight,(t.inHeight+c-p)/r),v=0;v<i;++v)for(var m=Math.max(0,Math.ceil((u-v)/o)),y=Math.min(t.outWidth,(t.inWidth+u-v)/o),x=0;x<t.outChannels;++x){for(var w=Math.trunc(x/l),b=x%l,I=0,E=0;E<t.batchSize;++E)for(var C=d;C<g;++C)for(var R=p+C*r-c,k=m;k<y;++k)I+=h.get(E,R,v+k*o-u,w)*f.get(E,C,k,x);s.set(I,p,v,w,b)}return s.toTensor()},B.prototype.tile=function(e,n){return X(e,"tile"),ff(this.bufferSync(e),n)},B.prototype.pad=function(e,n,t){X(e,"pad");var r=n.map(function(l,h){return l[0]+e.shape[h]+l[1]}),o=n.map(function(l){return l[0]}),a=this.bufferSync(e),i=he(r,e.dtype);0!==t&&i.values.fill(t);for(var s=0;s<e.size;s++){var u=a.indexToLoc(s),c=u.map(function(l,h){return l+o[h]});i.set.apply(i,[a.get.apply(a,u)].concat(c))}return i.toTensor()},B.prototype.transpose=function(e,n){X(e,"transpose");for(var t=new Array(e.rank),r=0;r<t.length;r++)t[r]=e.shape[n[r]];var o=this.readSync(e.dataId),a=he(t,e.dtype),i=this.bufferSync(e);for(r=0;r<e.size;++r){for(var s=i.indexToLoc(r),u=new Array(s.length),c=0;c<u.length;c++)u[c]=s[n[c]];var l=a.locToIndex(u);a.values[l]=o[r]}return a.toTensor()},B.prototype.gather=function(e,n,t){X([e,n],"gather");var r=e.shape.slice(),o=this.readSync(n.dataId);r[t]=o.length;for(var a=he(r,e.dtype),i=this.bufferSync(e),s=0;s<a.size;++s){var u=a.indexToLoc(s),c=u.slice();c[t]=o[u[t]];var l=i.locToIndex(c);a.values[s]=i.values[l]}return a.toTensor()},B.prototype.batchToSpaceND=function(e,n,t){X([e],"batchToSpaceND");var r=n.reduce(function(c,l){return c*l}),o=Ma(e.shape,n,r),a=Oa(o.length,n.length),i=Pa(e.shape,n,r),s=Qh(t,n.length),u=Zh(i,t,n.length);return e.reshape(o).transpose(a).reshape(i).slice(s,u)},B.prototype.spaceToBatchND=function(e,n,t){X([e],"spaceToBatchND");var r=n.reduce(function(l,h){return l*h}),o=[[0,0]];o.push.apply(o,t);for(var a=1+n.length;a<e.shape.length;++a)o.push([0,0]);var i=e.pad(o),s=Ma(i.shape,n,r,!1),u=Oa(s.length,n.length,!1),c=Pa(i.shape,n,r,!1);return i.reshape(s).transpose(u).reshape(c)},B.prototype.pool=function(e,n,t){X(e,"pool");for(var r=n.strideHeight,o=n.strideWidth,a=n.dilationHeight,i=n.dilationWidth,s=n.effectiveFilterHeight,u=n.effectiveFilterWidth,c=n.padInfo.top,l=n.padInfo.left,h="max"===t?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,f=this.readSync(e.dataId),p=he(n.outShape,e.dtype),d=p.values,g=n.outShape[1]*n.outShape[2]*n.outShape[3],v=n.outShape[2]*n.outShape[3],m=n.outShape[3],y=0;y<n.batchSize;++y)for(var x=y*g,w=y*e.strides[0],b=0;b<n.inChannels;++b)for(var I=0;I<n.outHeight;++I)for(var E=I*r-c,C=Math.max(0,E),R=Math.min(n.inHeight,s+E),k=x+I*v,D=0;D<n.outWidth;++D){for(var N=D*o-l,M=Math.max(0,N),W=Math.min(n.inWidth,u+N),P=h,F=0,z=0,j=C;j<R;j+=a){for(var K=w+j*e.strides[1],Y=M;Y<W;Y+=i){var J=f[K+Y*e.strides[2]+b];"max"===t&&P<J?P=J:"avg"===t&&(F+=J,z++)}if(isNaN(P))break}d[k+D*m+b]="avg"===t?F/z:P}return p.toTensor()},B.prototype.maxPool=function(e,n){return this.pool(e,n,"max")},B.prototype.maxPoolPositions=function(e,n){for(var t=he(n.outShape,"int32"),r=n.strideHeight,o=n.strideWidth,a=n.dilationHeight,i=n.dilationWidth,s=n.effectiveFilterHeight,u=n.effectiveFilterWidth,c=n.padInfo.top,l=n.padInfo.left,h=this.bufferSync(e),f=0;f<n.batchSize;++f)for(var p=0;p<n.inChannels;++p)for(var d=0;d<n.outHeight;++d){for(var g=d*r-c,v=g;v<0;)v+=a;for(var m=Math.min(n.inHeight,s+g),y=0;y<n.outWidth;++y){for(var x=y*o-l,w=x;w<0;)w+=i;for(var b=Math.min(n.inWidth,u+x),I=Number.NEGATIVE_INFINITY,E=-1,C=v;C<m;C+=a)for(var R=C-g,k=w;k<b;k+=i){var D=k-x,N=h.get(f,C,k,p);I<N&&(I=N,E=R*u+D)}t.set(E,f,d,y,p)}}return t.toTensor()},B.prototype.maxPoolBackprop=function(e,n,t,r){X([n,t],"maxPoolBackprop");for(var o=this.maxPoolPositions(n,r),a=r.strideHeight,i=r.strideWidth,s=r.dilationHeight,u=r.dilationWidth,c=r.effectiveFilterHeight,l=r.effectiveFilterWidth,h=l-1-r.padInfo.left,f=c-1-r.padInfo.top,p=he(n.shape,"float32"),d=this.bufferSync(o),g=this.bufferSync(e),v=0;v<r.batchSize;++v)for(var m=0;m<r.inChannels;++m)for(var y=0;y<r.inHeight;++y)for(var x=0;x<r.inWidth;++x){for(var w=y-f,b=x-h,I=0,E=0;E<c;E+=s){var C=(w+E)/a;if(!(C<0||C>=r.outHeight||Math.floor(C)!==C))for(var R=0;R<l;R+=u){var k=(b+R)/i;if(!(k<0||k>=r.outWidth||Math.floor(k)!==k)){var D=c*l-1-d.get(v,C,k,m)===E*l+R?1:0;0!=D&&(I+=g.get(v,C,k,m)*D)}}}p.set(I,v,y,x,m)}return p.toTensor()},B.prototype.avgPoolBackprop=function(e,n,t){X([e,n],"avgPoolBackprop");for(var r=t.strideHeight,o=t.strideWidth,a=t.filterHeight,i=t.filterWidth,s=t.dilationHeight,u=t.dilationWidth,c=t.effectiveFilterHeight,l=t.effectiveFilterWidth,h=l-1-t.padInfo.left,f=c-1-t.padInfo.top,p=he(n.shape,"float32"),d=1/(a*i),g=this.bufferSync(e),v=0;v<t.batchSize;++v)for(var m=0;m<t.inChannels;++m)for(var y=0;y<t.inHeight;++y)for(var x=0;x<t.inWidth;++x){for(var w=y-f,b=x-h,I=0,E=0;E<c;E+=s){var C=(w+E)/r;if(!(C<0||C>=t.outHeight||Math.floor(C)!==C))for(var R=0;R<l;R+=u){var k=(b+R)/o;k<0||k>=t.outWidth||Math.floor(k)!==k||(I+=g.get(v,C,k,m))}}p.set(I*d,v,y,x,m)}return p.toTensor()},B.prototype.pool3d=function(e,n,t){X(e,"pool3d");for(var r=n.strideDepth,o=n.strideHeight,a=n.strideWidth,i=n.dilationDepth,s=n.dilationHeight,u=n.dilationWidth,c=n.effectiveFilterDepth,l=n.effectiveFilterHeight,h=n.effectiveFilterWidth,f=n.padInfo.front,p=n.padInfo.top,d=n.padInfo.left,g="max"===t?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,v=this.readSync(e.dataId),m=he(n.outShape,e.dtype),y=m.values,x=n.outShape[1]*n.outShape[2]*n.outShape[3]*n.outShape[4],w=n.outShape[2]*n.outShape[3]*n.outShape[4],b=n.outShape[3]*n.outShape[4],I=n.outShape[4],E=0;E<n.batchSize;++E)for(var C=E*x,R=E*e.strides[0],k=0;k<n.inChannels;++k)for(var D=0;D<n.outDepth;++D){for(var N=D*r-f,M=N;M<0;)M+=i;for(var W=Math.min(n.inDepth,c+N),P=C+D*w,F=0;F<n.outHeight;++F){for(var z=F*o-p,j=z;j<0;)j+=s;for(var K=Math.min(n.inHeight,l+z),Y=P+F*b,J=0;J<n.outWidth;++J){for(var Z=J*a-d,ne=Z;ne<0;)ne+=u;for(var ce=Math.min(n.inWidth,h+Z),me=Y+J*I,ge=g,ye=0,Be=0,Ee=M;Ee<W;Ee+=i){for(var ke=R+Ee*e.strides[1],Ie=j;Ie<K;Ie+=s){for(var He=ke+Ie*e.strides[2],Ae=ne;Ae<ce;Ae+=u){var Te=v[He+Ae*e.strides[3]+k];if("max"===t&&ge<Te?ge=Te:"avg"===t&&(ye+=Te,Be++),isNaN(ge))break}if(isNaN(ge))break}if(isNaN(ge))break}y[me+k]="avg"===t?ye/Be:ge}}}return m.toTensor()},B.prototype.avgPool3d=function(e,n){return X(e,"avgPool3d"),this.pool3d(e,n,"avg").toFloat()},B.prototype.avgPool3dBackprop=function(e,n,t){X([e,n],"avgPool3dBackprop");for(var r=t.strideDepth,o=t.strideHeight,a=t.strideWidth,i=t.filterDepth,s=t.filterHeight,u=t.filterWidth,c=t.dilationDepth,l=t.dilationHeight,h=t.dilationWidth,f=t.effectiveFilterDepth,p=t.effectiveFilterHeight,d=t.effectiveFilterWidth,g=f-1-t.padInfo.front,v=d-1-t.padInfo.left,m=p-1-t.padInfo.top,y=he(n.shape,"float32"),x=1/(i*s*u),w=this.bufferSync(e),b=0;b<t.batchSize;++b)for(var I=0;I<t.inChannels;++I)for(var E=0;E<t.inDepth;++E)for(var C=0;C<t.inHeight;++C)for(var R=0;R<t.inWidth;++R){for(var k=E-g,D=C-m,N=R-v,M=0,W=0;W<f;W+=c){var P=(k+W)/r;if(!(P<0||P>=t.outDepth||Math.floor(P)!==P))for(var F=0;F<p;F+=l){var z=(D+F)/o;if(!(z<0||z>=t.outHeight||Math.floor(z)!==z))for(var j=0;j<d;j+=h){var K=(N+j)/a;K<0||K>=t.outWidth||Math.floor(K)!==K||(M+=w.get(b,P,z,K,I))}}}y.set(M*x,b,E,C,R,I)}return y.toTensor()},B.prototype.maxPool3d=function(e,n){return X(e,"maxPool3d"),this.pool3d(e,n,"max").toFloat()},B.prototype.maxPool3dPositions=function(e,n){for(var t=he(n.outShape,"int32"),r=n.strideDepth,o=n.strideHeight,a=n.strideWidth,i=n.dilationDepth,s=n.dilationHeight,u=n.dilationWidth,c=n.effectiveFilterDepth,l=n.effectiveFilterHeight,h=n.effectiveFilterWidth,f=n.padInfo.front,p=n.padInfo.top,d=n.padInfo.left,g=this.bufferSync(e),v=0;v<n.batchSize;++v)for(var m=0;m<n.inChannels;++m)for(var y=0;y<n.outDepth;++y){for(var x=y*r-f,w=x;w<0;)w+=i;for(var b=Math.min(n.inDepth,c+x),I=0;I<n.outHeight;++I){for(var E=I*o-p,C=E;C<0;)C+=s;for(var R=Math.min(n.inHeight,l+E),k=0;k<n.outWidth;++k){for(var D=k*a-d,N=D;N<0;)N+=u;for(var M=Math.min(n.inWidth,h+D),W=Number.NEGATIVE_INFINITY,P=-1,F=w;F<b;F+=i)for(var z=F-x,j=C;j<R;j+=s)for(var K=j-E,Y=N;Y<M;Y+=u){var J=Y-D,Z=g.get(v,F,j,Y,m);W<=Z&&(W=Z,P=z*l*h+K*l+J)}t.set(P,v,y,I,k,m)}}}return t.toTensor()},B.prototype.maxPool3dBackprop=function(e,n,t,r){X([n,t],"maxPool3dBackprop");for(var o=this.maxPool3dPositions(n,r),a=r.strideDepth,i=r.strideHeight,s=r.strideWidth,u=r.dilationDepth,c=r.dilationHeight,l=r.dilationWidth,h=r.effectiveFilterDepth,f=r.effectiveFilterHeight,p=r.effectiveFilterWidth,d=h-1-r.padInfo.front,g=p-1-r.padInfo.left,v=f-1-r.padInfo.top,m=he(n.shape,"float32"),y=this.bufferSync(o),x=this.bufferSync(e),w=0;w<r.batchSize;++w)for(var b=0;b<r.inChannels;++b)for(var I=0;I<r.inDepth;++I)for(var E=0;E<r.inHeight;++E)for(var C=0;C<r.inWidth;++C){for(var R=I-d,k=E-v,D=C-g,N=0,M=0;M<h;M+=u){var W=(R+M)/a;if(!(W<0||W>=r.outDepth||Math.floor(W)!==W))for(var P=0;P<f;P+=c){var F=(k+P)/i;if(!(F<0||F>=r.outHeight||Math.floor(F)!==F))for(var z=0;z<p;z+=l){var j=(D+z)/s;if(!(j<0||j>=r.outWidth||Math.floor(j)!==j)){var K=h*f*p-1-y.get(w,W,F,j,b)===M*f*p+P*p+z?1:0;0!=K&&(N+=x.get(w,W,F,j,b)*K)}}}}m.set(N,w,I,E,C,b)}return m.toTensor()},B.prototype.cast=function(e,n){return Gs(e,n,this)},B.prototype.reshape=function(e,n){return Va(e,n)},B.prototype.avgPool=function(e,n){return X(e,"avgPool"),this.pool(e,n,"avg").toFloat()},B.prototype.resizeBilinear=function(e,n,t,r){X(e,"resizeBilinear");for(var o=e.shape,a=o[0],i=o[1],s=o[2],u=o[3],c=this.readSync(e.dataId),l=new Float32Array(ie([a,n,t,u])),h=[r&&1<n?i-1:i,r&&1<t?s-1:s],f=[r&&1<n?n-1:n,r&&1<t?t-1:t],p=0,d=h[0]/f[0],g=h[1]/f[1],v=0;v<a;v++)for(var m=0;m<n;m++)for(var y=d*m,x=Math.floor(y),w=y-x,b=Math.min(i-1,Math.ceil(y)),I=v*e.strides[0]+x*e.strides[1],E=v*e.strides[0]+b*e.strides[1],C=0;C<t;C++)for(var R=g*C,k=Math.floor(R),D=R-k,N=Math.min(s-1,Math.ceil(R)),M=I+k*e.strides[2],W=E+k*e.strides[2],P=I+N*e.strides[2],F=E+N*e.strides[2],z=0;z<u;z++){var j=c[M+z],K=c[W+z],Y=j+(c[P+z]-j)*D;l[p++]=Y+(K+(c[F+z]-K)*D-Y)*w}return Je(l,[a,n,t,u])},B.prototype.resizeBilinearBackprop=function(e,n,t){X([e,n],"resizeBilinearBackprop");for(var r=n.shape,o=r[0],a=r[1],i=r[2],s=r[3],u=e.shape,c=u[1],l=u[2],h=new Float32Array(o*a*i*s),f=[t&&1<c?a-1:a,t&&1<l?i-1:i],p=[t&&1<c?c-1:c,t&&1<l?l-1:l],d=f[0]/p[0],g=f[1]/p[1],v=this.readSync(e.dataId),m=0,y=0;y<o;y++)for(var x=y*n.strides[0],w=0;w<c;w++)for(var b=w*d,I=Math.floor(b),E=Math.min(Math.ceil(b),a-1),C=x+I*n.strides[1],R=x+E*n.strides[1],k=b-I,D=1-k,N=0;N<l;N++)for(var M=N*g,W=Math.floor(M),P=Math.min(Math.ceil(M),i-1),F=M-W,z=1-F,j=C+W*n.strides[2],K=C+P*n.strides[2],Y=R+W*n.strides[2],J=R+P*n.strides[2],Z=D*z,ne=D*F,ce=k*z,me=k*F,ge=0;ge<s;ge++){var ye=v[m++];h[j+ge]+=ye*Z,h[K+ge]+=ye*ne,h[Y+ge]+=ye*ce,h[J+ge]+=ye*me}return ln(h,[o,i,a,s],n.dtype)},B.prototype.resizeNearestNeighbor=function(e,n,t,r){X(e,"resizeNearestNeighbor");for(var o=e.shape,a=o[0],i=o[1],s=o[2],u=o[3],c=this.readSync(e.dataId),l=new Float32Array(a*n*t*u),h=[r&&1<n?i-1:i,r&&1<t?s-1:s],f=[r&&1<n?n-1:n,r&&1<t?t-1:t],p=h[0]/f[0],d=h[1]/f[1],g=0,v=0;v<a;v++)for(var m=v*e.strides[0],y=0;y<n;y++)for(var x=p*y,w=m+Math.min(i-1,r?Math.round(x):Math.floor(x))*e.strides[1],b=0;b<t;b++)for(var I=d*b,E=w+Math.min(s-1,r?Math.round(I):Math.floor(I))*e.strides[2],C=0;C<u;C++)l[g++]=c[E+C];return Je(l,[a,n,t,u],e.dtype)},B.prototype.resizeNearestNeighborBackprop=function(e,n,t){X([e,n],"resizeNearestNeighborBackprop");for(var r=n.shape,o=r[0],a=r[1],i=r[2],s=r[3],u=e.shape,c=u[1],l=u[2],h=new Float32Array(o*a*i*s),f=this.readSync(e.dataId),p=[t&&1<c?a-1:a,t&&1<l?i-1:i],d=[t&&1<c?c-1:c,t&&1<l?l-1:l],g=p[0]/d[0],v=p[1]/d[1],m=1/g,y=1/v,x=2*Math.ceil(m)+2,w=2*Math.ceil(y)+2,b=0;b<o;b++)for(var I=b*n.strides[0],E=0;E<a;E++)for(var C=I+E*n.strides[1],R=Math.floor(E*m),k=Math.floor(R-x/2),D=0;D<i;D++)for(var N=C+D*n.strides[2],M=Math.floor(D*y),W=Math.floor(M-w/2),P=0;P<s;P++){for(var F=0,z=0;z<x;z++){var j=z+k;if(!(j<0||c<=j)){var K=I+j*e.strides[1],Y=j*g;if(E===Math.min(a-1,t?Math.round(Y):Math.floor(Y)))for(var J=0;J<w;J++){var Z=J+W;if(!(Z<0||l<=Z)){var ne=K+Z*e.strides[2],ce=Z*v;D===Math.min(i-1,t?Math.round(ce):Math.floor(ce))&&(F+=f[ne+P])}}}}h[N+P]=F}return ln(h,n.shape,n.dtype)},B.prototype.batchNormalization=function(e,n,t,r,o,a){X([e,n,t,o,a],"batchNorm");for(var i=this.readSync(e.dataId),s=this.readSync(n.dataId),u=this.readSync(t.dataId),c=o?this.readSync(o.dataId):new Float32Array([1]),l=a?this.readSync(a.dataId):new Float32Array([0]),h=new Float32Array(i.length),f=l.length,p=c.length,d=u.length,g=s.length,v=0,m=0,y=0,x=0,w=0;w<i.length;++w)h[w]=l[v++]+(i[w]-s[m++])*c[y++]/Math.sqrt(u[x++]+r),f<=v&&(v=0),g<=m&&(m=0),p<=y&&(y=0),d<=x&&(x=0);return ln(h,e.shape)},B.prototype.localResponseNormalization4D=function(e,n,t,r,o){X(e,"localResponseNormalization4D");var a=e.shape[3],i=a-1,s=this.readSync(e.dataId),u=e.size,c=new Float32Array(u);function l(d){for(var g=d%a,v=d-g+Math.max(0,g-n),m=d-g+Math.min(g+n,i),y=0;v<=m;v++){var x=s[v];y+=x*x}return y}for(var h=0;h<u;h++){var f=l(h),p=s[h]*Math.pow(t+r*f,-o);c[h]=p}return ln(c,e.shape)},B.prototype.LRNGrad=function(e,n,t,r,o,a,i){X(e,"LRNGrad");for(var s=e.shape[3],u=this.readSync(e.dataId),c=this.readSync(n.dataId),l=this.readSync(t.dataId),h=new Float32Array(e.size),f=e.size,p=0;p<f;p++){for(var d=p%s,g=p-d+Math.max(0,d-r),v=p-d+Math.min(s,d+r+1),m=0,y=g;y<v;y++)m+=Math.pow(c[y],2);for(m=a*m+o,y=g;y<v;y++){var x=-2*a*i*c[y]*l[p]/m;p===y&&(x+=Math.pow(m,-i)),h[y]+=x*=u[p]}}return ln(h,e.shape)},B.prototype.multinomial=function(e,n,t,r){X(e,"multinomial");for(var o=n?e:Yn(e),a=o.shape[0],i=o.shape[1],s=Se([a,t],"int32"),u=this.readSync(s.dataId),c=this.readSync(o.dataId),l=0;l<a;++l){var h=l*i,f=new Float32Array(i-1);f[0]=c[h];for(var p=1;p<f.length;++p)f[p]=f[p-1]+c[h+p];for(var d=Ta(r.toString()),g=l*t,v=0;v<t;++v){var m=d();u[g+v]=f.length;for(var y=0;y<f.length;y++)if(m<f[y]){u[g+v]=y;break}}}return s},B.prototype.oneHot=function(e,n,t,r){X(e,"oneHot");var o=new Float32Array(e.size*n);o.fill(r);for(var a=this.readSync(e.dataId),i=0;i<e.size;++i)0<=a[i]&&a[i]<n&&(o[i*n+a[i]]=t);return lt(o,[e.size,n],"int32")},B.prototype.nonMaxSuppression=function(e,n,t,r,o){return X(e,"nonMaxSuppression"),js(this.readSync(e.dataId),this.readSync(n.dataId),t,r,o)},B.prototype.fft=function(e){return this.fftBatch(e,!1)},B.prototype.ifft=function(e){return this.fftBatch(e,!0)},B.prototype.fftBatch=function(e,n){for(var t=e.shape[0],r=e.shape[1],o=he(e.shape,"float32"),a=he(e.shape,"float32"),i=Cn(e).as2D(t,r),s=Bn(e).as2D(t,r),u=0;u<t;u++)for(var c=i.slice([u,0],[1,r]),l=s.slice([u,0],[1,r]),h=$e(c,l),f=this.readSync(this.fftImpl(h,n).dataId),p=0;p<r;p++){var d=uf(f,p);o.values[u*r+p]=d.real,a.values[u*r+p]=d.imag}return $e(o.toTensor(),a.toTensor()).as2D(t,r)},B.prototype.fftImpl=function(e,n){var t=e.as1D(),r=t.size;if(this.isExponentOf2(r)){var o=this.fftRadix2(t,r,n).as2D(e.shape[0],e.shape[1]);return n&&(o=$e(Cn(o).div($(r)),Bn(o).div($(r)))),o}var a=this.readSync(e.dataId),i=function(s){for(var u=new Float32Array(s.length/2),c=new Float32Array(s.length/2),l=0;l<s.length;l+=2)u[l/2]=s[l],c[l/2]=s[l+1];return{real:u,imag:c}}(this.fourierTransformByMatmul(a,r,n));return $e(i.real,i.imag).as2D(e.shape[0],e.shape[1])},B.prototype.isExponentOf2=function(e){return 0==(e&e-1)},B.prototype.fftRadix2=function(e,n,t){if(1===n)return e;var r=this.readSync(e.dataId),o=n/2,a=function(g){for(var v=Math.ceil(g.length/4),m=new Float32Array(v),y=new Float32Array(v),x=0;x<g.length;x+=4)m[Math.floor(x/4)]=g[x],y[Math.floor(x/4)]=g[x+1];return{real:m,imag:y}}(r),i=$e(a.real,a.imag).as1D(),s=function(g){for(var v=Math.floor(g.length/4),m=new Float32Array(v),y=new Float32Array(v),x=2;x<g.length;x+=4)m[Math.floor(x/4)]=g[x],y[Math.floor(x/4)]=g[x+1];return{real:m,imag:y}}(r),u=$e(s.real,s.imag).as1D();i=this.fftRadix2(i,o,t),u=this.fftRadix2(u,o,t);var c=function(g,v){for(var m=new Float32Array(g/2),y=new Float32Array(g/2),x=0;x<Math.ceil(g/2);x++){var w=(v?2:-2)*Math.PI*(x/g);m[x]=Math.cos(w),y[x]=Math.sin(w)}return{real:m,imag:y}}(n,t),l=$e(c.real,c.imag).mul(u),h=i.add(l),f=i.sub(l),p=Cn(h).concat(Cn(f)),d=Bn(h).concat(Bn(f));return $e(p,d).as1D()},B.prototype.fourierTransformByMatmul=function(e,n,t){for(var r=new Float32Array(2*n),o=0;o<n;o++){for(var a=0,i=0,s=0;s<n;s++){var u=(v=(t?2:-2)*Math.PI*(o*s/n),{real:Math.cos(v),imag:Math.sin(v)}),c=uf(e,s);a+=c.real*u.real-c.imag*u.imag,i+=c.real*u.imag+c.imag*u.real}t&&(a/=n,i/=n),f=i,(l=r)[2*(p=o)]=a,l[2*p+1]=f}var l,f,p,v;return r},B.prototype.depthToSpace=function(e,n,t){S("NHWC"===t,function(){return"Only NHWC dataFormat supported on CPU for depthToSpace. Got "+t}),S(1<n,function(){return"blockSize should be > 1 for depthToSpace, but was: "+n});for(var r=e.shape[0],o=e.shape[1],a=e.shape[2],i=e.shape[3],s=o*n,u=a*n,c=i/(n*n),l=this.readSync(e.dataId),h=new Float32Array(r*s*u*c),f=0,p=0;p<r;++p)for(var d=0;d<s;++d)for(var g=Math.floor(d/n),v=d%n,m=0;m<u;++m)for(var y=Math.floor(m/n),x=(v*n+m%n)*c,w=0;w<c;++w)h[f++]=l[w+x+i*(y+a*(g+o*p))];return ln(h,[r,s,u,c])},B.prototype.broadcastedBinaryOp=function(e,n,t,r){var o=ve(e.shape,n.shape),a=he(o,t),i=this.readSync(e.dataId),s=this.readSync(n.dataId),u=ht(e.shape,o),c=ht(n.shape,o),l=a.values;if(u.length+c.length===0)for(var h=0;h<l.length;++h)l[h]=r(i[h%i.length],s[h%s.length]);else{var f=this.bufferSync(e),p=this.bufferSync(n),d=function(g){var v=a.indexToLoc(g),m=v.slice(-e.rank);u.forEach(function(b){return m[b]=0});var y=f.locToIndex(m),x=v.slice(-n.rank);c.forEach(function(b){return x[b]=0});var w=p.locToIndex(x);l[g]=r(i[y],s[w])};for(h=0;h<l.length;++h)d(h)}return a.toTensor()},B.prototype.broadcastedBinaryComplexOp=function(e,n,t){var r=ve(e.shape,n.shape),o=he(r,"float32"),a=he(r,"float32"),i=this.readSync(e.dataId),s=this.readSync(n.dataId),u=ht(e.shape,r),c=ht(n.shape,r),l=o.values,h=a.values;if(u.length+c.length===0)for(var f=0;f<l.length;f++){var p=f%i.length,d=f%s.length,g=t(i[2*p],i[2*p+1],s[2*d],s[2*d+1]);l[f]=g.real,h[f]=g.imag}else{var v=this.bufferSync(this.data.get(e.dataId).complexTensors.real),m=this.bufferSync(this.data.get(n.dataId).complexTensors.real),y=function(x){var w=o.indexToLoc(x),b=w.slice(-e.rank);u.forEach(function(k){return b[k]=0});var I=v.locToIndex(b),E=w.slice(-n.rank);c.forEach(function(k){return E[k]=0});var C=m.locToIndex(E),R=t(i[2*I],i[2*I+1],s[2*C],s[2*C+1]);l[x]=R.real,h[x]=R.imag};for(f=0;f<l.length;f++)y(f)}return this.complex(o.toTensor(),a.toTensor())},B.prototype.split=function(e,n,t){return hf(e,n,t)},B.prototype.dispose=function(){},B.prototype.floatPrecision=function(){return 32},B.prototype.epsilon=function(){return 1e-7},B.prototype.cropAndResize=function(e,n,t,r,o,a){for(var i=e.shape,s=i[0],u=i[1],c=i[2],l=i[3],h=n.shape[0],f=r[0],p=r[1],d=he([h,f,p,l],"float32"),g=this.readSync(n.dataId),v=this.readSync(t.dataId),m=this.readSync(e.dataId),y=e.strides,x=d.strides,w=0;w<h;w++){var b=4*w,I=g[b],E=g[1+b],C=g[2+b],R=g[3+b],k=v[w];if(!(s<=k))for(var D=1<f?(C-I)*(u-1)/(f-1):0,N=1<p?(R-E)*(c-1)/(p-1):0,M=0;M<f;M++){var W=1<f?I*(u-1)+M*D:.5*(I+C)*(u-1);if(W<0||u-1<W)for(var P=0;P<p;P++)for(var F=0;F<l;F++){var z=F+P*x[2]+M*x[1]+w*x[0];d.values[z]=a}else if("bilinear"===o){var j=Math.floor(W),K=Math.ceil(W),Y=W-j;for(P=0;P<p;P++)if((Ee=1<p?E*(c-1)+P*N:.5*(E+R)*(c-1))<0||c-1<Ee)for(F=0;F<l;F++)d.values[z=F+P*x[2]+M*x[1]+w*x[0]]=a;else{var J=Math.floor(Ee),Z=Math.ceil(Ee),ne=Ee-J;for(F=0;F<l;F++){var ce=m[z=F+J*y[2]+j*y[1]+k*y[0]],me=m[z=F+Z*y[2]+j*y[1]+k*y[0]],ge=m[z=F+J*y[2]+K*y[1]+k*y[0]],ye=ce+(me-ce)*ne,Be=ge+(m[z=F+Z*y[2]+K*y[1]+k*y[0]]-ge)*ne;d.values[z=F+P*x[2]+M*x[1]+w*x[0]]=ye+(Be-ye)*Y}}}else for(P=0;P<p;++P){var Ee;if((Ee=1<p?E*(c-1)+P*N:.5*(E+R)*(c-1))<0||c-1<Ee)for(F=0;F<l;F++)d.values[z=F+P*x[2]+M*x[1]+w*x[0]]=a;else{var ke=Math.round(Ee),Ie=Math.round(W);for(F=0;F<l;F++)d.values[F+P*x[2]+M*x[1]+w*x[0]]=m[F+ke*y[2]+Ie*y[1]+k*y[0]]}}}}return d.toTensor()},B.prototype.sparseToDense=function(e,n,t,r){var o=Do(0,e,t);return this.scatter(e,n,t,o.outputSize,o.sliceSize,o.numUpdates,o.sliceRank,o.strides,r,!1)},B.prototype.gatherND=function(e,n){var t=n.shape,r=t[t.length-1],o=Os(e,n),a=o[0],i=o[1],s=o[2],u=o[3];if(0===i)return Je([],a,e.dtype);for(var c=new Or([i,s],e.dtype),l=this.readSync(n.dataId),h=this.readSync(e.dataId),f=0;f<i;f++){for(var p=[],d=0,g=0;g<r;g++){var v=l[f*r+g];d+=v*u[g],p.push(v)}if(d<0||d>=e.size/s)throw new Error("Invalid indices: "+p+" does not index into "+e.shape);for(var m=0;m<s;m++)c.values[f*s+m]=h[d*s+m]}return c.toTensor().reshape(a)},B.prototype.scatterND=function(e,n,t){var r=Do(0,e,t),o=r.sliceRank,a=r.numUpdates,i=r.sliceSize,s=r.strides,u=r.outputSize,c=$(0);return this.scatter(e,n,t,u,i,a,o,s,c,!0)},B.prototype.fill=function(e,n,t){var r=vo(t=t||Fr(n),ie(e));return r.fill(n),A.makeTensor(r,e,t,this)},B.prototype.onesLike=function(e){if("string"===e.dtype)throw new Error("onesLike is not supported for string tensors");return this.fill(e.shape,1,e.dtype)},B.prototype.zerosLike=function(e){var n=vo(e.dtype,ie(e.shape));return this.makeOutput(n,e.shape,e.dtype)},B.prototype.linspace=function(e,n,t){return Hs(e,n,t)},B.prototype.scatter=function(e,n,t,r,o,a,i,s,u,c){var l=[r/o,o],h=this.readSync(e.dataId),f=this.readSync(n.dataId);if(0===r)return Je([],t,n.dtype);var p=new Or(l,n.dtype);p.values.fill(this.readSync(u.dataId)[0]);for(var d=0;d<a;d++){for(var g=[],v=0,m=0;m<i;m++){var y=h[d*i+m];g.push(y),v+=y*s[m]}if(v<0||r/o<=v)throw new Error("Invalid indices: "+g+" does not index into "+t);for(var x=0;x<o;x++)c?p.values[v*o+x]+=f[d*o+x]:p.values[v*o+x]=0===n.rank?f[0]:f[d*o+x]}return p.toTensor().reshape(t)},B);function B(){var e=Rv.call(this)||this;return e.blockSize=48,e.firstUse=!0,e.data=new Ws(e,A),e}A.registerBackend("cpu",function(){return new Ly},1);for(var Tu=0,kv=[{kernelName:"NonMaxSuppressionV5",backendName:"cpu",kernelFunc:function(e){var n=e.inputs,r=e.attrs,a=n.boxes,i=n.scores,u=r.maxOutputSize,c=r.iouThreshold,l=r.scoreThreshold,h=r.softNmsSigma,f=e.backend;X(a,"NonMaxSuppressionWithScore");var p=Ks(f.data.get(a.dataId).values,f.data.get(i.dataId).values,u,c,l,h);return[p.selectedIndices,p.selectedScores]}},{kernelName:"Square",backendName:"cpu",kernelFunc:function(e){var r=e.inputs.x,o=e.backend;X(r,"square");for(var a=o.data.get(r.dataId).values,i=new Float32Array(a.length),s=0;s<a.length;++s){var u=a[s];i[s]=u*u}return{dataId:o.write(i,r.shape,r.dtype),shape:r.shape,dtype:r.dtype}}},{kernelName:Po,backendName:"cpu",kernelFunc:function(e){var n=e.inputs,o=n.a,a=n.b,i=e.backend;X([o,a],Po);var s=i.data.get(o.dataId).values,u=i.data.get(a.dataId).values,c=function(f,p,d,g,v,m){var y=ve(f,p),x=y.length,w=Fn(y),b=Nr(v,ie(y)),I=f.length,E=p.length,C=Fn(f),R=Fn(p),k=ht(f,y),D=ht(p,y);if(k.length+D.length===0)for(var N=0;N<b.length;++N)b[N]=m(d[N%d.length],g[N%g.length]);else{var M=function(W){var P=Gl(W,x,w),F=P.slice(-I);k.forEach(function(Y){return F[Y]=0});var z=cs(F,I,C),j=P.slice(-E);D.forEach(function(Y){return j[Y]=0});var K=cs(j,E,R);b[W]=m(d[z],g[K])};for(N=0;N<b.length;++N)M(N)}return[b,y]}(o.shape,a.shape,s,u,o.dtype,function(f,p){var d=f-p;return d*d}),h=c[1];return{dataId:i.write(c[0],h,o.dtype),shape:h,dtype:o.dtype}}}];Tu<kv.length;Tu++)es(kv[Tu]);for(var qr,Wy=function(e){this.variableNames=["A"];var n=an(),t=e[0],r=e[1];this.outputShape=e,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n        vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+r+".0, "+t+".0);\n\n        vec4 values = "+n.texture2D+"(A, uv);\n        float value;\n        if (depth == 0) {\n          value = values.r;\n        } else if (depth == 1) {\n          value = values.g;\n        } else if (depth == 2) {\n          value = values.b;\n        } else if (depth == 3) {\n          value = values.a;\n        }\n\n        setOutput(floor(value * 255.0 + 0.5));\n      }\n    "},zy=function(e){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var n=an(),t=e[0],r=e[1];this.outputShape=e,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n\n        vec4 result = vec4(0.);\n\n        for(int row=0; row<=1; row++) {\n          for(int col=0; col<=1; col++) {\n            texC = coords[1] + row;\n            depth = coords[2] + col;\n\n            vec2 uv = (vec2(texC, texR) + halfCR) /\n                       vec2("+r+".0, "+t+".0);\n            vec4 values = "+n.texture2D+"(A, uv);\n            float value;\n            if (depth == 0) {\n              value = values.r;\n            } else if (depth == 1) {\n              value = values.g;\n            } else if (depth == 2) {\n              value = values.b;\n            } else if (depth == 3) {\n              value = values.a;\n            }\n\n            result[row * 2 + col] = floor(value * 255.0 + 0.5);\n          }\n        }\n\n        "+n.output+" = result;\n      }\n    "},Nu=0,Sv=[{kernelName:"FromPixels",backendName:"webgl",kernelFunc:function(e){var t=e.backend,o=e.inputs.pixels,i=typeof HTMLVideoElement<"u"&&o instanceof HTMLVideoElement,s=typeof HTMLImageElement<"u"&&o instanceof HTMLImageElement,u=i?[o.videoWidth,o.videoHeight]:[o.width,o.height],c=u[0],l=u[1],h=[l,c],f=[l,c,e.attrs.numChannels];(s||i)&&(null==qr&&(qr=document.createElement("canvas").getContext("2d")),qr.canvas.width=c,qr.canvas.height=l,qr.drawImage(o,0,0,c,l),o=qr.canvas);var p=t.makeTensorInfo(h,"int32");t.texData.get(p.dataId).usage=xn.PIXELS,t.gpgpu.uploadPixelDataToTexture(t.getTexture(p.dataId),o);var d=q().getBool("WEBGL_PACK")?new zy(f):new Wy(f),g=t.runWebGLProgram(d,[p],"int32");return t.disposeData(p.dataId),g}},{kernelName:"NonMaxSuppressionV5",backendName:"webgl",kernelFunc:function(e){var n=e.inputs,t=e.backend,r=e.attrs;ka("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead");var i=n.scores,u=r.maxOutputSize,c=r.iouThreshold,l=r.scoreThreshold,h=r.softNmsSigma,f=t,p=Ks(f.readSync(n.boxes.dataId),f.readSync(i.dataId),u,c,l,h);return[p.selectedIndices,p.selectedScores]}},{kernelName:"Square",backendName:"webgl",kernelFunc:function(e){var r=e.inputs.x,o=e.backend,a=new pe(r.shape,"return x * x;");return o.runWebGLProgram(a,[r],r.dtype)}},{kernelName:Po,backendName:"webgl",kernelFunc:function(e){var n=e.inputs,o=n.a,a=n.b,i=e.backend,s=q().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new ft("return (a - b) * (a - b);",o.shape,a.shape):new Oe("return (a - b) * (a - b);",o.shape,a.shape);return i.compileAndRun(s,[o,a])}}];Nu<Sv.length;Nu++)es(Sv[Nu]);for(var Fu=0,Dv=[{kernelName:"Square",gradFunc:function(e,n){var t=n[0];return{x:function(){return e.mul(t.toFloat().mul(2))}}}},{kernelName:Po,gradFunc:function(e,n){var t=n[0],r=n[1],o=$(2);return{a:function(){return nn(e,nn(o,Ge(t,r)))},b:function(){return nn(e,nn(o,Ge(r,t)))}}}}];Fu<Dv.length;Fu++)Tl(Dv[Fu]);var Uy=(qo.prototype.fetch=function(e,n){return fetch(e,n)},qo.prototype.now=function(){return performance.now()},qo.prototype.encode=function(e,n){if("utf-8"!==n&&"utf8"!==n)throw new Error("Browser's encoder only supports utf-8, but got "+n);return null==this.textEncoder&&(this.textEncoder=new TextEncoder),this.textEncoder.encode(e)},qo.prototype.decode=function(e,n){return new TextDecoder(n).decode(e)},qo);function qo(){}q().get("IS_BROWSER")&&q().setPlatform("browser",new Uy);var Mu,Vy=(jo.prototype.fetch=function(e,n){return null!=q().global.fetch?q().global.fetch(e,n):(null==Mu&&(Mu=require("node-fetch")),Mu(e,n))},jo.prototype.now=function(){var e=process.hrtime();return 1e3*e[0]+e[1]/1e6},jo.prototype.encode=function(e,n){if("utf-8"!==n&&"utf8"!==n)throw new Error("Node built-in encoder only supports utf-8, but got "+n);return this.textEncoder.encode(e)},jo.prototype.decode=function(e,n){return 0===e.length?"":new this.util.TextDecoder(n).decode(e)},jo);function jo(){this.util=require("util"),this.textEncoder=new this.util.TextEncoder}q().get("IS_NODE")&&q().setPlatform("node",new Vy);var Ou={float32:4,int32:4,uint16:2,uint8:1,bool:1},ai=4;function Av(e,n){for(var t={},r=0,o=function(s){var u=s.name,c=s.dtype,l=s.shape,h=ie(l),f=void 0;if("quantization"in s){var p=s.quantization;if("uint8"!==p.dtype&&"uint16"!==p.dtype)throw new Error("Weight "+s.name+" has unknown quantization dtype "+p.dtype+". Supported quantization dtypes are: 'uint8' and 'uint16'.");var d=Ou[p.dtype],g=e.slice(r,r+h*d),v="uint8"===p.dtype?new Uint8Array(g):new Uint16Array(g);if("float32"===c)f=Float32Array.from(v,function(I){return I*p.scale+p.min});else{if("int32"!==c)throw new Error("Unsupported dtype in weight '"+u+"': "+c);f=Int32Array.from(v,function(I){return Math.round(I*p.scale+p.min)})}r+=h*d}else if("string"===c){var m=ie(s.shape);f=[];for(var y=0;y<m;y++){var x=new Uint32Array(e.slice(r,r+ai))[0];r+=ai;var w=new Uint8Array(e.slice(r,r+x));f.push(w),r+=x}}else{var b=Ou[c];if(g=e.slice(r,r+h*b),"float32"===c)f=new Float32Array(g);else if("int32"===c)f=new Int32Array(g);else{if("bool"!==c)throw new Error("Unsupported dtype in weight '"+u+"': "+c);f=new Uint8Array(g)}r+=h*b}t[u]=Je(f,l,c)},a=0,i=n;a<i.length;a++)o(i[a]);return t}var Pu=typeof Buffer<"u"&&(typeof Blob>"u"||typeof atob>"u"||typeof btoa>"u");function Tv(e){return Pu?Buffer.byteLength(e):new Blob([e]).size}function Bu(e){var n=0;e.forEach(function(o){n+=o.byteLength});var t=new Uint8Array(n),r=0;return e.forEach(function(o){t.set(new Uint8Array(o),r),r+=o.byteLength}),t.buffer}function Nv(e){for(e=e.trim();e.endsWith("/");)e=e.slice(0,e.length-1);var n=e.split("/");return n[n.length-1]}function Ko(e){if(e.modelTopology instanceof ArrayBuffer)throw new Error("Expected JSON model topology, received ArrayBuffer.");return{dateSaved:new Date,modelTopologyType:"JSON",modelTopologyBytes:null==e.modelTopology?0:Tv(JSON.stringify(e.modelTopology)),weightSpecsBytes:null==e.weightSpecs?0:Tv(JSON.stringify(e.weightSpecs)),weightDataBytes:null==e.weightData?0:e.weightData.byteLength}}var In=(rn.getInstance=function(){return null==rn.instance&&(rn.instance=new rn),rn.instance},rn.registerSaveRouter=function(e){rn.getInstance().saveRouters.push(e)},rn.registerLoadRouter=function(e){rn.getInstance().loadRouters.push(e)},rn.getSaveHandlers=function(e){return rn.getHandlers(e,"save")},rn.getLoadHandlers=function(e,n){return rn.getHandlers(e,"load",n)},rn.getHandlers=function(e,n,t){var r=[];return("load"===n?rn.getInstance().loadRouters:rn.getInstance().saveRouters).forEach(function(o){var a=o(e,t);null!==a&&r.push(a)}),r},rn),jr="://",Wt=($n.getInstance=function(){return null==$n.instance&&($n.instance=new $n),$n.instance},$n.registerManager=function(e,n){S(null!=e,function(){return"scheme must not be undefined or null."}),e.endsWith(jr)&&(e=e.slice(0,e.indexOf(jr))),S(0<e.length,function(){return"scheme must not be an empty string."});var t=$n.getInstance();S(null==t.managers[e],function(){return"A model store manager is already registered for scheme '"+e+"'."}),t.managers[e]=n},$n.getManager=function(e){var n=this.getInstance().managers[e];if(null==n)throw new Error("Cannot find model manager for scheme '"+e+"'");return n},$n.getSchemes=function(){return Object.keys(this.getInstance().managers)},$n);function $n(){this.managers={}}function rn(){this.saveRouters=[],this.loadRouters=[]}function ii(e){if(-1===e.indexOf(jr))throw new Error("The url string provided does not contain a scheme. Supported schemes are: "+Wt.getSchemes().join(","));return{scheme:e.split(jr)[0],path:e.split(jr)[1]}}function Fv(e,n,t){return void 0===t&&(t=!1),oe(this,void 0,void 0,function(){var r,o,a,i,s,u,c,l,h;return ae(this,function(f){switch(f.label){case 0:return S(e!==n,function(){return"Old path and new path are the same: '"+e+"'"}),S(0<(r=In.getLoadHandlers(e)).length,function(){return"Copying failed because no load handler is found for source URL "+e+"."}),S(r.length<2,function(){return"Copying failed because more than one ("+r.length+") load handlers for source URL "+e+"."}),o=r[0],S(0<(a=In.getSaveHandlers(n)).length,function(){return"Copying failed because no save handler is found for destination URL "+n+"."}),S(a.length<2,function(){return"Copying failed because more than one ("+r.length+") save handlers for destination URL "+n+"."}),i=a[0],s=ii(e).scheme,u=ii(e).path,c=s===ii(e).scheme,[4,o.load()];case 1:return l=f.sent(),t&&c?[4,Wt.getManager(s).removeModel(u)]:[3,3];case 2:f.sent(),f.label=3;case 3:return[4,i.save(l)];case 4:return h=f.sent(),!t||c?[3,6]:[4,Wt.getManager(s).removeModel(u)];case 5:f.sent(),f.label=6;case 6:return[2,h.modelArtifactsInfo]}})})}var yr="models_store",zt="model_info_store";function Mv(){if(!q().getBool("IS_BROWSER"))throw new Error("Failed to obtain IndexedDB factory because the current environmentis not a web browser.");var e=window||self,n=e.indexedDB||e.mozIndexedDB||e.webkitIndexedDB||e.msIndexedDB||e.shimIndexedDB;if(null==n)throw new Error("The current browser does not appear to support IndexedDB.");return n}function Lu(e){var n=e.result;n.createObjectStore(yr,{keyPath:"modelPath"}),n.createObjectStore(zt,{keyPath:"modelPath"})}function Ov(e){return q().getBool("IS_BROWSER")&&!Array.isArray(e)&&e.startsWith(Kr.URL_SCHEME)?(n=e.slice(Kr.URL_SCHEME.length),new Kr(n)):null;var n}var Kr=(Xo.prototype.save=function(e){return oe(this,void 0,void 0,function(){return ae(this,function(n){if(e.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");return[2,this.databaseAction(this.modelPath,e)]})})},Xo.prototype.load=function(){return oe(this,void 0,void 0,function(){return ae(this,function(e){return[2,this.databaseAction(this.modelPath)]})})},Xo.prototype.databaseAction=function(e,n){var t=this;return new Promise(function(r,o){var a=t.indexedDB.open("tensorflowjs",1);a.onupgradeneeded=function(){return Lu(a)},a.onsuccess=function(){var i=a.result;if(null==n){var s=i.transaction(yr,"readonly"),u=s.objectStore(yr).get(t.modelPath);u.onsuccess=function(){if(null==u.result)return i.close(),o(new Error("Cannot find model with path '"+t.modelPath+"' in IndexedDB."));r(u.result.modelArtifacts)},u.onerror=function(d){return i.close(),o(u.error)},s.oncomplete=function(){return i.close()}}else{var c,l=Ko(n),h=i.transaction(zt,"readwrite"),f=h.objectStore(zt),p=f.put({modelPath:t.modelPath,modelArtifactsInfo:l});p.onsuccess=function(){var d=(c=i.transaction(yr,"readwrite")).objectStore(yr).put({modelPath:t.modelPath,modelArtifacts:n,modelArtifactsInfo:l});d.onsuccess=function(){return r({modelArtifactsInfo:l})},d.onerror=function(g){var v=(f=h.objectStore(zt)).delete(t.modelPath);v.onsuccess=function(){return i.close(),o(d.error)},v.onerror=function(m){return i.close(),o(d.error)}}},p.onerror=function(d){return i.close(),o(p.error)},h.oncomplete=function(){null==c?i.close():c.oncomplete=function(){return i.close()}}}},a.onerror=function(i){return o(a.error)}})},Xo.URL_SCHEME="indexeddb://",Xo);function Xo(e){if(this.indexedDB=Mv(),null==e||!e)throw new Error("For IndexedDB, modelPath must not be null, undefined or empty.");this.modelPath=e}In.registerSaveRouter(Ov),In.registerLoadRouter(Ov);var Gy=(Wu.prototype.listModels=function(){return oe(this,void 0,void 0,function(){var e=this;return ae(this,function(n){return[2,new Promise(function(t,r){var o=e.indexedDB.open("tensorflowjs",1);o.onupgradeneeded=function(){return Lu(o)},o.onsuccess=function(){var a=o.result,i=a.transaction(zt,"readonly"),s=i.objectStore(zt).getAll();s.onsuccess=function(){for(var u={},c=0,l=s.result;c<l.length;c++){var h=l[c];u[h.modelPath]=h.modelArtifactsInfo}t(u)},s.onerror=function(u){return a.close(),r(s.error)},i.oncomplete=function(){return a.close()}},o.onerror=function(a){return r(o.error)}})]})})},Wu.prototype.removeModel=function(e){return oe(this,void 0,void 0,function(){var n=this;return ae(this,function(t){var r;return e=(r=e).startsWith(Kr.URL_SCHEME)?r.slice(Kr.URL_SCHEME.length):r,[2,new Promise(function(o,a){var i=n.indexedDB.open("tensorflowjs",1);i.onupgradeneeded=function(){return Lu(i)},i.onsuccess=function(){var s,u=i.result,c=u.transaction(zt,"readwrite"),l=c.objectStore(zt),h=l.get(e);h.onsuccess=function(){if(null==h.result)return u.close(),a(new Error("Cannot find model with path '"+e+"' in IndexedDB."));function f(){var d=(s=u.transaction(yr,"readwrite")).objectStore(yr).delete(e);d.onsuccess=function(){return o(h.result.modelArtifactsInfo)},d.onerror=function(g){return a(h.error)}}var p=l.delete(e);p.onsuccess=f,p.onerror=function(d){return f(),u.close(),a(h.error)}},h.onerror=function(f){return u.close(),a(h.error)},c.oncomplete=function(){null==s?u.close():s.oncomplete=function(){return u.close()}}},i.onerror=function(s){return a(i.error)}})]})})},Wu);function Wu(){this.indexedDB=Mv()}if(q().getBool("IS_BROWSER"))try{Wt.registerManager(Kr.URL_SCHEME,new Gy)}catch{}var vt="/",Xr="tensorflowjs_models",Pv="info",Hy="model_topology",qy="weight_specs",jy="weight_data",Ky="model_metadata";function Bv(e){return{info:[Xr,e,Pv].join(vt),topology:[Xr,e,Hy].join(vt),weightSpecs:[Xr,e,qy].join(vt),weightData:[Xr,e,jy].join(vt),modelMetadata:[Xr,e,Ky].join(vt)}}function Xy(e){var n=e.split(vt);if(n.length<3)throw new Error("Invalid key format: "+e);return n.slice(1,n.length-1).join(vt)}function Lv(e){return q().getBool("IS_BROWSER")&&!Array.isArray(e)&&e.startsWith(Yr.URL_SCHEME)?(n=e.slice(Yr.URL_SCHEME.length),new Yr(n)):null;var n}var Yr=(si.prototype.save=function(e){return oe(this,void 0,void 0,function(){var n,t,r;return ae(this,function(o){if(e.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");n=JSON.stringify(e.modelTopology),t=JSON.stringify(e.weightSpecs),r=Ko(e);try{return this.LS.setItem(this.keys.info,JSON.stringify(r)),this.LS.setItem(this.keys.topology,n),this.LS.setItem(this.keys.weightSpecs,t),this.LS.setItem(this.keys.weightData,function(a){if(Pu)return Buffer.from(a).toString("base64");for(var i=new Uint8Array(a),s="",u=0,c=i.length;u<c;u++)s+=String.fromCharCode(i[u]);return btoa(s)}(e.weightData)),this.LS.setItem(this.keys.modelMetadata,JSON.stringify({format:e.format,generatedBy:e.generatedBy,convertedBy:e.convertedBy,userDefinedMetadata:e.userDefinedMetadata})),[2,{modelArtifactsInfo:r}]}catch{throw this.LS.removeItem(this.keys.info),this.LS.removeItem(this.keys.topology),this.LS.removeItem(this.keys.weightSpecs),this.LS.removeItem(this.keys.weightData),this.LS.removeItem(this.keys.modelMetadata),new Error("Failed to save model '"+this.modelPath+"' to local storage: size quota being exceeded is a possible cause of this failure: modelTopologyBytes="+r.modelTopologyBytes+", weightSpecsBytes="+r.weightSpecsBytes+", weightDataBytes="+r.weightDataBytes+".")}return[2]})})},si.prototype.load=function(){return oe(this,void 0,void 0,function(){var e,n,t,r,o,a,i;return ae(this,function(s){if(null==(e=JSON.parse(this.LS.getItem(this.keys.info))))throw new Error("In local storage, there is no model with name '"+this.modelPath+"'");if("JSON"!==e.modelTopologyType)throw new Error("BrowserLocalStorage does not support loading non-JSON model topology yet.");if(n={},null==(t=JSON.parse(this.LS.getItem(this.keys.topology))))throw new Error("In local storage, the topology of model '"+this.modelPath+"' is missing.");if(n.modelTopology=t,null==(r=JSON.parse(this.LS.getItem(this.keys.weightSpecs))))throw new Error("In local storage, the weight specs of model '"+this.modelPath+"' are missing.");if(n.weightSpecs=r,null!=(o=this.LS.getItem(this.keys.modelMetadata))&&(a=JSON.parse(o),n.format=a.format,n.generatedBy=a.generatedBy,n.convertedBy=a.convertedBy,n.userDefinedMetadata=a.userDefinedMetadata),null==(i=this.LS.getItem(this.keys.weightData)))throw new Error("In local storage, the binary weight values of model '"+this.modelPath+"' are missing.");return n.weightData=function(u){if(Pu){var c=Buffer.from(u,"base64");return c.buffer.slice(c.byteOffset,c.byteOffset+c.byteLength)}for(var l=atob(u),h=new Uint8Array(l.length),f=0;f<l.length;++f)h.set([l.charCodeAt(f)],f);return h.buffer}(i),[2,n]})})},si.URL_SCHEME="localstorage://",si);function si(e){if(!q().getBool("IS_BROWSER")||typeof window>"u"||void 0===window.localStorage)throw new Error("The current environment does not support local storage.");if(this.LS=window.localStorage,null==e||!e)throw new Error("For local storage, modelPath must not be null, undefined or empty.");this.modelPath=e,this.keys=Bv(this.modelPath)}In.registerSaveRouter(Lv),In.registerLoadRouter(Lv);var Yy=(zu.prototype.listModels=function(){return oe(this,void 0,void 0,function(){var e,n,t,r,o,a;return ae(this,function(i){for(e={},n=Xr+vt,t=vt+Pv,r=0;r<this.LS.length;++r)(o=this.LS.key(r)).startsWith(n)&&o.endsWith(t)&&(a=Xy(o),e[a]=JSON.parse(this.LS.getItem(o)));return[2,e]})})},zu.prototype.removeModel=function(e){return oe(this,void 0,void 0,function(){var n,t;return ae(this,function(r){var o;if(e=(o=e).startsWith(Yr.URL_SCHEME)?o.slice(Yr.URL_SCHEME.length):o,n=Bv(e),null==this.LS.getItem(n.info))throw new Error("Cannot find model at path '"+e+"'");return t=JSON.parse(this.LS.getItem(n.info)),this.LS.removeItem(n.info),this.LS.removeItem(n.topology),this.LS.removeItem(n.weightSpecs),this.LS.removeItem(n.weightData),[2,t]})})},zu);function zu(){S(q().getBool("IS_BROWSER"),function(){return"Current environment is not a web browser"}),S(typeof window>"u"||void 0!==window.localStorage,function(){return"Current browser does not appear to support localStorage"}),this.LS=window.localStorage}if(q().getBool("IS_BROWSER"))try{Wt.registerManager(Yr.URL_SCHEME,new Yy)}catch{}function Wv(e){return new Promise(function(n){return setTimeout(n)}).then(e)}var Uu=(Yo.prototype.save=function(e){return oe(this,void 0,void 0,function(){var n,o,a,i;return ae(this,function(s){switch(s.label){case 0:if(typeof document>"u")throw new Error("Browser downloads are not supported in this environment since `document` is not present");if(n=window.URL.createObjectURL(new Blob([e.weightData],{type:"application/octet-stream"})),!(e.modelTopology instanceof ArrayBuffer))return[3,1];throw new Error("BrowserDownloads.save() does not support saving model topology in binary formats yet.");case 1:return o=window.URL.createObjectURL(new Blob([JSON.stringify({modelTopology:e.modelTopology,format:e.format,generatedBy:e.generatedBy,convertedBy:e.convertedBy,weightsManifest:[{paths:["./"+this.weightDataFileName],weights:e.weightSpecs}]})],{type:"application/json"})),(a=null==this.jsonAnchor?document.createElement("a"):this.jsonAnchor).download=this.modelTopologyFileName,a.href=o,[4,Wv(function(){return a.dispatchEvent(new MouseEvent("click"))})];case 2:return s.sent(),null==e.weightData?[3,4]:((i=null==this.weightDataAnchor?document.createElement("a"):this.weightDataAnchor).download=this.weightDataFileName,i.href=n,[4,Wv(function(){return i.dispatchEvent(new MouseEvent("click"))})]);case 3:s.sent(),s.label=4;case 4:return[2,{modelArtifactsInfo:Ko(e)}]}})})},Yo.URL_SCHEME="downloads://",Yo),$y=(Vu.prototype.load=function(){return oe(this,void 0,void 0,function(){var e,n,t=this;return ae(this,function(r){return e=this.files[0],n=this.files.slice(1),[2,new Promise(function(o,a){var i=new FileReader;i.onload=function(s){var u=JSON.parse(s.target.result),c=u.modelTopology;if(null!=c){0===n.length&&o({modelTopology:c});var l=u.weightsManifest;if(null!=l){var h;try{h=t.checkManifestAndWeightFiles(l,n)}catch(g){return void a(g)}var f=[],p=[],d=[];l.forEach(function(g){g.paths.forEach(function(v){p.push(v),d.push(null)}),f.push.apply(f,g.weights)}),l.forEach(function(g){g.paths.forEach(function(v){var m=new FileReader;m.onload=function(y){var x=y.target.result,w=p.indexOf(v);d[w]=x,-1===d.indexOf(null)&&o({modelTopology:c,weightSpecs:f,weightData:Bu(d),format:u.format,generatedBy:u.generatedBy,convertedBy:u.convertedBy,userDefinedMetadata:u.userDefinedMetadata})},m.onerror=function(y){return a("Failed to weights data from file of path '"+v+"'.")},m.readAsArrayBuffer(h[v])})})}else a(new Error("weightManifest field is missing from file "+e.name))}else a(new Error("modelTopology field is missing from file "+e.name))},i.onerror=function(s){return a("Failed to read model topology and weights manifest JSON from file '"+e.name+"'. BrowserFiles supports loading Keras-style tf.Model artifacts only.")},i.readAsText(e)})]})})},Vu.prototype.checkManifestAndWeightFiles=function(e,n){for(var t=[],r=n.map(function(s){return Nv(s.name)}),o={},a=0,i=e;a<i.length;a++)i[a].paths.forEach(function(s){var u=Nv(s);if(-1!==t.indexOf(u))throw new Error("Duplicate file basename found in weights manifest: '"+u+"'");if(t.push(u),-1===r.indexOf(u))throw new Error("Weight file with basename '"+u+"' is not provided.");o[s]=n[r.indexOf(u)]});if(t.length!==n.length)throw new Error("Mismatch in the number of files in weights manifest ("+t.length+") and the number of weight files provided ("+n.length+").");return o},Vu);function Vu(e){if(null==e||e.length<1)throw new Error("When calling browserFiles, at least 1 file is required, but received "+e);this.files=e}function Yo(e){if(!q().getBool("IS_BROWSER"))throw new Error("browserDownloads() cannot proceed because the current environment is not a browser.");e.startsWith(Yo.URL_SCHEME)&&(e=e.slice(Yo.URL_SCHEME.length)),null!=e&&0!==e.length||(e="model"),this.modelTopologyFileName=e+".json",this.weightDataFileName=e+".weights.bin"}function zv(e,n,t,r){var o,a,i;S(null!=(i=e)&&Array.isArray(i)&&0<i.length,function(){return"promises must be a none empty array"}),o=t=t??0,a=r=r??1,S(0<=o&&o<=1,function(){return"Progress fraction must be in range [0, 1], but got startFraction "+o}),S(0<=a&&a<=1,function(){return"Progress fraction must be in range [0, 1], but got endFraction "+a}),S(o<=a,function(){return"startFraction must be no more than endFraction, but got startFraction "+o+" and endFraction "+a});var s=0;return Promise.all(e.map(function(u){return u.then(function(c){var l=t+ ++s/e.length*(r-t);return n(l),c}),u}))}function Uv(e,n){return oe(this,void 0,void 0,function(){var t,r,o,a,i,s,u,c,l;return ae(this,function(h){switch(h.label){case 0:return null==n&&(n={}),t=null==n.fetchFunc?q().platform.fetch:n.fetchFunc,r=e.map(function(f){return t(f,n.requestInit,{isBinary:!0})}),o=0,a=.5,null!=n.onProgress?[3,2]:[4,Promise.all(r)];case 1:return i=h.sent(),[3,4];case 2:return[4,zv(r,n.onProgress,o,a)];case 3:i=h.sent(),h.label=4;case 4:return s=i.map(function(f){return f.arrayBuffer()}),u=.5,c=1,null!=n.onProgress?[3,6]:[4,Promise.all(s)];case 5:return l=h.sent(),[3,8];case 6:return[4,zv(s,n.onProgress,u,c)];case 7:l=h.sent(),h.label=8;case 8:return[2,l]}})})}function Vv(e){var n=this;return function(t,r,o){return void 0===r&&(r=""),oe(n,void 0,void 0,function(){var a,i,s,u,c,l,h,f,p,d;return ae(this,function(g){switch(g.label){case 0:if(a=t.map(function(){return!1}),i={},s=null!=o?o.map(function(){return!1}):[],u=[],t.forEach(function(v,m){var y=0;v.weights.forEach(function(x){function w(){a[m]=!0,null==i[m]&&(i[m]=[]),i[m].push({manifestEntry:x,groupOffset:y,sizeBytes:I})}var I=Ou["quantization"in x?x.quantization.dtype:x.dtype]*ie(x.shape);null!=o?o.forEach(function(E,C){E===x.name&&(w(),s[C]=!0)}):w(),u.push(x.name),y+=I})}),!s.every(function(v){return v}))throw c=o.filter(function(v,m){return!s[m]}),new Error("Could not find weights in manifest with names: "+c.join(", ")+". \nManifest JSON has weights with names: "+u.join(", ")+".");return l=a.reduce(function(v,m,y){return m&&v.push(y),v},[]),h=[],l.forEach(function(v){t[v].paths.forEach(function(m){var y=r+(r.endsWith("/")?"":"/")+m;h.push(y)})}),[4,e(h)];case 1:return f=g.sent(),p={},d=0,l.forEach(function(v){for(var m=t[v].paths.length,y=0,x=0;x<m;x++)y+=f[d+x].byteLength;for(var w=new ArrayBuffer(y),b=new Uint8Array(w),I=0,E=0;E<m;E++){var C=new Uint8Array(f[d+E]);b.set(C,I),I+=C.byteLength}i[v].forEach(function(R){var k=Av(w.slice(R.groupOffset,R.groupOffset+R.sizeBytes),[R.manifestEntry]);for(var D in k)p[D]=k[D]}),d+=m}),[2,p]}})})}}In.registerSaveRouter(function(e){return q().getBool("IS_BROWSER")&&!Array.isArray(e)&&e.startsWith(Uu.URL_SCHEME)?(void 0===(n=e.slice(Uu.URL_SCHEME.length))&&(n="model"),new Uu(n)):null;var n});var Gv=($o.prototype.save=function(e){return oe(this,void 0,void 0,function(){var n,o;return ae(this,function(a){switch(a.label){case 0:if(e.modelTopology instanceof ArrayBuffer)throw new Error("BrowserHTTPRequest.save() does not support saving model topology in binary formats yet.");return(n=Object.assign({method:this.DEFAULT_METHOD},this.requestInit)).body=new FormData,n.body.append("model.json",new Blob([JSON.stringify({modelTopology:e.modelTopology,format:e.format,generatedBy:e.generatedBy,convertedBy:e.convertedBy,userDefinedMetadata:e.userDefinedMetadata,weightsManifest:[{paths:["./model.weights.bin"],weights:e.weightSpecs}]})],{type:"application/json"}),"model.json"),null!=e.weightData&&n.body.append("model.weights.bin",new Blob([e.weightData],{type:"application/octet-stream"}),"model.weights.bin"),[4,this.fetch(this.path,n)];case 1:if((o=a.sent()).ok)return[2,{modelArtifactsInfo:Ko(e),responses:[o]}];throw new Error("BrowserHTTPRequest.save() failed due to HTTP response status "+o.status+".")}})})},$o.prototype.load=function(){return oe(this,void 0,void 0,function(){var e,n,t,r,o,a,i,s,u,c,l,h;return ae(this,function(f){switch(f.label){case 0:return[4,this.fetch(this.path,this.requestInit)];case 1:if(!(e=f.sent()).ok)throw new Error("Request to "+this.path+" failed with status code "+e.status+". Please verify this URL points to the model JSON of the model to load.");f.label=2;case 2:return f.trys.push([2,4,,5]),[4,e.json()];case 3:return n=f.sent(),[3,5];case 4:throw f.sent(),t="Failed to parse model JSON of response from "+this.path+".",this.path.endsWith(".pb")?t+=" Your path contains a .pb file extension. Support for .pb models have been removed in TensorFlow.js 1.0 in favor of .json models. You can re-convert your Python TensorFlow model using the TensorFlow.js 1.0 conversion scripts or you can convert your.pb models with the 'pb2json'NPM script in the tensorflow/tfjs-converter repository.":t+=" Please make sure the server is serving valid JSON for this request.",new Error(t);case 5:if(o=n.weightsManifest,a=n.generatedBy,i=n.convertedBy,s=n.format,u=n.userDefinedMetadata,null==(r=n.modelTopology)&&null==o)throw new Error("The JSON from HTTP path "+this.path+" contains neither model topology or manifest for weights.");return null==o?[3,7]:[4,this.loadWeights(o)];case 6:h=f.sent(),c=h[0],l=h[1],f.label=7;case 7:return[2,{modelTopology:r,weightSpecs:c,weightData:l,userDefinedMetadata:u,generatedBy:a,convertedBy:i,format:s}]}})})},$o.prototype.loadWeights=function(e){return oe(this,void 0,void 0,function(){var t,r,o,a,i,s,u,l,h;return ae(this,function(f){switch(f.label){case 0:for(d=(p=Array.isArray(this.path)?this.path[1]:this.path).lastIndexOf("/"),g=p.lastIndexOf("?"),t=[p.substring(0,d)+"/",d<g?p.substring(g):""],r=t[0],o=t[1],a=this.weightPathPrefix||r,i=[],s=0,u=e;s<u.length;s++)i.push.apply(i,u[s].weights);return l=[],e.forEach(function(v){v.paths.forEach(function(m){l.push(a+m+o)})}),[4,Uv(l,{requestInit:this.requestInit,fetchFunc:this.fetch,onProgress:this.onProgress})];case 1:return h=f.sent(),[2,[i,Bu(h)]]}var p,d,g})})},$o.URL_SCHEME_REGEX=/^https?:\/\//,$o);function $o(e,n){if(this.DEFAULT_METHOD="POST",null==n&&(n={}),this.weightPathPrefix=n.weightPathPrefix,this.onProgress=n.onProgress,null!=n.fetchFunc?(S("function"==typeof n.fetchFunc,function(){return"Must pass a function that matches the signature of `fetch` (see https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)"}),this.fetch=n.fetchFunc):this.fetch=q().platform.fetch,S(null!=e&&0<e.length,function(){return"URL path for http must not be null, undefined or empty."}),Array.isArray(e)&&S(2===e.length,function(){return"URL paths for http must have a length of 2, (actual length is "+e.length+")."}),this.path=e,null!=n.requestInit&&null!=n.requestInit.body)throw new Error("requestInit is expected to have no pre-existing body, but has one.");this.requestInit=n.requestInit||{}}function Gu(e){return null!=e.match(Gv.URL_SCHEME_REGEX)}function Hv(e,n){return typeof fetch>"u"?null:(Array.isArray(e)?e.every(function(t){return Gu(t)}):Gu(e))?Hu(e,{onProgress:n}):null}function Hu(e,n){return new Gv(e,n)}In.registerSaveRouter(Hv),In.registerLoadRouter(Hv);var qu=(jv.prototype.load=function(){return oe(this,void 0,void 0,function(){return ae(this,function(e){return[2,this.modelArtifacts]})})},jv),Jy=(qv.prototype.save=function(e){return oe(this,void 0,void 0,function(){return ae(this,function(n){return[2,this.saveHandler(e)]})})},qv);function qv(e){this.saveHandler=e}function jv(e){this.modelArtifacts=e}var $r,ju=Object.freeze({browserFiles:function(e){return new $y(e)},browserHTTPRequest:function(e,n){return Hu(e,n)},concatenateArrayBuffers:Bu,decodeWeights:Av,encodeWeights:function(e,n){return oe(this,void 0,void 0,function(){var t,r,o,a,i,s=this;return ae(this,function(u){switch(u.label){case 0:for(t=[],r=[],o=Array.isArray(e)?e.map(function(c){return c.name}):Object.keys(e),a=function(c){var l=o[c],h=Array.isArray(e)?e[c].tensor:e[l];if("float32"!==h.dtype&&"int32"!==h.dtype&&"bool"!==h.dtype&&"string"!==h.dtype)throw new Error("Unsupported dtype in weight '"+l+"': "+h.dtype);var f={name:l,shape:h.shape,dtype:h.dtype};if("string"===h.dtype){var p=new Promise(function(d){return oe(s,void 0,void 0,function(){var g,v,m,y,x,w,b;return ae(this,function(I){switch(I.label){case 0:return[4,h.bytes()];case 1:for(g=I.sent(),v=g.reduce(function(E,C){return E+C.length},0)+ai*g.length,m=new Uint8Array(v),x=y=0;x<g.length;x++)w=g[x],b=new Uint8Array(new Uint32Array([w.length]).buffer),m.set(b,y),m.set(w,y+=ai),y+=w.length;return d(m),[2]}})})});r.push(p)}else r.push(h.data());null!=n&&(f.group=n),t.push(f)},i=0;i<o.length;++i)a(i);return[4,Promise.all(r)];case 1:return[2,{data:function(c){if(null===c)throw new Error("Invalid input value: "+JSON.stringify(c));var l=0,h=[];c.forEach(function(d){if(l+=d.byteLength,h.push(d.byteLength===d.buffer.byteLength?d:new d.constructor(d)),!(d instanceof Float32Array||d instanceof Int32Array||d instanceof Uint8Array))throw new Error("Unsupported TypedArray subtype: "+d.constructor.name)});var f=new Uint8Array(l),p=0;return h.forEach(function(d){f.set(new Uint8Array(d.buffer),p),p+=d.byteLength}),f.buffer}(u.sent()),specs:t}]}})})},fromMemory:function(e,n,t,r){return 1===arguments.length?null!=e.modelTopology||null!=e.weightSpecs?new qu(e):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new qu({modelTopology:e})):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new qu({modelTopology:e,weightSpecs:n,weightData:t,trainingConfig:r}))},getLoadHandlers:function(e,n){return In.getLoadHandlers(e,n)},getModelArtifactsInfoForJSON:Ko,getSaveHandlers:function(e){return In.getSaveHandlers(e)},http:Hu,isHTTPScheme:Gu,loadWeights:function(e,n,t,r){return void 0===n&&(n=""),oe(this,void 0,void 0,function(){return ae(this,function(o){return[2,Vv(function(a){return Uv(a,{requestInit:r})})(e,n,t)]})})},registerLoadRouter:function(e){return In.registerLoadRouter(e)},registerSaveRouter:function(e){return In.registerSaveRouter(e)},weightsLoaderFactory:Vv,withSaveHandler:function(e){return new Jy(e)},copyModel:function(e,n){return oe(this,void 0,void 0,function(){return ae(this,function(t){return[2,Fv(e,n,!1)]})})},listModels:function(){return oe(this,void 0,void 0,function(){var e,n,t,r,o,a,i;return ae(this,function(s){switch(s.label){case 0:e=Wt.getSchemes(),n={},t=0,r=e,s.label=1;case 1:return t<r.length?[4,Wt.getManager(o=r[t]).listModels()]:[3,4];case 2:for(i in a=s.sent())n[o+jr+i]=a[i];s.label=3;case 3:return t++,[3,1];case 4:return[2,n]}})})},moveModel:function(e,n){return oe(this,void 0,void 0,function(){return ae(this,function(t){return[2,Fv(e,n,!0)]})})},removeModel:function(e){return oe(this,void 0,void 0,function(){var n;return ae(this,function(t){return n=ii(e),[2,Wt.getManager(n.scheme).removeModel(n.path)]})})}}),Qy=T({confusionMatrix_:function(e,n,t){var r=_(e,"labels","confusionMatrix"),o=_(n,"predictions","confusionMatrix");S(null==t||0<t&&Number.isInteger(t),function(){return"If provided, numClasses must be a positive integer, but got "+t}),S(1===r.rank,function(){return"Expected the rank of labels to be 1, but got "+r.rank}),S(1===o.rank,function(){return"Expected the rank of predictions to be 1, but got "+o.rank}),S(r.shape[0]===o.shape[0],function(){return"Mismatch in the number of examples: "+r.shape[0]+" vs. "+o.shape[0]+". Labels and predictions should have the same number of elements."}),S(0<t&&Number.isInteger(t),function(){return"numClasses is required to be a positive integer, but got "+t});var a=Fa(r.asType("int32"),t),i=Fa(o.asType("int32"),t);return a.transpose().matMul(i).asType("int32")}}),Zy=Object.freeze({confusionMatrix:Qy}),ex=T({fromPixels_:function(e,n){if(void 0===n&&(n=3),4<n)throw new Error("Cannot construct Tensor with more than 4 channels from pixels.");if(null==e)throw new Error("pixels passed to tf.browser.fromPixels() can not be null");var t=!1,r=!1,o=!1,a=!1,i=!1;if(e.data instanceof Uint8Array)t=!0;else if(typeof ImageData<"u"&&e instanceof ImageData)r=!0;else if(typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement)o=!0;else if(typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement)a=!0;else{if(null==e.getContext)throw new Error("pixels passed to tf.browser.fromPixels() must be either an HTMLVideoElement, HTMLImageElement, HTMLCanvasElement, ImageData in browser, or OffscreenCanvas, ImageData in webworker or {data: Uint32Array, width: number, height: number}, but was "+e.constructor.name);i=!0}if(o&&o&&e.readyState<2)throw new Error("The video element has not loaded data yet. Please wait for `loadeddata` event on the <video> element.");if(null!=Qi("FromPixels",A.backendName))return A.runKernel("FromPixels",{pixels:e},{numChannels:n});var s,u,c=o?[e.videoWidth,e.videoHeight]:[e.width,e.height],l=c[0],h=c[1];if(i?s=e.getContext("2d").getImageData(0,0,l,h).data:r||t?s=e.data:(a||o)&&(null==$r&&($r=document.createElement("canvas").getContext("2d")),$r.canvas.width=l,$r.canvas.height=h,$r.drawImage(e,0,0,l,h),s=$r.getImageData(0,0,l,h).data),4===n)u=new Int32Array(s);else{var f=l*h;u=new Int32Array(f*n);for(var p=0;p<f;p++)for(var d=0;d<n;++d)u[p*n+d]=s[4*p+d]}return Da(u,[h,l,n],"int32")}}),ui=Object.freeze({toPixels:function(e,n){return oe(this,void 0,void 0,function(){var t,r,o,a,i,s,u,c,l,p,d,g,v,m,y,x,w,b,I,E,C;return ae(this,function(R){switch(R.label){case 0:if(t=_(e,"img","toPixels"),e instanceof Re||(t=t.toInt()),2!==t.rank&&3!==t.rank)throw new Error("toPixels only supports rank 2 or 3 tensors, got rank "+t.rank+".");if(r=t.shape.slice(0,2),o=r[0],a=r[1],4<(i=2===t.rank?1:t.shape[2])||2===i)throw new Error("toPixels only supports depth of size 1, 3 or 4 but got "+i);return[4,t.data()];case 1:return s=R.sent(),u=t.min(),c=t.max(),[4,Promise.all([u.data(),c.data()])];case 2:if(l=R.sent(),p=l[0][0],d=l[1][0],u.dispose(),c.dispose(),"float32"===t.dtype){if(p<0||1<d)throw new Error("Tensor values for a float32 Tensor must be in the range [0 - 1] but got range ["+p+" - "+d+"].")}else{if("int32"!==t.dtype)throw new Error("Unsupported type for toPixels: "+t.dtype+". Please use float32 or int32 tensors.");if(p<0||255<d)throw new Error("Tensor values for a int32 Tensor must be in the range [0 - 255] but got range ["+p+" - "+d+"].")}for(g="float32"===t.dtype?255:1,v=new Uint8ClampedArray(a*o*4),m=0;m<o*a;++m)b=w=x=y=void 0,1===i?(y=s[m]*g,x=s[m]*g,w=s[m]*g,b=255):3===i?(y=s[3*m]*g,x=s[3*m+1]*g,w=s[3*m+2]*g,b=255):4===i&&(y=s[4*m]*g,x=s[4*m+1]*g,w=s[4*m+2]*g,b=s[4*m+3]*g),v[0+(I=4*m)]=Math.round(y),v[1+I]=Math.round(x),v[2+I]=Math.round(w),v[3+I]=Math.round(b);return null!=n&&(n.width=a,n.height=o,E=n.getContext("2d"),C=new ImageData(v,a,o),E.putImageData(C,0,0)),t!==e&&t.dispose(),[2,v]}})})},fromPixels:ex}),Kv=(Ku.prototype.getClassName=function(){return this.constructor.className},Ku.fromConfig=function(e,n){return new e(n)},Ku),Xv=(Ut.getMap=function(){return null==Ut.instance&&(Ut.instance=new Ut),Ut.instance},Ut.register=function(e){Ut.getMap().classNameMap[e.className]=[e,e.fromConfig]},Ut);function Ut(){this.classNameMap={}}function Ku(){}function Vt(e){S(null!=e.className,function(){return"Class being registered does not have the static className property defined."}),S("string"==typeof e.className,function(){return"className is required to be a string, but got type "+typeof e.className}),S(0<e.className.length,function(){return"Class being registered has an empty-string as its className, which is disallowed."}),Xv.register(e)}var nx=Object.freeze({Serializable:Kv,SerializationMap:Xv,registerClass:Vt});function Xu(){return 32===A.backend.floatPrecision()?.001:.1}function Yu(e,n,t){var r=!0;if((Ze(e)||Ze(n))&&(r=!1),Ze(e)&&Ze(n)&&(r=!0),r){var o=e.constructor.name,a=n.constructor.name;if(o!==a)throw new Error("Arrays are of different type. Actual: "+o+". Expected: "+a)}if(Array.isArray(e)&&Array.isArray(n)){var i=Xn(e),s=Xn(n);if(!Le(i,s))throw new Error("Arrays have different shapes. Actual: ["+i+"]. Expected: ["+s+"]")}var u=Ze(e)?e:st(e),c=Ze(n)?n:st(n);if(u.length!==c.length)throw new Error("Arrays have different lengths actual: "+u.length+" vs expected: "+c.length+".\nActual:   "+u+".\nExpected: "+c+".");for(var l=0;l<c.length;++l){var h=u[l],f=c[l];if(!t(h,f))throw new Error("Arrays differ: actual["+l+"] = "+h+", expected["+l+"] = "+f+".\nActual:   "+u+".\nExpected: "+c+".")}}function $u(e,n,t){return!isFinite(e)&&!isFinite(n)||!(isNaN(e)||isNaN(n)||Math.abs(e-n)>t)}var Ju,tx=Object.freeze({TEST_EPSILON_FLOAT16:.1,expectArraysClose:function(e,n,t){return null==t&&(t=Xu()),Yu(e,n,function(r,o){return $u(r,o,t)})},testEpsilon:Xu,expectPromiseToFail:function(e,n){e().then(function(){return n.fail()},function(){return n()})},expectArraysEqual:function(e,n){var t="string"==typeof n||"number"==typeof n||"boolean"==typeof n?[n]:n;return Tt(e)||Tt(e[0])||Tt(n)||Tt(n[0])?Yu(e,t,function(r,o){return r==o}):Yu(e,n,function(r,o){return $u(r,o,0)})},expectNumbersClose:function(e,n,t){if(null==t&&(t=Xu()),!$u(e,n,t))throw new Error("Numbers differ: actual === "+e+", expected === "+n)},expectValuesInRange:function(e,n,t){for(var r=0;r<e.length;r++)if(e[r]<n||e[r]>t)throw new Error("Value out of range:"+e[r]+" low: "+n+", high: "+t)},expectArrayBuffersEqual:function(e,n){expect(new Float32Array(e)).toEqual(new Float32Array(n))}}),rx=Object.freeze({gpgpu_util:W0,webgl_util:Hg,forceHalfFloat:function(){q().set("WEBGL_FORCE_F16_TEXTURES",!0)},MathBackendWebGL:hp,setWebGLContext:Zl,GPGPUContext:Hf}),Gt=(Nn(zn,Ju=Kv),zn.prototype.minimize=function(e,n,t){void 0===n&&(n=!1);var r=this.computeGradients(e,t),o=r.value,a=r.grads;if(null!=t){var i=t.map(function(s){return{name:s.name,tensor:a[s.name]}});this.applyGradients(i)}else this.applyGradients(a);return un(a),n?o:(o.dispose(),null)},Object.defineProperty(zn.prototype,"iterations",{get:function(){return null==this.iterations_&&(this.iterations_=0),this.iterations_},enumerable:!0,configurable:!0}),zn.prototype.incrementIterations=function(){this.iterations_=this.iterations+1},zn.prototype.computeGradients=function(e,n){return af(e,n)},zn.prototype.dispose=function(){null!=this.iterations_&&un(this.iterations_)},zn.prototype.saveIterations=function(){return oe(this,void 0,void 0,function(){return ae(this,function(e){return null==this.iterations_&&(this.iterations_=0),[2,{name:"iter",tensor:$(this.iterations_,"int32")}]})})},zn.prototype.getWeights=function(){return oe(this,void 0,void 0,function(){return ae(this,function(e){throw new Error("getWeights() is not implemented for this optimizer yet.")})})},zn.prototype.setWeights=function(e){return oe(this,void 0,void 0,function(){return ae(this,function(n){throw new Error("setWeights() is not implemented for this optimizer class "+this.getClassName())})})},zn.prototype.extractIterations=function(e){return oe(this,void 0,void 0,function(){var n;return ae(this,function(t){switch(t.label){case 0:return n=this,[4,e[0].tensor.data()];case 1:return n.iterations_=t.sent()[0],[2,e.slice(1)]}})})},zn);function zn(){return null!==Ju&&Ju.apply(this,arguments)||this}Object.defineProperty(Gt,Symbol.hasInstance,{value:function(e){return null!=e.minimize&&null!=e.computeGradients&&null!=e.applyGradients}});var Yv,Qu=(Nn(mt,Yv=Gt),mt.prototype.applyGradients=function(e){var n=this;(Array.isArray(e)?e.map(function(t){return t.name}):Object.keys(e)).forEach(function(t,r){var o=A.registeredVariables[t];null==n.accumulatedGrads[r]&&(n.accumulatedGrads[r]={originalName:t+"/accum_grad",variable:Q(function(){return xe(o).variable(!1)})}),null==n.accumulatedUpdates[r]&&(n.accumulatedUpdates[r]={originalName:t+"/accum_var",variable:Q(function(){return xe(o).variable(!1)})});var a=Array.isArray(e)?e[r].tensor:e[t];if(null!=a){var i=n.accumulatedGrads[r].variable,s=n.accumulatedUpdates[r].variable;Q(function(){var u=i.mul(n.rho).add(a.square().mul(1-n.rho)),c=s.add(n.epsilon).sqrt().div(i.add(n.epsilon).sqrt()).mul(a),l=s.mul(n.rho).add(c.square().mul(1-n.rho));i.assign(u),s.assign(l);var h=c.mul(-n.learningRate).add(o);o.assign(h)})}}),this.incrementIterations()},mt.prototype.dispose=function(){null!=this.accumulatedUpdates&&(un(this.accumulatedGrads.map(function(e){return e.variable})),un(this.accumulatedUpdates.map(function(e){return e.variable})))},mt.prototype.getWeights=function(){return oe(this,void 0,void 0,function(){var e;return ae(this,function(n){switch(n.label){case 0:return e=this.accumulatedGrads.concat(this.accumulatedUpdates),[4,this.saveIterations()];case 1:return[2,[n.sent()].concat(e.map(function(t){return{name:t.originalName,tensor:t.variable}}))]}})})},mt.prototype.setWeights=function(e){return oe(this,void 0,void 0,function(){var n;return ae(this,function(t){switch(t.label){case 0:return[4,this.extractIterations(e)];case 1:return e=t.sent(),this.accumulatedGrads=e.slice(0,n=e.length/2).map(function(r){return{originalName:r.name,variable:r.tensor.variable(!1)}}),this.accumulatedUpdates=e.slice(n,2*n).map(function(r){return{originalName:r.name,variable:r.tensor.variable(!1)}}),[2]}})})},mt.prototype.getConfig=function(){return{learningRate:this.learningRate,rho:this.rho,epsilon:this.epsilon}},mt.fromConfig=function(e,n){return new e(n.learningRate,n.rho,n.epsilon)},mt.className="Adadelta",mt);function mt(e,n,t){void 0===t&&(t=null);var r=Yv.call(this)||this;return r.learningRate=e,r.rho=n,r.epsilon=t,r.accumulatedGrads=[],r.accumulatedUpdates=[],null==t&&(r.epsilon=A.backend.epsilon()),r}Vt(Qu);var $v,Zu=(Nn(gt,$v=Gt),gt.prototype.applyGradients=function(e){var n=this;(Array.isArray(e)?e.map(function(t){return t.name}):Object.keys(e)).forEach(function(t,r){var o=A.registeredVariables[t];null==n.accumulatedGrads[r]&&(n.accumulatedGrads[r]={originalName:t+"/accumulator",variable:Q(function(){return Ln(o.shape,n.initialAccumulatorValue).variable(!1)})});var a=Array.isArray(e)?e[r].tensor:e[t];if(null!=a){var i=n.accumulatedGrads[r].variable;Q(function(){var s=i.add(a.square());i.assign(s);var u=a.div(s.add(A.backend.epsilon()).sqrt()).mul(-n.learningRate).add(o);o.assign(u)})}}),this.incrementIterations()},gt.prototype.dispose=function(){null!=this.accumulatedGrads&&un(this.accumulatedGrads.map(function(e){return e.variable}))},gt.prototype.getWeights=function(){return oe(this,void 0,void 0,function(){return ae(this,function(e){switch(e.label){case 0:return[4,this.saveIterations()];case 1:return[2,[e.sent()].concat(this.accumulatedGrads.map(function(n){return{name:n.originalName,tensor:n.variable}}))]}})})},gt.prototype.setWeights=function(e){return oe(this,void 0,void 0,function(){return ae(this,function(n){switch(n.label){case 0:return[4,this.extractIterations(e)];case 1:return e=n.sent(),this.accumulatedGrads=e.map(function(t){return{originalName:t.name,variable:t.tensor.variable(!1)}}),[2]}})})},gt.prototype.getConfig=function(){return{learningRate:this.learningRate,initialAccumulatorValue:this.initialAccumulatorValue}},gt.fromConfig=function(e,n){return new e(n.learningRate,n.initialAccumulatorValue)},gt.className="Adagrad",gt);function gt(e,n){void 0===n&&(n=.1);var t=$v.call(this)||this;return t.learningRate=e,t.initialAccumulatorValue=n,t.accumulatedGrads=[],t}Vt(Zu);var Jv,ec=(Nn(yt,Jv=Gt),yt.prototype.applyGradients=function(e){var n=this,t=Array.isArray(e)?e.map(function(r){return r.name}):Object.keys(e);Q(function(){var r=Ge(1,n.accBeta1),o=Ge(1,n.accBeta2);t.forEach(function(a,i){var s=A.registeredVariables[a];null==n.accumulatedFirstMoment[i]&&(n.accumulatedFirstMoment[i]={originalName:a+"/m",variable:Q(function(){return xe(s).variable(!1)})}),null==n.accumulatedSecondMoment[i]&&(n.accumulatedSecondMoment[i]={originalName:a+"/v",variable:Q(function(){return xe(s).variable(!1)})});var u=Array.isArray(e)?e[i].tensor:e[a];if(null!=u){var c=n.accumulatedFirstMoment[i].variable,l=n.accumulatedSecondMoment[i].variable,h=c.mul(n.beta1).add(u.mul(1-n.beta1)),f=l.mul(n.beta2).add(u.square().mul(1-n.beta2)),p=h.div(r),d=f.div(o);c.assign(h),l.assign(f);var g=p.div(d.sqrt().add(n.epsilon)).mul(-n.learningRate).add(s);s.assign(g)}}),n.accBeta1.assign(n.accBeta1.mul(n.beta1)),n.accBeta2.assign(n.accBeta2.mul(n.beta2))}),this.incrementIterations()},yt.prototype.dispose=function(){this.accBeta1.dispose(),this.accBeta2.dispose(),null!=this.accumulatedFirstMoment&&un(this.accumulatedFirstMoment.map(function(e){return e.variable})),null!=this.accumulatedSecondMoment&&un(this.accumulatedSecondMoment.map(function(e){return e.variable}))},yt.prototype.getWeights=function(){return oe(this,void 0,void 0,function(){var e;return ae(this,function(n){switch(n.label){case 0:return e=this.accumulatedFirstMoment.concat(this.accumulatedSecondMoment),[4,this.saveIterations()];case 1:return[2,[n.sent()].concat(e.map(function(t){return{name:t.originalName,tensor:t.variable}}))]}})})},yt.prototype.setWeights=function(e){return oe(this,void 0,void 0,function(){var n,t=this;return ae(this,function(r){switch(r.label){case 0:return[4,this.extractIterations(e)];case 1:return e=r.sent(),Q(function(){t.accBeta1.assign(zo(t.beta1,t.iterations_+1)),t.accBeta2.assign(zo(t.beta2,t.iterations_+1))}),this.accumulatedFirstMoment=e.slice(0,n=e.length/2).map(function(o){return{originalName:o.name,variable:o.tensor.variable(!1)}}),this.accumulatedSecondMoment=e.slice(n,2*n).map(function(o){return{originalName:o.name,variable:o.tensor.variable(!1)}}),[2]}})})},yt.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon}},yt.fromConfig=function(e,n){return new e(n.learningRate,n.beta1,n.beta2,n.epsilon)},yt.className="Adam",yt);function yt(e,n,t,r){void 0===r&&(r=null);var o=Jv.call(this)||this;return o.learningRate=e,o.beta1=n,o.beta2=t,o.epsilon=r,o.accumulatedFirstMoment=[],o.accumulatedSecondMoment=[],Q(function(){o.accBeta1=$(n).variable(),o.accBeta2=$(t).variable()}),null==r&&(o.epsilon=A.backend.epsilon()),o}Vt(ec);var Qv,nc=(Nn(xt,Qv=Gt),xt.prototype.applyGradients=function(e){var n=this,t=Array.isArray(e)?e.map(function(r){return r.name}):Object.keys(e);Q(function(){var r=Ge(1,n.accBeta1),o=Tn(-n.learningRate,n.iteration.mul(n.decay).add(1));t.forEach(function(a,i){var s=A.registeredVariables[a];null==n.accumulatedFirstMoment[i]&&(n.accumulatedFirstMoment[i]={originalName:a+"/m",variable:xe(s).variable(!1)}),null==n.accumulatedWeightedInfNorm[i]&&(n.accumulatedWeightedInfNorm[i]={originalName:a+"/v",variable:xe(s).variable(!1)});var u=Array.isArray(e)?e[i].tensor:e[a];if(null!=u){var c=n.accumulatedFirstMoment[i].variable,l=n.accumulatedWeightedInfNorm[i].variable,h=c.mul(n.beta1).add(u.mul(1-n.beta1)),f=l.mul(n.beta2),p=u.abs(),d=f.maximum(p);c.assign(h),l.assign(d);var g=o.div(r).mul(h.div(d.add(n.epsilon))).add(s);s.assign(g)}}),n.iteration.assign(n.iteration.add(1)),n.accBeta1.assign(n.accBeta1.mul(n.beta1))}),this.incrementIterations()},xt.prototype.dispose=function(){this.accBeta1.dispose(),this.iteration.dispose(),null!=this.accumulatedFirstMoment&&un(this.accumulatedFirstMoment.map(function(e){return e.variable})),null!=this.accumulatedWeightedInfNorm&&un(this.accumulatedWeightedInfNorm.map(function(e){return e.variable}))},xt.prototype.getWeights=function(){return oe(this,void 0,void 0,function(){return ae(this,function(e){throw new Error("getWeights() is not implemented for Adamax yet.")})})},xt.prototype.setWeights=function(e){return oe(this,void 0,void 0,function(){return ae(this,function(n){throw new Error("setWeights() is not implemented for Adamax yet.")})})},xt.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon,decay:this.decay}},xt.fromConfig=function(e,n){return new e(n.learningRate,n.beta1,n.beta2,n.epsilon,n.decay)},xt.className="Adamax",xt);function xt(e,n,t,r,o){void 0===r&&(r=null),void 0===o&&(o=0);var a=Qv.call(this)||this;return a.learningRate=e,a.beta1=n,a.beta2=t,a.epsilon=r,a.decay=o,a.accumulatedFirstMoment=[],a.accumulatedWeightedInfNorm=[],Q(function(){a.iteration=$(0).variable(),a.accBeta1=$(n).variable()}),null==r&&(a.epsilon=A.backend.epsilon()),a}Vt(nc);var Zv,ci=(Nn(Jn,Zv=Gt),Jn.prototype.applyGradients=function(e){var n=this;(Array.isArray(e)?e.map(function(t){return t.name}):Object.keys(e)).forEach(function(t,r){var o=Array.isArray(e)?e[r].tensor:e[t];if(null!=o){var a=A.registeredVariables[t];Q(function(){var i=n.c.mul(o).add(a);a.assign(i)})}}),this.incrementIterations()},Jn.prototype.setLearningRate=function(e){this.learningRate=e,null!=this.c&&this.c.dispose(),this.c=_h($(-e))},Jn.prototype.dispose=function(){this.c.dispose()},Jn.prototype.getWeights=function(){return oe(this,void 0,void 0,function(){return ae(this,function(e){switch(e.label){case 0:return[4,this.saveIterations()];case 1:return[2,[e.sent()]]}})})},Jn.prototype.setWeights=function(e){return oe(this,void 0,void 0,function(){return ae(this,function(n){switch(n.label){case 0:return[4,this.extractIterations(e)];case 1:if(0!==(e=n.sent()).length)throw new Error("SGD optimizer does not have settable weights.");return[2]}})})},Jn.prototype.getConfig=function(){return{learningRate:this.learningRate}},Jn.fromConfig=function(e,n){return new e(n.learningRate)},Jn.className="SGD",Jn);function Jn(e){var n=Zv.call(this)||this;return n.learningRate=e,n.setLearningRate(e),n}Vt(ci);var em,tc=(Nn(Qn,em=ci),Qn.prototype.applyGradients=function(e){var n=this;(Array.isArray(e)?e.map(function(t){return t.name}):Object.keys(e)).forEach(function(t,r){var o=A.registeredVariables[t];null==n.accumulations[r]&&(n.accumulations[r]={originalName:t+"/momentum",variable:Q(function(){return xe(o).variable(!1)})});var a=n.accumulations[r].variable,i=Array.isArray(e)?e[r].tensor:e[t];null!=i&&Q(function(){var s,u=n.m.mul(a).add(i);s=n.useNesterov?n.c.mul(i.add(u.mul(n.m))).add(o):n.c.mul(u).add(o),a.assign(u),o.assign(s)})}),this.incrementIterations()},Qn.prototype.dispose=function(){this.m.dispose(),null!=this.accumulations&&un(this.accumulations.map(function(e){return e.variable}))},Qn.prototype.setMomentum=function(e){this.momentum=e},Qn.prototype.getWeights=function(){return oe(this,void 0,void 0,function(){return ae(this,function(e){switch(e.label){case 0:return[4,this.saveIterations()];case 1:return[2,[e.sent()].concat(this.accumulations.map(function(n){return{name:n.originalName,tensor:n.variable}}))]}})})},Qn.prototype.setWeights=function(e){return oe(this,void 0,void 0,function(){return ae(this,function(n){switch(n.label){case 0:return[4,this.extractIterations(e)];case 1:return e=n.sent(),this.accumulations=e.map(function(t){return{originalName:t.name,variable:t.tensor.variable(!1)}}),[2]}})})},Qn.prototype.getConfig=function(){return{learningRate:this.learningRate,momentum:this.momentum,useNesterov:this.useNesterov}},Qn.fromConfig=function(e,n){return new e(n.learningRate,n.momentum,n.useNesterov)},Qn.className="Momentum",Qn);function Qn(e,n,t){void 0===t&&(t=!1);var r=em.call(this,e)||this;return r.learningRate=e,r.momentum=n,r.useNesterov=t,r.accumulations=[],r.m=$(r.momentum),r}Vt(tc);var nm,rc=(Nn(bt,nm=Gt),bt.prototype.applyGradients=function(e){var n=this;(Array.isArray(e)?e.map(function(t){return t.name}):Object.keys(e)).forEach(function(t,r){var o=A.registeredVariables[t];null==n.accumulatedMeanSquares[r]&&(n.accumulatedMeanSquares[r]={originalName:t+"/rms",variable:Q(function(){return xe(o).variable(!1)})}),null==n.accumulatedMoments[r]&&(n.accumulatedMoments[r]={originalName:t+"/momentum",variable:Q(function(){return xe(o).variable(!1)})}),null==n.accumulatedMeanGrads[r]&&n.centered&&(n.accumulatedMeanGrads[r]={originalName:t+"/mg",variable:Q(function(){return xe(o).variable(!1)})});var a=Array.isArray(e)?e[r].tensor:e[t];if(null!=a){var i=n.accumulatedMeanSquares[r].variable,s=n.accumulatedMoments[r].variable;Q(function(){var u=i.mul(n.decay).add(a.square().mul(1-n.decay));if(n.centered){var c=n.accumulatedMeanGrads[r].variable,l=c.mul(n.decay).add(a.mul(1-n.decay)),h=s.mul(n.momentum).add(a.mul(n.learningRate).div(u.sub(l.square().add(n.epsilon)).sqrt()));i.assign(u),c.assign(l),s.assign(h);var f=o.sub(h);o.assign(f)}else{var p=i.mul(n.decay).add(a.square().mul(1-n.decay));h=s.mul(n.momentum).add(a.mul(n.learningRate).div(p.add(n.epsilon).sqrt())),i.assign(p),s.assign(h),f=o.sub(h),o.assign(f)}})}}),this.incrementIterations()},bt.prototype.dispose=function(){null!=this.accumulatedMeanSquares&&un(this.accumulatedMeanSquares.map(function(e){return e.variable})),null!=this.accumulatedMeanGrads&&this.centered&&un(this.accumulatedMeanGrads.map(function(e){return e.variable})),null!=this.accumulatedMoments&&un(this.accumulatedMoments.map(function(e){return e.variable}))},bt.prototype.getWeights=function(){return oe(this,void 0,void 0,function(){var e;return ae(this,function(n){switch(n.label){case 0:return e=this.accumulatedMeanSquares.concat(this.accumulatedMoments),this.centered&&e.push.apply(e,this.accumulatedMeanGrads),[4,this.saveIterations()];case 1:return[2,[n.sent()].concat(e.map(function(t){return{name:t.originalName,tensor:t.variable}}))]}})})},bt.prototype.setWeights=function(e){return oe(this,void 0,void 0,function(){var n;return ae(this,function(t){switch(t.label){case 0:return[4,this.extractIterations(e)];case 1:return e=t.sent(),this.accumulatedMeanSquares=e.slice(0,n=this.centered?e.length/3:e.length/2).map(function(r){return{originalName:r.name,variable:r.tensor.variable(!1)}}),this.accumulatedMoments=e.slice(n,2*n).map(function(r){return{originalName:r.name,variable:r.tensor.variable(!1)}}),this.centered&&(this.accumulatedMeanGrads=e.slice(2*n,3*n).map(function(r){return{originalName:r.name,variable:r.tensor.variable(!1)}})),[2]}})})},bt.prototype.getConfig=function(){return{learningRate:this.learningRate,decay:this.decay,momentum:this.momentum,epsilon:this.epsilon,centered:this.centered}},bt.fromConfig=function(e,n){return new e(n.learningRate,n.decay,n.momentum,n.epsilon,n.centered)},bt.className="RMSProp",bt);function bt(e,n,t,r,o){void 0===n&&(n=.9),void 0===t&&(t=0),void 0===r&&(r=null),void 0===o&&(o=!1);var a=nm.call(this)||this;if(a.learningRate=e,a.decay=n,a.momentum=t,a.epsilon=r,a.accumulatedMeanSquares=[],a.accumulatedMoments=[],a.accumulatedMeanGrads=[],a.centered=o,null==r&&(a.epsilon=A.backend.epsilon()),null==e)throw new Error("learningRate for RMSPropOptimizer must be defined.");return a}Vt(rc);var xr=(Ht.sgd=function(e){return new ci(e)},Ht.momentum=function(e,n,t){return void 0===t&&(t=!1),new tc(e,n,t)},Ht.rmsprop=function(e,n,t,r,o){return void 0===n&&(n=.9),void 0===t&&(t=0),void 0===r&&(r=null),void 0===o&&(o=!1),new rc(e,n,t,r,o)},Ht.adam=function(e,n,t,r){return void 0===e&&(e=.001),void 0===n&&(n=.9),void 0===t&&(t=.999),void 0===r&&(r=null),new ec(e,n,t,r)},Ht.adadelta=function(e,n,t){return void 0===e&&(e=.001),void 0===n&&(n=.95),void 0===t&&(t=null),new Qu(e,n,t)},Ht.adamax=function(e,n,t,r,o){return void 0===e&&(e=.002),void 0===n&&(n=.9),void 0===t&&(t=.999),void 0===r&&(r=null),void 0===o&&(o=0),new nc(e,n,t,r,o)},Ht.adagrad=function(e,n){return void 0===n&&(n=.1),new Zu(e,n)},Ht),ox={sgd:xr.sgd,momentum:xr.momentum,adadelta:xr.adadelta,adagrad:xr.adagrad,rmsprop:xr.rmsprop,adamax:xr.adamax,adam:xr.adam},ax=typeof requestAnimationFrame<"u"?requestAnimationFrame:typeof setImmediate<"u"?setImmediate:function(e){return e()};function Ht(){}Re.prototype.squaredDifference=function(e){return ou(this,e)},G=By;var ix=Object.freeze({__proto__:null,AdadeltaOptimizer:Qu,AdagradOptimizer:Zu,AdamOptimizer:ec,AdamaxOptimizer:nc,DataStorage:Ws,get ENV(){return Ji},Environment:Dl,KernelBackend:zs,MomentumOptimizer:tc,Optimizer:Gt,RMSPropOptimizer:rc,get Rank(){return hs},get Reduction(){return tn},SGDOptimizer:ci,Tensor:Re,TensorBuffer:Or,Variable:sr,abs:pp,acos:dp,acosh:vp,add:de,addN:ed,addStrict:nd,all:$d,any:Jd,argMax:Qd,argMin:Zd,asin:mp,asinh:gp,atan:yp,atan2:td,atanh:xp,avgPool:Hr,avgPool3d:qd,backend:function(){return A.backend},backend_util:t0,basicLSTMCell:uv,batchNorm:uu,batchNorm2d:Yp,batchNorm3d:$p,batchNorm4d:Jp,batchNormalization:Xp,batchNormalization2d:qp,batchNormalization3d:jp,batchNormalization4d:Kp,batchToSpaceND:As,booleanMaskAsync:Id,broadcastTo:Lh,browser:ui,buffer:he,cast:Wh,ceil:bp,clipByValue:ja,clone:zh,complex:$e,concat:ze,concat1d:Nh,concat2d:Fh,concat3d:Mh,concat4d:Oh,conv1d:Sd,conv2d:_n,conv2dTranspose:Fd,conv3d:Dd,conv3dTranspose:Md,cos:wp,cosh:Cp,cumsum:Uh,customGrad:Ao,deprecationWarn:_s,depthToSpace:Vh,depthwiseConv2d:Uo,diag:gv,disableDeprecationWarnings:function(){q().set("DEPRECATION_WARNINGS_ENABLED",!1),console.warn("TensorFlow.js deprecation warnings have been disabled.")},dispose:un,disposeVariables:function(){A.disposeVariables()},div:Tn,divNoNan:rd,divStrict:od,dot:Od,dropout:yv,elu:xu,enableDebugMode:function(){q().set("DEBUG",!0)},enableProdMode:function(){q().set("PROD",!0)},engine:function(){return A},env:q,equal:fu,equalStrict:pd,erf:Ep,exp:Ka,expandDims:En,expm1:_p,eye:Ts,fft:Za,fill:Ln,findBackend:function(e){return A.findBackend(e)},findBackendFactory:function(e){return A.findBackendFactory(e)},floor:Ip,floorDiv:lu,frame:ti,fused:Iv,gather:Ja,gatherND:mv,gather_util:Zg,getBackend:function(){return A.backendName},getGradient:Al,getKernel:Qi,getKernelsForBackend:Zi,grad:function(e){return S(Nt(e),function(){return"The f passed in grad(f) must be a function"}),function(n,t){var r=_(n,"x","tf.grad",null),o=null!=t?_(t,"dy","tf.grad"):null;return A.tidy(function(){var a=A.gradients(function(){return e(r)},[r],o),s=a.grads;return null!=o&&we(a.value.shape,o.shape,"The shape of dy passed in grad(f)(x, dy) must match the shape returned by f(x)"),Wa(s),s[0]})}},grads:function(e){return S(Nt(e),function(){return"The f passed in grads(f) must be a function"}),function(n,t){S(Array.isArray(n),function(){return"The args passed in grads(f)(args) must be an array of `Tensor`s or `TensorLike`s"});var r=ko(n,"args","tf.grads",null),o=null!=t?_(t,"dy","tf.grads"):null;return A.tidy(function(){var a=A.gradients(function(){return e.apply(void 0,r)},r,o),s=a.grads;return null!=o&&we(a.value.shape,o.shape,"The shape of dy passed in grads(f)([x1,...], dy) must match the shape returned by f([x1,...])"),Wa(s),s})}},greater:dd,greaterEqual:pu,greaterEqualStrict:vd,greaterStrict:md,hammingWindow:_u,hannWindow:ni,ifft:Ho,imag:Bn,image:oi,inTopKAsync:bv,io:ju,irfft:Eu,isFinite:Mp,isInf:Fp,isNaN:Np,keep:_h,leakyRelu:av,less:gd,lessEqual:yd,lessEqualStrict:xd,lessStrict:bd,linalg:_v,linspace:Th,localResponseNormalization:sv,log:Rp,log1p:kp,logSigmoid:Sp,logSoftmax:sf,logSumExp:ev,logicalAnd:Wo,logicalNot:Qp,logicalOr:cu,logicalXor:Zp,losses:Cv,matMul:Vo,math:Zy,max:Go,maxPool:qe,maxPool3d:Hd,maximum:$a,maximumStrict:ad,mean:nv,memory:function(){return A.memory()},min:tv,minimum:hu,minimumStrict:id,mod:sd,modStrict:ud,moments:rv,movingAverage:lv,mul:nn,mulStrict:cd,multiRNNCell:cv,multinomial:Gh,neg:Bo,nextFrame:function(){return new Promise(function(e){return ax(function(){return e()})})},norm:Cu,notEqual:wd,notEqualStrict:Cd,oneHot:Fa,ones:lr,onesLike:Rs,op:T,outerProduct:Pd,pad:Ot,pad1d:Hh,pad2d:qh,pad3d:jh,pad4d:Kh,pool:Gd,pow:zo,powStrict:ld,prelu:bu,print:Ph,prod:ov,profile:function(e){return A.profile(e)},rand:Xh,randomGamma:$h,randomNormal:Yh,randomUniform:Ns,range:So,ready:function(){return A.ready()},real:Cn,reciprocal:Dp,registerBackend:function(e,n,t){return void 0===t&&(t=1),A.registerBackend(e,n,t)},registerGradient:Tl,registerKernel:es,relu:Fe,relu6:wu,removeBackend:function(e){A.removeBackend(e)},reshape:An,reverse:Gr,reverse1d:Bd,reverse2d:Ld,reverse3d:Wd,reverse4d:zd,rfft:ei,round:Ap,rsqrt:au,scalar:$,scatterND:pv,scatter_util:e0,selu:iv,separableConv2d:Qa,serialization:nx,setBackend:function(e){return A.setBackend(e)},setPlatform:function(e,n){q().setPlatform(e,n)},setdiff1dAsync:Bh,sigmoid:iu,sign:Tp,signal:wv,sin:Op,sinh:Pp,slice:Wn,slice1d:jd,slice2d:Kd,slice3d:gu,slice4d:Xd,slice_util:n0,softmax:Yn,softplus:Bp,spaceToBatchND:Fs,sparseToDense:vv,spectral:dv,split:Aa,sqrt:Lp,square:fp,squaredDifference:ou,squaredDifferenceStrict:hd,squeeze:Ms,stack:dn,step:Wp,stft:Iu,stridedSlice:hv,sub:Ge,subStrict:fd,sum:yu,sumOutType:ya,tan:zp,tanh:Up,tensor:Je,tensor1d:Pe,tensor2d:lt,tensor3d:Da,tensor4d:ln,tensor5d:Sh,tensor6d:Dh,tensor_util:Ug,test_util:tx,tidy:Q,tile:pr,time:function(e){return A.time(e)},topk:fv,train:ox,transpose:pt,truncatedNormal:Jh,unregisterGradient:function(e){if(!po.has(e))throw new Error("The gradient '"+e+"' for backend is not registered");po.delete(e)},unregisterKernel:function(e,n){var t=ns(e,n);if(!Tr.has(t))throw new Error("The kernel '"+e+"' for backend '"+n+"' is not registered");Tr.delete(t)},unsortedSegmentSum:du,unstack:Ue,util:Bg,valueAndGrad:function(e){return S(Nt(e),function(){return"The f passed in valueAndGrad(f) must be a function"}),function(n,t){S(n instanceof Re,function(){return"The x passed in valueAndGrad(f)(x) must be a tensor"}),S(null==t||t instanceof Re,function(){return"The dy passed in valueAndGrad(f)(x, dy) must be a tensor"});var r=A.gradients(function(){return e(n)},[n],t),o=r.grads,a=r.value;return Wa(o),{grad:o[0],value:a}}},valueAndGrads:function(e){return S(Nt(e),function(){return"The f passed in valueAndGrads(f) must be a function"}),function(n,t){S(Array.isArray(n)&&n.every(function(o){return o instanceof Re}),function(){return"The args passed in valueAndGrads(f)(args) must be array of tensors"}),S(null==t||t instanceof Re,function(){return"The dy passed in valueAndGrads(f)(args, dy) must be a tensor"});var r=A.gradients(function(){return e.apply(void 0,n)},n,t);return null!=t&&we(r.value.shape,t.shape,"The shape of dy passed in valueAndGrads(f)([x1,...], dy) must match the shape returned by f([x1,...])"),Wa(r.grads),r}},variable:Ah,variableGrads:af,version_core:"1.7.0",webgl:rx,where:Bt,whereAsync:su,zeros:Se,zerosLike:xe});function qt(e,n,t){if(void 0===t&&(t=!1),e.beginPath(),n.slice(1).forEach(function(a,i){var s=a.x,u=a.y,c=n[i];e.moveTo(c.x,c.y),e.lineTo(s,u)}),t){var r=n[n.length-1],o=n[0];if(!r||!o)return;e.moveTo(r.x,r.y),e.lineTo(o.x,o.y)}e.stroke()}var tm=function(e,n){return(tm=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var o in r)r.hasOwnProperty(o)&&(t[o]=r[o])})(e,n)};function fe(e,n){function t(){this.constructor=e}tm(e,n),e.prototype=null===n?Object.create(n):(t.prototype=n.prototype,new t)}var fn=function(){return(fn=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++)for(var o in n=arguments[t])Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o]);return e}).apply(this,arguments)};function te(e,n,t,r){return new(t=t||Promise)(function(o,a){function i(c){try{u(r.next(c))}catch(l){a(l)}}function s(c){try{u(r.throw(c))}catch(l){a(l)}}function u(c){c.done?o(c.value):new t(function(l){l(c.value)}).then(i,s)}u((r=r.apply(e,n||[])).next())})}function re(e,n){var t,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(u){return function(c){return function(l){if(t)throw new TypeError("Generator is already executing.");for(;i;)try{if(t=1,r&&(o=2&l[0]?r.return:l[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,l[1])).done)return o;switch(r=0,o&&(l=[2&l[0],o.value]),l[0]){case 0:case 1:o=l;break;case 4:return i.label++,{value:l[1],done:!1};case 5:i.label++,r=l[1],l=[0];continue;case 7:l=i.ops.pop(),i.trys.pop();continue;default:if(!(o=0<(o=i.trys).length&&o[o.length-1])&&(6===l[0]||2===l[0])){i=0;continue}if(3===l[0]&&(!o||l[1]>o[0]&&l[1]<o[3])){i.label=l[1];break}if(6===l[0]&&i.label<o[1]){i.label=o[1],o=l;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(l);break}o[2]&&i.ops.pop(),i.trys.pop();continue}l=n.call(e,i)}catch(h){l=[6,h],r=0}finally{t=o=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([u,c])}}}function Jo(){for(var e=0,n=0,t=arguments.length;n<t;n++)e+=arguments[n].length;var r=Array(e),o=0;for(n=0;n<t;n++)for(var a=arguments[n],i=0,s=a.length;i<s;i++,o++)r[o]=a[i];return r}var jt=(Object.defineProperty(Qo.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(Qo.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Qo.prototype.reverse=function(){return new Qo(1/this.width,1/this.height)},Qo);function Qo(e,n){if(!Kt(e)||!Kt(n))throw new Error("Dimensions.constructor - expected width and height to be valid numbers, instead have "+JSON.stringify({width:e,height:n}));this._width=e,this._height=n}function Jr(e,n){return e instanceof Re&&e.shape.length===n}function rm(e){return Jr(e,2)}function Zo(e){return Jr(e,3)}function wt(e){return Jr(e,4)}function om(e){return e%1!=0}function oc(e){return e%2==0}function li(e,n){void 0===n&&(n=2);var t=Math.pow(10,n);return Math.floor(e*t)/t}function ac(e){return e&&e.width&&e.height}function am(e,n){var t=e.width,r=e.height,o=n/Math.max(r,t);return new jt(Math.round(t*o),Math.round(r*o))}function hi(e){return e.reduce(function(n,t){return n.add(t)},new Ce(0,0)).div(new Ce(e.length,e.length))}function Qr(e,n,t){return Array(e).fill(0).map(function(r,o){return n+o*t})}function Kt(e){return!!e&&e!==1/0&&e!==-1/0&&!isNaN(e)||0===e}function fi(e){return Kt(e)&&0<=e&&e<=1}var sx=Object.freeze({__proto__:null,isTensor:Jr,isTensor1D:function(e){return Jr(e,1)},isTensor2D:rm,isTensor3D:Zo,isTensor4D:wt,isFloat:om,isEven:oc,round:li,isDimensions:ac,computeReshapedDimensions:am,getCenterPoint:hi,range:Qr,isValidNumber:Kt,isValidProbablitiy:fi}),Ce=(Object.defineProperty(sn.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(sn.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),sn.prototype.add=function(e){return new sn(this.x+e.x,this.y+e.y)},sn.prototype.sub=function(e){return new sn(this.x-e.x,this.y-e.y)},sn.prototype.mul=function(e){return new sn(this.x*e.x,this.y*e.y)},sn.prototype.div=function(e){return new sn(this.x/e.x,this.y/e.y)},sn.prototype.abs=function(){return new sn(Math.abs(this.x),Math.abs(this.y))},sn.prototype.magnitude=function(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))},sn.prototype.floor=function(){return new sn(Math.floor(this.x),Math.floor(this.y))},sn);function sn(e,n){this._x=e,this._y=n}var Un=(be.isRect=function(e){return!!e&&[e.x,e.y,e.width,e.height].every(Kt)},be.assertIsValidBox=function(e,n,t){if(void 0===t&&(t=!1),!be.isRect(e))throw new Error(n+" - invalid box: "+JSON.stringify(e)+", expected object with properties x, y, width, height");if(!t&&(e.width<0||e.height<0))throw new Error(n+" - width ("+e.width+") and height ("+e.height+") must be positive numbers")},Object.defineProperty(be.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(be.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),Object.defineProperty(be.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(be.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(be.prototype,"left",{get:function(){return this.x},enumerable:!0,configurable:!0}),Object.defineProperty(be.prototype,"top",{get:function(){return this.y},enumerable:!0,configurable:!0}),Object.defineProperty(be.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(be.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(be.prototype,"area",{get:function(){return this.width*this.height},enumerable:!0,configurable:!0}),Object.defineProperty(be.prototype,"topLeft",{get:function(){return new Ce(this.left,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(be.prototype,"topRight",{get:function(){return new Ce(this.right,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(be.prototype,"bottomLeft",{get:function(){return new Ce(this.left,this.bottom)},enumerable:!0,configurable:!0}),Object.defineProperty(be.prototype,"bottomRight",{get:function(){return new Ce(this.right,this.bottom)},enumerable:!0,configurable:!0}),be.prototype.round=function(){var e=[this.x,this.y,this.width,this.height].map(function(n){return Math.round(n)});return new be({x:e[0],y:e[1],width:e[2],height:e[3]})},be.prototype.floor=function(){var e=[this.x,this.y,this.width,this.height].map(function(n){return Math.floor(n)});return new be({x:e[0],y:e[1],width:e[2],height:e[3]})},be.prototype.toSquare=function(){var e=this.x,n=this.y,t=this.width,r=this.height,o=Math.abs(t-r);return t<r&&(e-=o/2,t+=o),r<t&&(n-=o/2,r+=o),new be({x:e,y:n,width:t,height:r})},be.prototype.rescale=function(e){var n=ac(e)?e.width:e,t=ac(e)?e.height:e;return new be({x:this.x*n,y:this.y*t,width:this.width*n,height:this.height*t})},be.prototype.pad=function(e,n){var t=[this.x-e/2,this.y-n/2,this.width+e,this.height+n];return new be({x:t[0],y:t[1],width:t[2],height:t[3]})},be.prototype.clipAtImageBorders=function(e,n){var r=this.y,o=this.right,a=this.bottom,i=Math.max(this.x,0),s=Math.max(r,0),c=a-s;return new be({x:i,y:s,width:Math.min(o-i,e-i),height:Math.min(c,n-s)}).floor()},be.prototype.shift=function(e,n){return new be({x:this.x+e,y:this.y+n,width:this.width,height:this.height})},be.prototype.padAtBorders=function(e,n){var t=this.width+1,r=this.height+1,o=t,a=r,i=this.left,s=this.top,u=this.right,c=this.bottom;return n<u&&(o=-u+n+t,u=n),e<c&&(a=-c+e+r,c=e),i<1&&(a=2-i,i=1),s<1&&(a=2-s,s=1),{dy:1,edy:a,dx:1,edx:o,y:s,ey:c,x:i,ex:u,w:t,h:r}},be.prototype.calibrate=function(e){return new be({left:this.left+e.left*this.width,top:this.top+e.top*this.height,right:this.right+e.right*this.width,bottom:this.bottom+e.bottom*this.height}).toSquare().round()},be);function be(e,n){void 0===n&&(n=!0);var t=e||{},r=[t.left,t.top,t.right,t.bottom].every(Kt),o=[t.x,t.y,t.width,t.height].every(Kt);if(!o&&!r)throw new Error("Box.constructor - expected box to be IBoundingBox | IRect, instead have "+JSON.stringify(t));var a=o?[t.x,t.y,t.width,t.height]:[t.left,t.top,t.right-t.left,t.bottom-t.top],i=a[0],s=a[1],u=a[2],c=a[3];be.assertIsValidBox({x:i,y:s,width:u,height:c},"Box.constructor",n),this._x=i,this._y=s,this._width=u,this._height=c}var im,ea=(fe(sm,im=Un),sm);function sm(e,n,t,r,o){return void 0===o&&(o=!1),im.call(this,{left:e,top:n,right:t,bottom:r},o)||this}var ic=(Object.defineProperty(Vn.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(Vn.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0}),Object.defineProperty(Vn.prototype,"className",{get:function(){return this._className},enumerable:!0,configurable:!0}),Object.defineProperty(Vn.prototype,"box",{get:function(){return this._box},enumerable:!0,configurable:!0}),Object.defineProperty(Vn.prototype,"imageDims",{get:function(){return this._imageDims},enumerable:!0,configurable:!0}),Object.defineProperty(Vn.prototype,"imageWidth",{get:function(){return this.imageDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(Vn.prototype,"imageHeight",{get:function(){return this.imageDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(Vn.prototype,"relativeBox",{get:function(){return new Un(this._box).rescale(this.imageDims.reverse())},enumerable:!0,configurable:!0}),Vn.prototype.forSize=function(e,n){return new Vn(this.score,this.classScore,this.className,this.relativeBox,{width:e,height:n})},Vn);function Vn(e,n,t,r,o){this._imageDims=new jt(o.width,o.height),this._score=e,this._classScore=n,this._className=t,this._box=new Un(r).rescale(this._imageDims)}var sc,mn=(fe(pi,sc=ic),pi.prototype.forSize=function(e,n){var t=sc.prototype.forSize.call(this,e,n);return new pi(t.score,t.relativeBox,t.imageDims)},pi);function pi(e,n,t){return sc.call(this,e,e,"",n,t)||this}function um(e,n,t){void 0===t&&(t=!0);var r=Math.max(0,Math.min(e.right,n.right)-Math.max(e.left,n.left))*Math.max(0,Math.min(e.bottom,n.bottom)-Math.max(e.top,n.top));return t?r/(e.area+n.area-r):r/Math.min(e.area,n.area)}function cm(e){var n=e.map(function(s){return s.x}),t=e.map(function(s){return s.y}),r=n.reduce(function(s,u){return u<s?u:s},1/0),o=t.reduce(function(s,u){return u<s?u:s},1/0),a=n.reduce(function(s,u){return s<u?u:s},0),i=t.reduce(function(s,u){return s<u?u:s},0);return new ea(r,o,a,i)}function Zr(e,n,t,r){void 0===r&&(r=!0);for(var o=n.map(function(s,u){return{score:s,boxIndex:u}}).sort(function(s,u){return s.score-u.score}).map(function(s){return s.boxIndex}),a=[],i=function(){var s=o.pop();a.push(s);for(var u=o,c=[],l=0;l<u.length;l++)c.push(um(e[s],e[u[l]],r));o=o.filter(function(d,g){return c[g]<=t})};0<o.length;)i();return a}function eo(e,n){return Q(function(){var t=n[0],r=n[1],o=n[2],a=Ln(Jo(e.shape.slice(0,3),[1]),t),i=Ln(Jo(e.shape.slice(0,3),[1]),r),s=Ln(Jo(e.shape.slice(0,3),[1]),o),u=ze([a,i,s],3);return Ge(e,u)})}function lm(e,n){return void 0===n&&(n=!1),Q(function(){var t=e.shape.slice(1),r=t[0],o=t[1];if(r===o)return e;function a(f){var p=e.shape.slice();return p[u]=f,Ln(p,0)}var i=Math.abs(r-o),s=Math.round(i*(n?.5:1)),u=o<r?2:1,c=a(s),l=i-c.shape[u],h=[n&&l?a(l):null,e,c].filter(function(f){return!!f}).map(function(f){return f.toFloat()});return ze(h,u)})}function di(e){return 1/(1+Math.exp(-e))}var hm,vi=(fe(fm,hm=Un),fm);function fm(e,n,t,r,o){return void 0===o&&(o=!1),hm.call(this,{x:e,y:n,width:t,height:r},o)||this}var br=(Object.defineProperty(Rn.prototype,"shift",{get:function(){return new Ce(this._shift.x,this._shift.y)},enumerable:!0,configurable:!0}),Object.defineProperty(Rn.prototype,"imageWidth",{get:function(){return this._imgDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(Rn.prototype,"imageHeight",{get:function(){return this._imgDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(Rn.prototype,"positions",{get:function(){return this._positions},enumerable:!0,configurable:!0}),Object.defineProperty(Rn.prototype,"relativePositions",{get:function(){var e=this;return this._positions.map(function(n){return n.sub(e._shift).div(new Ce(e.imageWidth,e.imageHeight))})},enumerable:!0,configurable:!0}),Rn.prototype.forSize=function(e,n){return new this.constructor(this.relativePositions,{width:e,height:n})},Rn.prototype.shiftBy=function(e,n){return new this.constructor(this.relativePositions,this._imgDims,new Ce(e,n))},Rn.prototype.shiftByPoint=function(e){return this.shiftBy(e.x,e.y)},Rn.prototype.align=function(e,n){if(void 0===n&&(n={}),e){var t=e instanceof mn?e.box.floor():new Un(e);return this.shiftBy(t.x,t.y).align(null,n)}var r=Object.assign({},{useDlibAlignment:!1,minBoxPadding:.2},n),a=r.minBoxPadding;return r.useDlibAlignment?this.alignDlib():this.alignMinBbox(a)},Rn.prototype.alignDlib=function(){function e(l){return o.sub(l).magnitude()}var n=this.getRefPointsForAlignment(),r=n[1],o=n[2],a=(e(n[0])+e(r))/2,i=Math.floor(a/.45),s=hi(n),u=Math.floor(Math.max(0,s.x-.5*i)),c=Math.floor(Math.max(0,s.y-.43*i));return new vi(u,c,Math.min(i,this.imageWidth+u),Math.min(i,this.imageHeight+c))},Rn.prototype.alignMinBbox=function(e){var n=cm(this.positions);return n.pad(n.width*e,n.height*e)},Rn.prototype.getRefPointsForAlignment=function(){throw new Error("getRefPointsForAlignment not implemented by base class")},Rn);function Rn(e,n,t){void 0===t&&(t=new Ce(0,0));var r=n.width,o=n.height;this._imgDims=new jt(r,o),this._shift=t,this._positions=e.map(function(a){return a.mul(new Ce(r,o)).add(t)})}var uc,pm=(fe(cc,uc=br),cc.prototype.getRefPointsForAlignment=function(){var e=this.positions;return[e[0],e[1],hi([e[3],e[4]])]},cc);function cc(){return null!==uc&&uc.apply(this,arguments)||this}var lc,hc=(fe(Zn,lc=br),Zn.prototype.getJawOutline=function(){return this.positions.slice(0,17)},Zn.prototype.getLeftEyeBrow=function(){return this.positions.slice(17,22)},Zn.prototype.getRightEyeBrow=function(){return this.positions.slice(22,27)},Zn.prototype.getNose=function(){return this.positions.slice(27,36)},Zn.prototype.getLeftEye=function(){return this.positions.slice(36,42)},Zn.prototype.getRightEye=function(){return this.positions.slice(42,48)},Zn.prototype.getMouth=function(){return this.positions.slice(48,68)},Zn.prototype.getRefPointsForAlignment=function(){return[this.getLeftEye(),this.getRightEye(),this.getMouth()].map(hi)},Zn);function Zn(){return null!==lc&&lc.apply(this,arguments)||this}var fc=(Object.defineProperty(mi.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(mi.prototype,"distance",{get:function(){return this._distance},enumerable:!0,configurable:!0}),mi.prototype.toString=function(e){return void 0===e&&(e=!0),this.label+(e?" ("+li(this.distance)+")":"")},mi);function mi(e,n){this._label=e,this._distance=n}var dm,pc=(fe(gi,dm=Un),gi.assertIsValidLabeledBox=function(e,n){if(Un.assertIsValidBox(e,n),!Kt(e.label))throw new Error(n+" - expected property label ("+e.label+") to be a number")},Object.defineProperty(gi.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),gi);function gi(e,n){var t=dm.call(this,e)||this;return t._label=n,t}var na=(Object.defineProperty(no.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(no.prototype,"descriptors",{get:function(){return this._descriptors},enumerable:!0,configurable:!0}),no.prototype.toJSON=function(){return{label:this.label,descriptors:this.descriptors.map(function(e){return Array.from(e)})}},no.fromJSON=function(e){var n=e.descriptors.map(function(t){return new Float32Array(t)});return new no(e.label,n)},no);function no(e,n){if("string"!=typeof e)throw new Error("LabeledFaceDescriptors - constructor expected label to be a string");if(!Array.isArray(n)||n.some(function(t){return!(t instanceof Float32Array)}))throw new Error("LabeledFaceDescriptors - constructor expected descriptors to be an array of Float32Array");this._label=e,this._descriptors=n}var vm,je,ux=(fe(ta,vm=pc),ta.assertIsValidPredictedBox=function(e,n){if(pc.assertIsValidLabeledBox(e,n),!fi(e.score)||!fi(e.classScore))throw new Error(n+" - expected properties score ("+e.score+") and ("+e.classScore+") to be a number between [0, 1]")},Object.defineProperty(ta.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(ta.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0}),ta);function ta(e,n,t,r){var o=vm.call(this,e,n)||this;return o._score=t,o._classScore=r,o}function to(e){return e.detection instanceof mn}function ro(e,n){return Object.assign({},e,{detection:n})}function mm(){var e=window.fetch||function(){throw new Error("fetch - missing fetch implementation for browser environment")};return{Canvas:HTMLCanvasElement,CanvasRenderingContext2D,Image:HTMLImageElement,ImageData,Video:HTMLVideoElement,createCanvasElement:function(){return document.createElement("canvas")},createImageElement:function(){return document.createElement("img")},fetch:e,readFile:function(){throw new Error("readFile - filesystem not available for browser environment")}}}function gm(e){var n="";if(!e)try{e=require("fs")}catch(t){n=t.toString()}return{readFile:e?function(t){return new Promise(function(r,o){e.readFile(t,function(a,i){return a?o(a):r(i)})})}:function(){throw new Error("readFile - failed to require fs in nodejs environment with error: "+n)}}}function ym(){var e=global.Canvas||global.HTMLCanvasElement,n=global.Image||global.HTMLImageElement,t=global.fetch||function(){throw new Error("fetch - missing fetch implementation for nodejs environment")},r=gm();return fn({Canvas:e||function(){},CanvasRenderingContext2D:global.CanvasRenderingContext2D||function(){},Image:n||function(){},ImageData:global.ImageData||function(){},Video:global.HTMLVideoElement||function(){},createCanvasElement:function(){if(e)return new e;throw new Error("createCanvasElement - missing Canvas implementation for nodejs environment")},createImageElement:function(){if(n)return new n;throw new Error("createImageElement - missing Image implementation for nodejs environment")},fetch:t},r)}function xm(){return"object"==typeof window&&typeof document<"u"&&typeof HTMLImageElement<"u"&&typeof HTMLCanvasElement<"u"&&typeof HTMLVideoElement<"u"&&typeof ImageData<"u"&&typeof CanvasRenderingContext2D<"u"}function bm(){return"object"==typeof global&&"function"==typeof require&&typeof module<"u"&&typeof process<"u"&&!!process.version}function dc(e){je=e}function vc(){xm()&&dc(mm()),bm()&&dc(ym())}var Ct,yi,Qe={getEnv:function(){if(!je)throw new Error("getEnv - environment is not defined, check isNodejs() and isBrowser()");return je},setEnv:dc,initialize:vc,createBrowserEnv:mm,createFileSystem:gm,createNodejsEnv:ym,monkeyPatch:function(e){if(je||vc(),!je)throw new Error("monkeyPatch - environment is not defined, check isNodejs() and isBrowser()");var n=e.Canvas,t=void 0===n?je.Canvas:n,r=e.Image,o=void 0===r?je.Image:r;je.Canvas=t,je.Image=o,je.createCanvasElement=e.createCanvasElement||function(){return new t},je.createImageElement=e.createImageElement||function(){return new o},je.ImageData=e.ImageData||je.ImageData,je.Video=e.Video||je.Video,je.fetch=e.fetch||je.fetch,je.readFile=e.readFile||je.readFile},isBrowser:xm,isNodejs:bm};function xi(e){return Qe.isNodejs()||"string"!=typeof e?e:document.getElementById(e)}function Gn(e){var n=Qe.getEnv(),t=n.Canvas;if(e instanceof n.CanvasRenderingContext2D)return e;var r=xi(e);if(!(r instanceof t))throw new Error("resolveContext2d - expected canvas to be of instance of Canvas");var o=r.getContext("2d");if(!o)throw new Error("resolveContext2d - canvas 2d context is null");return o}vc(),(yi=Ct=Ct||{}).TOP_LEFT="TOP_LEFT",yi.TOP_RIGHT="TOP_RIGHT",yi.BOTTOM_LEFT="BOTTOM_LEFT",yi.BOTTOM_RIGHT="BOTTOM_RIGHT";var mc=function(e){void 0===e&&(e={});var t=e.backgroundColor,r=e.fontColor,o=e.fontSize,a=e.fontStyle,i=e.padding;this.anchorPosition=e.anchorPosition||Ct.TOP_LEFT,this.backgroundColor=t||"rgba(0, 0, 0, 0.5)",this.fontColor=r||"rgba(255, 255, 255, 1)",this.fontSize=o||14,this.fontStyle=a||"Georgia",this.padding=i||4},gc=(oo.prototype.measureWidth=function(e){var n=this.options.padding;return this.text.map(function(t){return e.measureText(t).width}).reduce(function(t,r){return t<r?r:t},0)+2*n},oo.prototype.measureHeight=function(){var e=this.options;return this.text.length*e.fontSize+2*e.padding},oo.prototype.getUpperLeft=function(e,n){var t=this.options.anchorPosition,r=t===Ct.BOTTOM_RIGHT||t===Ct.TOP_RIGHT,o=t===Ct.BOTTOM_LEFT||t===Ct.BOTTOM_RIGHT,a=this.measureWidth(e),i=this.measureHeight(),s=r?this.anchor.x-a:this.anchor.x,u=o?this.anchor.y-i:this.anchor.y;if(n){var l=n.height;return{x:Math.max(Math.min(s,n.width-a),0),y:Math.max(Math.min(u,l-i),0)}}return{x:s,y:u}},oo.prototype.draw=function(e){var n=xi(e),t=Gn(n),r=this.options,o=r.backgroundColor,a=r.fontColor,i=r.fontSize,u=r.padding;t.font=i+"px "+r.fontStyle;var c=this.measureWidth(t),l=this.measureHeight();t.fillStyle=o;var h=this.getUpperLeft(t,n);t.fillRect(h.x,h.y,c,l),t.fillStyle=a,this.text.forEach(function(f,p){t.fillText(f,u+h.x,u+h.y+(p+1)*i)})},oo);function oo(e,n,t){void 0===t&&(t={}),this.text="string"==typeof e?[e]:e instanceof oo?e.text:e,this.anchor=n,this.options=new mc(t)}var wm=function(e){void 0===e&&(e={});var t=e.lineWidth,r=e.label,o=e.drawLabelOptions;this.boxColor=e.boxColor||"rgba(0, 0, 255, 1)",this.lineWidth=t||2,this.label=r,this.drawLabelOptions=new mc(Object.assign({},{anchorPosition:Ct.BOTTOM_LEFT,backgroundColor:this.boxColor},o))},Cm=(Em.prototype.draw=function(e){var n=Gn(e),t=this.options,o=t.lineWidth,a=this.box,i=a.x,s=a.y,u=a.width,c=a.height;n.strokeStyle=t.boxColor,n.lineWidth=o,n.strokeRect(i,s,u,c);var l=this.options.label;l&&new gc([l],{x:i-o/2,y:s},this.options.drawLabelOptions).draw(e)},Em);function Em(e,n){void 0===n&&(n={}),this.box=new Un(e),this.options=new wm(n)}function yc(e){var n=Qe.getEnv();return e instanceof n.Image&&e.complete||e instanceof n.Video&&3<=e.readyState}function _m(e){return new Promise(function(n,t){if(e instanceof Qe.getEnv().Canvas||yc(e))return n();function r(a){a.currentTarget&&(a.currentTarget.removeEventListener("load",r),a.currentTarget.removeEventListener("error",o),n(a))}function o(a){a.currentTarget&&(a.currentTarget.removeEventListener("load",r),a.currentTarget.removeEventListener("error",o),t(a))}e.addEventListener("load",r),e.addEventListener("error",o)})}function Im(e){return new Promise(function(n,t){if(!(e instanceof Blob))return t("bufferToImage - expected buf to be of type: Blob");var r=new FileReader;r.onload=function(){if("string"!=typeof r.result)return t("bufferToImage - expected reader.result to be a string, in onload");var o=Qe.getEnv().createImageElement();o.onload=function(){return n(o)},o.onerror=t,o.src=r.result},r.onerror=t,r.readAsDataURL(e)})}function bi(e){var n=Qe.getEnv(),r=n.Video;return e instanceof n.Image?new jt(e.naturalWidth,e.naturalHeight):e instanceof r?new jt(e.videoWidth,e.videoHeight):new jt(e.width,e.height)}function ra(e){var n=e.width,t=e.height,r=(0,Qe.getEnv().createCanvasElement)();return r.width=n,r.height=t,r}function wi(e,n){var t=Qe.getEnv().ImageData;if(!(e instanceof t||yc(e)))throw new Error("createCanvasFromMedia - media has not finished loading yet");var r=n||bi(e),o=r.width,a=r.height,i=ra({width:o,height:a});return e instanceof t?Gn(i).putImageData(e,0,0):Gn(i).drawImage(e,0,0,o,a),i}function Rm(e,n){return te(this,void 0,void 0,function(){var t,r,o,a,i,s;return re(this,function(u){switch(u.label){case 0:return t=n||Qe.getEnv().createCanvasElement(),r=e.shape.slice(wt(e)?1:0),o=r[0],a=r[1],i=r[2],s=Q(function(){return e.as3D(o,a,i).toInt()}),[4,ui.toPixels(s,t)];case 1:return u.sent(),s.dispose(),[2,t]}})})}function xc(e){var n=Qe.getEnv();return e instanceof n.Image||e instanceof n.Canvas||e instanceof n.Video}function km(e,n,t){void 0===t&&(t=!1);var r=Qe.getEnv(),a=r.Canvas;if(!(e instanceof r.Image||e instanceof a))throw new Error("imageToSquare - expected arg0 to be HTMLImageElement | HTMLCanvasElement");var i=bi(e),s=n/Math.max(i.height,i.width),u=s*i.width,c=s*i.height,l=ra({width:n,height:n}),h=e instanceof a?e:wi(e),f=Math.abs(u-c)/2,p=t&&u<c?f:0,d=t&&c<u?f:0;return Gn(l).drawImage(h,p,d,u,c),l}var oa=(Object.defineProperty(gn.prototype,"imageTensors",{get:function(){return this._imageTensors},enumerable:!0,configurable:!0}),Object.defineProperty(gn.prototype,"canvases",{get:function(){return this._canvases},enumerable:!0,configurable:!0}),Object.defineProperty(gn.prototype,"isBatchInput",{get:function(){return 1<this.batchSize||this._treatAsBatchInput},enumerable:!0,configurable:!0}),Object.defineProperty(gn.prototype,"batchSize",{get:function(){return this._batchSize},enumerable:!0,configurable:!0}),Object.defineProperty(gn.prototype,"inputDimensions",{get:function(){return this._inputDimensions},enumerable:!0,configurable:!0}),Object.defineProperty(gn.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(gn.prototype,"reshapedInputDimensions",{get:function(){var e=this;return Qr(this.batchSize,0,1).map(function(n,t){return e.getReshapedInputDimensions(t)})},enumerable:!0,configurable:!0}),gn.prototype.getInput=function(e){return this.canvases[e]||this.imageTensors[e]},gn.prototype.getInputDimensions=function(e){return this._inputDimensions[e]},gn.prototype.getInputHeight=function(e){return this._inputDimensions[e][0]},gn.prototype.getInputWidth=function(e){return this._inputDimensions[e][1]},gn.prototype.getReshapedInputDimensions=function(e){if("number"!=typeof this.inputSize)throw new Error("getReshapedInputDimensions - inputSize not set, toBatchTensor has not been called yet");return am({width:this.getInputWidth(e),height:this.getInputHeight(e)},this.inputSize)},gn.prototype.toBatchTensor=function(e,n){var t=this;return void 0===n&&(n=!0),this._inputSize=e,Q(function(){var r=Qr(t.batchSize,0,1).map(function(o){var a=t.getInput(o);if(a instanceof Re){var i=wt(a)?a:a.expandDims();return(i=lm(i,n)).shape[1]===e&&i.shape[2]===e||(i=oi.resizeBilinear(i,[e,e])),i.as3D(e,e,3)}if(a instanceof Qe.getEnv().Canvas)return ui.fromPixels(km(a,e,n));throw new Error("toBatchTensor - at batchIdx "+o+", expected input to be instanceof tf.Tensor or instanceof HTMLCanvasElement, instead have "+a)});return dn(r.map(function(o){return o.toFloat()})).as4D(t.batchSize,e,e,3)})},gn);function gn(e,n){var t=this;if(void 0===n&&(n=!1),this._imageTensors=[],this._canvases=[],this._treatAsBatchInput=!1,this._inputDimensions=[],!Array.isArray(e))throw new Error("NetInput.constructor - expected inputs to be an Array of TResolvedNetInput or to be instanceof tf.Tensor4D, instead have "+e);this._treatAsBatchInput=n,this._batchSize=e.length,e.forEach(function(r,o){if(Zo(r))return t._imageTensors[o]=r,void(t._inputDimensions[o]=r.shape);if(wt(r)){var a=r.shape[0];if(1!==a)throw new Error("NetInput - tf.Tensor4D with batchSize "+a+" passed, but not supported in input array");return t._imageTensors[o]=r,void(t._inputDimensions[o]=r.shape.slice(1))}var i=r instanceof Qe.getEnv().Canvas?r:wi(r);t._canvases[o]=i,t._inputDimensions[o]=[i.height,i.width,3]})}function Ke(e){return te(this,void 0,void 0,function(){var n,t,r;return re(this,function(o){switch(o.label){case 0:if(e instanceof oa)return[2,e];if(!(n=Array.isArray(e)?e:[e]).length)throw new Error("toNetInput - empty array passed as input");return t=function(a){return Array.isArray(e)?" at input index "+a+":":""},(r=n.map(xi)).forEach(function(a,i){if(!xc(a)&&!Zo(a)&&!wt(a))throw"string"==typeof n[i]?new Error("toNetInput -"+t(i)+" string passed, but could not resolve HTMLElement for element id "+n[i]):new Error("toNetInput -"+t(i)+" expected media to be of type HTMLImageElement | HTMLVideoElement | HTMLCanvasElement | tf.Tensor3D, or to be an element id");if(wt(a)){var s=a.shape[0];if(1!==s)throw new Error("toNetInput -"+t(i)+" tf.Tensor4D with batchSize "+s+" passed, but not supported in input array")}}),[4,Promise.all(r.map(function(a){return xc(a)&&_m(a)}))];case 1:return o.sent(),[2,new oa(r,Array.isArray(e))]}})})}function Ci(e,n){return te(this,void 0,void 0,function(){var t,r,o,a,i,s;return re(this,function(u){switch(u.label){case 0:return t=Qe.getEnv().Canvas,(r=e)instanceof t?[3,5]:[4,Ke(e)];case 1:if(1<(o=u.sent()).batchSize)throw new Error("extractFaces - batchSize > 1 not supported");return(a=o.getInput(0))instanceof t?(i=a,[3,4]):[3,2];case 2:return[4,Rm(a)];case 3:i=u.sent(),u.label=4;case 4:r=i,u.label=5;case 5:return s=Gn(r),[2,n.map(function(c){return c instanceof mn?c.forSize(r.width,r.height).box.floor():c}).map(function(c){return c.clipAtImageBorders(r.width,r.height)}).map(function(c){var l=c.x,h=c.y,f=c.width,p=c.height,d=ra({width:f,height:p});return Gn(d).putImageData(s.getImageData(l,h,f,p),0,0),d})]}})})}function Ei(e,n){return te(this,void 0,void 0,function(){return re(this,function(t){if(!Zo(e)&&!wt(e))throw new Error("extractFaceTensors - expected image tensor to be 3D or 4D");if(wt(e)&&1<e.shape[0])throw new Error("extractFaceTensors - batchSize > 1 not supported");return[2,Q(function(){var r=e.shape.slice(wt(e)?1:0),o=r[0],a=r[1],i=r[2];return n.map(function(s){return s instanceof mn?s.forSize(a,o).box:s}).map(function(s){return s.clipAtImageBorders(a,o)}).map(function(s){var u=s.x,c=s.y,l=s.width,h=s.height;return gu(e.as3D(o,a,i),[c,u,0],[h,l,i])})})]})})}function _i(e,n){return te(this,void 0,void 0,function(){var t;return re(this,function(r){switch(r.label){case 0:return[4,(0,Qe.getEnv().fetch)(e,n)];case 1:if(!((t=r.sent()).status<400))throw new Error("failed to fetch: ("+t.status+") "+t.statusText+", from url: "+t.url);return[2,t]}})})}function Sm(e){return te(this,void 0,void 0,function(){return re(this,function(n){switch(n.label){case 0:return[4,_i(e)];case 1:return[2,n.sent().json()]}})})}function Dm(e,n){var t=n+"-weights_manifest.json";if(!e)return{modelBaseUri:"",manifestUri:t};if("/"===e)return{modelBaseUri:"/",manifestUri:"/"+t};var r=e.startsWith("http://")?"http://":e.startsWith("https://")?"https://":"",o=(e=e.replace(r,"")).split("/").filter(function(s){return s}),a=e.endsWith(".json")?o[o.length-1]:t,i=r+(e.endsWith(".json")?o.slice(0,o.length-1):o).join("/");return{modelBaseUri:i=e.startsWith("/")?"/"+i:i,manifestUri:"/"===i?"/"+a:i+"/"+a}}function Am(e,n){return te(this,void 0,void 0,function(){var t,o,a;return re(this,function(i){switch(i.label){case 0:return t=Dm(e,n),o=t.modelBaseUri,[4,Sm(t.manifestUri)];case 1:return a=i.sent(),[2,ju.loadWeights(a,o)]}})})}var et=(Object.defineProperty(Xe.prototype,"params",{get:function(){return this._params},enumerable:!0,configurable:!0}),Object.defineProperty(Xe.prototype,"paramMappings",{get:function(){return this._paramMappings},enumerable:!0,configurable:!0}),Object.defineProperty(Xe.prototype,"isLoaded",{get:function(){return!!this.params},enumerable:!0,configurable:!0}),Xe.prototype.getParamFromPath=function(e){var n=this.traversePropertyPath(e);return n.obj[n.objProp]},Xe.prototype.reassignParamFromPath=function(e,n){var t=this.traversePropertyPath(e),r=t.obj,o=t.objProp;r[o].dispose(),r[o]=n},Xe.prototype.getParamList=function(){var e=this;return this._paramMappings.map(function(n){var t=n.paramPath;return{path:t,tensor:e.getParamFromPath(t)}})},Xe.prototype.getTrainableParams=function(){return this.getParamList().filter(function(e){return e.tensor instanceof sr})},Xe.prototype.getFrozenParams=function(){return this.getParamList().filter(function(e){return!(e.tensor instanceof sr)})},Xe.prototype.variable=function(){var e=this;this.getFrozenParams().forEach(function(n){e.reassignParamFromPath(n.path,n.tensor.variable())})},Xe.prototype.freeze=function(){var e=this;this.getTrainableParams().forEach(function(n){var t=n.path,r=n.tensor,o=Je(r.dataSync());r.dispose(),e.reassignParamFromPath(t,o)})},Xe.prototype.dispose=function(e){void 0===e&&(e=!0),this.getParamList().forEach(function(n){if(e&&n.tensor.isDisposed)throw new Error("param tensor has already been disposed for path "+n.path);n.tensor.dispose()}),this._params=void 0},Xe.prototype.serializeParams=function(){return new Float32Array(this.getParamList().map(function(e){return Array.from(e.tensor.dataSync())}).reduce(function(e,n){return e.concat(n)}))},Xe.prototype.load=function(e){return te(this,void 0,void 0,function(){return re(this,function(n){switch(n.label){case 0:return e instanceof Float32Array?(this.extractWeights(e),[2]):[4,this.loadFromUri(e)];case 1:return n.sent(),[2]}})})},Xe.prototype.loadFromUri=function(e){return te(this,void 0,void 0,function(){var n;return re(this,function(t){switch(t.label){case 0:if(e&&"string"!=typeof e)throw new Error(this._name+".loadFromUri - expected model uri");return[4,Am(e,this.getDefaultModelName())];case 1:return n=t.sent(),this.loadFromWeightMap(n),[2]}})})},Xe.prototype.loadFromDisk=function(e){return te(this,void 0,void 0,function(){var n,t,r,o,i,s,u,c,l;return re(this,function(h){switch(h.label){case 0:if(e&&"string"!=typeof e)throw new Error(this._name+".loadFromDisk - expected model file path");return n=Qe.getEnv().readFile,t=Dm(e,this.getDefaultModelName()),r=t.manifestUri,o=t.modelBaseUri,i=ju.weightsLoaderFactory(function(f){return Promise.all(f.map(function(p){return n(p).then(function(d){return d.buffer})}))}),c=(u=JSON).parse,[4,n(r)];case 1:return s=c.apply(u,[h.sent().toString()]),[4,i(s,o)];case 2:return l=h.sent(),this.loadFromWeightMap(l),[2]}})})},Xe.prototype.loadFromWeightMap=function(e){var n=this.extractParamsFromWeigthMap(e),r=n.params;this._paramMappings=n.paramMappings,this._params=r},Xe.prototype.extractWeights=function(e){var n=this.extractParams(e),r=n.params;this._paramMappings=n.paramMappings,this._params=r},Xe.prototype.traversePropertyPath=function(e){if(!this.params)throw new Error("traversePropertyPath - model has no loaded params");var n=e.split("/").reduce(function(o,a){if(!o.nextObj.hasOwnProperty(a))throw new Error("traversePropertyPath - object does not have property "+a+", for path "+e);return{obj:o.nextObj,objProp:a,nextObj:o.nextObj[a]}},{nextObj:this.params}),t=n.obj,r=n.objProp;if(!(t&&r&&t[r]instanceof Re))throw new Error("traversePropertyPath - parameter is not a tensor, for path "+e);return{obj:t,objProp:r}},Xe);function Xe(e){this._name=e,this._params=void 0,this._paramMappings=[]}function kn(e,n,t){return Q(function(){var r=Qa(e,n.depthwise_filter,n.pointwise_filter,t,"same");return de(r,n.bias)})}function bc(e,n,t){return void 0===t&&(t=!1),Q(function(){var r=Fe(t?de(_n(e,n.conv0.filters,[2,2],"same"),n.conv0.bias):kn(e,n.conv0,[2,2])),o=kn(r,n.conv1,[1,1]),a=kn(Fe(de(r,o)),n.conv2,[1,1]);return Fe(de(r,de(o,a)))})}function Ii(e,n,t,r){return void 0===t&&(t=!1),void 0===r&&(r=!0),Q(function(){var o=Fe(t?de(_n(e,n.conv0.filters,r?[2,2]:[1,1],"same"),n.conv0.bias):kn(e,n.conv0,r?[2,2]:[1,1])),a=kn(o,n.conv1,[1,1]),i=kn(Fe(de(o,a)),n.conv2,[1,1]),s=kn(Fe(de(o,de(a,i))),n.conv3,[1,1]);return Fe(de(o,de(a,de(i,s))))})}function Hn(e,n,t,r){return void 0===t&&(t="same"),void 0===r&&(r=!1),Q(function(){var o=de(_n(e,n.filters,[1,1],t),n.bias);return r?Fe(o):o})}function Et(e,n){Object.keys(e).forEach(function(t){n.some(function(r){return r.originalPath===t})||e[t].dispose()})}function Ri(e,n){return function(t,r,o,a){var i=ln(e(t*r*o*o),[o,o,t,r]),s=Pe(e(r));return n.push({paramPath:a+"/filters"},{paramPath:a+"/bias"}),{filters:i,bias:s}}}function wc(e,n){return function(t,r,o){var a=lt(e(t*r),[t,r]),i=Pe(e(r));return n.push({paramPath:o+"/weights"},{paramPath:o+"/bias"}),{weights:a,bias:i}}}var Tm=function(e,n,t){this.depthwise_filter=e,this.pointwise_filter=n,this.bias=t};function Cc(e,n){return function(t,r,o){var a=ln(e(9*t),[3,3,t,1]),i=ln(e(t*r),[1,1,t,r]),s=Pe(e(r));return n.push({paramPath:o+"/depthwise_filter"},{paramPath:o+"/pointwise_filter"},{paramPath:o+"/bias"}),new Tm(a,i,s)}}function Ec(e){return function(n){var t=e(n+"/depthwise_filter",4),r=e(n+"/pointwise_filter",4),o=e(n+"/bias",1);return new Tm(t,r,o)}}function Xt(e,n){return function(t,r,o){var a=e[t];if(!Jr(a,r))throw new Error("expected weightMap["+t+"] to be a Tensor"+r+"D, instead have "+a);return n.push({originalPath:t,paramPath:o||t}),a}}function _t(e){var n=e;return{extractWeights:function(t){var r=n.slice(0,t);return n=n.slice(t),r},getRemainingWeights:function(){return n}}}function Nm(e,n){var t=Ri(e,n),r=Cc(e,n);function o(a,i,s,u){return void 0===u&&(u=!1),{conv0:u?t(a,i,3,s+"/conv0"):r(a,i,s+"/conv0"),conv1:r(i,i,s+"/conv1"),conv2:r(i,i,s+"/conv2")}}return{extractDenseBlock3Params:o,extractDenseBlock4Params:function(a,i,s,u){void 0===u&&(u=!1);var c=o(a,i,s,u);return{conv0:c.conv0,conv1:c.conv1,conv2:c.conv2,conv3:r(i,i,s+"/conv3")}}}}function Fm(e){return function(n){return{filters:e(n+"/filters",4),bias:e(n+"/bias",1)}}}function Mm(e,n){var t=Xt(e,n),r=Fm(t),o=Ec(t);return{extractDenseBlock3Params:function(a,i){return void 0===i&&(i=!1),{conv0:i?r(a+"/conv0"):o(a+"/conv0"),conv1:o(a+"/conv1"),conv2:o(a+"/conv2")}},extractDenseBlock4Params:function(a,i){return void 0===i&&(i=!1),{conv0:i?r(a+"/conv0"):o(a+"/conv0"),conv1:o(a+"/conv1"),conv2:o(a+"/conv2"),conv3:o(a+"/conv3")}}}}var Om,Pm=(fe(wr,Om=et),wr.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("FaceFeatureExtractor - load model before inference");return Q(function(){var t=Ii(eo(e.toBatchTensor(112,!0),[122.782,117.001,104.298]).div($(255)),n.dense0,!0);return t=Ii(t=Ii(t=Ii(t,n.dense1),n.dense2),n.dense3),Hr(t,[7,7],[2,2],"valid")})},wr.prototype.forward=function(e){return te(this,void 0,void 0,function(){var n;return re(this,function(t){switch(t.label){case 0:return n=this.forwardInput,[4,Ke(e)];case 1:return[2,n.apply(this,[t.sent()])]}})})},wr.prototype.getDefaultModelName=function(){return"face_feature_extractor_model"},wr.prototype.extractParamsFromWeigthMap=function(e){return o={dense0:(r=Mm(n=e,t=[]).extractDenseBlock4Params)("dense0",!0),dense1:r("dense1"),dense2:r("dense2"),dense3:r("dense3")},Et(n,t),{params:o,paramMappings:t};var n,t,r,o},wr.prototype.extractParams=function(e){return function(n){var t=[],r=_t(n),a=r.getRemainingWeights,i=Nm(r.extractWeights,t).extractDenseBlock4Params,s=i(3,32,"dense0",!0),u=i(32,64,"dense1"),c=i(64,128,"dense2"),l=i(128,256,"dense3");if(0!==a().length)throw new Error("weights remaing after extract: "+a().length);return{paramMappings:t,params:{dense0:s,dense1:u,dense2:c,dense3:l}}}(e)},wr);function wr(){return Om.call(this,"FaceFeatureExtractor")||this}function nt(e,n){return Q(function(){return de(Vo(e,n.weights),n.bias)})}function Bm(e){var n={},t={};return Object.keys(e).forEach(function(r){(r.startsWith("fc")?t:n)[r]=e[r]}),{featureExtractorMap:n,classifierMap:t}}var _c,Lm=(fe(It,_c=et),Object.defineProperty(It.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),It.prototype.runNet=function(e){var n=this,t=this.params;if(!t)throw new Error(this._name+" - load model before inference");return Q(function(){var r=e instanceof oa?n.faceFeatureExtractor.forwardInput(e):e;return nt(r.as2D(r.shape[0],-1),t.fc)})},It.prototype.dispose=function(e){void 0===e&&(e=!0),this.faceFeatureExtractor.dispose(e),_c.prototype.dispose.call(this,e)},It.prototype.loadClassifierParams=function(e){var n=this.extractClassifierParams(e),r=n.paramMappings;this._params=n.params,this._paramMappings=r},It.prototype.extractClassifierParams=function(e){return function(n,t,r){var o=[],a=_t(n),s=a.getRemainingWeights,u=wc(a.extractWeights,o)(t,r,"fc");if(0!==s().length)throw new Error("weights remaing after extract: "+s().length);return{paramMappings:o,params:{fc:u}}}(e,this.getClassifierChannelsIn(),this.getClassifierChannelsOut())},It.prototype.extractParamsFromWeigthMap=function(e){var o,i,s,u,n=Bm(e),r=n.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(n.featureExtractorMap),u={fc:{weights:(s=Xt(o=r,i=[]))("fc/weights",2),bias:s("fc/bias",1)}},Et(o,i),{params:u,paramMappings:i}},It.prototype.extractParams=function(e){var n=this.getClassifierChannelsIn(),t=this.getClassifierChannelsOut(),r=t*n+t,o=e.slice(0,e.length-r),a=e.slice(e.length-r);return this.faceFeatureExtractor.extractWeights(o),this.extractClassifierParams(a)},It);function It(e,n){var t=_c.call(this,e)||this;return t._faceFeatureExtractor=n,t}var Ic=["neutral","happy","sad","angry","fearful","disgusted","surprised"],ki=(Wm.prototype.asSortedArray=function(){var e=this;return Ic.map(function(n){return{expression:n,probability:e[n]}}).sort(function(n,t){return t.probability-n.probability})},Wm);function Wm(e){var n=this;if(7!==e.length)throw new Error("FaceExpressions.constructor - expected probabilities.length to be 7, have: "+e.length);Ic.forEach(function(t,r){n[t]=e[r]})}var zm,Um=(fe(Yt,zm=Lm),Yt.prototype.forwardInput=function(e){var n=this;return Q(function(){return Yn(n.runNet(e))})},Yt.prototype.forward=function(e){return te(this,void 0,void 0,function(){var n;return re(this,function(t){switch(t.label){case 0:return n=this.forwardInput,[4,Ke(e)];case 1:return[2,n.apply(this,[t.sent()])]}})})},Yt.prototype.predictExpressions=function(e){return te(this,void 0,void 0,function(){var n,t,r,o,a=this;return re(this,function(i){switch(i.label){case 0:return[4,Ke(e)];case 1:return n=i.sent(),[4,this.forwardInput(n)];case 2:return t=i.sent(),[4,Promise.all(Ue(t).map(function(s){return te(a,void 0,void 0,function(){var u;return re(this,function(c){switch(c.label){case 0:return[4,s.data()];case 1:return u=c.sent(),s.dispose(),[2,u]}})})}))];case 3:return r=i.sent(),t.dispose(),o=r.map(function(s){return new ki(s)}),[2,n.isBatchInput?o:o[0]]}})})},Yt.prototype.getDefaultModelName=function(){return"face_expression_model"},Yt.prototype.getClassifierChannelsIn=function(){return 256},Yt.prototype.getClassifierChannelsOut=function(){return 7},Yt);function Yt(e){return void 0===e&&(e=new Pm),zm.call(this,"FaceExpressionNet",e)||this}function Vm(e){return e.expressions instanceof ki}function Rc(e,n){return Object.assign({},e,{expressions:n})}function Si(e){return to(e)&&e.landmarks instanceof br&&e.unshiftedLandmarks instanceof br&&e.alignedRect instanceof mn}function aa(e,n){var t=e.detection.box,r=n.shiftBy(t.x,t.y),o=r.align(),a=e.detection.imageDims,i={landmarks:r,unshiftedLandmarks:n,alignedRect:new mn(e.detection.score,o.rescale(a.reverse()),a)};return Object.assign({},e,i)}var Gm=function(e){void 0===e&&(e={});var n=e.drawLines,r=e.drawPoints,o=void 0===r||r,a=e.lineWidth,i=e.lineColor,s=e.pointSize,u=e.pointColor;this.drawLines=void 0===n||n,this.drawPoints=o,this.lineWidth=a||1,this.pointSize=s||2,this.lineColor=i||"rgba(0, 255, 255, 1)",this.pointColor=u||"rgba(255, 0, 255, 1)"},Hm=(qm.prototype.draw=function(e){var n=Gn(e),t=this.options,o=t.drawPoints,a=t.lineWidth,s=t.pointSize,u=t.pointColor;t.drawLines&&this.faceLandmarks instanceof hc&&(n.strokeStyle=t.lineColor,n.lineWidth=a,qt(n,this.faceLandmarks.getJawOutline()),qt(n,this.faceLandmarks.getLeftEyeBrow()),qt(n,this.faceLandmarks.getRightEyeBrow()),qt(n,this.faceLandmarks.getNose()),qt(n,this.faceLandmarks.getLeftEye(),!0),qt(n,this.faceLandmarks.getRightEye(),!0),qt(n,this.faceLandmarks.getMouth(),!0)),o&&(n.strokeStyle=u,n.fillStyle=u,this.faceLandmarks.positions.forEach(function(c){n.beginPath(),n.arc(c.x,c.y,s,0,2*Math.PI),n.fill()}))},qm);function qm(e,n){void 0===n&&(n={}),this.faceLandmarks=e,this.options=new Gm(n)}var cx=Object.freeze({__proto__:null,drawContour:qt,drawDetections:function(e,n){(Array.isArray(n)?n:[n]).forEach(function(t){var r=t instanceof mn?t.score:to(t)?t.detection.score:void 0,o=t instanceof mn?t.box:to(t)?t.detection.box:new Un(t),a=r?""+li(r):void 0;new Cm(o,{label:a}).draw(e)})},drawFaceExpressions:function(e,n,t,r){void 0===t&&(t=.1),(Array.isArray(n)?n:[n]).forEach(function(o){var a=o instanceof ki?o:Vm(o)?o.expressions:void 0;if(!a)throw new Error("drawFaceExpressions - expected faceExpressions to be FaceExpressions | WithFaceExpressions<{}> or array thereof");var i=a.asSortedArray().filter(function(u){return u.probability>t}),s=to(o)?o.detection.box.bottomLeft:r||new Ce(0,0);new gc(i.map(function(u){return u.expression+" ("+li(u.probability)+")"}),s).draw(e)})},DrawBoxOptions:wm,DrawBox:Cm,DrawFaceLandmarksOptions:Gm,DrawFaceLandmarks:Hm,drawFaceLandmarks:function(e,n){(Array.isArray(n)?n:[n]).forEach(function(t){var r=t instanceof br?t:Si(t)?t.landmarks:void 0;if(!r)throw new Error("drawFaceLandmarks - expected faceExpressions to be FaceLandmarks | WithFaceLandmarks<WithFaceDetection<{}>> or array thereof");new Hm(r).draw(e)})},get AnchorPosition(){return Ct},DrawTextFieldOptions:mc,DrawTextField:gc});function jm(e,n,t){return de(_n(e,n.filters,t,"same"),n.bias)}function kc(e,n,t){void 0===t&&(t=!0);var r=t?Fe(e):e;return r=kn(r,n.separable_conv0,[1,1]),r=kn(Fe(r),n.separable_conv1,[1,1]),r=qe(r,[3,3],[2,2],"same"),de(r,jm(e,n.expansion_conv,[2,2]))}var Km,Xm,fx=(fe(Cr,Km=et),Cr.prototype.forwardInput=function(e){var n=this,t=this.params;if(!t)throw new Error("TinyXception - load model before inference");return Q(function(){var r=eo(e.toBatchTensor(112,!0),[122.782,117.001,104.298]).div($(256)),o=Fe(jm(r,t.entry_flow.conv_in,[2,2]));return o=kc(o=kc(o,t.entry_flow.reduction_block_0,!1),t.entry_flow.reduction_block_1),Qr(n._numMainBlocks,0,1).forEach(function(a){var i,s,u;s=t.middle_flow["main_block_"+a],u=kn(Fe(i=o),s.separable_conv0,[1,1]),u=kn(Fe(u),s.separable_conv1,[1,1]),u=kn(Fe(u),s.separable_conv2,[1,1]),o=de(u,i)}),o=kc(o,t.exit_flow.reduction_block),o=Fe(kn(o,t.exit_flow.separable_conv,[1,1]))})},Cr.prototype.forward=function(e){return te(this,void 0,void 0,function(){var n;return re(this,function(t){switch(t.label){case 0:return n=this.forwardInput,[4,Ke(e)];case 1:return[2,n.apply(this,[t.sent()])]}})})},Cr.prototype.getDefaultModelName=function(){return"tiny_xception_model"},Cr.prototype.extractParamsFromWeigthMap=function(e){return function hx(e,n){var p,d,g,t=[],r=(p=Xt(e,t),d=Fm(p),g=Ec(p),{extractConvParams:d,extractSeparableConvParams:g,extractReductionBlockParams:function(v){return{separable_conv0:g(v+"/separable_conv0"),separable_conv1:g(v+"/separable_conv1"),expansion_conv:d(v+"/expansion_conv")}},extractMainBlockParams:function(v){return{separable_conv0:g(v+"/separable_conv0"),separable_conv1:g(v+"/separable_conv1"),separable_conv2:g(v+"/separable_conv2")}}}),a=r.extractSeparableConvParams,i=r.extractReductionBlockParams,s=r.extractMainBlockParams,u={conv_in:(0,r.extractConvParams)("entry_flow/conv_in"),reduction_block_0:i("entry_flow/reduction_block_0"),reduction_block_1:i("entry_flow/reduction_block_1")},c={};Qr(n,0,1).forEach(function(h){c["main_block_"+h]=s("middle_flow/main_block_"+h)});var l={reduction_block:i("exit_flow/reduction_block"),separable_conv:a("exit_flow/separable_conv")};return Et(e,t),{params:{entry_flow:u,middle_flow:c,exit_flow:l},paramMappings:t}}(e,this._numMainBlocks)},Cr.prototype.extractParams=function(e){return function lx(e,n){var d,g,v,m,t=[],r=_t(e),a=r.getRemainingWeights,i=(v=Ri(d=r.extractWeights,g=t),m=Cc(d,g),{extractConvParams:v,extractSeparableConvParams:m,extractReductionBlockParams:function(y,x,w){return{separable_conv0:m(y,x,w+"/separable_conv0"),separable_conv1:m(x,x,w+"/separable_conv1"),expansion_conv:v(y,x,1,w+"/expansion_conv")}},extractMainBlockParams:function(y,x){return{separable_conv0:m(y,y,x+"/separable_conv0"),separable_conv1:m(y,y,x+"/separable_conv1"),separable_conv2:m(y,y,x+"/separable_conv2")}}}),u=i.extractSeparableConvParams,c=i.extractReductionBlockParams,l=i.extractMainBlockParams,h={conv_in:(0,i.extractConvParams)(3,32,3,"entry_flow/conv_in"),reduction_block_0:c(32,64,"entry_flow/reduction_block_0"),reduction_block_1:c(64,128,"entry_flow/reduction_block_1")},f={};Qr(n,0,1).forEach(function(d){f["main_block_"+d]=l(128,"middle_flow/main_block_"+d)});var p={reduction_block:c(128,256,"exit_flow/reduction_block"),separable_conv:u(256,512,"exit_flow/separable_conv")};if(0!==a().length)throw new Error("weights remaing after extract: "+a().length);return{paramMappings:t,params:{entry_flow:h,middle_flow:f,exit_flow:p}}}(e,this._numMainBlocks)},Cr);function Cr(e){var n=Km.call(this,"TinyXception")||this;return n._numMainBlocks=e,n}(Xm=H.Gender||(H.Gender={})).FEMALE="female",Xm.MALE="male";var Sc,Ym=(fe(Sn,Sc=et),Object.defineProperty(Sn.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),Sn.prototype.runNet=function(e){var n=this,t=this.params;if(!t)throw new Error(this._name+" - load model before inference");return Q(function(){var r=e instanceof oa?n.faceFeatureExtractor.forwardInput(e):e,o=Hr(r,[7,7],[2,2],"valid").as2D(r.shape[0],-1);return{age:nt(o,t.fc.age).as1D(),gender:nt(o,t.fc.gender)}})},Sn.prototype.forwardInput=function(e){var n=this;return Q(function(){var t=n.runNet(e);return{age:t.age,gender:Yn(t.gender)}})},Sn.prototype.forward=function(e){return te(this,void 0,void 0,function(){var n;return re(this,function(t){switch(t.label){case 0:return n=this.forwardInput,[4,Ke(e)];case 1:return[2,n.apply(this,[t.sent()])]}})})},Sn.prototype.predictAgeAndGender=function(e){return te(this,void 0,void 0,function(){var n,t,r,o,a,i,s=this;return re(this,function(u){switch(u.label){case 0:return[4,Ke(e)];case 1:return n=u.sent(),[4,this.forwardInput(n)];case 2:return t=u.sent(),r=Ue(t.age),o=Ue(t.gender),a=r.map(function(c,l){return{ageTensor:c,genderTensor:o[l]}}),[4,Promise.all(a.map(function(c){var l=c.ageTensor,h=c.genderTensor;return te(s,void 0,void 0,function(){var f,p,d,g,v;return re(this,function(m){switch(m.label){case 0:return[4,l.data()];case 1:return f=m.sent()[0],[4,h.data()];case 2:return p=m.sent()[0],g=(d=.5<p)?H.Gender.MALE:H.Gender.FEMALE,v=d?p:1-p,l.dispose(),h.dispose(),[2,{age:f,gender:g,genderProbability:v}]}})})}))];case 3:return i=u.sent(),t.age.dispose(),t.gender.dispose(),[2,n.isBatchInput?i:i[0]]}})})},Sn.prototype.getDefaultModelName=function(){return"age_gender_model"},Sn.prototype.dispose=function(e){void 0===e&&(e=!0),this.faceFeatureExtractor.dispose(e),Sc.prototype.dispose.call(this,e)},Sn.prototype.loadClassifierParams=function(e){var n=this.extractClassifierParams(e),r=n.paramMappings;this._params=n.params,this._paramMappings=r},Sn.prototype.extractClassifierParams=function(e){return function(n){var t=[],r=_t(n),a=r.getRemainingWeights,i=wc(r.extractWeights,t),s=i(512,1,"fc/age"),u=i(512,2,"fc/gender");if(0!==a().length)throw new Error("weights remaing after extract: "+a().length);return{paramMappings:t,params:{fc:{age:s,gender:u}}}}(e)},Sn.prototype.extractParamsFromWeigthMap=function(e){var n=Bm(e),r=n.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(n.featureExtractorMap),function(o){var a=[],i=Xt(o,a);function s(c){return{weights:i(c+"/weights",2),bias:i(c+"/bias",1)}}var u={fc:{age:s("fc/age"),gender:s("fc/gender")}};return Et(o,a),{params:u,paramMappings:a}}(r)},Sn.prototype.extractParams=function(e){var n=e.slice(0,e.length-1539),t=e.slice(e.length-1539);return this.faceFeatureExtractor.extractWeights(n),this.extractClassifierParams(t)},Sn);function Sn(e){void 0===e&&(e=new fx(2));var n=Sc.call(this,"AgeGenderNet")||this;return n._faceFeatureExtractor=e,n}var Dc,$m=(fe(Er,Dc=Lm),Er.prototype.postProcess=function(e,n,t){var r=t.map(function(a){var i=a.width,s=a.height,u=n/Math.max(s,i);return{width:i*u,height:s*u}}),o=r.length;return Q(function(){function a(s,u){return dn([Ln([68],s),Ln([68],u)],1).as2D(1,136).as1D()}function i(s,u){var c=r[s],l=c.width,h=c.height;return u(l,h)?Math.abs(l-h)/2:0}return e.mul(Ln([o,136],n)).sub(dn(Array.from(Array(o),function(s,u){return a(i(u,function(l,h){return l<h}),i(u,function(l,h){return h<l}))}))).div(dn(Array.from(Array(o),function(s,u){return a(r[u].width,r[u].height)})))})},Er.prototype.forwardInput=function(e){var n=this;return Q(function(){var t=n.runNet(e);return n.postProcess(t,e.inputSize,e.inputDimensions.map(function(r){return{height:r[0],width:r[1]}}))})},Er.prototype.forward=function(e){return te(this,void 0,void 0,function(){var n;return re(this,function(t){switch(t.label){case 0:return n=this.forwardInput,[4,Ke(e)];case 1:return[2,n.apply(this,[t.sent()])]}})})},Er.prototype.detectLandmarks=function(e){return te(this,void 0,void 0,function(){var n,t,r,o=this;return re(this,function(a){switch(a.label){case 0:return[4,Ke(e)];case 1:return n=a.sent(),t=Q(function(){return Ue(o.forwardInput(n))}),[4,Promise.all(t.map(function(i,s){return te(o,void 0,void 0,function(){var u,c,l,h,f;return re(this,function(p){switch(p.label){case 0:return l=(c=Array).from,[4,i.data()];case 1:return u=l.apply(c,[p.sent()]),h=u.filter(function(d,g){return oc(g)}),f=u.filter(function(d,g){return!oc(g)}),[2,new hc(Array(68).fill(0).map(function(d,g){return new Ce(h[g],f[g])}),{height:n.getInputHeight(s),width:n.getInputWidth(s)})]}})})}))];case 2:return r=a.sent(),t.forEach(function(i){return i.dispose()}),[2,n.isBatchInput?r:r[0]]}})})},Er.prototype.getClassifierChannelsOut=function(){return 136},Er);function Er(){return null!==Dc&&Dc.apply(this,arguments)||this}var Jm,Ac=(fe(Di,Jm=$m),Di.prototype.getDefaultModelName=function(){return"face_landmark_68_model"},Di.prototype.getClassifierChannelsIn=function(){return 256},Di);function Di(e){return void 0===e&&(e=new Pm),Jm.call(this,"FaceLandmark68Net",e)||this}var Qm,px=(fe(_r,Qm=et),_r.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("TinyFaceFeatureExtractor - load model before inference");return Q(function(){var t=bc(eo(e.toBatchTensor(112,!0),[122.782,117.001,104.298]).div($(255)),n.dense0,!0);return t=bc(t=bc(t,n.dense1),n.dense2),Hr(t,[14,14],[2,2],"valid")})},_r.prototype.forward=function(e){return te(this,void 0,void 0,function(){var n;return re(this,function(t){switch(t.label){case 0:return n=this.forwardInput,[4,Ke(e)];case 1:return[2,n.apply(this,[t.sent()])]}})})},_r.prototype.getDefaultModelName=function(){return"face_feature_extractor_tiny_model"},_r.prototype.extractParamsFromWeigthMap=function(e){return o={dense0:(r=Mm(n=e,t=[]).extractDenseBlock3Params)("dense0",!0),dense1:r("dense1"),dense2:r("dense2")},Et(n,t),{params:o,paramMappings:t};var n,t,r,o},_r.prototype.extractParams=function(e){return function(n){var t=[],r=_t(n),a=r.getRemainingWeights,i=Nm(r.extractWeights,t).extractDenseBlock3Params,s=i(3,32,"dense0",!0),u=i(32,64,"dense1"),c=i(64,128,"dense2");if(0!==a().length)throw new Error("weights remaing after extract: "+a().length);return{paramMappings:t,params:{dense0:s,dense1:u,dense2:c}}}(e)},_r);function _r(){return Qm.call(this,"TinyFaceFeatureExtractor")||this}var Zm,eg=(fe(Ai,Zm=$m),Ai.prototype.getDefaultModelName=function(){return"face_landmark_68_tiny_model"},Ai.prototype.getClassifierChannelsIn=function(){return 128},Ai);function Ai(e){return void 0===e&&(e=new px),Zm.call(this,"FaceLandmark68TinyNet",e)||this}var Tc,dx=(fe(ng,Tc=Ac),ng);function ng(){return null!==Tc&&Tc.apply(this,arguments)||this}function Nc(e,n,t,r,o){void 0===o&&(o="same");var c,l,a=n.conv,s=a.bias,u=_n(e,a.filters,t,o);return c=u=de(u,s),u=de(nn(c,(l=n.scale).weights),l.biases),r?Fe(u):u}function tg(e,n){return Nc(e,n,[1,1],!1)}function rg(e,n){return Nc(e,n,[2,2],!0,"valid")}function tt(e,n){var t=Nc(e,n.conv1,[1,1],!0);return t=tg(t,n.conv2),t=de(t,e),Fe(t)}function Ti(e,n){var t=rg(e,n.conv1);t=tg(t,n.conv2);var r=Hr(e,2,2,"valid"),o=Se(r.shape),a=r.shape[3]!==t.shape[3];if(r.shape[1]!==t.shape[1]||r.shape[2]!==t.shape[2]){var i=Jo(t.shape);i[1]=1;var s=Se(i),u=Jo((t=ze([t,s],1)).shape);u[2]=1;var c=Se(u);t=ze([t,c],2)}return r=a?ze([r,o],3):r,t=de(r,t),Fe(t)}var og,Fc=(fe($t,og=et),$t.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("FaceRecognitionNet - load model before inference");return Q(function(){var t=rg(eo(e.toBatchTensor(150,!0).toFloat(),[122.782,117.001,104.298]).div($(256)),n.conv32_down),r=(t=Ti(t=tt(t=tt(t=Ti(t=tt(t=tt(t=Ti(t=tt(t=tt(t=tt(t=Ti(t=tt(t=tt(t=tt(t=qe(t,3,2,"valid"),n.conv32_1),n.conv32_2),n.conv32_3),n.conv64_down),n.conv64_1),n.conv64_2),n.conv64_3),n.conv128_down),n.conv128_1),n.conv128_2),n.conv256_down),n.conv256_1),n.conv256_2),n.conv256_down_out)).mean([1,2]);return Vo(r,n.fc)})},$t.prototype.forward=function(e){return te(this,void 0,void 0,function(){var n;return re(this,function(t){switch(t.label){case 0:return n=this.forwardInput,[4,Ke(e)];case 1:return[2,n.apply(this,[t.sent()])]}})})},$t.prototype.computeFaceDescriptor=function(e){return te(this,void 0,void 0,function(){var n,t,r,o=this;return re(this,function(a){switch(a.label){case 0:return[4,Ke(e)];case 1:return n=a.sent(),t=Q(function(){return Ue(o.forwardInput(n))}),[4,Promise.all(t.map(function(i){return i.data()}))];case 2:return r=a.sent(),t.forEach(function(i){return i.dispose()}),[2,n.isBatchInput?r:r[0]]}})})},$t.prototype.getDefaultModelName=function(){return"face_recognition_model"},$t.prototype.extractParamsFromWeigthMap=function(e){return function(n){var t=[],r=function mx(e,n){var t=Xt(e,n);function r(o){return{conv:{filters:t(o+"/conv/filters",4),bias:t(o+"/conv/bias",1)},scale:(a=o,{weights:t(a+"/scale/weights",1),biases:t(a+"/scale/biases",1)})};var a}return{extractConvLayerParams:r,extractResidualLayerParams:function(o){return{conv1:r(o+"/conv1"),conv2:r(o+"/conv2")}}}}(n,t),a=r.extractResidualLayerParams,i=(0,r.extractConvLayerParams)("conv32_down"),s=a("conv32_1"),u=a("conv32_2"),c=a("conv32_3"),l=a("conv64_down"),h=a("conv64_1"),f=a("conv64_2"),p=a("conv64_3"),d=a("conv128_down"),g=a("conv128_1"),v=a("conv128_2"),m=a("conv256_down"),y=a("conv256_1"),x=a("conv256_2"),w=a("conv256_down_out"),b=n.fc;if(t.push({originalPath:"fc",paramPath:"fc"}),!rm(b))throw new Error("expected weightMap[fc] to be a Tensor2D, instead have "+b);var I={conv32_down:i,conv32_1:s,conv32_2:u,conv32_3:c,conv64_down:l,conv64_1:h,conv64_2:f,conv64_3:p,conv128_down:d,conv128_1:g,conv128_2:v,conv256_down:m,conv256_1:y,conv256_2:x,conv256_down_out:w,fc:b};return Et(n,t),{params:I,paramMappings:t}}(e)},$t.prototype.extractParams=function(e){return function(n){var t=_t(n),r=t.extractWeights,o=t.getRemainingWeights,a=[],i=function vx(e,n){function t(o,a,i,s){var u=function(l,h,f){var p=e(l),d=p.length/(h*f*f);if(om(d))throw new Error("depth has to be an integer: "+d+", weights.length: "+p.length+", numFilters: "+h+", filterSize: "+f);return Q(function(){return pt(ln(p,[h,d,f,f]),[2,3,1,0])})}(o,a,i),c=Pe(e(a));return n.push({paramPath:s+"/filters"},{paramPath:s+"/bias"}),{filters:u,bias:c}}function r(o,a,i,s){return{conv:t(o,a,i,s+"/conv"),scale:(u=a,c=s+"/scale",l=Pe(e(u)),h=Pe(e(u)),n.push({paramPath:c+"/weights"},{paramPath:c+"/biases"}),{weights:l,biases:h})};var u,c,l,h}return{extractConvLayerParams:r,extractResidualLayerParams:function(o,a,i,s,u){return void 0===u&&(u=!1),{conv1:r((u?.5:1)*o,a,i,s+"/conv1"),conv2:r(o,a,i,s+"/conv2")}}}}(r,a),u=i.extractResidualLayerParams,c=(0,i.extractConvLayerParams)(4704,32,7,"conv32_down"),l=u(9216,32,3,"conv32_1"),h=u(9216,32,3,"conv32_2"),f=u(9216,32,3,"conv32_3"),p=u(36864,64,3,"conv64_down",!0),d=u(36864,64,3,"conv64_1"),g=u(36864,64,3,"conv64_2"),v=u(36864,64,3,"conv64_3"),m=u(147456,128,3,"conv128_down",!0),y=u(147456,128,3,"conv128_1"),x=u(147456,128,3,"conv128_2"),w=u(589824,256,3,"conv256_down",!0),b=u(589824,256,3,"conv256_1"),I=u(589824,256,3,"conv256_2"),E=u(589824,256,3,"conv256_down_out"),C=Q(function(){return pt(lt(r(32768),[128,256]),[1,0])});if(a.push({paramPath:"fc"}),0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{params:{conv32_down:c,conv32_1:l,conv32_2:h,conv32_3:f,conv64_down:p,conv64_1:d,conv64_2:g,conv64_3:v,conv128_down:m,conv128_1:y,conv128_2:x,conv256_down:w,conv256_1:b,conv256_2:I,conv256_down_out:E,fc:C},paramMappings:a}}(e)},$t);function $t(){return og.call(this,"FaceRecognitionNet")||this}function Mc(e,n){return Object.assign({},e,{descriptor:n})}function Oc(e,n){return Object.assign({},e,{age:n})}function Pc(e,n,t){return Object.assign({},e,{gender:n,genderProbability:t})}var Ni=(Object.defineProperty(ao.prototype,"minFaceSize",{get:function(){return this._minFaceSize},enumerable:!0,configurable:!0}),Object.defineProperty(ao.prototype,"scaleFactor",{get:function(){return this._scaleFactor},enumerable:!0,configurable:!0}),Object.defineProperty(ao.prototype,"maxNumScales",{get:function(){return this._maxNumScales},enumerable:!0,configurable:!0}),Object.defineProperty(ao.prototype,"scoreThresholds",{get:function(){return this._scoreThresholds},enumerable:!0,configurable:!0}),Object.defineProperty(ao.prototype,"scaleSteps",{get:function(){return this._scaleSteps},enumerable:!0,configurable:!0}),ao);function ao(e){var n=void 0===e?{}:e,t=n.minFaceSize,r=n.scaleFactor,o=n.maxNumScales,a=n.scoreThresholds,i=n.scaleSteps;if(this._name="MtcnnOptions",this._minFaceSize=t||20,this._scaleFactor=r||.709,this._maxNumScales=o||10,this._scoreThresholds=a||[.6,.7,.7],this._scaleSteps=i,"number"!=typeof this._minFaceSize||this._minFaceSize<0)throw new Error(this._name+" - expected minFaceSize to be a number > 0");if("number"!=typeof this._scaleFactor||this._scaleFactor<=0||1<=this._scaleFactor)throw new Error(this._name+" - expected scaleFactor to be a number between 0 and 1");if("number"!=typeof this._maxNumScales||this._maxNumScales<0)throw new Error(this._name+" - expected maxNumScales to be a number > 0");if(!Array.isArray(this._scoreThresholds)||3!==this._scoreThresholds.length||this._scoreThresholds.some(function(s){return"number"!=typeof s}))throw new Error(this._name+" - expected scoreThresholds to be an array of numbers of length 3");if(this._scaleSteps&&(!Array.isArray(this._scaleSteps)||this._scaleSteps.some(function(s){return"number"!=typeof s})))throw new Error(this._name+" - expected scaleSteps to be an array of numbers")}function rt(e,n,t){return Q(function(){var r=_n(e,n.filters,t,"same");return r=de(r,n.batch_norm_offset),ja(r,0,6)})}function wx(e,n,t){var r=e.arraySync(),o=Math.min(r[n][0],r[n][2]),a=Math.min(r[n][1],r[n][3]),i=Math.max(r[n][0],r[n][2]),s=Math.max(r[n][1],r[n][3]),u=Math.min(r[t][0],r[t][2]),c=Math.min(r[t][1],r[t][3]),l=Math.max(r[t][0],r[t][2]),h=Math.max(r[t][1],r[t][3]),f=(i-o)*(s-a),p=(l-u)*(h-c);if(f<=0||p<=0)return 0;var d=Math.max(o,u),g=Math.max(a,c),v=Math.min(i,l),m=Math.min(s,h),y=Math.max(v-d,0)*Math.max(m-g,0);return y/(f+p-y)}function io(e,n){return Q(function(){var t=e.shape[0];return{boxPredictionEncoding:An(Hn(e,n.box_encoding_predictor),[t,-1,1,4]),classPrediction:An(Hn(e,n.class_predictor),[t,-1,3])}})}var Ir=(Object.defineProperty(Bc.prototype,"minConfidence",{get:function(){return this._minConfidence},enumerable:!0,configurable:!0}),Object.defineProperty(Bc.prototype,"maxResults",{get:function(){return this._maxResults},enumerable:!0,configurable:!0}),Bc);function Bc(e){var n=void 0===e?{}:e,t=n.minConfidence,r=n.maxResults;if(this._name="SsdMobilenetv1Options",this._minConfidence=t||.5,this._maxResults=r||100,"number"!=typeof this._minConfidence||this._minConfidence<=0||1<=this._minConfidence)throw new Error(this._name+" - expected minConfidence to be a number between 0 and 1");if("number"!=typeof this._maxResults)throw new Error(this._name+" - expected maxResults to be a number")}var ag,Fi=(fe(Jt,ag=et),Jt.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("SsdMobilenetv1 - load model before inference");return Q(function(){var a,i,s,t=e.toBatchTensor(512,!1).toFloat(),r=function bx(e,n){return Q(function(){var t=null,r=rt(e,n.conv_0,[2,2]);if([n.conv_1,n.conv_2,n.conv_3,n.conv_4,n.conv_5,n.conv_6,n.conv_7,n.conv_8,n.conv_9,n.conv_10,n.conv_11,n.conv_12,n.conv_13].forEach(function(o,a){var u,i=a+1,s=(u=i,[2,4,6,12].some(function(c){return c===u})?[2,2]:[1,1]);r=rt(r=function(u,c,l){return Q(function(){var h=Uo(u,c.filters,l,"same");return h=uu(h,c.batch_norm_mean,c.batch_norm_variance,c.batch_norm_offset,c.batch_norm_scale,.0010000000474974513),ja(h,0,6)})}(r,o.depthwise_conv,s),o.pointwise_conv,[1,1]),11===i&&(t=r)}),null===t)throw new Error("mobileNetV1 - output of conv layer 11 is null");return{out:r,conv11:t}})}(Ge(nn(t,$(.007843137718737125)),$(1)),n.mobilenetv1),o=(a=r.out,i=r.conv11,s=n.prediction_layer,Q(function(){var u=rt(rt(a,s.conv_0,[1,1]),s.conv_1,[2,2]),c=rt(rt(u,s.conv_2,[1,1]),s.conv_3,[2,2]),l=rt(rt(c,s.conv_4,[1,1]),s.conv_5,[2,2]),h=rt(rt(l,s.conv_6,[1,1]),s.conv_7,[2,2]),f=io(i,s.box_predictor_0),p=io(a,s.box_predictor_1),d=io(u,s.box_predictor_2),g=io(c,s.box_predictor_3),v=io(l,s.box_predictor_4),m=io(h,s.box_predictor_5);return{boxPredictions:ze([f.boxPredictionEncoding,p.boxPredictionEncoding,d.boxPredictionEncoding,g.boxPredictionEncoding,v.boxPredictionEncoding,m.boxPredictionEncoding],1),classPredictions:ze([f.classPrediction,p.classPrediction,d.classPrediction,g.classPrediction,v.classPrediction,m.classPrediction],1)}}));return function(a,i,s){return Q(function(){var u=a.shape[0],c=function Cx(e,n){var h,f,t=(h=Ue(pt(e,[1,0])),{sizes:f=[Ge(h[2],h[0]),Ge(h[3],h[1])],centers:[de(h[0],Tn(f[0],$(2))),de(h[1],Tn(f[1],$(2)))]}),r=t.sizes,o=t.centers,a=Ue(pt(n,[1,0])),i=Tn(nn(Ka(Tn(a[2],$(5))),r[0]),$(2)),s=de(nn(Tn(a[0],$(10)),r[0]),o[0]),u=Tn(nn(Ka(Tn(a[3],$(5))),r[1]),$(2)),c=de(nn(Tn(a[1],$(10)),r[1]),o[1]);return pt(dn([Ge(s,i),Ge(c,u),de(s,i),de(c,u)]),[1,0])}(An(pr(s.extra_dim,[u,1,1]),[-1,4]),An(a,[-1,4]));c=An(c,[u,c.shape[0]/u,4]);var l=iu(Wn(i,[0,0,1],[-1,-1,-1])),h=Wn(l,[0,0,0],[-1,-1,1]);return h=An(h,[u,h.shape[1]]),{boxes:Ue(c),scores:Ue(h)}})}(o.boxPredictions,o.classPredictions,n.output_layer)})},Jt.prototype.forward=function(e){return te(this,void 0,void 0,function(){var n;return re(this,function(t){switch(t.label){case 0:return n=this.forwardInput,[4,Ke(e)];case 1:return[2,n.apply(this,[t.sent()])]}})})},Jt.prototype.locateFaces=function(e,n){return void 0===n&&(n={}),te(this,void 0,void 0,function(){var t,r,o,a,i,s,u,c,l,h,f,p,d,g,v,m,y,x,w,b;return re(this,function(I){switch(I.label){case 0:return t=new Ir(n),r=t.maxResults,o=t.minConfidence,[4,Ke(e)];case 1:for(a=I.sent(),i=this.forwardInput(a),c=(s=i.boxes)[0],l=(u=i.scores)[0],h=1;h<s.length;h++)s[h].dispose(),u[h].dispose();return d=(p=Array).from,[4,l.data()];case 2:return f=d.apply(p,[I.sent()]),E=c,C=f,D=o,M=Math.min(r,E.shape[0]),W=C.map(function(F,z){return{score:F,boxIndex:z}}).filter(function(F){return F.score>D}).sort(function(F,z){return z.score-F.score}),P=[],W.forEach(function(F){if(!(P.length>=M)){for(var z=F.score,j=P.length-1;0<=j;--j){var K=wx(E,F.boxIndex,P[j]);if(0!==K&&(F.score*=K<=.5?1:0,F.score<=D))break}z===F.score&&P.push(F.boxIndex)}}),g=P,v=a.getReshapedInputDimensions(0),y=(m=a.inputSize)/v.width,x=m/v.height,w=c.arraySync(),b=g.map(function(E){var C=[Math.max(0,w[E][0]),Math.min(1,w[E][2])].map(function(W){return W*x}),R=C[0],k=C[1],D=[Math.max(0,w[E][1]),Math.min(1,w[E][3])].map(function(W){return W*y}),N=D[0];return new mn(f[E],new vi(N,R,D[1]-N,k-R),{height:a.getInputHeight(0),width:a.getInputWidth(0)})}),c.dispose(),l.dispose(),[2,b]}var E,C,D,M,W,P})})},Jt.prototype.getDefaultModelName=function(){return"ssd_mobilenetv1_model"},Jt.prototype.extractParamsFromWeigthMap=function(e){return function yx(e){var n=[],t=function(s,u){var c=Xt(s,u);function l(d,g,v){return{filters:c(d+"/Conv2d_"+g+"_pointwise/weights",4,v+"/filters"),batch_norm_offset:c(d+"/Conv2d_"+g+"_pointwise/convolution_bn_offset",1,v+"/batch_norm_offset")}}function h(d){var g="mobilenetv1/conv_"+d,v="MobilenetV1/Conv2d_"+d+"_depthwise",m=g+"/depthwise_conv",y=g+"/pointwise_conv";return{depthwise_conv:{filters:c(v+"/depthwise_weights",4,m+"/filters"),batch_norm_scale:c(v+"/BatchNorm/gamma",1,m+"/batch_norm_scale"),batch_norm_offset:c(v+"/BatchNorm/beta",1,m+"/batch_norm_offset"),batch_norm_mean:c(v+"/BatchNorm/moving_mean",1,m+"/batch_norm_mean"),batch_norm_variance:c(v+"/BatchNorm/moving_variance",1,m+"/batch_norm_variance")},pointwise_conv:l("MobilenetV1",d,y)}}function f(d,g){return{filters:c(d+"/weights",4,g+"/filters"),bias:c(d+"/biases",1,g+"/bias")}}function p(d){return{box_encoding_predictor:f("Prediction/BoxPredictor_"+d+"/BoxEncodingPredictor","prediction_layer/box_predictor_"+d+"/box_encoding_predictor"),class_predictor:f("Prediction/BoxPredictor_"+d+"/ClassPredictor","prediction_layer/box_predictor_"+d+"/class_predictor")}}return{extractMobilenetV1Params:function(){return{conv_0:l("MobilenetV1",0,"mobilenetv1/conv_0"),conv_1:h(1),conv_2:h(2),conv_3:h(3),conv_4:h(4),conv_5:h(5),conv_6:h(6),conv_7:h(7),conv_8:h(8),conv_9:h(9),conv_10:h(10),conv_11:h(11),conv_12:h(12),conv_13:h(13)}},extractPredictionLayerParams:function(){return{conv_0:l("Prediction",0,"prediction_layer/conv_0"),conv_1:l("Prediction",1,"prediction_layer/conv_1"),conv_2:l("Prediction",2,"prediction_layer/conv_2"),conv_3:l("Prediction",3,"prediction_layer/conv_3"),conv_4:l("Prediction",4,"prediction_layer/conv_4"),conv_5:l("Prediction",5,"prediction_layer/conv_5"),conv_6:l("Prediction",6,"prediction_layer/conv_6"),conv_7:l("Prediction",7,"prediction_layer/conv_7"),box_predictor_0:p(0),box_predictor_1:p(1),box_predictor_2:p(2),box_predictor_3:p(3),box_predictor_4:p(4),box_predictor_5:p(5)}}}}(e,n),r=t.extractMobilenetV1Params,o=t.extractPredictionLayerParams,a=e["Output/extra_dim"];if(n.push({originalPath:"Output/extra_dim",paramPath:"output_layer/extra_dim"}),!Zo(a))throw new Error("expected weightMap['Output/extra_dim'] to be a Tensor3D, instead have "+a);var i={mobilenetv1:r(),prediction_layer:o(),output_layer:{extra_dim:a}};return Et(e,n),{params:i,paramMappings:n}}(e)},Jt.prototype.extractParams=function(e){return function(n){var t=[],r=_t(n),o=r.extractWeights,a=r.getRemainingWeights,i=function gx(e,n){function t(a,i,s,u,c){var l=ln(e(a*i*s*s),[s,s,a,i]),h=Pe(e(i));return n.push({paramPath:u+"/filters"},{paramPath:u+"/"+(c?"batch_norm_offset":"bias")}),{filters:l,bias:h}}function r(a,i,s,u){var c=t(a,i,s,u,!0);return{filters:c.filters,batch_norm_offset:c.bias}}function o(a,i,s){return{depthwise_conv:(u=a,c=s+"/depthwise_conv",l=ln(e(9*u),[3,3,u,1]),h=Pe(e(u)),f=Pe(e(u)),p=Pe(e(u)),d=Pe(e(u)),n.push({paramPath:c+"/filters"},{paramPath:c+"/batch_norm_scale"},{paramPath:c+"/batch_norm_offset"},{paramPath:c+"/batch_norm_mean"},{paramPath:c+"/batch_norm_variance"}),{filters:l,batch_norm_scale:h,batch_norm_offset:f,batch_norm_mean:p,batch_norm_variance:d}),pointwise_conv:r(a,i,1,s+"/pointwise_conv")};var u,c,l,h,f,p,d}return{extractMobilenetV1Params:function(){return{conv_0:r(3,32,3,"mobilenetv1/conv_0"),conv_1:o(32,64,"mobilenetv1/conv_1"),conv_2:o(64,128,"mobilenetv1/conv_2"),conv_3:o(128,128,"mobilenetv1/conv_3"),conv_4:o(128,256,"mobilenetv1/conv_4"),conv_5:o(256,256,"mobilenetv1/conv_5"),conv_6:o(256,512,"mobilenetv1/conv_6"),conv_7:o(512,512,"mobilenetv1/conv_7"),conv_8:o(512,512,"mobilenetv1/conv_8"),conv_9:o(512,512,"mobilenetv1/conv_9"),conv_10:o(512,512,"mobilenetv1/conv_10"),conv_11:o(512,512,"mobilenetv1/conv_11"),conv_12:o(512,1024,"mobilenetv1/conv_12"),conv_13:o(1024,1024,"mobilenetv1/conv_13")}},extractPredictionLayerParams:function(){return{conv_0:r(1024,256,1,"prediction_layer/conv_0"),conv_1:r(256,512,3,"prediction_layer/conv_1"),conv_2:r(512,128,1,"prediction_layer/conv_2"),conv_3:r(128,256,3,"prediction_layer/conv_3"),conv_4:r(256,128,1,"prediction_layer/conv_4"),conv_5:r(128,256,3,"prediction_layer/conv_5"),conv_6:r(256,64,1,"prediction_layer/conv_6"),conv_7:r(64,128,3,"prediction_layer/conv_7"),box_predictor_0:{box_encoding_predictor:t(512,12,1,"prediction_layer/box_predictor_0/box_encoding_predictor"),class_predictor:t(512,9,1,"prediction_layer/box_predictor_0/class_predictor")},box_predictor_1:{box_encoding_predictor:t(1024,24,1,"prediction_layer/box_predictor_1/box_encoding_predictor"),class_predictor:t(1024,18,1,"prediction_layer/box_predictor_1/class_predictor")},box_predictor_2:{box_encoding_predictor:t(512,24,1,"prediction_layer/box_predictor_2/box_encoding_predictor"),class_predictor:t(512,18,1,"prediction_layer/box_predictor_2/class_predictor")},box_predictor_3:{box_encoding_predictor:t(256,24,1,"prediction_layer/box_predictor_3/box_encoding_predictor"),class_predictor:t(256,18,1,"prediction_layer/box_predictor_3/class_predictor")},box_predictor_4:{box_encoding_predictor:t(256,24,1,"prediction_layer/box_predictor_4/box_encoding_predictor"),class_predictor:t(256,18,1,"prediction_layer/box_predictor_4/class_predictor")},box_predictor_5:{box_encoding_predictor:t(128,24,1,"prediction_layer/box_predictor_5/box_encoding_predictor"),class_predictor:t(128,18,1,"prediction_layer/box_predictor_5/class_predictor")}}}}}(o,t),u=i.extractPredictionLayerParams,c=(0,i.extractMobilenetV1Params)(),l=u(),h={extra_dim:Da(o(20472),[1,5118,4])};if(t.push({paramPath:"output_layer/extra_dim"}),0!==a().length)throw new Error("weights remaing after extract: "+a().length);return{params:{mobilenetv1:c,prediction_layer:l,output_layer:h},paramMappings:t}}(e)},Jt);function Jt(){return ag.call(this,"SsdMobilenetv1")||this}function ig(e){var n=new Fi;return n.extractWeights(e),n}var Lc,Ex=(fe(sg,Lc=Fi),sg);function sg(){return null!==Lc&&Lc.apply(this,arguments)||this}var Qt,_x=[new Ce(.738768,.874946),new Ce(2.42204,2.65704),new Ce(4.30971,7.04493),new Ce(10.246,4.59428),new Ce(12.6868,11.8741)],Ix=[new Ce(1.603231,2.094468),new Ce(6.041143,7.080126),new Ce(2.882459,3.518061),new Ce(4.266906,5.178857),new Ce(9.041765,10.66308)],Rx=[117.001,114.697,97.404],Mi=function(e){return"number"==typeof e};function ug(e){if(!e)throw new Error("invalid config: "+e);if("boolean"!=typeof e.withSeparableConvs)throw new Error("config.withSeparableConvs has to be a boolean, have: "+e.withSeparableConvs);if(!Mi(e.iouThreshold)||e.iouThreshold<0||1<e.iouThreshold)throw new Error("config.iouThreshold has to be a number between [0, 1], have: "+e.iouThreshold);if(!Array.isArray(e.classes)||!e.classes.length||!e.classes.every(function(n){return"string"==typeof n}))throw new Error("config.classes has to be an array class names: string[], have: "+JSON.stringify(e.classes));if(!Array.isArray(e.anchors)||!e.anchors.length||!e.anchors.map(function(n){return n||{}}).every(function(n){return Mi(n.x)&&Mi(n.y)}))throw new Error("config.anchors has to be an array of { x: number, y: number }, have: "+JSON.stringify(e.anchors));if(e.meanRgb&&(!Array.isArray(e.meanRgb)||3!==e.meanRgb.length||!e.meanRgb.every(Mi)))throw new Error("config.meanRgb has to be an array of shape [number, number, number], have: "+JSON.stringify(e.meanRgb))}function Wc(e){return Q(function(){var n=nn(e,$(.10000000149011612));return de(Fe(Ge(e,n)),n)})}function Zt(e,n){return Q(function(){var t=Ot(e,[[0,0],[1,1],[1,1],[0,0]]);return t=_n(t,n.conv.filters,[1,1],"valid"),t=Ge(t,n.bn.sub),t=nn(t,n.bn.truediv),Wc(t=de(t,n.conv.bias))})}function er(e,n){return Q(function(){var t=Ot(e,[[0,0],[1,1],[1,1],[0,0]]);return t=Qa(t,n.depthwise_filter,n.pointwise_filter,[1,1],"valid"),Wc(t=de(t,n.bias))})}(Qt=H.TinyYolov2SizeType||(H.TinyYolov2SizeType={}))[Qt.XS=224]="XS",Qt[Qt.SM=320]="SM",Qt[Qt.MD=416]="MD",Qt[Qt.LG=608]="LG";var ia=(Object.defineProperty(zc.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(zc.prototype,"scoreThreshold",{get:function(){return this._scoreThreshold},enumerable:!0,configurable:!0}),zc);function zc(e){var n=void 0===e?{}:e,t=n.inputSize,r=n.scoreThreshold;if(this._name="TinyYolov2Options",this._inputSize=t||416,this._scoreThreshold=r||.5,"number"!=typeof this._inputSize||this._inputSize%32!=0)throw new Error(this._name+" - expected inputSize to be a number divisible by 32");if("number"!=typeof this._scoreThreshold||this._scoreThreshold<=0||1<=this._scoreThreshold)throw new Error(this._name+" - expected scoreThreshold to be a number between 0 and 1")}var cg,lg=(fe(on,cg=et),Object.defineProperty(on.prototype,"config",{get:function(){return this._config},enumerable:!0,configurable:!0}),Object.defineProperty(on.prototype,"withClassScores",{get:function(){return this.config.withClassScores||1<this.config.classes.length},enumerable:!0,configurable:!0}),Object.defineProperty(on.prototype,"boxEncodingSize",{get:function(){return 5+(this.withClassScores?this.config.classes.length:0)},enumerable:!0,configurable:!0}),on.prototype.runTinyYolov2=function(e,n){var t=Zt(e,n.conv0);return t=Zt(t=qe(t,[2,2],[2,2],"same"),n.conv1),t=Zt(t=qe(t,[2,2],[2,2],"same"),n.conv2),t=Zt(t=qe(t,[2,2],[2,2],"same"),n.conv3),t=Zt(t=qe(t,[2,2],[2,2],"same"),n.conv4),t=Zt(t=qe(t,[2,2],[2,2],"same"),n.conv5),Hn(t=Zt(t=Zt(t=qe(t,[2,2],[1,1],"same"),n.conv6),n.conv7),n.conv8,"valid",!1)},on.prototype.runMobilenet=function(e,n){var t=this.config.isFirstLayerConv2d?Wc(Hn(e,n.conv0,"valid",!1)):er(e,n.conv0);return t=er(t=qe(t,[2,2],[2,2],"same"),n.conv1),t=er(t=qe(t,[2,2],[2,2],"same"),n.conv2),t=er(t=qe(t,[2,2],[2,2],"same"),n.conv3),t=er(t=qe(t,[2,2],[2,2],"same"),n.conv4),t=er(t=qe(t,[2,2],[2,2],"same"),n.conv5),t=qe(t,[2,2],[1,1],"same"),t=n.conv6?er(t,n.conv6):t,Hn(t=n.conv7?er(t,n.conv7):t,n.conv8,"valid",!1)},on.prototype.forwardInput=function(e,n){var t=this,r=this.params;if(!r)throw new Error("TinyYolov2 - load model before inference");return Q(function(){var o=e.toBatchTensor(n,!1).toFloat();return o=(o=t.config.meanRgb?eo(o,t.config.meanRgb):o).div($(256)),t.config.withSeparableConvs?t.runMobilenet(o,r):t.runTinyYolov2(o,r)})},on.prototype.forward=function(e,n){return te(this,void 0,void 0,function(){var t;return re(this,function(r){switch(r.label){case 0:return t=this.forwardInput,[4,Ke(e)];case 1:return[4,t.apply(this,[r.sent(),n])];case 2:return[2,r.sent()]}})})},on.prototype.detect=function(e,n){return void 0===n&&(n={}),te(this,void 0,void 0,function(){var t,r,o,a,i,s,u,c,l,h,f,p,d=this;return re(this,function(g){switch(g.label){case 0:return t=new ia(n),r=t.inputSize,o=t.scoreThreshold,[4,Ke(e)];case 1:return a=g.sent(),[4,this.forwardInput(a,r)];case 2:return i=g.sent(),s=Q(function(){return Ue(i)[0].expandDims()}),u={width:a.getInputWidth(0),height:a.getInputHeight(0)},[4,this.extractBoxes(s,a.getReshapedInputDimensions(0),o)];case 3:return c=g.sent(),i.dispose(),s.dispose(),l=c.map(function(v){return v.box}),h=c.map(function(v){return v.score}),f=c.map(function(v){return v.classScore}),p=c.map(function(v){return d.config.classes[v.label]}),[2,Zr(l.map(function(v){return v.rescale(r)}),h,this.config.iouThreshold,!0).map(function(v){return new ic(h[v],f[v],p[v],l[v],u)})]}})})},on.prototype.getDefaultModelName=function(){return""},on.prototype.extractParamsFromWeigthMap=function(e){return function(n,t){var r,o=[],a=function Sx(e,n){var t=Xt(e,n);function r(o){return{filters:t(o+"/filters",4),bias:t(o+"/bias",1)}}return{extractConvParams:r,extractConvWithBatchNormParams:function(o){return{conv:r(o+"/conv"),bn:(a=o+"/bn",{sub:t(a+"/sub",1),truediv:t(a+"/truediv",1)})};var a},extractSeparableConvParams:Ec(t)}}(n,o),i=a.extractConvParams,s=a.extractConvWithBatchNormParams,u=a.extractSeparableConvParams;if(t.withSeparableConvs){var c=t.filterSizes&&t.filterSizes.length||9;r={conv0:t.isFirstLayerConv2d?i("conv0"):u("conv0"),conv1:u("conv1"),conv2:u("conv2"),conv3:u("conv3"),conv4:u("conv4"),conv5:u("conv5"),conv6:7<c?u("conv6"):void 0,conv7:8<c?u("conv7"):void 0,conv8:i("conv8")}}else r={conv0:s("conv0"),conv1:s("conv1"),conv2:s("conv2"),conv3:s("conv3"),conv4:s("conv4"),conv5:s("conv5"),conv6:s("conv6"),conv7:s("conv7"),conv8:i("conv8")};return Et(n,o),{params:r,paramMappings:o}}(e,this.config)},on.prototype.extractParams=function(e){var n=this.config.filterSizes||on.DEFAULT_FILTER_SIZES,t=n?n.length:void 0;if(7!==t&&8!==t&&9!==t)throw new Error("TinyYolov2 - expected 7 | 8 | 9 convolutional filters, but found "+t+" filterSizes in config");return function(r,o,a,i){var s,u=_t(r),l=u.getRemainingWeights,h=[],f=function kx(e,n){var t=Ri(e,n),r=Cc(e,n);return{extractConvParams:t,extractConvWithBatchNormParams:function(o,a,i){return{conv:t(o,a,3,i+"/conv"),bn:(s=a,u=i+"/bn",c=Pe(e(s)),l=Pe(e(s)),n.push({paramPath:u+"/sub"},{paramPath:u+"/truediv"}),{sub:c,truediv:l})};var s,u,c,l},extractSeparableConvParams:r}}(u.extractWeights,h),p=f.extractConvParams,d=f.extractConvWithBatchNormParams,g=f.extractSeparableConvParams;if(o.withSeparableConvs){var v=i[0],m=i[1],y=i[2],x=i[3],w=i[4],b=i[5],I=i[6],E=i[7],C=i[8];s={conv0:o.isFirstLayerConv2d?p(v,m,3,"conv0"):g(v,m,"conv0"),conv1:g(m,y,"conv1"),conv2:g(y,x,"conv2"),conv3:g(x,w,"conv3"),conv4:g(w,b,"conv4"),conv5:g(b,I,"conv5"),conv6:E?g(I,E,"conv6"):void 0,conv7:C?g(E,C,"conv7"):void 0,conv8:p(C||E||I,5*a,1,"conv8")}}else y=i[2],x=i[3],w=i[4],b=i[5],I=i[6],E=i[7],C=i[8],s={conv0:d(v=i[0],m=i[1],"conv0"),conv1:d(m,y,"conv1"),conv2:d(y,x,"conv2"),conv3:d(x,w,"conv3"),conv4:d(w,b,"conv4"),conv5:d(b,I,"conv5"),conv6:d(I,E,"conv6"),conv7:d(E,C,"conv7"),conv8:p(C,5*a,1,"conv8")};if(0!==l().length)throw new Error("weights remaing after extract: "+l().length);return{params:s,paramMappings:h}}(e,this.config,this.boxEncodingSize,n)},on.prototype.extractBoxes=function(e,n,t){return te(this,void 0,void 0,function(){var r,o,a,i,s,u,c,l,h,f,p,d,g,v,m,y,x,w,b,I,E,C,R,k,D,N,M,W,P,F=this;return re(this,function(z){switch(z.label){case 0:return r=n.width,o=n.height,a=Math.max(r,o),i=a/r,s=a/o,u=e.shape[1],c=this.config.anchors.length,l=Q(function(){var j=e.reshape([u,u,c,F.boxEncodingSize]);return[j.slice([0,0,0,0],[u,u,c,4]),j.slice([0,0,0,4],[u,u,c,1]),F.withClassScores?Yn(j.slice([0,0,0,5],[u,u,c,F.config.classes.length]),3):$(0)]}),h=l[0],p=l[2],d=[],[4,(f=l[1]).array()];case 1:return g=z.sent(),[4,h.array()];case 2:v=z.sent(),m=0,z.label=3;case 3:if(!(m<u))return[3,12];y=0,z.label=4;case 4:if(!(y<u))return[3,11];x=0,z.label=5;case 5:return x<c?(w=di(g[m][y][x][0]),!t||t<w?(b=(y+di(v[m][y][x][0]))/u*i,I=(m+di(v[m][y][x][1]))/u*s,E=Math.exp(v[m][y][x][2])*this.config.anchors[x].x/u*i,C=Math.exp(v[m][y][x][3])*this.config.anchors[x].y/u*s,R=b-E/2,k=I-C/2,D={row:m,col:y,anchor:x},this.withClassScores?[4,this.extractPredictedClass(p,D)]:[3,7]):[3,9]):[3,10];case 6:return P=z.sent(),[3,8];case 7:P={classScore:1,label:0},z.label=8;case 8:M=(N=P).classScore,W=N.label,d.push(fn({box:new ea(R,k,R+E,k+C),score:w,classScore:w*M,label:W},D)),z.label=9;case 9:return x++,[3,5];case 10:return y++,[3,4];case 11:return m++,[3,3];case 12:return h.dispose(),f.dispose(),p.dispose(),[2,d]}})})},on.prototype.extractPredictedClass=function(e,n){return te(this,void 0,void 0,function(){var t,r,o,a;return re(this,function(i){switch(i.label){case 0:return t=n.row,r=n.col,o=n.anchor,[4,e.array()];case 1:return a=i.sent(),[2,Array(this.config.classes.length).fill(0).map(function(s,u){return a[t][r][o][u]}).map(function(s,u){return{classScore:s,label:u}}).reduce(function(s,u){return s.classScore>u.classScore?s:u})]}})})},on.DEFAULT_FILTER_SIZES=[3,16,32,64,128,256,512,1024,1024],on);function on(e){var n=cg.call(this,"TinyYolov2")||this;return ug(e),n._config=e,n}var Uc,Vc=(fe(Rr,Uc=lg),Object.defineProperty(Rr.prototype,"withSeparableConvs",{get:function(){return this.config.withSeparableConvs},enumerable:!0,configurable:!0}),Object.defineProperty(Rr.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),Rr.prototype.locateFaces=function(e,n){return te(this,void 0,void 0,function(){return re(this,function(t){switch(t.label){case 0:return[4,this.detect(e,n)];case 1:return[2,t.sent().map(function(r){return new mn(r.score,r.relativeBox,{width:r.imageWidth,height:r.imageHeight})})]}})})},Rr.prototype.getDefaultModelName=function(){return this.withSeparableConvs?"tiny_yolov2_separable_conv_model":"tiny_yolov2_model"},Rr.prototype.extractParamsFromWeigthMap=function(e){return Uc.prototype.extractParamsFromWeigthMap.call(this,e)},Rr);function Rr(e){void 0===e&&(e=!0);var n=Object.assign({},{withSeparableConvs:e,iouThreshold:.4,classes:["face"]},e?{anchors:Ix,meanRgb:Rx}:{anchors:_x,withClassScores:!0});return Uc.call(this,n)||this}var Gc,hg=(fe(fg,Gc=ia),fg);function fg(){var e=null!==Gc&&Gc.apply(this,arguments)||this;return e._name="TinyFaceDetectorOptions",e}var so=(Hc.prototype.then=function(e){return te(this,void 0,void 0,function(){var n;return re(this,function(t){switch(t.label){case 0:return n=e,[4,this.run()];case 1:return[2,n.apply(void 0,[t.sent()])]}})})},Hc.prototype.run=function(){return te(this,void 0,void 0,function(){return re(this,function(e){throw new Error("ComposableTask - run is not implemented")})})},Hc);function Hc(){}function Oi(e,n,t,r,o){return void 0===o&&(o=function(a){return a.alignedRect}),te(this,void 0,void 0,function(){var a,i,s,u,c;return re(this,function(l){switch(l.label){case 0:return a=e.map(function(h){return Si(h)?o(h):h.detection}),(s=r)?[3,5]:n instanceof Re?[4,Ei(n,a)]:[3,2];case 1:return u=l.sent(),[3,4];case 2:return[4,Ci(n,a)];case 3:u=l.sent(),l.label=4;case 4:s=u,l.label=5;case 5:return[4,t(i=s)];case 6:return c=l.sent(),i.forEach(function(h){return h instanceof Re&&h.dispose()}),[2,c]}})})}function qc(e,n,t,r,o){return te(this,void 0,void 0,function(){var a=this;return re(this,function(i){return[2,Oi([e],n,function(s){return te(a,void 0,void 0,function(){return re(this,function(u){return[2,t(s[0])]})})},r,o)]})})}function jc(e,n){var r=n[1];return{height:Math.floor(n[0]*e),width:Math.floor(r*e)}}var pg,Kc=(fe(dg,pg=Un),dg);function dg(e,n,t,r){return pg.call(this,{left:e,top:n,right:t,bottom:r},!0)||this}function vg(e){return Q(function(){return nn(Ge(e,$(127.5)),$(.0078125))})}function uo(e,n){return Q(function(){return de(Fe(e),nn(n,Bo(Fe(Bo(e)))))})}function Xc(e,n,t){return void 0===t&&(t=!1),Q(function(){var r=Hn(e,n.conv1,"valid");return r=uo(r,n.prelu1_alpha),r=uo(r=Hn(r=qe(r,t?[2,2]:[3,3],[2,2],"same"),n.conv2,"valid"),n.prelu2_alpha),uo(r=Hn(r=t?r:qe(r,[3,3],[2,2],"valid"),n.conv3,"valid"),n.prelu3_alpha)})}function Tx(e,n,t,r,o){o.stage1=[];var a=n.map(function(l){return Q(function(){var m,y,h={scale:l},f=(m=e,y=l,Q(function(){var x=jc(y,m.shape.slice(1)),I=vg(oi.resizeBilinear(m,[x.height,x.width]));return pt(I,[0,2,1,3])})),p=Date.now(),d=function(m,y){return Q(function(){var x=Xc(m,y,!0),w=Hn(x,y.conv4_1,"valid"),b=En(Go(w,3),3);return{prob:Yn(Ge(w,b),3),regions:Hn(x,y.conv4_2,"valid")}})}(f,r),g=d.prob,v=d.regions;return h.pnet=Date.now()-p,{scoresTensor:Ue(Ue(g,3)[1])[0],regionsTensor:Ue(v)[0],scale:l,statsForScale:h}})}).map(function(l){var h=l.scoresTensor,f=l.regionsTensor,d=l.statsForScale,g=function(y,x,w,b){for(var I=[],E=y.arraySync(),C=0;C<y.shape[0];C++)for(var R=0;R<y.shape[1];R++)E[C][R]>=b&&I.push(new Ce(R,C));return I.map(function(k){var D=new ea(Math.round((2*k.y+1)/w),Math.round((2*k.x+1)/w),Math.round((2*k.y+12)/w),Math.round((2*k.x+12)/w)),N=E[k.y][k.x],M=x.arraySync();return{cell:D,score:N,region:new Kc(M[k.y][k.x][0],M[k.y][k.x][1],M[k.y][k.x][2],M[k.y][k.x][3])}})}(h,f,l.scale,t);if(h.dispose(),f.dispose(),!g.length)return o.stage1.push(d),[];var v=Date.now(),m=Zr(g.map(function(y){return y.cell}),g.map(function(y){return y.score}),.5);return d.nms=Date.now()-v,d.numBoxes=m.length,o.stage1.push(d),m.map(function(y){return g[y]})}).reduce(function(l,h){return l.concat(h)},[]),i=[],s=[];if(0<a.length){var u=Date.now(),c=Zr(a.map(function(l){return l.cell}),a.map(function(l){return l.score}),.7);o.stage1_nms=Date.now()-u,s=c.map(function(l){return a[l].score}),i=c.map(function(l){return a[l]}).map(function(l){var h=l.cell,f=l.region;return new ea(h.left+f.left*h.width,h.top+f.top*h.height,h.right+f.right*h.width,h.bottom+f.bottom*h.height).toSquare().round()})}return{boxes:i,scores:s}}function mg(e,n,t){var r=t.width,o=t.height;return te(this,void 0,void 0,function(){var a,i,s,u=this;return re(this,function(c){switch(c.label){case 0:return a=Gn(e),[4,Promise.all(n.map(function(l){return te(u,void 0,void 0,function(){var h,v,m,y;return re(this,function(x){return h=l.padAtBorders(e.height,e.width),y=a.getImageData(v=h.x-1,m=h.y-1,h.ex-v,h.ey-m),[2,Qe.isNodejs()?wi(y):createImageBitmap(y)]})})}))];case 1:return i=c.sent(),s=[],i.forEach(function(l){var h=Gn(ra({width:r,height:o}));h.drawImage(l,0,0,r,o);for(var f=h.getImageData(0,0,r,o).data,p=[],d=0;d<f.length;d+=4)p.push(f[d+2]),p.push(f[d+1]),p.push(f[d]);s.push(p)}),[2,s.map(function(l){return Q(function(){return vg(pt(ln(l,[1,r,o,3]),[0,2,1,3]).toFloat())})})]}})})}function Nx(e,n,t,r,o){return te(this,void 0,void 0,function(){var a,i,s,u,c,l,h,f,p,d,g,v,m,y;return re(this,function(x){switch(x.label){case 0:return a=Date.now(),[4,mg(e,n,{width:24,height:24})];case 1:return i=x.sent(),o.stage2_extractImagePatches=Date.now()-a,a=Date.now(),s=i.map(function(w){var I,E,b=(I=w,E=r,Q(function(){var C=Xc(I,E),R=uo(nt(An(C,[C.shape[0],E.fc1.weights.shape[0]]),E.fc1),E.prelu4_alpha),k=nt(R,E.fc2_1),D=En(Go(k,1),1),N=Yn(Ge(k,D),1),M=nt(R,E.fc2_2);return{scores:Ue(N,1)[1],regions:M}}));return w.dispose(),b}),o.stage2_rnet=Date.now()-a,u=1<s.length?ze(s.map(function(w){return w.scores})):s[0].scores,h=(l=Array).from,[4,u.data()];case 2:return c=h.apply(l,[x.sent()]),u.dispose(),f=c.map(function(w,b){return{score:w,idx:b}}).filter(function(w){return w.score>t}).map(function(w){return w.idx}),p=f.map(function(w){return n[w]}),d=f.map(function(w){return c[w]}),g=[],v=[],0<p.length&&(a=Date.now(),m=Zr(p,d,.7),o.stage2_nms=Date.now()-a,y=m.map(function(w){var b=s[f[w]].regions.arraySync();return new Kc(b[0][0],b[0][1],b[0][2],b[0][3])}),v=m.map(function(w){return d[w]}),g=m.map(function(w,b){return p[w].calibrate(y[b])})),s.forEach(function(w){w.regions.dispose(),w.scores.dispose()}),[2,{boxes:g,scores:v}]}})})}function Fx(e,n,t,r,o){return te(this,void 0,void 0,function(){var a,i,s,u,c,l,h,f,p,d,g,v,m,y,x;return re(this,function(w){switch(w.label){case 0:return a=Date.now(),[4,mg(e,n,{width:48,height:48})];case 1:return i=w.sent(),o.stage3_extractImagePatches=Date.now()-a,a=Date.now(),s=i.map(function(b){var E,C,I=(E=b,C=r,Q(function(){var R=Xc(E,C);R=uo(R=Hn(R=qe(R,[2,2],[2,2],"same"),C.conv4,"valid"),C.prelu4_alpha);var k=uo(nt(An(R,[R.shape[0],C.fc1.weights.shape[0]]),C.fc1),C.prelu5_alpha),D=nt(k,C.fc2_1),N=En(Go(D,1),1),M=Yn(Ge(D,N),1),W=nt(k,C.fc2_2),P=nt(k,C.fc2_3);return{scores:Ue(M,1)[1],regions:W,points:P}}));return b.dispose(),I}),o.stage3_onet=Date.now()-a,u=1<s.length?ze(s.map(function(b){return b.scores})):s[0].scores,h=(l=Array).from,[4,u.data()];case 2:return c=h.apply(l,[w.sent()]),u.dispose(),f=c.map(function(b,I){return{score:b,idx:I}}).filter(function(b){return b.score>t}).map(function(b){return b.idx}),p=f.map(function(b){var I=s[b].regions.arraySync();return new Kc(I[0][0],I[0][1],I[0][2],I[0][3])}),d=f.map(function(b,I){return n[b].calibrate(p[I])}),g=f.map(function(b){return c[b]}),v=[],m=[],y=[],0<d.length&&(a=Date.now(),x=Zr(d,g,.7,!1),o.stage3_nms=Date.now()-a,v=x.map(function(b){return d[b]}),m=x.map(function(b){return g[b]}),y=x.map(function(b,I){return Array(5).fill(0).map(function(E,C){var R=s[b].points.arraySync();return new Ce(R[0][C]*(v[I].width+1)+v[I].left,R[0][C+5]*(v[I].height+1)+v[I].top)})})),s.forEach(function(b){b.regions.dispose(),b.scores.dispose(),b.points.dispose()}),[2,{boxes:v,scores:m,points:y}]}})})}var Li,Yc=(fe(ot,Li=et),ot.prototype.load=function(e){return te(this,void 0,void 0,function(){return re(this,function(n){return console.warn("mtcnn is deprecated and will be removed soon"),[2,Li.prototype.load.call(this,e)]})})},ot.prototype.loadFromDisk=function(e){return te(this,void 0,void 0,function(){return re(this,function(n){return console.warn("mtcnn is deprecated and will be removed soon"),[2,Li.prototype.loadFromDisk.call(this,e)]})})},ot.prototype.forwardInput=function(e,n){return void 0===n&&(n={}),te(this,void 0,void 0,function(){var t,r,o,a,i,s,u,c,l,h,f,p,d,g,m,y,x,w,b,I;return re(this,function(E){switch(E.label){case 0:if(!(t=this.params))throw new Error("Mtcnn - load model before inference");if(!(r=e.canvases[0]))throw new Error("Mtcnn - inputCanvas is not defined, note that passing tensors into Mtcnn.forwardInput is not supported yet.");return o={},a=Date.now(),i=Q(function(){return C=En(ui.fromPixels(r)).toFloat(),Q(function(){return dn(Ue(C,3).reverse(),3)});var C}),s=function(C){return i.dispose(),o.total=Date.now()-a,C},u=i.shape.slice(1),c=u[0],l=u[1],h=new Ni(n),f=h.minFaceSize,p=h.scaleFactor,d=h.maxNumScales,g=h.scoreThresholds,m=(h.scaleSteps||function(C,R,k){for(var M=12/C,W=[],P=Math.min(k[0],k[1])*M,F=0;12<=P;)W.push(M*Math.pow(R,F)),P*=R,F+=1;return W}(f,p,[c,l])).filter(function(C){var R=jc(C,[c,l]);return Math.min(R.width,R.height)>12}).slice(0,d),o.scales=m,o.pyramid=m.map(function(C){return jc(C,[c,l])}),y=Date.now(),[4,Tx(i,m,g[0],t.pnet,o)];case 1:return x=E.sent(),o.total_stage1=Date.now()-y,x.boxes.length?(o.stage2_numInputBoxes=x.boxes.length,y=Date.now(),[4,Nx(r,x.boxes,g[1],t.rnet,o)]):[2,s({results:[],stats:o})];case 2:return w=E.sent(),o.total_stage2=Date.now()-y,w.boxes.length?(o.stage3_numInputBoxes=w.boxes.length,y=Date.now(),[4,Fx(r,w.boxes,g[2],t.onet,o)]):[2,s({results:[],stats:o})];case 3:return b=E.sent(),o.total_stage3=Date.now()-y,I=b.boxes.map(function(C,R){return aa(ro({},new mn(b.scores[R],new vi(C.left/l,C.top/c,C.width/l,C.height/c),{height:c,width:l})),new pm(b.points[R].map(function(k){return k.sub(new Ce(C.left,C.top)).div(new Ce(C.width,C.height))}),{width:C.width,height:C.height}))}),[2,s({results:I,stats:o})]}})})},ot.prototype.forward=function(e,n){return void 0===n&&(n={}),te(this,void 0,void 0,function(){var t;return re(this,function(r){switch(r.label){case 0:return t=this.forwardInput,[4,Ke(e)];case 1:return[4,t.apply(this,[r.sent(),n])];case 2:return[2,r.sent().results]}})})},ot.prototype.forwardWithStats=function(e,n){return void 0===n&&(n={}),te(this,void 0,void 0,function(){var t;return re(this,function(r){switch(r.label){case 0:return t=this.forwardInput,[4,Ke(e)];case 1:return[2,t.apply(this,[r.sent(),n])]}})})},ot.prototype.getDefaultModelName=function(){return"mtcnn_model"},ot.prototype.extractParamsFromWeigthMap=function(e){return function Ax(e){var n=[],t=function(c,l){var h=Xt(c,l);function f(v){return{filters:h(v+"/weights",4,v+"/filters"),bias:h(v+"/bias",1)}}function p(v){return{weights:h(v+"/weights",2),bias:h(v+"/bias",1)}}function d(v){return h(v,1)}function g(v){return{conv1:f(v+"/conv1"),prelu1_alpha:d(v+"/prelu1_alpha"),conv2:f(v+"/conv2"),prelu2_alpha:d(v+"/prelu2_alpha"),conv3:f(v+"/conv3"),prelu3_alpha:d(v+"/prelu3_alpha")}}return{extractPNetParams:function(){var v=g("pnet"),m=f("pnet/conv4_1"),y=f("pnet/conv4_2");return fn(fn({},v),{conv4_1:m,conv4_2:y})},extractRNetParams:function(){var v=g("rnet"),m=p("rnet/fc1"),y=d("rnet/prelu4_alpha"),x=p("rnet/fc2_1"),w=p("rnet/fc2_2");return fn(fn({},v),{fc1:m,prelu4_alpha:y,fc2_1:x,fc2_2:w})},extractONetParams:function(){var v=g("onet"),m=f("onet/conv4"),y=d("onet/prelu4_alpha"),x=p("onet/fc1"),w=d("onet/prelu5_alpha"),b=p("onet/fc2_1"),I=p("onet/fc2_2"),E=p("onet/fc2_3");return fn(fn({},v),{conv4:m,prelu4_alpha:y,fc1:x,prelu5_alpha:w,fc2_1:b,fc2_2:I,fc2_3:E})}}}(e,n),o=t.extractRNetParams,a=t.extractONetParams,i=(0,t.extractPNetParams)(),s=o(),u=a();return Et(e,n),{params:{pnet:i,rnet:s,onet:u},paramMappings:n}}(e)},ot.prototype.extractParams=function(e){return function Dx(e){var n=_t(e),r=n.getRemainingWeights,o=[],a=function(f,p){var d=Ri(f,p),g=wc(f,p);function v(y,x){var w=Pe(f(y));return p.push({paramPath:x}),w}function m(y,x,w){return void 0===w&&(w=!1),{conv1:d(y[0],y[1],3,x+"/conv1"),prelu1_alpha:v(y[1],x+"/prelu1_alpha"),conv2:d(y[1],y[2],3,x+"/conv2"),prelu2_alpha:v(y[2],x+"/prelu2_alpha"),conv3:d(y[2],y[3],w?2:3,x+"/conv3"),prelu3_alpha:v(y[3],x+"/prelu3_alpha")}}return{extractPNetParams:function(){var y=m([3,10,16,32],"pnet"),x=d(32,2,1,"pnet/conv4_1"),w=d(32,4,1,"pnet/conv4_2");return fn(fn({},y),{conv4_1:x,conv4_2:w})},extractRNetParams:function(){var y=m([3,28,48,64],"rnet",!0),x=g(576,128,"rnet/fc1"),w=v(128,"rnet/prelu4_alpha"),b=g(128,2,"rnet/fc2_1"),I=g(128,4,"rnet/fc2_2");return fn(fn({},y),{fc1:x,prelu4_alpha:w,fc2_1:b,fc2_2:I})},extractONetParams:function(){var y=m([3,32,64,64],"onet"),x=d(64,128,2,"onet/conv4"),w=v(128,"onet/prelu4_alpha"),b=g(1152,256,"onet/fc1"),I=v(256,"onet/prelu5_alpha"),E=g(256,2,"onet/fc2_1"),C=g(256,4,"onet/fc2_2"),R=g(256,10,"onet/fc2_3");return fn(fn({},y),{conv4:x,prelu4_alpha:w,fc1:b,prelu5_alpha:I,fc2_1:E,fc2_2:C,fc2_3:R})}}}(n.extractWeights,o),s=a.extractRNetParams,u=a.extractONetParams,c=(0,a.extractPNetParams)(),l=s(),h=u();if(0!==r().length)throw new Error("weights remaing after extract: "+r().length);return{params:{pnet:c,rnet:l,onet:h},paramMappings:o}}(e)},ot);function ot(){return Li.call(this,"Mtcnn")||this}var $c,Mx=[new Ce(1.603231,2.094468),new Ce(6.041143,7.080126),new Ce(2.882459,3.518061),new Ce(4.266906,5.178857),new Ce(9.041765,10.66308)],Ox=[117.001,114.697,97.404],Jc=(fe(co,$c=lg),Object.defineProperty(co.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),co.prototype.locateFaces=function(e,n){return te(this,void 0,void 0,function(){return re(this,function(t){switch(t.label){case 0:return[4,this.detect(e,n)];case 1:return[2,t.sent().map(function(r){return new mn(r.score,r.relativeBox,{width:r.imageWidth,height:r.imageHeight})})]}})})},co.prototype.getDefaultModelName=function(){return"tiny_face_detector_model"},co.prototype.extractParamsFromWeigthMap=function(e){return $c.prototype.extractParamsFromWeigthMap.call(this,e)},co);function co(){return $c.call(this,{withSeparableConvs:!0,iouThreshold:.4,classes:["face"],anchors:Mx,meanRgb:Ox,isFirstLayerConv2d:!0,filterSizes:[3,16,32,64,128,256,512]})||this}function gg(e,n){return _e.ssdMobilenetv1.locateFaces(e,n)}function yg(e){return _e.faceLandmark68Net.detectLandmarks(e)}function xg(e){return _e.ssdMobilenetv1.load(e)}var bg,_e={ssdMobilenetv1:new Fi,tinyFaceDetector:new Jc,tinyYolov2:new Vc,mtcnn:new Yc,faceLandmark68Net:new Ac,faceLandmark68TinyNet:new eg,faceRecognitionNet:new Fc,faceExpressionNet:new Um,ageGenderNet:new Ym},Px=xg,Bx=gg,Lx=yg,wg=(fe(Cg,bg=so),Cg);function Cg(e,n,t){var r=bg.call(this)||this;return r.parentTask=e,r.input=n,r.extractedFaces=t,r}var Qc,Zc=(fe(Wi,Qc=wg),Wi.prototype.run=function(){return te(this,void 0,void 0,function(){var e,n,t=this;return re(this,function(r){switch(r.label){case 0:return[4,this.parentTask];case 1:return[4,Oi(e=r.sent(),this.input,function(o){return te(t,void 0,void 0,function(){return re(this,function(a){switch(a.label){case 0:return[4,Promise.all(o.map(function(i){return _e.faceExpressionNet.predictExpressions(i)}))];case 1:return[2,a.sent()]}})})},this.extractedFaces)];case 2:return n=r.sent(),[2,e.map(function(o,a){return Rc(o,n[a])})]}})})},Wi.prototype.withAgeAndGender=function(){return new sl(this,this.input)},Wi);function Wi(){return null!==Qc&&Qc.apply(this,arguments)||this}var el,nl=(fe(zi,el=wg),zi.prototype.run=function(){return te(this,void 0,void 0,function(){var e,n;return re(this,function(t){switch(t.label){case 0:return[4,this.parentTask];case 1:return(e=t.sent())?[4,qc(e,this.input,function(r){return _e.faceExpressionNet.predictExpressions(r)},this.extractedFaces)]:[2];case 2:return n=t.sent(),[2,Rc(e,n)]}})})},zi.prototype.withAgeAndGender=function(){return new cl(this,this.input)},zi);function zi(){return null!==el&&el.apply(this,arguments)||this}var tl,rl=(fe(Ui,tl=Zc),Ui.prototype.withAgeAndGender=function(){return new hl(this,this.input)},Ui.prototype.withFaceDescriptors=function(){return new Ki(this,this.input)},Ui);function Ui(){return null!==tl&&tl.apply(this,arguments)||this}var ol,al=(fe(Vi,ol=nl),Vi.prototype.withAgeAndGender=function(){return new pl(this,this.input)},Vi.prototype.withFaceDescriptor=function(){return new Xi(this,this.input)},Vi);function Vi(){return null!==ol&&ol.apply(this,arguments)||this}var Eg,_g=(fe(Ig,Eg=so),Ig);function Ig(e,n,t){var r=Eg.call(this)||this;return r.parentTask=e,r.input=n,r.extractedFaces=t,r}var il,sl=(fe(Gi,il=_g),Gi.prototype.run=function(){return te(this,void 0,void 0,function(){var e,n,t=this;return re(this,function(r){switch(r.label){case 0:return[4,this.parentTask];case 1:return[4,Oi(e=r.sent(),this.input,function(o){return te(t,void 0,void 0,function(){return re(this,function(a){switch(a.label){case 0:return[4,Promise.all(o.map(function(i){return _e.ageGenderNet.predictAgeAndGender(i)}))];case 1:return[2,a.sent()]}})})},this.extractedFaces)];case 2:return n=r.sent(),[2,e.map(function(o,a){var i=n[a],s=i.age;return Oc(Pc(o,i.gender,i.genderProbability),s)})]}})})},Gi.prototype.withFaceExpressions=function(){return new Zc(this,this.input)},Gi);function Gi(){return null!==il&&il.apply(this,arguments)||this}var ul,cl=(fe(Hi,ul=_g),Hi.prototype.run=function(){return te(this,void 0,void 0,function(){var e,n,t;return re(this,function(a){switch(a.label){case 0:return[4,this.parentTask];case 1:return(e=a.sent())?[4,qc(e,this.input,function(i){return _e.ageGenderNet.predictAgeAndGender(i)},this.extractedFaces)]:[2];case 2:return n=a.sent(),t=n.age,[2,Oc(Pc(e,n.gender,n.genderProbability),t)]}})})},Hi.prototype.withFaceExpressions=function(){return new nl(this,this.input)},Hi);function Hi(){return null!==ul&&ul.apply(this,arguments)||this}var ll,hl=(fe(qi,ll=sl),qi.prototype.withFaceExpressions=function(){return new rl(this,this.input)},qi.prototype.withFaceDescriptors=function(){return new Ki(this,this.input)},qi);function qi(){return null!==ll&&ll.apply(this,arguments)||this}var fl,pl=(fe(ji,fl=cl),ji.prototype.withFaceExpressions=function(){return new al(this,this.input)},ji.prototype.withFaceDescriptor=function(){return new Xi(this,this.input)},ji);function ji(){return null!==fl&&fl.apply(this,arguments)||this}var Rg,dl=(fe(kg,Rg=so),kg);function kg(e,n){var t=Rg.call(this)||this;return t.parentTask=e,t.input=n,t}var vl,Ki=(fe(sa,vl=dl),sa.prototype.run=function(){return te(this,void 0,void 0,function(){var e;return re(this,function(n){switch(n.label){case 0:return[4,this.parentTask];case 1:return[4,Oi(e=n.sent(),this.input,function(t){return Promise.all(t.map(function(r){return _e.faceRecognitionNet.computeFaceDescriptor(r)}))},null,function(t){return t.landmarks.align(null,{useDlibAlignment:!0})})];case 2:return[2,n.sent().map(function(t,r){return Mc(e[r],t)})]}})})},sa.prototype.withFaceExpressions=function(){return new rl(this,this.input)},sa.prototype.withAgeAndGender=function(){return new hl(this,this.input)},sa);function sa(){return null!==vl&&vl.apply(this,arguments)||this}var ml,Xi=(fe(ua,ml=dl),ua.prototype.run=function(){return te(this,void 0,void 0,function(){var e,n;return re(this,function(t){switch(t.label){case 0:return[4,this.parentTask];case 1:return(e=t.sent())?[4,qc(e,this.input,function(r){return _e.faceRecognitionNet.computeFaceDescriptor(r)},null,function(r){return r.landmarks.align(null,{useDlibAlignment:!0})})]:[2];case 2:return n=t.sent(),[2,Mc(e,n)]}})})},ua.prototype.withFaceExpressions=function(){return new al(this,this.input)},ua.prototype.withAgeAndGender=function(){return new pl(this,this.input)},ua);function ua(){return null!==ml&&ml.apply(this,arguments)||this}var Sg,gl=(fe(yl,Sg=so),Object.defineProperty(yl.prototype,"landmarkNet",{get:function(){return this.useTinyLandmarkNet?_e.faceLandmark68TinyNet:_e.faceLandmark68Net},enumerable:!0,configurable:!0}),yl);function yl(e,n,t){var r=Sg.call(this)||this;return r.parentTask=e,r.input=n,r.useTinyLandmarkNet=t,r}var xl,Dg=(fe(lo,xl=gl),lo.prototype.run=function(){return te(this,void 0,void 0,function(){var e,n,t,r,o,a=this;return re(this,function(i){switch(i.label){case 0:return[4,this.parentTask];case 1:return e=i.sent(),n=e.map(function(s){return s.detection}),this.input instanceof Re?[4,Ei(this.input,n)]:[3,3];case 2:return r=i.sent(),[3,5];case 3:return[4,Ci(this.input,n)];case 4:r=i.sent(),i.label=5;case 5:return t=r,[4,Promise.all(t.map(function(s){return a.landmarkNet.detectLandmarks(s)}))];case 6:return o=i.sent(),t.forEach(function(s){return s instanceof Re&&s.dispose()}),[2,e.map(function(s,u){return aa(s,o[u])})]}})})},lo.prototype.withFaceExpressions=function(){return new rl(this,this.input)},lo.prototype.withAgeAndGender=function(){return new hl(this,this.input)},lo.prototype.withFaceDescriptors=function(){return new Ki(this,this.input)},lo);function lo(){return null!==xl&&xl.apply(this,arguments)||this}var bl,Ag=(fe(ho,bl=gl),ho.prototype.run=function(){return te(this,void 0,void 0,function(){var e,n,t,r,o;return re(this,function(a){switch(a.label){case 0:return[4,this.parentTask];case 1:return(e=a.sent())?(n=e.detection,this.input instanceof Re?[4,Ei(this.input,[n])]:[3,3]):[2];case 2:return r=a.sent(),[3,5];case 3:return[4,Ci(this.input,[n])];case 4:r=a.sent(),a.label=5;case 5:return[4,this.landmarkNet.detectLandmarks((t=r)[0])];case 6:return o=a.sent(),t.forEach(function(i){return i instanceof Re&&i.dispose()}),[2,aa(e,o)]}})})},ho.prototype.withFaceExpressions=function(){return new al(this,this.input)},ho.prototype.withAgeAndGender=function(){return new pl(this,this.input)},ho.prototype.withFaceDescriptor=function(){return new Xi(this,this.input)},ho);function ho(){return null!==bl&&bl.apply(this,arguments)||this}var Tg,wl=(fe(Ng,Tg=so),Ng);function Ng(e,n){void 0===n&&(n=new Ir);var t=Tg.call(this)||this;return t.input=e,t.options=n,t}var Cl,El=(fe(kr,Cl=wl),kr.prototype.run=function(){return te(this,void 0,void 0,function(){var e,n,t,r;return re(this,function(o){switch(o.label){case 0:return n=(e=this).input,(t=e.options)instanceof Ni?[4,_e.mtcnn.forward(n,t)]:[3,2];case 1:return[2,o.sent().map(function(a){return a.detection})];case 2:if(!(r=t instanceof hg?function(a){return _e.tinyFaceDetector.locateFaces(a,t)}:t instanceof Ir?function(a){return _e.ssdMobilenetv1.locateFaces(a,t)}:t instanceof ia?function(a){return _e.tinyYolov2.locateFaces(a,t)}:null))throw new Error("detectFaces - expected options to be instance of TinyFaceDetectorOptions | SsdMobilenetv1Options | MtcnnOptions | TinyYolov2Options");return[2,r(n)]}})})},kr.prototype.runAndExtendWithFaceDetections=function(){var e=this;return new Promise(function(n){return te(e,void 0,void 0,function(){var t;return re(this,function(r){switch(r.label){case 0:return[4,this.run()];case 1:return t=r.sent(),[2,n(t.map(function(o){return ro({},o)}))]}})})})},kr.prototype.withFaceLandmarks=function(e){return void 0===e&&(e=!1),new Dg(this.runAndExtendWithFaceDetections(),this.input,e)},kr.prototype.withFaceExpressions=function(){return new Zc(this.runAndExtendWithFaceDetections(),this.input)},kr.prototype.withAgeAndGender=function(){return new sl(this.runAndExtendWithFaceDetections(),this.input)},kr);function kr(){return null!==Cl&&Cl.apply(this,arguments)||this}var _l,Fg=(fe(Sr,_l=wl),Sr.prototype.run=function(){return te(this,void 0,void 0,function(){var e,n;return re(this,function(t){switch(t.label){case 0:return[4,new El(this.input,this.options)];case 1:return e=t.sent(),n=e[0],e.forEach(function(r){r.score>n.score&&(n=r)}),[2,n]}})})},Sr.prototype.runAndExtendWithFaceDetection=function(){var e=this;return new Promise(function(n){return te(e,void 0,void 0,function(){var t;return re(this,function(r){switch(r.label){case 0:return[4,this.run()];case 1:return t=r.sent(),[2,n(t?ro({},t):void 0)]}})})})},Sr.prototype.withFaceLandmarks=function(e){return void 0===e&&(e=!1),new Ag(this.runAndExtendWithFaceDetection(),this.input,e)},Sr.prototype.withFaceExpressions=function(){return new nl(this.runAndExtendWithFaceDetection(),this.input)},Sr.prototype.withAgeAndGender=function(){return new cl(this.runAndExtendWithFaceDetection(),this.input)},Sr);function Sr(){return null!==_l&&_l.apply(this,arguments)||this}function Yi(e,n){return void 0===n&&(n=new Ir),new El(e,n)}function Mg(e,n){return te(this,void 0,void 0,function(){return re(this,function(t){switch(t.label){case 0:return console.warn("allFacesSsdMobilenetv1 is deprecated and will be removed soon, use the high level api instead"),[4,Yi(e,new Ir(n?{minConfidence:n}:{})).withFaceLandmarks().withFaceDescriptors()];case 1:return[2,t.sent()]}})})}var Wx=Mg;function Og(e,n){if(e.length!==n.length)throw new Error("euclideanDistance: arr1.length !== arr2.length");var t=Array.from(e),r=Array.from(n);return Math.sqrt(t.map(function(o,a){return o-r[a]}).reduce(function(o,a){return o+Math.pow(a,2)},0))}var zx=(Object.defineProperty(Rt.prototype,"labeledDescriptors",{get:function(){return this._labeledDescriptors},enumerable:!0,configurable:!0}),Object.defineProperty(Rt.prototype,"distanceThreshold",{get:function(){return this._distanceThreshold},enumerable:!0,configurable:!0}),Rt.prototype.computeMeanDistance=function(e,n){return n.map(function(t){return Og(t,e)}).reduce(function(t,r){return t+r},0)/(n.length||1)},Rt.prototype.matchDescriptor=function(e){var n=this;return this.labeledDescriptors.map(function(t){return new fc(t.label,n.computeMeanDistance(e,t.descriptors))}).reduce(function(t,r){return t.distance<r.distance?t:r})},Rt.prototype.findBestMatch=function(e){var n=this.matchDescriptor(e);return n.distance<this.distanceThreshold?n:new fc("unknown",n.distance)},Rt.prototype.toJSON=function(){return{distanceThreshold:this.distanceThreshold,labeledDescriptors:this.labeledDescriptors.map(function(e){return e.toJSON()})}},Rt.fromJSON=function(e){return new Rt(e.labeledDescriptors.map(function(n){return na.fromJSON(n)}),e.distanceThreshold)},Rt);function Rt(e,n){void 0===n&&(n=.6),this._distanceThreshold=n;var t=Array.isArray(e)?e:[e];if(!t.length)throw new Error("FaceRecognizer.constructor - expected atleast one input");function r(){return"person "+o++}var o=1;this._labeledDescriptors=t.map(function(a){if(a instanceof na)return a;if(a instanceof Float32Array)return new na(r(),[a]);if(a.descriptor&&a.descriptor instanceof Float32Array)return new na(r(),[a.descriptor]);throw new Error("FaceRecognizer.constructor - expected inputs to be of type LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array | Array<LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array>")})}H.AgeGenderNet=Ym,H.BoundingBox=ea,H.Box=Un,H.ComposableTask=so,H.ComputeAllFaceDescriptorsTask=Ki,H.ComputeFaceDescriptorsTaskBase=dl,H.ComputeSingleFaceDescriptorTask=Xi,H.DetectAllFaceLandmarksTask=Dg,H.DetectAllFacesTask=El,H.DetectFaceLandmarksTaskBase=gl,H.DetectFacesTaskBase=wl,H.DetectSingleFaceLandmarksTask=Ag,H.DetectSingleFaceTask=Fg,H.Dimensions=jt,H.FACE_EXPRESSION_LABELS=Ic,H.FaceDetection=mn,H.FaceDetectionNet=Ex,H.FaceExpressionNet=Um,H.FaceExpressions=ki,H.FaceLandmark68Net=Ac,H.FaceLandmark68TinyNet=eg,H.FaceLandmarkNet=dx,H.FaceLandmarks=br,H.FaceLandmarks5=pm,H.FaceLandmarks68=hc,H.FaceMatch=fc,H.FaceMatcher=zx,H.FaceRecognitionNet=Fc,H.LabeledBox=pc,H.LabeledFaceDescriptors=na,H.Mtcnn=Yc,H.MtcnnOptions=Ni,H.NetInput=oa,H.NeuralNetwork=et,H.ObjectDetection=ic,H.Point=Ce,H.PredictedBox=ux,H.Rect=vi,H.SsdMobilenetv1=Fi,H.SsdMobilenetv1Options=Ir,H.TinyFaceDetector=Jc,H.TinyFaceDetectorOptions=hg,H.TinyYolov2=Vc,H.TinyYolov2Options=ia,H.allFaces=Wx,H.allFacesMtcnn=function(e,n){return void 0===n&&(n={}),te(this,void 0,void 0,function(){return re(this,function(t){switch(t.label){case 0:return console.warn("allFacesMtcnn is deprecated and will be removed soon, use the high level api instead"),[4,Yi(e,new Ni(n)).withFaceLandmarks().withFaceDescriptors()];case 1:return[2,t.sent()]}})})},H.allFacesSsdMobilenetv1=Mg,H.allFacesTinyYolov2=function(e,n){return void 0===n&&(n={}),te(this,void 0,void 0,function(){return re(this,function(t){switch(t.label){case 0:return console.warn("allFacesTinyYolov2 is deprecated and will be removed soon, use the high level api instead"),[4,Yi(e,new ia(n)).withFaceLandmarks().withFaceDescriptors()];case 1:return[2,t.sent()]}})})},H.awaitMediaLoaded=_m,H.bufferToImage=Im,H.computeFaceDescriptor=function(e){return _e.faceRecognitionNet.computeFaceDescriptor(e)},H.createCanvas=ra,H.createCanvasFromMedia=wi,H.createFaceDetectionNet=function(e){return ig(e)},H.createFaceRecognitionNet=function(e){var n=new Fc;return n.extractWeights(e),n},H.createMtcnn=function(e){var n=new Yc;return n.extractWeights(e),n},H.createSsdMobilenetv1=ig,H.createTinyFaceDetector=function(e){var n=new Jc;return n.extractWeights(e),n},H.createTinyYolov2=function(e,n){void 0===n&&(n=!0);var t=new Vc(n);return t.extractWeights(e),t},H.detectAllFaces=Yi,H.detectFaceLandmarks=yg,H.detectFaceLandmarksTiny=function(e){return _e.faceLandmark68TinyNet.detectLandmarks(e)},H.detectLandmarks=Lx,H.detectSingleFace=function(e,n){return void 0===n&&(n=new Ir),new Fg(e,n)},H.draw=cx,H.env=Qe,H.euclideanDistance=Og,H.extendWithAge=Oc,H.extendWithFaceDescriptor=Mc,H.extendWithFaceDetection=ro,H.extendWithFaceExpressions=Rc,H.extendWithFaceLandmarks=aa,H.extendWithGender=Pc,H.extractFaceTensors=Ei,H.extractFaces=Ci,H.fetchImage=function(e){return te(this,void 0,void 0,function(){var n,t;return re(this,function(r){switch(r.label){case 0:return[4,_i(e)];case 1:return[4,(n=r.sent()).blob()];case 2:if(!(t=r.sent()).type.startsWith("image/"))throw new Error("fetchImage - expected blob type to be of type image/*, instead have: "+t.type+", for url: "+n.url);return[2,Im(t)]}})})},H.fetchJson=Sm,H.fetchNetWeights=function(e){return te(this,void 0,void 0,function(){var n;return re(this,function(t){switch(t.label){case 0:return n=Float32Array.bind,[4,_i(e)];case 1:return[4,t.sent().arrayBuffer()];case 2:return[2,new(n.apply(Float32Array,[void 0,t.sent()]))]}})})},H.fetchOrThrow=_i,H.getContext2dOrThrow=Gn,H.getMediaDimensions=bi,H.imageTensorToCanvas=Rm,H.imageToSquare=km,H.inverseSigmoid=function(e){return Math.log(e/(1-e))},H.iou=um,H.isMediaElement=xc,H.isMediaLoaded=yc,H.isWithAge=function(e){return"number"==typeof e.age},H.isWithFaceDetection=to,H.isWithFaceExpressions=Vm,H.isWithFaceLandmarks=Si,H.isWithGender=function(e){return(e.gender===H.Gender.MALE||e.gender===H.Gender.FEMALE)&&fi(e.genderProbability)},H.loadAgeGenderModel=function(e){return _e.ageGenderNet.load(e)},H.loadFaceDetectionModel=Px,H.loadFaceExpressionModel=function(e){return _e.faceExpressionNet.load(e)},H.loadFaceLandmarkModel=function(e){return _e.faceLandmark68Net.load(e)},H.loadFaceLandmarkTinyModel=function(e){return _e.faceLandmark68TinyNet.load(e)},H.loadFaceRecognitionModel=function(e){return _e.faceRecognitionNet.load(e)},H.loadMtcnnModel=function(e){return _e.mtcnn.load(e)},H.loadSsdMobilenetv1Model=xg,H.loadTinyFaceDetectorModel=function(e){return _e.tinyFaceDetector.load(e)},H.loadTinyYolov2Model=function(e){return _e.tinyYolov2.load(e)},H.loadWeightMap=Am,H.locateFaces=Bx,H.matchDimensions=function(e,n,t){void 0===t&&(t=!1);var r=t?bi(n):n,a=r.height;return{width:e.width=r.width,height:e.height=a}},H.minBbox=cm,H.mtcnn=function(e,n){return _e.mtcnn.forward(e,n)},H.nets=_e,H.nonMaxSuppression=Zr,H.normalize=eo,H.padToSquare=lm,H.predictAgeAndGender=function(e){return _e.ageGenderNet.predictAgeAndGender(e)},H.recognizeFaceExpressions=function(e){return _e.faceExpressionNet.predictExpressions(e)},H.resizeResults=function e(n,t){var r=new jt(t.width,t.height),o=r.width,a=r.height;if(o<=0||a<=0)throw new Error("resizeResults - invalid dimensions: "+JSON.stringify({width:o,height:a}));if(Array.isArray(n))return n.map(function(u){return e(u,{width:o,height:a})});if(Si(n)){var i=n.detection.forSize(o,a),s=n.unshiftedLandmarks.forSize(i.box.width,i.box.height);return aa(ro(n,i),s)}return to(n)?ro(n,n.detection.forSize(o,a)):n instanceof br||n instanceof mn?n.forSize(o,a):n},H.resolveInput=xi,H.shuffleArray=function(e){for(var n=e.slice(),t=n.length-1;0<t;t--){var r=Math.floor(Math.random()*(t+1)),o=n[t];n[t]=n[r],n[r]=o}return n},H.sigmoid=di,H.ssdMobilenetv1=gg,H.tf=ix,H.tinyFaceDetector=function(e,n){return _e.tinyFaceDetector.locateFaces(e,n)},H.tinyYolov2=function(e,n){return _e.tinyYolov2.locateFaces(e,n)},H.toNetInput=Ke,H.utils=sx,H.validateConfig=ug,Object.defineProperty(H,"__esModule",{value:!0})});